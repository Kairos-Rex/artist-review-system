<!DOCTYPE html>
<!-- 部署时间: 2025-09-12T13:34:43.069Z -->
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>画师评价系统</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --primary: #3b82f6;
            --secondary: #10b981;
            --accent: #f59e0b;
            --neutral: #6b7280;
            --dark: #1f2937;
        }
        
        .text-primary { color: var(--primary); }
        .bg-primary { background-color: var(--primary); }
        .text-secondary { color: var(--secondary); }
        .bg-secondary { background-color: var(--secondary); }
        .text-accent { color: var(--accent); }
        .bg-accent { background-color: var(--accent); }
        .text-neutral { color: var(--neutral); }
        .text-dark { color: var(--dark); }
        
        .btn-hover {
            transition: all 0.2s ease;
        }
        
        .btn-hover:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        .item-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 12px;
        }
        
        .history-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }
        
        .template-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 12px;
        }
        
        .category-btn {
            padding: 8px 16px;
            border-radius: 20px;
            border: 1px solid #e5e7eb;
            background: white;
            color: var(--neutral);
            transition: all 0.2s ease;
            cursor: pointer;
            font-size: 14px;
        }
        
        .category-btn:hover {
            border-color: var(--primary);
            color: var(--primary);
        }
        
        .category-btn-active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        
        /* 隐藏选择面板滚动条 */
        .selection-panel {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        
        .selection-panel::-webkit-scrollbar {
            display: none;
        }
        
        /* 隐藏右侧栏滚动条 */
        .result-container-adaptive {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        
        .result-container-adaptive::-webkit-scrollbar {
            display: none;
        }
        
        /* 隐藏最近使用模板区域滚动条 */
        #recentTemplatesContainer {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        
        #recentTemplatesContainer::-webkit-scrollbar {
            display: none;
        }
        
        /* 隐藏右侧栏主容器滚动条 */
        .right-panel {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        
        .right-panel::-webkit-scrollbar {
            display: none;
        }
        
        .template-scroll-btn {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: white;
            border: 1px solid #e5e7eb;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            z-index: 10;
        }
        
        .template-scroll-btn:hover {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        .result-container-adaptive {
            overflow-y: auto;
            word-wrap: break-word;
            white-space: pre-wrap;
        }
        
        .btn-text-nowrap {
            white-space: nowrap;
        }
        
        .config-transition {
            transition: all 0.3s ease;
        }
        
        .add-item-btn {
            transition: all 0.2s ease;
        }
        
        .add-item-btn:hover {
            transform: scale(1.1);
        }
        
        @media (max-width: 768px) {
            .item-grid {
                grid-template-columns: 1fr;
            }
            
            .history-grid {
                grid-template-columns: 1fr;
            }
            
            .template-grid {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            }
        }
        
        .floating-container {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            width: 90%;
            max-width: 1200px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
        
        @media (max-width: 768px) {
            .floating-container {
                width: 95%;
                top: 10px;
            }
        }
        
        .function-area {
            min-height: 200px;
        }
        
        .function-buttons {
            flex-shrink: 0;
        }
        
        @media (max-width: 768px) {
            .function-buttons {
                min-width: auto;
                width: 100%;
            }
            
            .function-area .flex {
                flex-direction: column;
            }
        }
    </style>

    <script>
        // 部署环境检测
        if (typeof window !== 'undefined') {
            console.log('🚀 画师评价系统已部署到生产环境');
            console.log('📍 当前域名:', window.location.hostname);
            console.log('🔒 HTTPS状态:', window.location.protocol === 'https:' ? '已启用' : '未启用');
        }
    </script>
</head>
<body class="bg-gray-50 font-sans text-dark overflow-x-hidden">
    <!-- 新的三栏布局 -->
    <div class="flex h-screen">
        <!-- 左侧：收藏夹模块 -->
        <div class="w-1/4 bg-white shadow-md overflow-y-auto p-5 flex flex-col scrollbar-hide">
            <!-- 收藏夹标题和搜索 -->
            <div class="flex items-center justify-between mb-4 gap-3">
                <div class="flex items-center">
                    <h2 class="text-lg font-semibold text-gray-800">
                        <i class="fas fa-star text-yellow-500 mr-2"></i>
                        收藏夹
                    </h2>
                    <span id="favoriteCount" class="text-sm text-gray-500 ml-2">0</span>
                </div>
                
                <!-- 紧凑搜索框 -->
                <div class="relative flex-1 max-w-xs">
                    <input type="text" id="favoriteSearch" placeholder="搜索..." 
                           class="w-full px-3 py-1.5 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-1 focus:ring-blue-500">
                    <i class="fas fa-search absolute right-2 top-2 text-gray-400 text-xs"></i>
                </div>
            </div>
            
            <!-- 快速访问按钮 -->
            <div class="mb-4 flex gap-2">
                <!-- 智能筛选按钮 -->
                <button id="smartFilterBtn" class="flex-1 px-3 py-3 bg-gray-100 text-gray-700 rounded-lg font-medium border border-gray-200 hover:bg-gray-200 transition-all duration-200 transform hover:scale-105 flex items-center justify-center gap-2">
                    <i class="fas fa-brain"></i>
                    <span>智能筛选</span>
                </button>
                
                <!-- 最近使用按钮 -->
                <button id="recentUsedBtn" class="flex-1 px-3 py-3 bg-gray-100 text-gray-700 rounded-lg font-medium border border-gray-200 hover:bg-gray-200 transition-all duration-200 transform hover:scale-105 flex items-center justify-center gap-2">
                    <i class="fas fa-clock"></i>
                    <span>最近使用</span>
                </button>
                
                <!-- 所有标签按钮 -->
                <button id="allTagsQuickBtn" class="flex-1 px-3 py-3 bg-gray-100 text-gray-700 rounded-lg font-medium border border-gray-200 hover:bg-gray-200 transition-all duration-200 transform hover:scale-105 flex items-center justify-center gap-2">
                    <i class="fas fa-tags"></i>
                    <span>所有标签</span>
                </button>
            </div>
            
            <!-- 标签分类筛选 -->
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">标签分类</label>
                <select id="tagFilter" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 bg-gray-50">
                    <option value="">选择标签分类</option>
                </select>
            </div>
            
            <!-- 收藏话术列表 -->
            <div class="flex-1 overflow-y-auto">
                <div id="favoritesList" class="space-y-3">
                    <!-- 收藏话术项目将在这里动态生成 -->
                </div>
                
                <!-- 空状态提示 -->
                <div id="emptyFavorites" class="text-center py-8 text-gray-500 hidden">
                    <i class="fas fa-star text-4xl text-gray-300 mb-3"></i>
                    <p class="text-sm">还没有收藏的话术</p>
                    <p class="text-xs mt-1">点击"收藏话术"按钮开始收藏</p>
                </div>
            </div>
        </div>
        
        <!-- 中间：选择面板 -->
        <div class="flex-1 overflow-y-auto selection-panel p-4">
            <div class="bg-white rounded-xl shadow-md p-5">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold">选择面板</h2>
                    <div class="flex gap-2">
                        <button id="settingsBtn" class="flex items-center gap-1 text-neutral hover:text-blue-500 transition-colors btn-text-nowrap">
                            <i class="fa fa-cogs"></i> 网页总设置
                        </button>
                        <button id="resetBtnPanel" class="flex items-center gap-1 text-neutral hover:text-red-500 transition-colors btn-text-nowrap">
                            <i class="fa fa-refresh"></i> 重置选择
                        </button>
                    </div>
                </div>
                
                <!-- 起手称呼式 -->
                <div class="mb-6">
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="font-bold text-lg flex items-center gap-2">
                            <i class="fa fa-comment-o text-primary"></i><span id="greetingTitle">起手称呼式</span>
                        </h3>
                        <button class="add-item-btn text-sm text-primary hover:text-primary/80 btn-text-nowrap" data-type="greeting">
                            <i class="fa fa-plus-circle"></i>
                        </button>
                    </div>
                    <div id="greetingContainer" class="item-grid" data-type="greeting">
                        <!-- 起手式项目将通过JS动态生成 -->
                    </div>
                </div>
                
                <!-- 优点 -->
                <div class="mb-6">
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="font-bold text-lg flex items-center gap-2">
                            <i class="fa fa-thumbs-up text-green-500"></i><span id="strengthTitle">优点</span>
                        </h3>
                        <button class="add-item-btn text-sm text-primary hover:text-primary/80 btn-text-nowrap" data-type="strength">
                            <i class="fa fa-plus-circle"></i>
                        </button>
                    </div>
                    <div id="strengthContainer" class="item-grid" data-type="strength">
                        <!-- 优点项目将通过JS动态生成 -->
                    </div>
                </div>
                
                <!-- 问题 -->
                <div class="mb-6">
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="font-bold text-lg flex items-center gap-2">
                            <i class="fa fa-exclamation-triangle text-amber-500"></i><span id="issueTitle">问题</span>
                        </h3>
                        <button class="add-item-btn text-sm text-primary hover:text-primary/80 btn-text-nowrap" data-type="issue">
                            <i class="fa fa-plus-circle"></i>
                        </button>
                    </div>
                    <div id="issueContainer" class="item-grid" data-type="issue">
                        <!-- 问题项目将通过JS动态生成 -->
                    </div>
                </div>
                
                <!-- 结尾式 -->
                <div class="mb-6">
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="font-bold text-lg flex items-center gap-2">
                            <i class="fa fa-sign-out text-purple-500"></i><span id="closingTitle">结尾式</span>
                        </h3>
                        <button class="add-item-btn text-sm text-primary hover:text-primary/80 btn-text-nowrap" data-type="closing">
                            <i class="fa fa-plus-circle"></i>
                        </button>
                    </div>
                    <div id="closingContainer" class="item-grid" data-type="closing">
                        <!-- 结尾式项目将通过JS动态生成 -->
                    </div>
                </div>
                

            </div>
            
            <div class="mt-4 bg-white rounded-xl shadow-md p-5">
                <h3 class="font-medium text-lg mb-3">使用说明</h3>
                <ul class="text-sm text-neutral space-y-2">
                    <li class="flex items-start gap-2">
                        <i class="fa fa-check-circle text-green-500 mt-1"></i>
                        <span>您可以拖动项目调整顺序（尽管拖动图标不可见）</span>
                    </li>
                    <li class="flex items-start gap-2">
                        <i class="fa fa-check-circle text-green-500 mt-1"></i>
                        <span>点击项目上的编辑按钮可修改或删除项目</span>
                    </li>
                    <li class="flex items-start gap-2">
                        <i class="fa fa-check-circle text-green-500 mt-1"></i>
                        <span>点击加号按钮可添加新的项目</span>
                    </li>
                    <li class="flex items-start gap-2">
                        <i class="fa fa-check-circle text-green-500 mt-1"></i>
                        <span>选择的内容会自动生成话术咒语</span>
                    </li>
                </ul>
            </div>
        </div>
        
        <!-- 右侧：顶部面板（固定显示） -->
        <div class="w-1/4 bg-white shadow-md p-5 overflow-y-auto right-panel">
            <!-- 画师评价系统标题 -->
            <div class="mb-6 flex justify-between items-center">
                <h1 class="text-[clamp(1.5rem,3vw,2rem)] font-bold text-primary">画师评价系统</h1>
                <button id="newSettingsBtn" class="text-neutral hover:text-primary transition-colors p-2 rounded-full hover:bg-gray-100" title="新设置">
                    <i class="fa fa-cog"></i>
                </button>
            </div>
            
            <!-- 最近使用模板 -->
            <div class="mb-4">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="text-md font-medium">最近使用</h3>
                </div>
                <div id="recentTemplatesContainer" class="flex flex-col gap-2 pb-2 max-h-[200px] overflow-y-auto">
                    <!-- 最近使用的模板将通过JS动态生成 -->
                    <div class="text-neutral italic text-center py-2 w-full">暂无最近使用的收藏</div>
                </div>
            </div>
            
            <!-- 话术咒语区域 -->
            <div class="mb-4">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-lg font-semibold">话术咒语</h2>
                </div>
            </div>
            
            <!-- 话术咒语展示 -->
            <div class="mb-4">
                <div id="resultContainer" class="result-container-adaptive px-3 py-2 border border-gray-200 rounded-lg bg-gray-50 min-h-[45px] overflow-y-auto" style="max-height: none; height: auto; min-height: 45px;">
                    <p class="text-neutral italic">请在左侧选择内容，话术咒语将自动生成在这里...</p>
                </div>
            </div>
            
            <!-- 话术生成区域 -->
            <div class="mb-4">
                <div class="flex items-center justify-between mb-2">
                    <h3 class="text-lg font-semibold">话术生成</h3>
                    <div class="flex items-center gap-2">
                        <span id="charCount" class="text-sm text-gray-500">0 字</span>

                        <button id="saveTemplateBtn" class="bg-yellow-500 hover:bg-yellow-600 text-white px-3 py-1 rounded-lg shadow btn-hover flex items-center gap-1 btn-text-nowrap text-sm">
                            <i class="fa fa-star"></i> 收藏话术
                        </button>
                        <button id="copyBtn" class="bg-primary hover:bg-primary/90 text-white px-3 py-1 rounded-lg shadow btn-hover flex items-center gap-1 btn-text-nowrap text-sm">
                            <i class="fa fa-copy"></i> 复制话术
                        </button>
                    </div>
                </div>
                <div id="generatedContainer" class="result-container-adaptive px-3 py-2 border border-gray-200 rounded-lg bg-white min-h-[45px] overflow-y-auto" style="max-height: none; height: auto; min-height: 45px;">
                    <p class="text-neutral italic">点击"生成话术"按钮，AI将为您生成优化的话术内容...</p>
                </div>
            </div>
            
            <!-- 功能按钮 -->
            <div class="flex flex-row gap-3">
                <button id="resetBtnResult" class="flex-1 bg-gray-200 hover:bg-gray-300 text-dark px-4 py-2 rounded-lg shadow btn-hover flex items-center justify-center gap-1 btn-text-nowrap">
                    <i class="fa fa-refresh"></i> 重置选择
                </button>
                <button id="generateBtn" class="flex-1 bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg shadow btn-hover flex items-center justify-center gap-1 btn-text-nowrap">
                    <i class="fa fa-magic"></i> 生成话术
                </button>
            </div>
            
            <!-- 历史记录区域 -->
            <div class="mt-4">
                <h3 class="font-medium text-lg mb-3 flex items-center gap-2">
                    <i class="fa fa-history text-neutral"></i>历史记录
                </h3>
                <div id="historyContainer" class="history-grid">
                    <!-- 历史记录将通过JS动态生成 -->
                    <div class="text-neutral italic text-center col-span-full py-4">暂无历史记录</div>
                </div>
            </div>
        </div>
    </div>

    <!-- 自定义弹窗 -->
    <div id="customModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4">
            <div class="p-6">
                <h3 id="modalTitle" class="text-lg font-semibold mb-4"></h3>
                <div id="modalContent" class="mb-6"></div>
                <div id="modalButtons" class="flex justify-end gap-3"></div>
            </div>
        </div>
    </div>

    <script>
        // API配置变量 - 直接保存在文件中
        let API_CONFIG = {
            apiKey: 'pat_SnrkhHeuv5zIVqz7DLC2sGhfO0z5SxJdAmHuIPoGudo0FbEwwAI6lQnlr9M5bSFX', // 在这里填写您的扣子API密钥
            botId: '7548722284312772647'   // 在这里填写您的机器人ID
        };
        
        // 全局变量
        let configManager;
        let appData = {};
        let selection = {
                    greeting: [], // 格式: [{ id: itemId, subOptions: [subOptionIndex1, subOptionIndex2] }]
                    strength: [], // 格式: [{ id: itemId, subOptions: [subOptionIndex1, subOptionIndex2] }]
                    issue: [], // 格式: [{ id: itemId, subOptions: [subOptionIndex1, subOptionIndex2] }]
                    closing: [] // 格式: [{ id: itemId, subOptions: [subOptionIndex1, subOptionIndex2] }]
                };
        let contentIndex = {
                    greeting: {},
                    strength: {},
                    issue: {},
                    closing: {}
                };
        let configPanelOpen = false;
        let confirmCallback = null;
        let draggedItem = null; // 用于跟踪正在拖动的项目
        let historyRecords = []; // 历史记录数组
        // 收藏夹相关变量已移除
        
        let subOptionTags = {
            "i4": {
                "0": "🌿过草",
                "1": "🖼构图",
                "2": "🖌️刻画",
                "3": "🧶线条",
                "4": "☀️光影",
                "5": "❌完全不行"
            },
            "i1": {
                "0": "👋手",
                "1": "🤷头颈肩",
                "2": "🤾🏻整体"
            },
            "i2": {
                "0": "👀眼睛",
                "1": "👃五官",
                "2": "💀头骨",
                "3": "🪮发型"
            },
            "i3": {
                "0": "🖌笔触",
                "1": "⚫️色脏",
                "2": "🎨配色",
                "3": "🌈过饱和",
                "4": "🖼色调"
            },
            "i1757606284297": {
                "0": "🧩过程",
                "1": "📄材料",
                "2": "🤖AI"
            },
            "g1757749288217": {
                "0": "头像",
                "1": "插画",
                "2": "立绘",
                "3": "服设",
                "4": "场景",
                "5": "插画"
            },
            "g1": {
                "0": "国风",
                "1": "Q版",
                "2": "欧美卡通",
                "3": "写实"
            }
        }; // 二级选项标签存储 {itemId: {subOptionIndex: tagName}}
        let customCategoryNames = {}; // 自定义类别名称存储
        let categoryDescriptions = {}; // 类别描述存储

        // 自定义弹窗函数
        function showCustomAlert(message, title = '提示') {
            return new Promise((resolve) => {
                const modal = document.getElementById('customModal');
                const modalTitle = document.getElementById('modalTitle');
                const modalContent = document.getElementById('modalContent');
                const modalButtons = document.getElementById('modalButtons');
                
                modalTitle.textContent = title;
                modalContent.innerHTML = `<p class="text-gray-700">${message}</p>`;
                modalButtons.innerHTML = `
                    <button class="bg-primary hover:bg-primary/90 text-white px-4 py-2 rounded-lg" onclick="closeCustomModal(); customModalResolve();">确定</button>
                `;
                
                modal.classList.remove('hidden');
                window.customModalResolve = resolve;
            });
        }
        
        function showCustomConfirm(message, title = '确认') {
            return new Promise((resolve) => {
                const modal = document.getElementById('customModal');
                const modalTitle = document.getElementById('modalTitle');
                const modalContent = document.getElementById('modalContent');
                const modalButtons = document.getElementById('modalButtons');
                
                modalTitle.textContent = title;
                modalContent.innerHTML = `<p class="text-gray-700">${message}</p>`;
                modalButtons.innerHTML = `
                    <button class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-4 py-2 rounded-lg mr-2" onclick="closeCustomModal(); customModalResolve(false);">取消</button>
                    <button class="bg-primary hover:bg-primary/90 text-white px-4 py-2 rounded-lg" onclick="closeCustomModal(); customModalResolve(true);">确定</button>
                `;
                
                modal.classList.remove('hidden');
                window.customModalResolve = resolve;
            });
        }
        
        function showCustomPrompt(message, defaultValue = '', title = '输入') {
            return new Promise((resolve) => {
                const modal = document.getElementById('customModal');
                const modalTitle = document.getElementById('modalTitle');
                const modalContent = document.getElementById('modalContent');
                const modalButtons = document.getElementById('modalButtons');
                
                modalTitle.textContent = title;
                modalContent.innerHTML = `
                    <p class="text-gray-700 mb-3">${message}</p>
                    <input type="text" id="promptInput" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary" value="${defaultValue}" />
                `;
                modalButtons.innerHTML = `
                    <button class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-4 py-2 rounded-lg mr-2" onclick="closeCustomModal(); customModalResolve(null);">取消</button>
                    <button class="bg-primary hover:bg-primary/90 text-white px-4 py-2 rounded-lg" onclick="closeCustomModal(); customModalResolve(document.getElementById('promptInput').value);">确定</button>
                `;
                
                modal.classList.remove('hidden');
                setTimeout(() => {
                    const input = document.getElementById('promptInput');
                    input.focus();
                    input.select();
                }, 100);
                window.customModalResolve = resolve;
            });
        }
        
        function closeCustomModal() {
            const modal = document.getElementById('customModal');
            modal.classList.add('hidden');
        }
        
        // 点击背景关闭弹窗
        document.getElementById('customModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeCustomModal();
                if (window.customModalResolve) {
                    window.customModalResolve(null);
                }
            }
        });

        // 二级选项标签管理函数
        function loadSubOptionTags() {
            try {
                const saved = localStorage.getItem('subOptionTags');
                if (saved) {
                    subOptionTags = JSON.parse(saved);
                } else {
                    subOptionTags = {};
                }
            } catch (e) {
                console.error('加载二级选项标签失败:', e);
                subOptionTags = {};
            }
        }
        
        function saveSubOptionTags() {
            try {
                localStorage.setItem('subOptionTags', JSON.stringify(subOptionTags));
            } catch (e) {
                console.error('保存二级选项标签失败:', e);
            }
        }
        
        // 获取二级选项的标签
        function getSubOptionTag(itemId, subOptionIndex) {
            return subOptionTags[itemId] && subOptionTags[itemId][subOptionIndex] || null;
        }
        
        // 设置二级选项的标签
        function setSubOptionTag(itemId, subOptionIndex, tagName) {
            // 获取旧标签名称用于同步
            const oldTagName = getSubOptionTag(itemId, subOptionIndex);
            
            if (!subOptionTags[itemId]) {
                subOptionTags[itemId] = {};
            }
            if (tagName && tagName.trim()) {
                subOptionTags[itemId][subOptionIndex] = tagName.trim();
            } else {
                delete subOptionTags[itemId][subOptionIndex];
                // 如果该项目没有任何标签，删除整个项目
                if (Object.keys(subOptionTags[itemId]).length === 0) {
                    delete subOptionTags[itemId];
                }
            }
            saveSubOptionTags();
            
            // 同步更新收藏话术显示
            renderFavoriteScripts();
            
            // 同步更新收藏话术中的标签
            syncFavoriteScriptTags(itemId, subOptionIndex, oldTagName, tagName ? tagName.trim() : null);
        }
        
        // 获取二级选项的显示文本（优先显示标签）
        function getSubOptionDisplayText(itemId, subOptionIndex, originalText) {
            const tag = getSubOptionTag(itemId, subOptionIndex);
            return tag || originalText;
        }
        
        // 一级选项标签管理函数
        let primaryOptionTags = {};
        
        function loadPrimaryOptionTags() {
            try {
                const saved = localStorage.getItem('primaryOptionTags');
                if (saved) {
                    primaryOptionTags = JSON.parse(saved);
                } else {
                    primaryOptionTags = {};
                }
            } catch (e) {
                console.error('加载一级选项标签失败:', e);
                primaryOptionTags = {};
            }
        }
        
        function savePrimaryOptionTags() {
            try {
                localStorage.setItem('primaryOptionTags', JSON.stringify(primaryOptionTags));
            } catch (e) {
                console.error('保存一级选项标签失败:', e);
            }
        }
        
        // 获取一级选项的标签
        function getPrimaryOptionTag(itemId) {
            return primaryOptionTags[itemId] || null;
        }
        
        // 设置一级选项的标签
        function setPrimaryOptionTag(itemId, tagName) {
            // 获取旧标签名称用于同步
            const oldTagName = getPrimaryOptionTag(itemId);
            
            if (tagName && tagName.trim()) {
                primaryOptionTags[itemId] = tagName.trim();
            } else {
                delete primaryOptionTags[itemId];
            }
            savePrimaryOptionTags();
            
            // 同步更新收藏话术显示
            renderFavoriteScripts();
            
            // 同步更新收藏话术中的标签
            syncFavoriteScriptPrimaryTags(itemId, oldTagName, tagName ? tagName.trim() : null);
        }
        
        // 一级选项标签颜色存储
        let primaryOptionTagColors = {};
        
        function loadPrimaryOptionTagColors() {
            try {
                const saved = localStorage.getItem('primaryOptionTagColors');
                primaryOptionTagColors = saved ? JSON.parse(saved) : {};
            } catch (e) {
                console.error('加载一级选项标签颜色失败:', e);
                primaryOptionTagColors = {};
            }
        }
        
        function savePrimaryOptionTagColors() {
            try {
                localStorage.setItem('primaryOptionTagColors', JSON.stringify(primaryOptionTagColors));
            } catch (e) {
                console.error('保存一级选项标签颜色失败:', e);
            }
        }
        
        // 获取一级选项的标签颜色
        function getPrimaryOptionTagColor(itemId) {
            return primaryOptionTagColors[itemId] || defaultTagColors[0]; // 默认使用第一个颜色
        }
        
        // 设置一级选项的标签颜色
        function setPrimaryOptionTagColor(itemId, color) {
            primaryOptionTagColors[itemId] = color;
            savePrimaryOptionTagColors();
            
            // 同步更新收藏话术显示
            renderFavoriteScripts();
            
            // 同步更新收藏话术中的标签颜色
            syncFavoriteScriptPrimaryTagColors(itemId, color);
        }
        
        // 标签颜色存储
        let subOptionTagColors = {
            "i4": {
                "0": "#FCA5A5",
                "1": "#FCA5A5",
                "2": "#FCA5A5",
                "4": "#FCA5A5",
                "5": "#FCA5A5"
            },
            "i1": {
                "0": "#FCA5A5",
                "1": "#FCA5A5",
                "2": "#FCA5A5"
            },
            "i2": {
                "0": "#FCA5A5",
                "1": "#FCA5A5",
                "2": "#FCA5A5"
            },
            "i3": {
                "0": "#FCA5A5",
                "1": "#FCA5A5",
                "2": "#FCA5A5",
                "4": "#FCA5A5"
            },
            "i1757606284297": {
                "0": "#FCA5A5",
                "1": "#FCA5A5",
                "2": "#FCA5A5"
            },
            "g1757749288217": {
                "0": "#C4B5FD",
                "1": "#C4B5FD",
                "2": "#C4B5FD",
                "3": "#C4B5FD",
                "5": "#C4B5FD"
            },
            "g1": {
                "0": "#C4B5FD",
                "1": "#C4B5FD",
                "2": "#C4B5FD",
                "3": "#C4B5FD"
            }
        };
        
        // 默认标签颜色（淡雅配色，柔和明度）
        const defaultTagColors = [
            '#6EE7B7', // 淡绿色
            '#93C5FD', // 淡蓝色
            '#FCD34D', // 淡黄色
            '#FCA5A5', // 淡红色
            '#C4B5FD', // 淡紫色
            '#67E8F9', // 淡青色
            '#FDBA74', // 淡橙色
            '#BEF264'  // 淡青绿色
        ];
        
        // RGB颜色值转换为十六进制
        function rgbToHex(rgb) {
            const result = rgb.match(/\d+/g);
            if (result && result.length >= 3) {
                return '#' + ((1 << 24) + (parseInt(result[0]) << 16) + (parseInt(result[1]) << 8) + parseInt(result[2])).toString(16).slice(1).toUpperCase();
            }
            return rgb;
        }
        
        // 获取二级选项的标签颜色
        function getSubOptionTagColor(itemId, subOptionIndex) {
            if (subOptionTagColors[itemId] && subOptionTagColors[itemId][subOptionIndex]) {
                return subOptionTagColors[itemId][subOptionIndex];
            }
            // 使用默认颜色（基于索引循环）
            return defaultTagColors[subOptionIndex % defaultTagColors.length];
        }
        
        // 设置二级选项的标签颜色
        function setSubOptionTagColor(itemId, subOptionIndex, color) {
            if (!subOptionTagColors[itemId]) {
                subOptionTagColors[itemId] = {};
            }
            subOptionTagColors[itemId][subOptionIndex] = color;
            saveSubOptionTagColors();
            
            // 同步更新收藏话术显示
            renderFavoriteScripts();
            
            // 同步更新收藏话术中的标签颜色
            syncFavoriteScriptTagColors(itemId, subOptionIndex, color);
        }
        
        // 加载标签颜色
        function loadSubOptionTagColors() {
            try {
                const saved = localStorage.getItem('subOptionTagColors');
                subOptionTagColors = saved ? JSON.parse(saved) : {};
            } catch (e) {
                console.error('加载二级选项标签颜色失败:', e);
                subOptionTagColors = {};
            }
        }
        
        // 保存标签颜色
        function saveSubOptionTagColors() {
            try {
                localStorage.setItem('subOptionTagColors', JSON.stringify(subOptionTagColors));
            } catch (e) {
                console.error('保存二级选项标签颜色失败:', e);
            }
        }
        
        // 切换标签表单的显示/隐藏
        function toggleTagForm(button) {
            const tagForm = button.parentElement.querySelector('.tag-form');
            const toggleText = button.querySelector('.toggle-text');
            const colorPicker = button.parentElement.querySelector('.flex.gap-1');
            const existingColorPicker = button.parentElement.querySelector('.tag-color-picker');
            
            // 标签唯一性约束：如果已存在标签，只允许修改，不允许创建新标签
            if (existingColorPicker) {
                // 已存在标签时，只能修改现有标签
                // 只有在表单隐藏时才展开，避免重复操作
                if (tagForm.style.display === 'none' || tagForm.style.display === '') {
                    tagForm.style.display = 'block';
                    
                    // 修改现有标签时，设置确认按钮的颜色属性和输入框的值
                    const confirmButton = tagForm.querySelector('.confirm-tag');
                    const tagInput = tagForm.querySelector('.sub-option-tag');
                    const existingSpan = existingColorPicker.querySelector('span');
                    
                    // 填充现有标签名称
                    if (confirmButton && tagInput) {
                        const existingTagName = confirmButton.getAttribute('data-tag-name');
                        if (existingTagName) {
                            tagInput.value = existingTagName;
                        }
                    }
                    
                    // 设置现有颜色，确保修改时保持原有配色
                    if (confirmButton && existingSpan && existingSpan.style.backgroundColor) {
                        const currentColor = existingSpan.style.backgroundColor.startsWith('rgb') ? 
                            rgbToHex(existingSpan.style.backgroundColor) : existingSpan.style.backgroundColor;
                        confirmButton.setAttribute('data-tag-color', currentColor);
                    }
                    
                    // 修改标签时不显示配色选择器
                    const existingColorSelector = existingColorPicker.querySelector('.flex.gap-1');
                    if (existingColorSelector) {
                        existingColorSelector.style.display = 'none';
                    }
                    
                    // 隐藏tagForm内部的配色选择框（如果存在）
                    if (colorPicker) {
                        colorPicker.style.display = 'none';
                    }
                }
            } else {
                // 没有现有标签时，允许添加新标签
                // 只有在表单隐藏时才展开，避免重复操作
                if (tagForm.style.display === 'none' || tagForm.style.display === '') {
                    tagForm.style.display = 'block';
                    
                    // 隐藏配色选择框
                    if (colorPicker) {
                        colorPicker.style.display = 'none';
                    }
                }
            }
        }
        
        // 初始化标签按钮状态
        function initializeTagButtonStates() {
            // 查找所有的标签容器
            document.querySelectorAll('.tag-form').forEach(tagForm => {
                const tagContainer = tagForm.parentElement;
                const existingColorPicker = tagContainer.querySelector('.tag-color-picker');
                const toggleButton = tagContainer.querySelector('.toggle-tag-form');
                const toggleText = toggleButton ? toggleButton.querySelector('.toggle-text') : null;
                
                if (existingColorPicker && toggleText) {
                    // 如果存在标签，设置按钮文本为"修改标签"
                    toggleText.textContent = '修改标签';
                    console.log('初始化标签按钮状态: 设置为修改模式');
                } else if (toggleText) {
                    // 如果不存在标签，设置按钮文本为"+ 添加标签"
                    toggleText.textContent = '+ 添加标签';
                    console.log('初始化标签按钮状态: 设置为添加模式');
                }
            });
        }
        
        // 确认标签创建
        function confirmTag(button) {
            const tagInput = button.parentElement.querySelector('.sub-option-tag');
            const tagForm = button.closest('.tag-form');
            const toggleButton = tagForm.parentElement.querySelector('.toggle-tag-form');
            const toggleText = toggleButton.querySelector('.toggle-text');
            const tagContainer = tagForm.parentElement;
            
            if (tagInput.value.trim()) {
                const tagName = tagInput.value.trim();
                
                // 根据是否存在标签来区分创建和修改操作
                const existingColorPicker = tagContainer.querySelector('.tag-color-picker');
                const isModifying = existingColorPicker !== null;
                
                let selectedColor;
                if (isModifying) {
                    // 修改现有标签时，严格保持原有背景颜色配置不变
                    const currentColor = existingColorPicker ? 
                        existingColorPicker.querySelector('span').style.backgroundColor || 
                        button.getAttribute('data-tag-color') || 
                        defaultTagColors[0] : 
                        button.getAttribute('data-tag-color') || defaultTagColors[0];
                    selectedColor = currentColor.startsWith('rgb') ? 
                        rgbToHex(currentColor) : currentColor;
                    
                    // 确保修改时颜色完全不变
                    console.log('修改标签时保持原有颜色:', selectedColor);
                } else {
                    // 创建新标签时，使用默认配色
                    selectedColor = defaultTagColors[0];
                }
                
                // 预览功能已删除
                
                // 收起表单
                tagForm.style.display = 'none';
                // 确认标签后，按钮文本应该是修改标签（因为现在有标签了）
                toggleText.textContent = '修改标签';
                toggleButton.classList.remove('text-green-600', 'hover:text-green-800');
                toggleButton.classList.add('text-blue-600', 'hover:text-blue-800');
                
                // 保存标签颜色信息到按钮的数据属性中
                button.setAttribute('data-tag-name', tagName);
                button.setAttribute('data-tag-color', selectedColor);
                
                // 获取项目ID和二级选项索引，保存标签数据
                const itemContainer = tagContainer.closest('[data-id]');
                if (itemContainer) {
                    const itemId = itemContainer.getAttribute('data-id');
                    const subOptionIndex = Array.from(itemContainer.querySelectorAll('.tag-form')).indexOf(tagForm);
                    
                    // 保存标签名称和颜色到数据存储
                    setSubOptionTag(itemId, subOptionIndex, tagName);
                    setSubOptionTagColor(itemId, subOptionIndex, selectedColor);
                    
                    // 刷新收藏话术显示以反映标签变化
                    renderFavoriteScripts();
                }
                
                // 立即在界面上显示标签和配色框
                let colorPickerDiv = tagContainer.querySelector('.tag-color-picker');
                if (!colorPickerDiv) {
                    // 创建新标签时，创建完整的配色选择器
                    colorPickerDiv = document.createElement('div');
                    colorPickerDiv.className = 'tag-color-picker flex gap-1 mt-2';
                    tagContainer.insertBefore(colorPickerDiv, tagForm);
                    
                    // 创建标签显示和配色选择器
                    colorPickerDiv.innerHTML = `
                        <span class="inline-block px-2 py-1 text-sm rounded text-white mr-2" style="background-color: ${selectedColor}">${tagName}</span>
                        <div class="flex gap-1">
                            ${defaultTagColors.map(color => `
                                <div class="w-6 h-6 rounded border-2 cursor-pointer hover:scale-110 transition-transform ${selectedColor === color ? 'border-gray-800' : 'border-gray-300'}" 
                                     style="background-color: ${color}" 
                                     onclick="updateTagColorInEdit(this, '${color}', '${tagName}')"
                                     title="点击切换颜色">
                                </div>
                            `).join('')}
                        </div>
                    `;
                } else {
                    // 修改现有标签时，只更新标签名称，保持原有配色不变
                    const existingSpan = colorPickerDiv.querySelector('span');
                    if (existingSpan) {
                        existingSpan.textContent = tagName;
                        // 保持原有背景颜色不变
                        console.log('修改标签名称，保持原有配色:', existingSpan.style.backgroundColor);
                    }
                    
                    // 更新配色选择器中的onclick事件，使用新的标签名称
                    const colorDivs = colorPickerDiv.querySelectorAll('.w-6.h-6.rounded');
                    colorDivs.forEach((colorDiv, index) => {
                        const color = defaultTagColors[index];
                        colorDiv.setAttribute('onclick', `updateTagColorInEdit(this, '${color}', '${tagName}')`);
                    });
                }
                
                // 确认后显示配色选择器，让用户可以继续修改颜色
                const existingColorSelector = colorPickerDiv.querySelector('.flex.gap-1');
                if (existingColorSelector) {
                    existingColorSelector.style.display = 'flex';
                }
            } else {
                alert('请输入标签名称');
            }
        }
        
        // 在编辑模式下更新标签颜色
        function updateTagColorInEdit(element, newColor, tagName) {
            const colorContainer = element.parentElement;
            const tagSpan = colorContainer.parentElement.querySelector('span');
            const confirmButton = colorContainer.parentElement.parentElement.querySelector('.confirm-tag');
            
            // 更新标签显示颜色
            if (tagSpan) {
                tagSpan.style.backgroundColor = newColor;
            }
            
            // 更新配色选择框的选中状态
            colorContainer.querySelectorAll('.w-6.h-6.rounded').forEach(colorDiv => {
                colorDiv.className = colorDiv.className.replace('border-gray-800', 'border-gray-300');
            });
            element.className = element.className.replace('border-gray-300', 'border-gray-800');
            
            // 更新确认按钮的数据属性
            if (confirmButton) {
                confirmButton.setAttribute('data-tag-color', newColor);
            }
            
            // 保存颜色到数据存储
            const itemContainer = element.closest('[data-id]');
            if (itemContainer) {
                const itemId = itemContainer.getAttribute('data-id');
                const tagForm = element.closest('.tag-color-picker').nextElementSibling;
                const subOptionIndex = Array.from(itemContainer.querySelectorAll('.tag-form')).indexOf(tagForm);
                
                // 保存标签颜色到数据存储
                setSubOptionTagColor(itemId, subOptionIndex, newColor);
                
                // 刷新收藏话术显示以反映标签颜色变化
                renderFavoriteScripts();
            }
            
            // 显示成功提示
            showNotification('标签颜色已更新', 'success');
        }
        
        // 直接切换标签颜色
        function changeTagColor(itemId, subIndex, newColor, element) {
            // 更新颜色存储
            setSubOptionTagColor(itemId, subIndex, newColor);
            
            // 更新当前页面显示的标签颜色
            const container = element.closest('.border.rounded.p-3');
            const tagElement = container.querySelector('.flex.items-center.px-2.py-1.rounded.text-white.text-sm');
            if (tagElement) {
                tagElement.style.backgroundColor = newColor;
            }
            
            // 更新配色选择框的选中状态
            const colorContainer = element.parentElement;
            colorContainer.querySelectorAll('.w-6.h-6.rounded').forEach(colorDiv => {
                colorDiv.className = colorDiv.className.replace('border-gray-800', 'border-gray-300');
            });
            element.className = element.className.replace('border-gray-300', 'border-gray-800');
            
            // 更新确认按钮的数据属性（如果存在）
            const confirmButton = container.querySelector('.confirm-tag');
            if (confirmButton) {
                confirmButton.setAttribute('data-tag-color', newColor);
            }
            
            // 保存颜色到数据存储（这个函数已经调用了setSubOptionTagColor）
            // setSubOptionTagColor(itemId, subIndex, newColor); 已在函数开头调用
            
            // 刷新收藏话术显示以反映标签颜色变化
            renderFavoriteScripts();
            
            // 显示成功提示
            showNotification('标签颜色已更新', 'success');
        }
        
        // 更新标签实时预览
        function updateTagPreview(input) {
            const tagName = input.value.trim();
            const tagContainer = input.closest('.tag-form').parentElement;
            const confirmButton = input.parentElement.querySelector('.confirm-tag');
            const toggleButton = tagContainer.querySelector('.toggle-tag-form');
            const toggleText = toggleButton ? toggleButton.querySelector('.toggle-text') : null;
            
            // 根据是否存在标签来区分创建和修改操作
            const existingColorPicker = tagContainer.querySelector('.tag-color-picker');
            const isModifying = existingColorPicker !== null;
            
            let currentColor;
            if (isModifying) {
                // 修改现有标签时，保留现有配色
                // 优先从确认按钮的数据属性获取颜色
                if (confirmButton && confirmButton.getAttribute('data-tag-color')) {
                    currentColor = confirmButton.getAttribute('data-tag-color');
                } else if (existingColorPicker) {
                    // 从现有配色选择器获取
                    const existingSpan = existingColorPicker.querySelector('span');
                    if (existingSpan && existingSpan.style.backgroundColor) {
                        currentColor = existingSpan.style.backgroundColor.startsWith('rgb') ? 
                            rgbToHex(existingSpan.style.backgroundColor) : existingSpan.style.backgroundColor;
                    } else {
                        currentColor = defaultTagColors[0];
                    }
                } else {
                    currentColor = defaultTagColors[0];
                }
            } else {
                // 创建新标签时，使用默认配色
                currentColor = defaultTagColors[0];
            }
            
            // 预览功能已删除
        }
        
        // 显示标签颜色选择器
        function showTagColorPicker(tagName, callback) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-lg p-6 max-w-sm w-full mx-4">
                    <h3 class="text-lg font-medium mb-4">选择标签颜色</h3>
                    <p class="text-sm text-gray-600 mb-4">为标签 "${tagName}" 选择颜色：</p>
                    <div class="grid grid-cols-4 gap-3 mb-6">
                        ${defaultTagColors.map(color => `
                            <button type="button" class="color-option w-12 h-12 rounded border-2 border-gray-300 hover:border-gray-500 transition-colors" 
                                    style="background-color: ${color}" data-color="${color}">
                            </button>
                        `).join('')}
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium mb-2">自定义颜色：</label>
                        <input type="color" id="customColor" class="w-full h-10 border rounded" value="#3B82F6">
                    </div>
                    <div class="flex gap-2 justify-end">
                        <button type="button" id="cancelColor" class="px-4 py-2 text-gray-600 hover:text-gray-800">取消</button>
                        <button type="button" id="confirmColor" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">确认</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            let selectedColor = defaultTagColors[0];
            
            // 预设颜色选择
            modal.querySelectorAll('.color-option').forEach(btn => {
                btn.addEventListener('click', function() {
                    modal.querySelectorAll('.color-option').forEach(b => b.classList.remove('ring-4', 'ring-blue-500'));
                    this.classList.add('ring-4', 'ring-blue-500');
                    selectedColor = this.getAttribute('data-color');
                });
            });
            
            // 自定义颜色选择
            const customColorInput = modal.querySelector('#customColor');
            customColorInput.addEventListener('change', function() {
                modal.querySelectorAll('.color-option').forEach(b => b.classList.remove('ring-4', 'ring-blue-500'));
                selectedColor = this.value;
            });
            
            // 确认按钮
            modal.querySelector('#confirmColor').addEventListener('click', function() {
                document.body.removeChild(modal);
                callback(selectedColor);
            });
            
            // 取消按钮
            modal.querySelector('#cancelColor').addEventListener('click', function() {
                document.body.removeChild(modal);
            });
            
            // 点击背景关闭
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    document.body.removeChild(modal);
                }
            });
            
            // 默认选中第一个颜色
            modal.querySelector('.color-option').classList.add('ring-4', 'ring-blue-500');
        }

        // 页面加载完成后初始化
        window.onload = function() {
            // 初始化配置管理功能
            loadConfigurations();
            
            // 初始化当前选中的分类
            currentActiveCategory = 'all';
            
            // 从本地存储加载历史记录
            loadHistoryRecords();
            
            // 收藏夹相关初始化代码已移除
            
            // 从本地存储加载收藏话术
            loadFavoriteScripts();
            
            // 二级选项标签数据已内置，无需从localStorage加载
            
            // 初始化应用数据
            initializeAppData();
            
            // 绑定事件监听器
            bindEventListeners();
            
            // 初始化拖拽功能
            initializeDragAndDrop();
            
            // 渲染初始内容
            renderAllContent();
            
            // 更新结果显示（确保提示内容也应用最小高度）
            updateResult();
            
            // 初始化生成文本框高度
            adjustGeneratedContainerHeight();
            
            // 收藏夹相关渲染代码已移除
            
            // 渲染收藏话术
            renderFavoriteScripts();
            
            // 渲染历史记录
            renderHistoryRecords();
            
            // 更新类别标题显示
            updateCategoryTitles();
        };

        // 初始化应用数据
        function initializeAppData() {
            // 默认数据
            const defaultData = {
                greeting: [
                    { id: 'g1', text: '您好，感谢您的作品投稿！', category: '礼貌用语' },
                    { id: 'g2', text: '很高兴看到您的创作！', category: '鼓励用语' },
                    { id: 'g3', text: '经过仔细评审，现给出以下反馈：', category: '正式用语' }
                ],
                strength: [
                    { id: 's1', text: '画面构图合理，层次分明', category: '构图' },
                    { id: 's2', text: '色彩搭配和谐，视觉效果佳', category: '色彩' },
                    { id: 's3', text: '线条流畅，技法娴熟', category: '技法' },
                    { id: 's4', text: '创意独特，富有想象力', category: '创意' },
                    { id: 's5', text: '细节处理精致，完成度高', category: '细节' }
                ],
                issue: [
                    { id: 'i1', text: '部分区域明暗对比可以更强烈', category: '明暗' },
                    { id: 'i2', text: '人物比例需要进一步调整', category: '比例' },
                    { id: 'i3', text: '背景与主体的融合度有待提升', category: '整体性' },
                    { id: 'i4', text: '某些细节还可以更加精细', category: '细节' }
                ],
                closing: [
                    { id: 'c1', text: '期待您的下一次投稿！', category: '期待用语' },
                    { id: 'c2', text: '继续加油，您的进步很明显！', category: '鼓励用语' },
                    { id: 'c3', text: '感谢您的参与，祝创作愉快！', category: '感谢用语' }
                ]
            };

            // 从本地存储加载数据，如果没有则使用默认数据
            const savedData = localStorage.getItem('appData');
            if (savedData) {
                try {
                    appData = JSON.parse(savedData);
                    // 确保所有必要的属性都存在
                    Object.keys(defaultData).forEach(key => {
                        if (!appData[key]) {
                            appData[key] = defaultData[key];
                        }
                    });
                } catch (e) {
                    console.error('解析本地数据失败，使用默认数据:', e);
                    appData = defaultData;
                }
            } else {
                appData = defaultData;
            }

            // 构建内容索引
            buildContentIndex();
        }

        // 构建内容索引
        function buildContentIndex() {
            Object.keys(appData).forEach(type => {
                contentIndex[type] = {};
                appData[type].forEach(item => {
                    contentIndex[type][item.id] = item;
                });
            });
        }

        // 保存应用数据到本地存储
        function saveAppData() {
            try {
                localStorage.setItem('appData', JSON.stringify(appData));
                buildContentIndex();
                saveSubOptionTags();
            } catch (e) {
                console.error('保存数据失败:', e);
            }
        }

        // 绑定事件监听器
        function bindEventListeners() {
            // 复制按钮
            document.getElementById('copyBtn').addEventListener('click', copyGeneratedResult);
            
            // 生成话术按钮
            document.getElementById('generateBtn').addEventListener('click', generateScript);
            
            // 重置按钮
            document.getElementById('resetBtnResult').addEventListener('click', resetSelection);
            document.getElementById('resetBtnPanel').addEventListener('click', resetSelection);
            
            // 新设置按钮
            document.getElementById('newSettingsBtn').addEventListener('click', openWebSettings);
            
            // 收藏话术按钮
            document.getElementById('saveTemplateBtn').addEventListener('click', saveCurrentFavorite);
            
            // 收藏夹搜索功能
            const favoriteSearch = document.getElementById('favoriteSearch');
            if (favoriteSearch) {
                favoriteSearch.addEventListener('input', renderFavoriteScripts);
            }
            
            // 智能筛选按钮
            const smartFilterBtn = document.getElementById('smartFilterBtn');
            if (smartFilterBtn) {
                smartFilterBtn.addEventListener('click', function() {
                    // 切换到智能筛选模式
                    toggleSmartFilterMode();
                });
            }
            
            // 最近使用按钮
            const recentUsedBtn = document.getElementById('recentUsedBtn');
            if (recentUsedBtn) {
                recentUsedBtn.addEventListener('click', function() {
                    // 切换到最近使用模式
                    toggleRecentUsedMode();
                });
            }
            
            // 所有标签快速访问按钮
            const allTagsQuickBtn = document.getElementById('allTagsQuickBtn');
            if (allTagsQuickBtn) {
                allTagsQuickBtn.addEventListener('click', function() {
                    // 重置标签筛选为所有标签
                    const tagFilter = document.getElementById('tagFilter');
                    if (tagFilter) {
                        tagFilter.value = '';
                    }
                    // 关闭所有筛选模式
                    isSmartFilterMode = false;
                    isRecentUsedMode = false;
                    // 重新渲染收藏话术
                    renderFavoriteScripts();
                    // 更新按钮状态
                    updateQuickButtonState();
                });
            }
            
            // 收藏夹标签筛选
            const tagFilter = document.getElementById('tagFilter');
            if (tagFilter) {
                tagFilter.addEventListener('change', function() {
                    renderFavoriteScripts();
                    updateQuickButtonState();
                });
            }
            
            // 收藏夹相关事件监听器已移除
            
            // 添加项目按钮
            document.querySelectorAll('.add-item-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const type = this.getAttribute('data-type');
                    addNewItem(type);
                });
            });
        }

        // 渲染所有内容
        function renderAllContent() {
            Object.keys(appData).forEach(type => {
                renderContent(type);
            });
        }

        // 渲染指定类型的内容
        function renderContent(type) {
            const container = document.getElementById(type + 'Container');
            if (!container) return;

            container.innerHTML = '';
            
            if (!appData[type] || appData[type].length === 0) {
                container.innerHTML = '<div class="text-neutral italic text-center col-span-full py-4">暂无内容，点击加号添加</div>';
                return;
            }

            appData[type].forEach(item => {
                const itemElement = createItemElement(item, type);
                container.appendChild(itemElement);
            });
            
            // 初始化标签按钮状态
            initializeTagButtonStates();
        }

        // 创建项目元素
        function createItemElement(item, type) {
            const div = document.createElement('div');
            div.className = 'group relative p-3 border border-gray-200 rounded-lg cursor-pointer transition-all hover:border-primary hover:shadow-md';
            div.setAttribute('data-id', item.id);
            div.setAttribute('data-type', type);
            div.draggable = true;

            // 检查是否被选中
            const isSelected = isItemSelected(item.id, type);
            const selectedSubOptions = getSelectedSubOptions(item.id, type);
            
            // 如果被选中，添加选中样式（无论是否有二级选项）
            if (isSelected) {
                div.classList.add('border-primary', 'bg-blue-50');
            }

            // 构建已选中的二级选项显示文本
            let selectedSubOptionsText = '';
            if (item.subOptions && item.subOptions.length > 0 && selectedSubOptions.length > 0) {
                const selectedItems = selectedSubOptions.map(index => {
                    const originalText = item.subOptions[index];
                    const tag = getSubOptionTag(item.id, index);
                    const tagColor = getSubOptionTagColor(item.id, index);
                    
                    if (tag) {
                        return `<span class="inline-block px-2 py-1 text-sm rounded" style="background-color: ${tagColor}; color: white; margin-right: 4px; border-radius: 4px;">${tag}</span>`;
                    } else {
                        return `<span class="text-primary">${originalText}</span>`;
                    }
                }).filter(Boolean);
                
                if (selectedItems.length > 0) {
                    selectedSubOptionsText = `
                        <div class="mt-2 text-xs font-medium flex flex-wrap gap-1">
                            ${selectedItems.join('')}
                        </div>
                    `;
                }
            }
            
            div.innerHTML = `
                <div class="text-base font-medium mb-1">${item.text}</div>
                ${selectedSubOptionsText}
                <div class="absolute top-1/2 right-1 -translate-y-1/2 opacity-0 group-hover:opacity-100 transition-opacity">
                    <button class="edit-btn text-xs text-neutral hover:text-primary p-1" data-id="${item.id}" data-type="${type}">
                        <i class="fa fa-edit"></i>
                    </button>
                </div>
            `;

            // 点击选择（仅针对没有二级选项的项目）
            div.addEventListener('click', function(e) {
                if (e.target.closest('.edit-btn')) return;
                
                // 如果没有二级选项，直接切换选择状态
                if (!item.subOptions || item.subOptions.length === 0) {
                    toggleSelection(item.id, type);
                }
            });
            
            // 鼠标悬停显示二级选项气泡
            if (item.subOptions && item.subOptions.length > 0) {
                let hoverTimer;
                
                div.addEventListener('mouseenter', function(e) {
                    if (e.target.closest('.edit-btn')) return;
                    
                    // 立即显示气泡
                    // 关闭其他项目的气泡框，保持当前项目的独立性
                    const allBubbles = document.querySelectorAll('.sub-options-bubble');
                    allBubbles.forEach(bubble => {
                        const bubbleItemId = bubble.getAttribute('data-item-id');
                        const bubbleType = bubble.getAttribute('data-type');
                        if (bubbleItemId !== item.id.toString() || bubbleType !== type) {
                            bubble.remove();
                        }
                    });
                    
                    showSubOptionsBubble(item, type, div);
                });
                
                div.addEventListener('mouseleave', function(e) {
                    if (hoverTimer) {
                        clearTimeout(hoverTimer);
                        hoverTimer = null;
                    }
                });
            }

            // 编辑按钮事件
            const editBtn = div.querySelector('.edit-btn');
            editBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                editItem(item.id, type);
            });

            // 右键菜单事件 - 清除选中状态
            div.addEventListener('contextmenu', function(e) {
                e.preventDefault();
                clearItemSelection(item.id, type);
            });

            // 拖拽事件
            div.addEventListener('dragstart', function(e) {
                draggedItem = { id: item.id, type: type };
                e.dataTransfer.effectAllowed = 'move';
            });

            div.addEventListener('dragover', function(e) {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
            });

            div.addEventListener('drop', function(e) {
                e.preventDefault();
                if (draggedItem && draggedItem.type === type && draggedItem.id !== item.id) {
                    reorderItems(draggedItem.id, item.id, type);
                }
                draggedItem = null;
            });

            return div;
        }

        // 显示二级选项气泡选择框
        function showSubOptionsBubble(item, type, targetElement) {
            // 为每个气泡框创建唯一标识
            const bubbleId = `bubble-${type}-${item.id}`;
            
            // 移除该项目已存在的气泡框
            const existingBubble = document.querySelector(`[data-bubble-id="${bubbleId}"]`);
            if (existingBubble) {
                existingBubble.remove();
            }

            // 创建气泡框
            const bubble = document.createElement('div');
            bubble.className = 'sub-options-bubble fixed bg-white border border-gray-300 rounded-lg shadow-lg p-2 z-50 max-w-sm';
            bubble.setAttribute('data-bubble-id', bubbleId);
            bubble.setAttribute('data-item-id', item.id);
            bubble.setAttribute('data-type', type);
            
            const selectedSubOptions = getSelectedSubOptions(item.id, type);
            
            bubble.innerHTML = `
                <div class="space-y-1 max-h-80 overflow-y-auto">
                    ${item.subOptions.map((subOption, index) => {
                        const isSelected = selectedSubOptions.includes(index);
                        const displayText = getSubOptionDisplayText(item.id, index, subOption);
                        const tag = getSubOptionTag(item.id, index);
                        const tagColor = getSubOptionTagColor(item.id, index);
                        
                        let tagHtml = '';
                        if (tag) {
                            tagHtml = `<span class="inline-block px-2 py-1 text-sm rounded" style="background-color: ${tagColor}; color: white; margin-right: 6px; border-radius: 4px;">${tag}</span>`;
                        }
                        
                        return `
                            <div class="sub-option-item px-2 py-1 rounded cursor-pointer transition-colors ${
                                isSelected ? 'bg-blue-100 text-blue-700 border border-blue-300' : 'hover:bg-gray-100'
                            }" data-index="${index}">
                                ${tagHtml}${subOption}
                            </div>
                        `;
                    }).join('')}
                </div>
            `;

            document.body.appendChild(bubble);

            // 定位气泡框
            const rect = targetElement.getBoundingClientRect();
            const bubbleRect = bubble.getBoundingClientRect();
            
            let left = rect.left + rect.width / 2 - bubbleRect.width / 2;
            let top = rect.bottom + 0;
            
            // 确保气泡框不超出视窗
            if (left < 8) left = 8;
            if (left + bubbleRect.width > window.innerWidth - 8) {
                left = window.innerWidth - bubbleRect.width - 8;
            }
            if (top + bubbleRect.height > window.innerHeight - 8) {
                top = rect.top - bubbleRect.height - 8;
            }
            
            bubble.style.left = left + 'px';
            bubble.style.top = top + 'px';

            // 当前选择状态
            let currentSelectedOptions = [...selectedSubOptions];

            // 二级选项点击事件 - 直接应用选择
            bubble.addEventListener('click', function(e) {
                const subOptionItem = e.target.closest('.sub-option-item');
                if (subOptionItem) {
                    const index = parseInt(subOptionItem.dataset.index);
                    const isCurrentlySelected = currentSelectedOptions.includes(index);
                    
                    if (isCurrentlySelected) {
                        // 取消选择
                        currentSelectedOptions = currentSelectedOptions.filter(i => i !== index);
                        subOptionItem.className = 'sub-option-item px-2 py-1 rounded cursor-pointer transition-colors hover:bg-gray-100';
                    } else {
                        // 选择
                        currentSelectedOptions.push(index);
                        subOptionItem.className = 'sub-option-item px-2 py-1 rounded cursor-pointer transition-colors bg-blue-100 text-blue-700 border border-blue-300';
                    }
                    
                    // 立即应用选择
                    applySubOptionSelection(item.id, type, currentSelectedOptions);
                }
            });

            // 鼠标移出自动关闭机制 - 每个气泡框独立管理
            let closeTimer;
            
            const bubbleMouseEnter = function() {
                if (closeTimer) {
                    clearTimeout(closeTimer);
                    closeTimer = null;
                }
            };
            
            const bubbleMouseLeave = function() {
                closeTimer = setTimeout(() => {
                    if (document.body.contains(bubble)) {
                        bubble.remove();
                    }
                }, 100); // 100ms延迟关闭
            };
            
            const targetMouseLeave = function() {
                closeTimer = setTimeout(() => {
                    if (document.body.contains(bubble)) {
                        bubble.remove();
                    }
                }, 100);
            };
            
            const targetMouseEnter = function() {
                if (closeTimer) {
                    clearTimeout(closeTimer);
                    closeTimer = null;
                }
            };
            
            bubble.addEventListener('mouseenter', bubbleMouseEnter);
            bubble.addEventListener('mouseleave', bubbleMouseLeave);
            targetElement.addEventListener('mouseleave', targetMouseLeave);
            targetElement.addEventListener('mouseenter', targetMouseEnter);
            
            // 清理事件监听器
            bubble.addEventListener('remove', function() {
                bubble.removeEventListener('mouseenter', bubbleMouseEnter);
                bubble.removeEventListener('mouseleave', bubbleMouseLeave);
                targetElement.removeEventListener('mouseleave', targetMouseLeave);
                targetElement.removeEventListener('mouseenter', targetMouseEnter);
                if (closeTimer) {
                    clearTimeout(closeTimer);
                }
            });

            // 点击外部关闭 - 独立处理
            const clickOutsideHandler = function(e) {
                if (document.body.contains(bubble) && 
                    !bubble.contains(e.target) && 
                    !targetElement.contains(e.target)) {
                    bubble.remove();
                    document.removeEventListener('click', clickOutsideHandler);
                }
            };
            
            setTimeout(() => {
                document.addEventListener('click', clickOutsideHandler);
            }, 100);
            
            // 确保在气泡框移除时清理事件监听器
            const originalRemove = bubble.remove;
            bubble.remove = function() {
                document.removeEventListener('click', clickOutsideHandler);
                originalRemove.call(this);
            };
        }

        // 应用二级选项选择
        function applySubOptionSelection(itemId, type, selectedIndexes) {
            // 移除旧的选择
            const existingIndex = selection[type].findIndex(item => item.id === itemId);
            if (existingIndex > -1) {
                selection[type].splice(existingIndex, 1);
            }
            // 添加新的选择
            if (selectedIndexes.length > 0) {
                selection[type].push({ id: itemId, subOptions: selectedIndexes });
            }
            
            // 重新渲染该类型的内容
            renderContent(type);
            
            // 更新结果
            updateResult();
        }

        // 清除指定项目的选中状态（包括所有二级选项）
        function clearItemSelection(id, type) {
            let wasSelected = false;
            
            // 多选类型
            const index = selection[type].findIndex(item => item.id === id);
            if (index > -1) {
                selection[type].splice(index, 1);
                wasSelected = true;
            }
            
            if (wasSelected) {
                // 重新渲染该类型的内容
                renderContent(type);
                
                // 更新结果
                updateResult();
                
                // 显示提示信息
                showNotification('已清除选中状态', 'info');
            }
        }

        // 获取选中的二级选项
        function getSelectedSubOptions(itemId, type) {
            const item = selection[type].find(item => item.id === itemId);
            return item ? item.subOptions : [];
        }
        
        // 切换二级选项选择状态
        function toggleSubOptionSelection(itemId, subIndex, type, checked) {
            let item = selection[type].find(item => item.id === itemId);
            if (!item) {
                item = { id: itemId, subOptions: [] };
                selection[type].push(item);
            }
            
            if (checked) {
                if (!item.subOptions.includes(subIndex)) {
                    item.subOptions.push(subIndex);
                }
            } else {
                const index = item.subOptions.indexOf(subIndex);
                if (index > -1) {
                    item.subOptions.splice(index, 1);
                }
                // 如果没有选中的二级选项，移除整个项目
                if (item.subOptions.length === 0) {
                    const itemIndex = selection[type].indexOf(item);
                    if (itemIndex > -1) {
                        selection[type].splice(itemIndex, 1);
                    }
                }
            }
            
            updateResult();
        }

        // 检查项目是否被选中
        function isItemSelected(id, type) {
            return selection[type].some(item => item.id === id);
        }

        // 切换选择状态
        function toggleSelection(id, type) {
            // 多选
            const index = selection[type].findIndex(item => item.id === id);
            if (index > -1) {
                selection[type].splice(index, 1);
            } else {
                selection[type].push({ id: id, subOptions: [] });
                
                // 检查是否为一级选项且无二级选项，如果是则自动记录为标签
                const item = contentIndex[type][id];
                if (item && (!item.subOptions || item.subOptions.length === 0)) {
                    // 自动设置一级选项标签
                    setPrimaryOptionTag(id, item.text);
                }
            }
            
            // 重新渲染该类型的内容
            renderContent(type);
            
            // 更新结果
            updateResult();
        }

        // 更新结果
        function updateResult() {
            const resultContainer = document.getElementById('resultContainer');
            let resultParts = [];
            
            // 如果处于智能筛选模式，实时更新收藏话术筛选
            if (isSmartFilterMode) {
                renderFavoriteScripts();
                updateQuickButtonState();
            }

            // 处理起手称呼式
            if (selection.greeting.length > 0) {
                const greetingContents = [];
                const categoryName = getCategoryDisplayName('greeting');
                selection.greeting.forEach(selItem => {
                    const item = contentIndex.greeting[selItem.id];
                    if (item) {
                        if (selItem.subOptions.length > 0) {
                            const subContents = selItem.subOptions.map(index => item.subOptions[index]).filter(Boolean);
                            if (subContents.length > 0) {
                                greetingContents.push(...subContents);
                            }
                        } else {
                            // 没有二级选项时，直接使用一级选项内容作为二级选项内容
                            greetingContents.push(item.text);
                        }
                    }
                });
                if (greetingContents.length > 0) {
                    resultParts.push(`${categoryName}：${greetingContents.join('，')}`);
                }
            }

            // 处理优点
            if (selection.strength.length > 0) {
                const strengthContents = [];
                const categoryName = getCategoryDisplayName('strength');
                selection.strength.forEach(selItem => {
                    const item = contentIndex.strength[selItem.id];
                    if (item) {
                        if (selItem.subOptions.length > 0) {
                            const subContents = selItem.subOptions.map(index => item.subOptions[index]).filter(Boolean);
                            if (subContents.length > 0) {
                                strengthContents.push(...subContents);
                            }
                        } else {
                            // 没有二级选项时，直接使用一级选项内容作为二级选项内容
                            strengthContents.push(item.text);
                        }
                    }
                });
                if (strengthContents.length > 0) {
                    resultParts.push(`${categoryName}：${strengthContents.join('，')}`);
                }
            }

            // 处理问题
            if (selection.issue.length > 0) {
                const issueContents = [];
                const categoryName = getCategoryDisplayName('issue');
                selection.issue.forEach(selItem => {
                    const item = contentIndex.issue[selItem.id];
                    if (item) {
                        if (selItem.subOptions.length > 0) {
                            const subContents = selItem.subOptions.map(index => item.subOptions[index]).filter(Boolean);
                            if (subContents.length > 0) {
                                issueContents.push(...subContents);
                            }
                        } else {
                            // 没有二级选项时，直接使用一级选项内容作为二级选项内容
                            issueContents.push(item.text);
                        }
                    }
                });
                if (issueContents.length > 0) {
                    resultParts.push(`${categoryName}：${issueContents.join('，')}`);
                }
            }

            // 处理结尾式
            if (selection.closing.length > 0) {
                const closingContents = [];
                const categoryName = getCategoryDisplayName('closing');
                selection.closing.forEach(selItem => {
                    const item = contentIndex.closing[selItem.id];
                    if (item) {
                        if (selItem.subOptions.length > 0) {
                            const subContents = selItem.subOptions.map(index => item.subOptions[index]).filter(Boolean);
                            if (subContents.length > 0) {
                                closingContents.push(...subContents);
                            }
                        } else {
                            // 没有二级选项时，直接使用一级选项内容作为二级选项内容
                            closingContents.push(item.text);
                        }
                    }
                });
                if (closingContents.length > 0) {
                    resultParts.push(`${categoryName}：${closingContents.join('，')}`);
                }
            }

            // 用分号连接所有部分
            const result = resultParts.join('；');

            if (result.trim()) {
                resultContainer.innerHTML = `<pre class="whitespace-pre-wrap font-sans">${result}</pre>`;
            } else {
                resultContainer.innerHTML = '<p class="text-neutral italic">请在左侧选择内容，话术咒语将自动生成在这里...</p>';
            }
            
            // 动态调整文本框高度（无论有无内容都执行）
            setTimeout(() => {
                const minHeight = 45; // 最小高度 - 单行文字高度
                const maxHeight = Math.max(300, window.innerHeight * 0.4); // 最大高度
                
                // 临时重置高度以获取真实的内容高度
                const originalHeight = resultContainer.style.height;
                resultContainer.style.height = 'auto';
                resultContainer.style.maxHeight = 'none';
                
                const contentHeight = resultContainer.scrollHeight;
                let targetHeight = Math.max(minHeight, contentHeight);
                
                if (targetHeight > maxHeight) {
                    resultContainer.style.height = maxHeight + 'px';
                    resultContainer.style.overflowY = 'auto';
                } else {
                    resultContainer.style.height = targetHeight + 'px';
                    resultContainer.style.overflowY = 'hidden';
                }
                
                // 确保最小高度始终生效
                resultContainer.style.minHeight = minHeight + 'px';
            }, 50);
        }

        // 生成话术
        async function generateScript() {
            const resultContainer = document.getElementById('resultContainer');
            const generatedContainer = document.getElementById('generatedContainer');
            const generateBtn = document.getElementById('generateBtn');
            
            const inputText = resultContainer.textContent || resultContainer.innerText;
            
            if (!inputText.trim() || inputText.includes('请在左侧选择内容')) {
                showNotification('请先选择内容生成话术咒语', 'warning');
                return;
            }
            
            // 检查API配置
            if (!isApiConfigured()) {
                showNotification('请先在设置中配置API密钥和机器人ID', 'error');
                openConfigPanel();
                return;
            }
            
            // 显示加载状态
            generateBtn.disabled = true;
            generateBtn.innerHTML = '<i class="fa fa-spinner fa-spin"></i> 生成中...';
            generatedContainer.innerHTML = '<p class="text-neutral italic">AI正在为您生成优化的话术内容，请稍候...</p>';
            
            try {
                // 获取配置的API信息
                const apiKey = getApiKey();
                const botId = getBotId();
                
                // 根据Coze API v3文档优化参数格式
                const userId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                const requestBody = {
                    bot_id: botId,
                    user_id: userId, // 使用动态生成的唯一用户ID
                    stream: false,
                    auto_save_history: true,
                    additional_messages: [
                        {
                            role: 'user',
                            content: inputText.trim(),
                            content_type: 'text'
                        }
                    ]
                };
                
                console.log('=== Coze API v3 请求详情 ===');
                console.log('API端点: https://api.coze.cn/v3/chat');
                console.log('请求方法: POST');
                console.log('用户ID:', userId);
                console.log('机器人ID:', botId);
                console.log('API密钥状态:', apiKey ? `已配置(${apiKey.substring(0, 8)}...)` : '未配置');
                console.log('请求体:', JSON.stringify(requestBody, null, 2));
                
                // 调用扣子API v3
                const response = await fetch('https://api.coze.cn/v3/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify(requestBody)
                });
                
                console.log('=== API响应状态检查 ===');
                console.log('响应状态码:', response.status);
                console.log('响应状态文本:', response.statusText);
                console.log('响应头信息:', Object.fromEntries(response.headers.entries()));
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('API调用失败详情:', {
                        status: response.status,
                        statusText: response.statusText,
                        errorBody: errorText
                    });
                    
                    // 尝试解析错误响应为JSON
                    let errorData;
                    try {
                        errorData = JSON.parse(errorText);
                    } catch (e) {
                        errorData = { message: errorText };
                    }
                    
                    // 根据状态码和Coze错误码提供具体的错误诊断
                    let errorMessage = `API调用失败: ${response.status} ${response.statusText}`;
                    
                    // 检查Coze特有的错误码
                    if (errorData.code === 702242001) {
                        errorMessage += '\n🔍 Coze错误码 702242001: 参数传递错误';
                        errorMessage += '\n可能原因：';
                        errorMessage += '\n  - 请求头不完整（缺少Content-Type或Authorization）';
                        errorMessage += '\n  - 请求体格式错误';
                        errorMessage += '\n  - 必需参数缺失或格式不正确';
                        errorMessage += '\n💡 建议：检查API密钥格式是否为 "Bearer pat_xxx"';
                    } else if (response.status === 401) {
                        errorMessage += '\n🔍 HTTP 401: 未授权访问';
                        errorMessage += '\n可能原因：';
                        errorMessage += '\n  - API密钥无效或已过期';
                        errorMessage += '\n  - 密钥格式错误（应为 Bearer pat_xxx）';
                        errorMessage += '\n💡 建议：重新生成Personal Access Token';
                    } else if (response.status === 403) {
                        errorMessage += '\n🔍 HTTP 403: 权限不足';
                        errorMessage += '\n可能原因：';
                        errorMessage += '\n  - PAT令牌缺少chat权限';
                        errorMessage += '\n  - 机器人与令牌不在同一空间';
                        errorMessage += '\n💡 建议：检查令牌权限设置';
                    } else if (response.status === 404) {
                        errorMessage += '\n🔍 HTTP 404: 资源不存在';
                        errorMessage += '\n可能原因：';
                        errorMessage += '\n  - 机器人ID不存在';
                        errorMessage += '\n  - 机器人未发布为API服务';
                        errorMessage += '\n💡 建议：确认机器人ID并检查发布状态';
                    } else if (response.status === 429) {
                        errorMessage += '\n🔍 HTTP 429: 请求过多';
                        errorMessage += '\n可能原因：请求频率超过限制';
                        errorMessage += '\n💡 建议：降低请求频率或稍后重试';
                    } else if (response.status >= 500) {
                        errorMessage += '\n🔍 HTTP 5xx: 服务器错误';
                        errorMessage += '\n可能原因：Coze服务器内部错误';
                        errorMessage += '\n💡 建议：稍后重试或联系技术支持';
                    }
                    
                    errorMessage += `\n\n📋 完整错误信息: ${errorText}`;
                    errorMessage += '\n\n🔧 使用错误排查工具: coze-error-debug.html';
                    throw new Error(errorMessage);
                }
                
                const data = await response.json();
                
                // 详细记录API响应用于调试
                console.log('=== Coze API v3 调用流程开始 ===');
                console.log('步骤1 - 发起对话请求成功');
                console.log('完整响应数据:', JSON.stringify(data, null, 2));
                console.log('响应数据结构检查:', {
                    hasCode: 'code' in data,
                    code: data.code,
                    hasMsg: 'msg' in data,
                    msg: data.msg,
                    hasData: 'data' in data,
                    dataType: typeof data.data
                });
                
                // 根据Coze API文档，非流式调用需要三步：
                // 1. 发起对话请求（当前步骤）- 返回chat_id
                // 2. 轮询对话状态 - 等待completed
                // 3. 获取对话消息 - 获取最终结果
                
                if (!data.data || !data.data.id) {
                    throw new Error('未获取到chat_id，API响应格式异常');
                }
                
                const chatId = data.data.id;
                const conversationId = data.data.conversation_id;
                console.log('获取到chat_id:', chatId);
                console.log('会话ID:', conversationId);
                
                // 步骤2: 轮询对话状态
                console.log('步骤2 - 开始轮询对话状态...');
                let chatStatus = 'in_progress';
                let pollCount = 0;
                const maxPolls = 30; // 最多轮询30次，避免无限等待
                
                while (chatStatus === 'in_progress' && pollCount < maxPolls) {
                    await new Promise(resolve => setTimeout(resolve, 1000)); // 等待1秒
                    pollCount++;
                    
                    const statusResponse = await fetch(`https://api.coze.cn/v3/chat/retrieve?conversation_id=${conversationId}&chat_id=${chatId}`, {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${apiKey}`
                        }
                    });
                    
                    if (!statusResponse.ok) {
                        throw new Error(`状态查询失败: ${statusResponse.status}`);
                    }
                    
                    const statusData = await statusResponse.json();
                    chatStatus = statusData.data.status;
                    console.log(`轮询第${pollCount}次，状态: ${chatStatus}`);
                    
                    if (chatStatus === 'failed') {
                        throw new Error('对话处理失败');
                    }
                    if (chatStatus === 'cancelled') {
                        throw new Error('对话被取消');
                    }
                }
                
                if (chatStatus !== 'completed') {
                    throw new Error('对话处理超时，请稍后重试');
                }
                
                console.log('步骤3 - 对话完成，获取消息内容...');
                
                // 步骤3: 获取对话消息
                const messagesResponse = await fetch(`https://api.coze.cn/v3/chat/message/list?conversation_id=${conversationId}&chat_id=${chatId}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`
                    }
                });
                
                if (!messagesResponse.ok) {
                    throw new Error(`消息获取失败: ${messagesResponse.status}`);
                }
                
                const messagesData = await messagesResponse.json();
                console.log('=== 消息响应数据验证 ===');
                console.log('完整响应数据:', JSON.stringify(messagesData, null, 2));
                console.log('响应数据类型:', typeof messagesData);
                console.log('响应状态码:', messagesResponse.status);
                console.log('响应头信息:', Object.fromEntries(messagesResponse.headers.entries()));
                
                // 验证响应数据结构
                if (!messagesData || typeof messagesData !== 'object') {
                    throw new Error('消息响应数据格式无效：不是有效的JSON对象');
                }
                
                console.log('是否有data字段:', 'data' in messagesData);
                console.log('data字段类型:', typeof messagesData.data);
                console.log('data是否为数组:', Array.isArray(messagesData.data));
                
                if (messagesData.data) {
                    console.log('data数组长度:', messagesData.data.length);
                    if (messagesData.data.length > 0) {
                        console.log('第一条消息结构:', messagesData.data[0]);
                    }
                } else {
                    console.warn('警告：响应中没有data字段');
                    console.log('可用字段:', Object.keys(messagesData));
                }
                
                let generatedText = '';
                
                // 解析Coze API的消息格式
                if (messagesData.data && Array.isArray(messagesData.data)) {
                    console.log('=== 解析Coze消息数组 ===');
                    console.log('消息总数:', messagesData.data.length);
                    
                    // 显示所有消息的详细信息
                    messagesData.data.forEach((msg, index) => {
                        console.log(`消息${index + 1}详情:`, {
                            id: msg.id,
                            role: msg.role,
                            type: msg.type,
                            content_type: msg.content_type,
                            content: msg.content,
                            chat_id: msg.chat_id
                        });
                    });
                    
                    // 根据Coze API文档，查找type=answer且content_type=text的智能体回复
                    const textAnswerMessages = messagesData.data.filter(msg => 
                        msg.role === 'assistant' && 
                        msg.type === 'answer' && 
                        msg.content_type === 'text'
                    );
                    
                    console.log('找到文本格式智能体回复数量:', textAnswerMessages.length);
                    
                    if (textAnswerMessages.length > 0) {
                        // 合并所有文本回复内容
                        generatedText = textAnswerMessages.map(msg => msg.content).join('\n');
                        console.log('提取的智能体回复内容:', generatedText);
                    } else {
                        // 如果没有找到标准的文本回复，尝试查找其他类型的assistant消息
                        const allAssistantMessages = messagesData.data.filter(msg => 
                            msg.role === 'assistant'
                        );
                        
                        console.log('所有assistant消息数量:', allAssistantMessages.length);
                        
                        if (allAssistantMessages.length > 0) {
                            // 优先选择answer类型的消息
                            const answerMessages = allAssistantMessages.filter(msg => msg.type === 'answer');
                            if (answerMessages.length > 0) {
                                generatedText = answerMessages.map(msg => msg.content).join('\n');
                                console.log('使用answer类型消息:', generatedText);
                            } else {
                                // 如果没有answer类型，使用第一个assistant消息
                                generatedText = allAssistantMessages[0].content;
                                console.log('使用第一个assistant消息:', generatedText);
                            }
                        } else {
                            console.error('未找到任何assistant角色的消息');
                            throw new Error('未找到有效的智能体回复');
                        }
                    }
                } else {
                    console.error('消息数据格式异常:', messagesData);
                    throw new Error('消息数据格式异常');
                }
                
                console.log('=== API响应解析结束 ===');
                console.log('最终提取的内容:', generatedText);
                
                console.log('提取的生成文本:', generatedText);
                
                // 如果API返回内容为空，使用备用内容
                if (!generatedText || generatedText.trim() === '') {
                    console.log('API返回内容为空，使用备用内容');
                    generatedText = `【优化后的话术】\n\n${inputText.trim()}\n\n经过AI优化，以上话术在以下方面得到了改进：\n1. 语言表达更加专业和礼貌\n2. 逻辑结构更加清晰\n3. 说服力和感染力得到增强\n4. 符合现代商务沟通标准\n\n建议在实际使用时根据具体情况进行微调。\n\n注意：API返回内容为空，当前使用备用生成模式。`;
                } else {
                    console.log('使用API生成的内容');
                }
                
                // 显示生成的内容 - 使用textContent避免HTML注入
                const preElement = document.createElement('pre');
                preElement.className = 'whitespace-pre-wrap font-sans';
                preElement.textContent = generatedText;
                generatedContainer.innerHTML = '';
                generatedContainer.appendChild(preElement);
                
                // 动态调整生成文本框高度
                adjustGeneratedContainerHeight();
                
                // 更新字数统计
                updateCharCount();
                
                showNotification('话术生成成功！', 'success');
                
                // 自动复制生成的话术到剪切板
                copyGeneratedResult();
                
            } catch (error) {
                console.error('=== API调用异常详细分析 ===');
                console.error('错误对象:', error);
                console.error('错误消息:', error.message);
                console.error('错误堆栈:', error.stack);
                console.error('错误类型:', error.constructor.name);
                
                // 网络状态检查
                console.log('=== 网络状态检查 ===');
                console.log('在线状态:', navigator.onLine ? '在线' : '离线');
                console.log('用户代理:', navigator.userAgent);
                
                // API配置检查
                console.log('=== API配置检查 ===');
                const currentApiKey = getApiKey();
                const currentBotId = getBotId();
                console.log('API密钥状态:', currentApiKey ? `已配置(长度: ${currentApiKey.length}, 前缀: ${currentApiKey.substring(0, 10)}...)` : '未配置');
                console.log('机器人ID状态:', currentBotId ? `已配置(${currentBotId})` : '未配置');
                console.log('配置完整性:', isApiConfigured() ? '完整' : '不完整');
                
                // 详细的错误分类和诊断
                let errorMessage = 'API调用失败';
                let diagnosticInfo = '';
                let troubleshootingSteps = [];
                
                if (error.message.includes('Failed to fetch') || error.name === 'TypeError') {
                    errorMessage = 'API调用失败：网络连接错误';
                    diagnosticInfo = '无法连接到Coze API服务器';
                    troubleshootingSteps = [
                        '1. 检查网络连接是否正常',
                        '2. 确认防火墙或代理设置',
                        '3. 验证API服务器是否可访问',
                        '4. 检查CORS策略配置'
                    ];
                } else if (error.message.includes('401') || error.message.includes('Unauthorized')) {
                    errorMessage = 'API调用失败：身份验证失败';
                    diagnosticInfo = 'API密钥无效或已过期';
                    troubleshootingSteps = [
                        '1. 检查API密钥是否正确',
                        '2. 确认API密钥未过期',
                        '3. 验证API密钥权限范围',
                        '4. 重新生成API密钥'
                    ];
                } else if (error.message.includes('403') || error.message.includes('Forbidden')) {
                    errorMessage = 'API调用失败：权限不足';
                    diagnosticInfo = '机器人ID无效或API密钥无访问权限';
                    troubleshootingSteps = [
                        '1. 确认机器人ID正确',
                        '2. 检查API密钥权限',
                        '3. 验证机器人状态是否正常',
                        '4. 确认账户余额充足'
                    ];
                } else if (error.message.includes('429') || error.message.includes('Too Many Requests')) {
                    errorMessage = 'API调用失败：请求频率过高';
                    diagnosticInfo = '触发了API速率限制';
                    troubleshootingSteps = [
                        '1. 等待一段时间后重试',
                        '2. 检查API配额使用情况',
                        '3. 优化请求频率',
                        '4. 考虑升级API套餐'
                    ];
                } else if (error.message.includes('500') || error.message.includes('502') || error.message.includes('503')) {
                    errorMessage = 'API调用失败：服务器错误';
                    diagnosticInfo = 'Coze API服务器出现问题';
                    troubleshootingSteps = [
                        '1. 稍后重试请求',
                        '2. 检查Coze服务状态',
                        '3. 联系技术支持',
                        '4. 使用备用方案'
                    ];
                } else if (error.message.includes('未获取到chat_id')) {
                    errorMessage = 'API调用失败：响应格式异常';
                    diagnosticInfo = '初始请求未返回有效的chat_id';
                    troubleshootingSteps = [
                        '1. 检查请求参数格式',
                        '2. 验证机器人配置',
                        '3. 确认API版本兼容性',
                        '4. 查看详细响应日志'
                    ];
                } else if (error.message.includes('对话处理失败') || error.message.includes('对话被取消')) {
                    errorMessage = 'API调用失败：对话处理异常';
                    diagnosticInfo = '机器人处理过程中出现问题';
                    troubleshootingSteps = [
                        '1. 检查输入内容是否合规',
                        '2. 验证机器人配置',
                        '3. 重试请求',
                        '4. 联系技术支持'
                    ];
                } else if (error.message.includes('对话处理超时')) {
                    errorMessage = 'API调用失败：处理超时';
                    diagnosticInfo = '机器人响应时间过长';
                    troubleshootingSteps = [
                        '1. 简化输入内容',
                        '2. 重试请求',
                        '3. 检查机器人性能',
                        '4. 增加超时时间'
                    ];
                } else {
                    diagnosticInfo = '未知错误类型';
                    troubleshootingSteps = [
                        '1. 查看浏览器控制台详细信息',
                        '2. 检查网络连接',
                        '3. 验证API配置',
                        '4. 联系技术支持'
                    ];
                }
                
                console.log('=== 错误诊断结果 ===');
                console.log('错误分类:', errorMessage);
                console.log('问题描述:', diagnosticInfo);
                console.log('排查步骤:', troubleshootingSteps);
                console.log('=== 诊断信息结束 ===');
                
                // 显示用户友好的错误信息
                showNotification(`${errorMessage}。${diagnosticInfo}`, 'error');
                
                // 如果API调用失败，提供备用内容
                const fallbackText = `【优化后的话术】\n\n${inputText.trim()}\n\n经过AI优化，以上话术在以下方面得到了改进：\n1. 语言表达更加专业和礼貌\n2. 逻辑结构更加清晰\n3. 说服力和感染力得到增强\n4. 符合现代商务沟通标准\n\n建议在实际使用时根据具体情况进行微调。\n\n注意：API调用失败，当前使用备用生成模式。`;
                
                // 使用相同的方式显示备用内容
                const fallbackPreElement = document.createElement('pre');
                fallbackPreElement.className = 'whitespace-pre-wrap font-sans';
                fallbackPreElement.textContent = fallbackText;
                generatedContainer.innerHTML = '';
                generatedContainer.appendChild(fallbackPreElement);
                adjustGeneratedContainerHeight();
                
                // 更新字数统计
                updateCharCount();
                
                showNotification(errorMessage + '，已使用备用模式', 'warning');
            } finally {
                // 恢复按钮状态
                generateBtn.disabled = false;
                generateBtn.innerHTML = '<i class="fa fa-magic"></i> 生成话术';
            }
        }
        
        // 调整生成文本框高度
        function adjustGeneratedContainerHeight() {
            const generatedContainer = document.getElementById('generatedContainer');
            const minHeight = 45;
            const maxHeight = Math.max(300, window.innerHeight * 0.4);
            
            // 临时重置高度以获取真实的内容高度
            generatedContainer.style.height = 'auto';
            generatedContainer.style.maxHeight = 'none';
            
            const contentHeight = generatedContainer.scrollHeight;
            let targetHeight = Math.max(minHeight, contentHeight);
            
            if (targetHeight > maxHeight) {
                generatedContainer.style.height = maxHeight + 'px';
                generatedContainer.style.overflowY = 'auto';
            } else {
                generatedContainer.style.height = targetHeight + 'px';
                generatedContainer.style.overflowY = 'hidden';
            }
            
            generatedContainer.style.minHeight = minHeight + 'px';
        }

        // 更新字数统计
        function updateCharCount() {
            const generatedContainer = document.getElementById('generatedContainer');
            const charCountElement = document.getElementById('charCount');
            
            if (!generatedContainer || !charCountElement) return;
            
            const text = generatedContainer.textContent || generatedContainer.innerText || '';
            
            // 过滤掉默认提示文本
            if (text.includes('点击"生成话术"按钮') || text.includes('AI正在为您生成')) {
                charCountElement.textContent = '0 字';
                return;
            }
            
            const charCount = text.trim().length;
            charCountElement.textContent = `${charCount} 字`;
            
            // 根据字数添加颜色提示
            charCountElement.className = 'text-sm';
            if (charCount === 0) {
                charCountElement.className += ' text-gray-500';
            } else if (charCount < 100) {
                charCountElement.className += ' text-green-600';
            } else if (charCount < 500) {
                charCountElement.className += ' text-blue-600';
            } else {
                charCountElement.className += ' text-orange-600';
            }
        }

        // 复制生成的话术
        function copyGeneratedResult() {
            const generatedContainer = document.getElementById('generatedContainer');
            const text = generatedContainer.textContent || generatedContainer.innerText;
            
            if (text.trim() && !text.includes('点击"生成话术"按钮') && !text.includes('AI正在为您生成')) {
                navigator.clipboard.writeText(text.trim()).then(() => {
                    showNotification('已自动复制到剪切板', 'success');
                    
                    // 保存到历史记录
                    saveToHistory(text.trim());
                }).catch(err => {
                    console.error('复制失败:', err);
                    showNotification('复制失败，请手动复制', 'error');
                });
            } else {
                showNotification('没有生成的话术可复制', 'warning');
            }
        }

        // 重置选择
        function resetSelection() {
            selection = {
                greeting: [],
                strength: [],
                issue: [],
                closing: []
            };
            
            renderAllContent();
            updateResult();
            showNotification('已重置选择', 'info');
        }

        // 保存到历史记录
        function saveToHistory(text) {
            const timestamp = new Date().toLocaleString();
            const historyItem = {
                id: 'h' + Date.now(),
                text: text,
                timestamp: timestamp,
                selection: JSON.parse(JSON.stringify(selection)) // 深拷贝当前选择
            };
            
            // 添加到历史记录数组开头
            historyRecords.unshift(historyItem);
            
            // 限制历史记录数量
            if (historyRecords.length > MAX_HISTORY_RECORDS) {
                historyRecords = historyRecords.slice(0, MAX_HISTORY_RECORDS);
            }
            
            // 保存到本地存储
            saveHistoryRecords();
            
            // 重新渲染历史记录
            renderHistoryRecords();
        }

        // 保存历史记录到本地存储
        function saveHistoryRecords() {
            try {
                localStorage.setItem('historyRecords', JSON.stringify(historyRecords));
            } catch (e) {
                console.error('保存历史记录失败:', e);
            }
        }

        // 从本地存储加载历史记录
        function loadHistoryRecords() {
            try {
                const saved = localStorage.getItem('historyRecords');
                if (saved) {
                    historyRecords = JSON.parse(saved);
                }
            } catch (e) {
                console.error('加载历史记录失败:', e);
                historyRecords = [];
            }
        }

        // 渲染历史记录
        function renderHistoryRecords() {
            const container = document.getElementById('historyContainer');
            if (!container) return;

            container.innerHTML = '';
            
            if (historyRecords.length === 0) {
                container.innerHTML = '<div class="text-neutral italic text-center col-span-full py-4">暂无历史记录</div>';
                return;
            }

            historyRecords.forEach(record => {
                const div = document.createElement('div');
                div.className = 'p-4 border border-gray-200 rounded-lg hover:border-primary transition-colors cursor-pointer';
                
                const preview = record.text.length > 100 ? record.text.substring(0, 100) + '...' : record.text;
                
                div.innerHTML = `
                    <div class="text-sm mb-2">${preview}</div>
                    <div class="text-xs text-neutral mb-2">${record.timestamp}</div>
                    <div class="flex gap-2">
                        <button class="restore-btn text-xs text-primary hover:text-primary/80" data-id="${record.id}">
                            <i class="fa fa-undo"></i> 恢复选择
                        </button>
                        <button class="copy-history-btn text-xs text-secondary hover:text-secondary/80" data-id="${record.id}">
                            <i class="fa fa-copy"></i> 复制
                        </button>
                        <button class="delete-history-btn text-xs text-red-500 hover:text-red-700" data-id="${record.id}">
                            <i class="fa fa-trash"></i> 删除
                        </button>
                    </div>
                `;
                
                // 恢复选择按钮
                div.querySelector('.restore-btn').addEventListener('click', function(e) {
                    e.stopPropagation();
                    restoreSelection(record.id);
                });
                
                // 复制按钮
                div.querySelector('.copy-history-btn').addEventListener('click', function(e) {
                    e.stopPropagation();
                    copyHistoryItem(record.id);
                });
                
                // 删除按钮
                div.querySelector('.delete-history-btn').addEventListener('click', function(e) {
                    e.stopPropagation();
                    deleteHistoryItem(record.id);
                });
                
                container.appendChild(div);
            });
        }

        // 恢复历史选择
        function restoreSelection(historyId) {
            const record = historyRecords.find(r => r.id === historyId);
            if (record && record.selection) {
                selection = JSON.parse(JSON.stringify(record.selection));
                renderAllContent();
                updateResult();
                showNotification('已恢复历史选择', 'success');
            }
        }

        // 复制历史项目
        function copyHistoryItem(historyId) {
            const record = historyRecords.find(r => r.id === historyId);
            if (record) {
                navigator.clipboard.writeText(record.text).then(() => {
                    showNotification('复制成功！', 'success');
                }).catch(err => {
                    console.error('复制失败:', err);
                    showNotification('复制失败', 'error');
                });
            }
        }

        // 删除历史项目
        async function deleteHistoryItem(historyId) {
            const confirmed = await showCustomConfirm('确定要删除这条历史记录吗？');
            if (confirmed) {
                historyRecords = historyRecords.filter(r => r.id !== historyId);
                saveHistoryRecords();
                renderHistoryRecords();
                showNotification('已删除历史记录', 'info');
            }
        }

        // 显示通知
        function showNotification(message, type = 'info') {
            // 创建通知元素
            const notification = document.createElement('div');
            notification.className = `fixed bottom-4 left-1/2 transform -translate-x-1/2 px-6 py-3 rounded-lg shadow-lg z-50 transition-all duration-300 translate-y-full text-lg min-w-64`;
            
            // 根据类型设置样式
            switch (type) {
                case 'success':
                    notification.classList.add('bg-green-500', 'text-white');
                    break;
                case 'error':
                    notification.classList.add('bg-red-500', 'text-white');
                    break;
                case 'warning':
                    notification.classList.add('bg-yellow-500', 'text-white');
                    break;
                default:
                    notification.classList.add('bg-blue-500', 'text-white');
            }
            
            notification.textContent = message;
            document.body.appendChild(notification);
            
            // 显示动画
            setTimeout(() => {
                notification.classList.remove('translate-y-full');
            }, 100);
            
            // 自动隐藏
            setTimeout(() => {
                notification.classList.add('translate-y-full');
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }

        // 添加新项目
        function addNewItem(type) {
            // 创建新项目对话框
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-40';
            modal.innerHTML = `
                <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
                    <h3 class="text-lg font-medium mb-4">添加新选项</h3>
                    <div class="mb-4">
                        <label class="block text-sm font-medium mb-2">选项标题：</label>
                        <input type="text" id="newTitle" class="w-full p-2 border rounded" placeholder="请输入选项标题">
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium mb-2">二级选项：</label>
                        <div id="newSubOptionsContainer" class="space-y-2">
                        </div>
                        <button type="button" id="addNewSubOption" class="mt-2 text-blue-500 hover:text-blue-700 text-sm">+ 添加二级选项</button>
                    </div>
                    <div class="flex gap-2 justify-end">
                        <button type="button" id="cancelNew" class="px-4 py-2 text-gray-600 hover:text-gray-800">取消</button>
                        <button type="button" id="saveNew" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">保存</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // 添加二级选项功能
            document.getElementById('addNewSubOption').addEventListener('click', function() {
                const container = document.getElementById('newSubOptionsContainer');
                const div = document.createElement('div');
                div.className = 'border rounded p-3 bg-gray-50';
                div.innerHTML = `
                    <div class="flex gap-2 mb-2">
                        <input type="text" class="flex-1 p-2 border rounded new-sub-option" placeholder="二级选项内容">
                        <button type="button" class="text-red-500 hover:text-red-700 px-2" onclick="this.parentElement.parentElement.remove()">删除</button>
                    </div>
                    <div class="mt-2">
                        <button type="button" class="text-sm text-blue-600 hover:text-blue-800 toggle-tag-form" onclick="toggleTagForm(this)">
                            <span class="toggle-text">+ 添加标签</span>
                        </button>
                        <div class="tag-form mt-2" style="display: none;">
                            <div class="flex gap-2">
                                <input type="text" class="flex-1 p-2 border rounded new-sub-option-tag" placeholder="标签名称" >
                                <button type="button" class="px-3 py-2 bg-green-500 text-white rounded hover:bg-green-600 text-sm confirm-tag" onclick="confirmTag(this)">确认</button>
                            </div>
                        </div>
                    </div>
                `;
                container.appendChild(div);
            });
            
            // 取消按钮
            document.getElementById('cancelNew').addEventListener('click', function() {
                document.body.removeChild(modal);
            });
            
            // 保存按钮
            document.getElementById('saveNew').addEventListener('click', function() {
                const title = document.getElementById('newTitle').value.trim();
                const subOptionContainers = document.querySelectorAll('#newSubOptionsContainer > div');
                const subOptions = [];
                
                if (title) {
                    const newItem = {
                        id: type.charAt(0) + Date.now(),
                        text: title,
                        subOptions: subOptions
                    };
                    
                    // 处理二级选项和标签
                    subOptionContainers.forEach((container, index) => {
                        const subOptionInput = container.querySelector('.new-sub-option');
                        const tagInput = container.querySelector('.new-sub-option-tag');
                        const confirmButton = container.querySelector('.tag-form button');
                        
                        if (subOptionInput && subOptionInput.value.trim()) {
                            const subOptionText = subOptionInput.value.trim();
                            const tagText = tagInput ? tagInput.value.trim() : '';
                            
                            subOptions.push(subOptionText);
                            
                            // 保存标签（如果有）
                            if (tagText) {
                                setSubOptionTag(newItem.id, index, tagText);
                                
                                // 保存标签颜色（从确认按钮的数据属性中获取）
                                const tagColor = confirmButton ? confirmButton.getAttribute('data-tag-color') : null;
                                if (tagColor) {
                                    setSubOptionTagColor(newItem.id, index, tagColor);
                                }
                            }
                        }
                    });
                    
                    appData[type].push(newItem);
                    saveAppData();
                    renderContent(type);
                    showNotification('添加成功！', 'success');
                    document.body.removeChild(modal);
                } else {
                    showCustomAlert('请输入选项标题');
                }
            });
            
            // 点击背景关闭
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    document.body.removeChild(modal);
                }
            });
            
            // 自动聚焦到标题输入框
            setTimeout(() => {
                document.getElementById('newTitle').focus();
            }, 100);
        }

        // 编辑项目
        function editItem(id, type) {
            const item = contentIndex[type][id];
            if (!item) return;
            
            // 创建编辑对话框
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-40';
            modal.innerHTML = `
                <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
                    <h3 class="text-lg font-medium mb-4">编辑选项</h3>
                    <div class="mb-4">
                        <label class="block text-sm font-medium mb-2">选项标题：</label>
                        <input type="text" id="editTitle" class="w-full p-2 border rounded" value="${item.text}">
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium mb-2">二级选项：</label>
                        <div id="subOptionsContainer" class="space-y-2">
                            ${(item.subOptions || []).map((sub, index) => {
                                const tag = getSubOptionTag(item.id, index);
                                const tagColor = getSubOptionTagColor(item.id, index);
                                const hasTag = tag && tag.trim();
                                return `
                                <div class="border rounded p-3 bg-gray-50" data-sub-index="${index}">
                                    <div class="flex gap-2 mb-2">
                                        ${hasTag ? `<div class="flex items-center px-2 py-1 rounded text-white text-sm" style="background-color: ${tagColor}; min-width: fit-content;">${tag}</div>` : ''}
                                        <input type="text" class="flex-1 p-2 border rounded sub-option" value="${sub}" placeholder="二级选项内容">
                                        <button type="button" class="text-red-500 hover:text-red-700 px-2" onclick="this.parentElement.parentElement.remove()">删除</button>
                                    </div>
                                    <div class="mt-2 flex items-center gap-2">
                                        <button type="button" class="text-sm text-blue-600 hover:text-blue-800 toggle-tag-form" onclick="toggleTagForm(this)">
                                            <span class="toggle-text">${hasTag ? '修改标签' : '+ 添加标签'}</span>
                                        </button>
                                        ${hasTag ? `
                                        <div class="flex gap-1">
                                            ${defaultTagColors.map(color => `
                                                <div class="w-6 h-6 rounded border-2 cursor-pointer hover:scale-110 transition-transform ${tagColor === color ? 'border-gray-800' : 'border-gray-300'}" 
                                                     style="background-color: ${color}" 
                                                     onclick="changeTagColor('${item.id}', ${index}, '${color}', this)"
                                                     title="点击切换颜色">
                                                </div>
                                            `).join('')}
                                        </div>` : ''}
                                        <div class="tag-form mt-2" style="display: none;">
                                            <div class="flex gap-2">
                                                <input type="text" class="flex-1 p-2 border rounded sub-option-tag" value="${tag || ''}" placeholder="标签名称" >
                                                <button type="button" class="px-3 py-2 bg-green-500 text-white rounded hover:bg-green-600 text-sm confirm-tag" onclick="confirmTag(this)">确认</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `}).join('')}
                        </div>
                        <button type="button" id="addSubOption" class="mt-2 text-blue-500 hover:text-blue-700 text-sm">+ 添加二级选项</button>
                    </div>
                    <div class="flex gap-2 justify-end">
                        <button type="button" id="cancelEdit" class="px-4 py-2 text-gray-600 hover:text-gray-800">取消</button>
                        <button type="button" id="deleteItem" class="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600">删除</button>
                        <button type="button" id="saveEdit" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">保存</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // 添加二级选项功能
            document.getElementById('addSubOption').addEventListener('click', function() {
                const container = document.getElementById('subOptionsContainer');
                const div = document.createElement('div');
                div.className = 'border rounded p-3 bg-gray-50';
                div.setAttribute('data-sub-index', 'new');
                div.innerHTML = `
                    <div class="flex gap-2 mb-2">
                        <input type="text" class="flex-1 p-2 border rounded sub-option" placeholder="二级选项内容">
                        <button type="button" class="text-red-500 hover:text-red-700 px-2" onclick="this.parentElement.parentElement.remove()">删除</button>
                    </div>
                    <div class="mt-2">
                        <button type="button" class="text-sm text-blue-600 hover:text-blue-800 toggle-tag-form" onclick="toggleTagForm(this)">
                            <span class="toggle-text">+ 添加标签</span>
                        </button>
                        <div class="tag-form mt-2" style="display: none;">
                            <div class="flex gap-2">
                                <input type="text" class="flex-1 p-2 border rounded sub-option-tag" placeholder="标签名称">
                                <button type="button" class="px-3 py-2 bg-green-500 text-white rounded hover:bg-green-600 text-sm confirm-tag" onclick="confirmTag(this)">确认</button>
                            </div>
                        </div>
                    </div>
                `;
                container.appendChild(div);
            });
            
            // 取消按钮
            document.getElementById('cancelEdit').addEventListener('click', function() {
                document.body.removeChild(modal);
            });
            
            // 删除按钮
            document.getElementById('deleteItem').addEventListener('click', async function() {
                const confirmed = await showCustomConfirm('确定要删除此项目吗？');
                if (confirmed) {
                    deleteItem(id, type);
                    document.body.removeChild(modal);
                }
            });
            
            // 保存按钮
            document.getElementById('saveEdit').addEventListener('click', function() {
                const title = document.getElementById('editTitle').value.trim();
                const subOptionContainers = document.querySelectorAll('#subOptionsContainer > div');
                const subOptions = [];
                
                // 清除该项目的所有标签
                if (subOptionTags[item.id]) {
                    delete subOptionTags[item.id];
                }
                
                subOptionContainers.forEach((container, newIndex) => {
                    const subOptionInput = container.querySelector('.sub-option');
                    const tagInput = container.querySelector('.sub-option-tag');
                    const confirmButton = container.querySelector('.tag-form button');
                    
                    if (subOptionInput && subOptionInput.value.trim()) {
                        const subOptionText = subOptionInput.value.trim();
                        const tagText = tagInput ? tagInput.value.trim() : '';
                        
                        subOptions.push(subOptionText);
                        
                        // 保存标签（如果有）
                        if (tagText) {
                            setSubOptionTag(item.id, newIndex, tagText);
                            
                            // 保存标签颜色（从确认按钮的数据属性中获取）
                            const tagColor = confirmButton ? confirmButton.getAttribute('data-tag-color') : null;
                            if (tagColor) {
                                setSubOptionTagColor(item.id, newIndex, tagColor);
                            }
                        }
                    }
                });
                
                if (title) {
                    // 获取旧的一级选项名称用于同步
                    const oldText = item.text;
                    
                    item.text = title;
                    item.subOptions = subOptions;
                    
                    // 如果一级选项名称发生变更，需要同步更新标签
                    if (oldText !== title) {
                        // 检查是否有一级选项标签需要更新
                        const primaryTag = getPrimaryOptionTag(item.id);
                        if (primaryTag === oldText) {
                            // 更新一级选项标签为新名称
                            setPrimaryOptionTag(item.id, title);
                            // 同步更新收藏话术中的一级选项标签
                            syncFavoriteScriptPrimaryTags(item.id, oldText, title);
                        }
                    }
                    
                    saveAppData();
                    renderContent(type);
                    updateResult();
                    showNotification('修改成功！', 'success');
                    document.body.removeChild(modal);
                } else {
                    showCustomAlert('请输入选项标题');
                }
            });
            
            // 点击背景关闭
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    document.body.removeChild(modal);
                }
            });
        }

        // 删除项目
        function deleteItem(id, type) {
            const index = appData[type].findIndex(item => item.id === id);
            if (index > -1) {
                appData[type].splice(index, 1);
                
                // 如果删除的项目被选中，则取消选择
                const selectionIndex = selection[type].findIndex(item => item.id === id);
                if (selectionIndex > -1) {
                    selection[type].splice(selectionIndex, 1);
                }
                
                saveAppData();
                renderContent(type);
                updateResult();
                showNotification('删除成功！', 'success');
            }
        }

        // 重新排序项目
        function reorderItems(draggedId, targetId, type) {
            const items = appData[type];
            const draggedIndex = items.findIndex(item => item.id === draggedId);
            const targetIndex = items.findIndex(item => item.id === targetId);
            
            if (draggedIndex > -1 && targetIndex > -1 && draggedIndex !== targetIndex) {
                const draggedItem = items.splice(draggedIndex, 1)[0];
                items.splice(targetIndex, 0, draggedItem);
                
                saveAppData();
                renderContent(type);
                showNotification('排序已更新', 'info');
            }
        }

        // 初始化拖拽功能
        function initializeDragAndDrop() {
            // 这个函数可以用来初始化更复杂的拖拽功能
            // 目前基本的拖拽功能已经在createItemElement中实现
        }

        // 收藏话术数组
        let favoriteScripts = [];
        
        // 智能筛选模式状态
        let isSmartFilterMode = true;
        
        // 最近使用模式状态
        let isRecentUsedMode = false;
        
        // 收藏话术使用记录（存储复制时间）
        let scriptUsageRecords = JSON.parse(localStorage.getItem('scriptUsageRecords') || '{}');
        
        // 切换智能筛选模式
        function toggleSmartFilterMode() {
            isSmartFilterMode = !isSmartFilterMode;
            
            // 如果开启智能筛选模式，关闭其他模式
            if (isSmartFilterMode) {
                isRecentUsedMode = false;
                const tagFilter = document.getElementById('tagFilter');
                if (tagFilter) {
                    tagFilter.value = '';
                }
            }
            
            // 重新渲染收藏话术
            renderFavoriteScripts();
            // 更新按钮状态
            updateQuickButtonState();
        }
        
        // 切换最近使用模式
        function toggleRecentUsedMode() {
            isRecentUsedMode = !isRecentUsedMode;
            
            // 如果开启最近使用模式，关闭其他模式
            if (isRecentUsedMode) {
                isSmartFilterMode = false;
                const tagFilter = document.getElementById('tagFilter');
                if (tagFilter) {
                    tagFilter.value = '';
                }
            }
            
            // 重新渲染收藏话术
            renderFavoriteScripts();
            // 更新按钮状态
            updateQuickButtonState();
        }
        
        // 记录收藏话术的使用时间
        function recordScriptUsage(scriptId) {
            scriptUsageRecords[scriptId] = Date.now();
            localStorage.setItem('scriptUsageRecords', JSON.stringify(scriptUsageRecords));
        }
        
        // 最近使用筛选函数：根据使用时间降序排列收藏话术
        function getRecentUsedScripts() {
            if (!isRecentUsedMode) {
                return favoriteScripts;
            }
            
            // 获取有使用记录的收藏话术
            const scriptsWithUsage = favoriteScripts.filter(script => {
                return scriptUsageRecords[script.id];
            });
            
            // 按使用时间降序排序（最近使用的在前面）
            scriptsWithUsage.sort((a, b) => {
                const timeA = scriptUsageRecords[a.id] || 0;
                const timeB = scriptUsageRecords[b.id] || 0;
                return timeB - timeA; // 降序排列
            });
            
            return scriptsWithUsage;
        }
        
        // 智能筛选函数：根据当前选择面板的已选项筛选收藏话术
        function getSmartFilteredScripts() {
            if (!isSmartFilterMode) {
                return favoriteScripts;
            }
            
            // 获取当前选择面板中的已选项
            const currentSelections = {
                greeting: selection.greeting || [],
                strength: selection.strength || [],
                issue: selection.issue || [],
                closing: selection.closing || []
            };
            
            // 检查是否有任何选择
            const hasAnySelection = Object.values(currentSelections).some(arr => arr.length > 0);
            if (!hasAnySelection) {
                return favoriteScripts; // 如果没有选择任何项，显示所有收藏
            }
            
            // 筛选匹配的收藏话术
            return favoriteScripts.filter(script => {
                if (!script.tags || script.tags.length === 0) {
                    return false; // 没有标签的话术不匹配
                }
                
                // 收集所有选中的筛选条件
                const allSelectedConditions = [];
                Object.entries(currentSelections).forEach(([type, selections]) => {
                    selections.forEach(selection => {
                        if (selection.subOptions && selection.subOptions.length > 0) {
                            // 如果有二级选项，只添加二级选项的组合ID
                            selection.subOptions.forEach(subIndex => {
                                allSelectedConditions.push(`${selection.id}-${subIndex}`);
                            });
                        } else {
                            // 如果没有二级选项，添加一级选项ID
                            allSelectedConditions.push(selection.id);
                        }
                    });
                });
                
                if (allSelectedConditions.length === 0) {
                    return true; // 如果没有选择任何项，显示所有收藏
                }
                
                // 检查收藏话术是否同时满足所有选中的筛选条件（AND逻辑）
                return allSelectedConditions.every(condition => {
                    return script.tags.some(tag => {
                        if (tag.type === 'sub') {
                            // 二级选项标签，匹配格式：itemId-subIndex
                            const tagId = `${tag.itemId}-${tag.subIndex}`;
                            return tagId === condition;
                        } else {
                            // 一级选项标签，直接匹配itemId
                            return tag.itemId === condition;
                        }
                    });
                });
            });
        }
        
        // 收藏夹相关函数已移除
        
        // 收藏当前话术
        async function saveCurrentFavorite() {
            // 检查是否有选择内容
            const hasSelection = selection.greeting.length > 0 || 
                                selection.strength.length > 0 || 
                                selection.issue.length > 0 || 
                                selection.closing.length > 0;
            
            if (!hasSelection) {
                showNotification('请先选择一些内容再收藏话术', 'warning');
                return;
            }
            
            // 获取当前生成的话术文本
            const generatedContainer = document.getElementById('generatedContainer');
            const generatedText = generatedContainer.textContent || generatedContainer.innerText || '';
            
            // 检查是否有生成的话术
            if (!generatedText.trim() || generatedText.includes('点击"生成话术"按钮') || generatedText.includes('AI正在为您生成')) {
                showNotification('请先生成话术再进行收藏', 'warning');
                return;
            }
            
            // 询问用户是否要为话术设置名称
            const scriptName = await showCustomPrompt('为收藏的话术设置名称（可留空）：', '');
            if (scriptName !== null) {
                // 构建标签数据 - 从选中的二级选项和一级选项中提取标签信息
                const tags = [];
                
                // 处理greeting类型的标签
                selection.greeting.forEach(item => {
                    if (item.subOptions && item.subOptions.length > 0) {
                        // 有二级选项时，收集二级选项标签
                        item.subOptions.forEach(subIndex => {
                            const tag = getSubOptionTag(item.id, subIndex);
                            const color = getSubOptionTagColor(item.id, subIndex);
                            if (tag) {
                                tags.push({ name: tag, color: color, itemId: item.id, subIndex: subIndex, type: 'sub' });
                            }
                        });
                    } else {
                        // 无二级选项时，收集一级选项标签
                        const tag = getPrimaryOptionTag(item.id);
                        const color = getPrimaryOptionTagColor(item.id);
                        if (tag) {
                            tags.push({ name: tag, color: color, itemId: item.id, type: 'primary' });
                        }
                    }
                });
                
                // 处理strength类型的标签
                selection.strength.forEach(item => {
                    if (item.subOptions && item.subOptions.length > 0) {
                        // 有二级选项时，收集二级选项标签
                        item.subOptions.forEach(subIndex => {
                            const tag = getSubOptionTag(item.id, subIndex);
                            const color = getSubOptionTagColor(item.id, subIndex);
                            if (tag) {
                                tags.push({ name: tag, color: color, itemId: item.id, subIndex: subIndex, type: 'sub' });
                            }
                        });
                    } else {
                        // 无二级选项时，收集一级选项标签
                        const tag = getPrimaryOptionTag(item.id);
                        const color = getPrimaryOptionTagColor(item.id);
                        if (tag) {
                            tags.push({ name: tag, color: color, itemId: item.id, type: 'primary' });
                        }
                    }
                });
                
                // 处理issue类型的标签
                selection.issue.forEach(item => {
                    if (item.subOptions && item.subOptions.length > 0) {
                        // 有二级选项时，收集二级选项标签
                        item.subOptions.forEach(subIndex => {
                            const tag = getSubOptionTag(item.id, subIndex);
                            const color = getSubOptionTagColor(item.id, subIndex);
                            if (tag) {
                                tags.push({ name: tag, color: color, itemId: item.id, subIndex: subIndex, type: 'sub' });
                            }
                        });
                    } else {
                        // 无二级选项时，收集一级选项标签
                        const tag = getPrimaryOptionTag(item.id);
                        const color = getPrimaryOptionTagColor(item.id);
                        if (tag) {
                            tags.push({ name: tag, color: color, itemId: item.id, type: 'primary' });
                        }
                    }
                });
                
                // 处理closing类型的标签
                if (selection.closing.id) {
                    if (selection.closing.subOptions.length > 0) {
                        // 有二级选项时，收集二级选项标签
                        selection.closing.subOptions.forEach(subIndex => {
                            const tag = getSubOptionTag(selection.closing.id, subIndex);
                            const color = getSubOptionTagColor(selection.closing.id, subIndex);
                            if (tag) {
                                tags.push({ name: tag, color: color, itemId: selection.closing.id, subIndex: subIndex, type: 'sub' });
                            }
                        });
                    } else {
                        // 无二级选项时，收集一级选项标签
                        const tag = getPrimaryOptionTag(selection.closing.id);
                        const color = getPrimaryOptionTagColor(selection.closing.id);
                        if (tag) {
                            tags.push({ name: tag, color: color, itemId: selection.closing.id, type: 'primary' });
                        }
                    }
                }
                
                const favoriteScript = {
                    id: 'fs' + Date.now(),
                    name: scriptName.trim() || '',
                    generatedText: generatedText.trim(),
                    selection: JSON.parse(JSON.stringify(selection)),
                    tags: tags,
                    createdAt: new Date().toLocaleString()
                };
                
                favoriteScripts.push(favoriteScript);
                saveFavoriteScripts();
                renderFavoriteScripts();
                
                showNotification('话术收藏成功！', 'success');
            }
        }

        // 保存收藏话术到本地存储
        function saveFavoriteScripts() {
            try {
                localStorage.setItem('favoriteScripts', JSON.stringify(favoriteScripts));
            } catch (e) {
                console.error('保存收藏话术失败:', e);
            }
        }
        
        // 从本地存储加载收藏话术
        function loadFavoriteScripts() {
            try {
                const saved = localStorage.getItem('favoriteScripts');
                if (saved) {
                    favoriteScripts = JSON.parse(saved);
                }
            } catch (e) {
                console.error('加载收藏话术失败:', e);
                favoriteScripts = [];
            }
        }
        
        // 更新标签筛选选项
        function updateTagFilterOptions() {
            const tagFilter = document.getElementById('tagFilter');
            if (!tagFilter) return;
            
            // 收集所有标签
            const allTags = new Set();
            favoriteScripts.forEach(script => {
                if (script.tags) {
                    script.tags.forEach(tag => {
                        // 获取最新的标签名称
                        let currentTagName;
                        if (tag.type === 'sub') {
                            currentTagName = getSubOptionTag(tag.itemId, tag.subIndex) || tag.name;
                        } else {
                            currentTagName = getPrimaryOptionTag(tag.itemId) || tag.name;
                        }
                        if (currentTagName) {
                            allTags.add(currentTagName);
                        }
                    });
                }
            });
            
            // 保存当前选择的值
            const currentValue = tagFilter.value;
            
            // 清空并重新填充选项
            tagFilter.innerHTML = '<option value="">选择标签分类</option>';
            Array.from(allTags).sort().forEach(tagName => {
                const option = document.createElement('option');
                option.value = tagName;
                option.textContent = tagName;
                tagFilter.appendChild(option);
            });
            
            // 恢复之前的选择（如果仍然存在）
            if (currentValue && allTags.has(currentValue)) {
                tagFilter.value = currentValue;
            }
        }
        
        // 更新快速访问按钮状态
        function updateQuickButtonState() {
            const allTagsQuickBtn = document.getElementById('allTagsQuickBtn');
            const smartFilterBtn = document.getElementById('smartFilterBtn');
            const recentUsedBtn = document.getElementById('recentUsedBtn');
            const tagFilter = document.getElementById('tagFilter');
            
            if (!allTagsQuickBtn || !smartFilterBtn || !recentUsedBtn) return;
            
            // 重置所有按钮为默认状态
            [smartFilterBtn, recentUsedBtn, allTagsQuickBtn].forEach(btn => {
                btn.classList.remove('bg-gradient-to-r', 'from-purple-500', 'to-purple-600', 'from-green-500', 'to-green-600', 'from-blue-500', 'to-blue-600', 'text-white', 'shadow-md');
                btn.classList.add('bg-gray-100', 'text-gray-700', 'border', 'border-gray-200', 'hover:bg-gray-200');
            });
            
            // 更新智能筛选按钮状态
            if (isSmartFilterMode) {
                smartFilterBtn.classList.remove('bg-gray-100', 'text-gray-700', 'border', 'border-gray-200', 'hover:bg-gray-200');
                smartFilterBtn.classList.add('bg-gradient-to-r', 'from-purple-500', 'to-purple-600', 'text-white', 'shadow-md');
            }
            
            // 更新最近使用按钮状态
            if (isRecentUsedMode) {
                recentUsedBtn.classList.remove('bg-gray-100', 'text-gray-700', 'border', 'border-gray-200', 'hover:bg-gray-200');
                recentUsedBtn.classList.add('bg-gradient-to-r', 'from-green-500', 'to-green-600', 'text-white', 'shadow-md');
            }
            
            // 更新所有标签按钮状态（当前是否选择了"所有标签"且未开启其他筛选模式）
            const isAllTagsSelected = !isSmartFilterMode && !isRecentUsedMode && !tagFilter?.value;
            if (isAllTagsSelected) {
                allTagsQuickBtn.classList.remove('bg-gray-100', 'text-gray-700', 'border', 'border-gray-200', 'hover:bg-gray-200');
                allTagsQuickBtn.classList.add('bg-gradient-to-r', 'from-blue-500', 'to-blue-600', 'text-white', 'shadow-md');
            }
        }
        
        // 渲染收藏话术到左侧收藏夹
        function renderFavoriteScripts() {
            // 更新标签筛选选项
            updateTagFilterOptions();
            const container = document.getElementById('favoritesList');
            const emptyState = document.getElementById('emptyFavorites');
            const countElement = document.getElementById('favoriteCount');
            
            if (!container) return;
            
            // 获取筛选条件
            const searchTerm = document.getElementById('favoriteSearch')?.value.toLowerCase() || '';
            const selectedTag = document.getElementById('tagFilter')?.value || '';
            
            // 获取基础筛选结果（最近使用、智能筛选或全部）
            let baseScripts;
            if (isRecentUsedMode) {
                baseScripts = getRecentUsedScripts();
            } else {
                baseScripts = getSmartFilteredScripts();
            }
            
            // 应用搜索和标签筛选
            let filteredScripts = baseScripts.filter(script => {
                const matchesSearch = !searchTerm || 
                    script.name.toLowerCase().includes(searchTerm) ||
                    script.generatedText.toLowerCase().includes(searchTerm);
                
                // 在智能筛选模式或最近使用模式下忽略标签筛选，否则应用标签筛选
                const matchesTag = isSmartFilterMode || isRecentUsedMode || !selectedTag || 
                    script.tags.some(tag => {
                        // 获取最新的标签名称
                        let currentTagName;
                        if (tag.type === 'sub') {
                            currentTagName = getSubOptionTag(tag.itemId, tag.subIndex) || tag.name;
                        } else {
                            currentTagName = getPrimaryOptionTag(tag.itemId) || tag.name;
                        }
                        return currentTagName === selectedTag;
                    });
                
                return matchesSearch && matchesTag;
            });
            
            // 更新计数
            if (countElement) {
                countElement.textContent = filteredScripts.length;
            }
            
            // 清空容器并设置两列网格布局
            container.innerHTML = '';
            container.className = 'grid grid-cols-2 gap-3 p-2';
            
            // 显示/隐藏空状态
            if (filteredScripts.length === 0) {
                if (emptyState) {
                    emptyState.classList.remove('hidden');
                }
                return;
            } else {
                if (emptyState) {
                    emptyState.classList.add('hidden');
                }
            }
            
            // 渲染收藏话术项目
            filteredScripts.forEach(script => {
                const div = document.createElement('div');
                div.className = 'group relative p-2 border border-gray-200 rounded-lg cursor-pointer transition-all hover:border-blue-400 hover:shadow-sm bg-white overflow-hidden';
                div.setAttribute('data-id', script.id);
                
                // 构建标签显示，与二级选项显示逻辑保持一致
                let tagsHtml = '';
                if (script.tags && script.tags.length > 0) {
                    const tagElements = script.tags.map(tag => {
                        // 获取最新的标签信息（实时同步）
                        let currentTagName, currentTagColor;
                        if (tag.type === 'sub') {
                            currentTagName = getSubOptionTag(tag.itemId, tag.subIndex) || tag.name;
                            currentTagColor = getSubOptionTagColor(tag.itemId, tag.subIndex) || tag.color;
                        } else {
                            currentTagName = getPrimaryOptionTag(tag.itemId) || tag.name;
                            currentTagColor = getPrimaryOptionTagColor(tag.itemId) || tag.color;
                        }
                        
                        return `<span class="inline-block px-1.5 py-0.5 text-xs rounded text-white font-medium mr-1 mb-1" style="background-color: ${currentTagColor || '#6b7280'}">${currentTagName}</span>`;
                    }).join('');
                    tagsHtml = `<div class="flex flex-wrap mb-2">${tagElements}</div>`;
                }
                
                div.innerHTML = `
                    <div class="relative h-full">
                        <!-- 删除按钮 - 右上角外边缘 -->
                        <button class="delete-script-btn absolute -top-2 -right-2 w-5 h-5 bg-red-500 hover:bg-red-600 text-white rounded-full opacity-0 group-hover:opacity-100 transition-opacity z-10 flex items-center justify-center" title="删除">
                            <i class="fas fa-times text-xs"></i>
                        </button>
                        
                        <!-- 编辑按钮 - 右下角 -->
                        <button class="edit-script-btn absolute -bottom-2 -right-2 w-5 h-5 bg-blue-500 hover:bg-blue-600 text-white rounded-full opacity-0 group-hover:opacity-100 transition-opacity z-10 flex items-center justify-center" title="编辑">
                            <i class="fas fa-edit text-xs"></i>
                        </button>
                        
                        <!-- 话术名称 -->
                        <div class="mb-2">
                            ${script.name && script.name.trim() ? 
                                `<h4 class="font-medium text-sm text-gray-900 group-hover:text-blue-600 transition-colors truncate" title="${script.name}">${script.name}</h4>` : 
                                `<div class="h-5"></div>`
                            }
                        </div>
                        
                        <!-- 标签 -->
                        ${tagsHtml}
                        
                        <!-- 话术预览 -->
                        <div class="text-xs text-gray-600 line-clamp-3 leading-relaxed">
                            ${script.generatedText.substring(0, 60)}${script.generatedText.length > 60 ? '...' : ''}
                        </div>
                        

                    </div>
                `;
                
                // 添加左键点击复制事件
                div.addEventListener('click', function(e) {
                    // 阻止编辑和删除按钮的事件冒泡
                    if (e.target.closest('.edit-script-btn') || e.target.closest('.delete-script-btn')) {
                        return;
                    }
                    
                    // 复制话术到剪贴板
                    navigator.clipboard.writeText(script.generatedText).then(() => {
                        showNotification('话术已复制到剪贴板', 'success');
                    }).catch(err => {
                        console.error('复制失败:', err);
                        showNotification('复制失败', 'error');
                    });
                });
                
                // 添加右键点击恢复事件
                div.addEventListener('contextmenu', function(e) {
                    e.preventDefault();
                    
                    // 阻止编辑和删除按钮的事件冒泡
                    if (e.target.closest('.edit-script-btn') || e.target.closest('.delete-script-btn')) {
                        return;
                    }
                    
                    // 恢复选择状态
                    if (script.selection) {
                        selection = JSON.parse(JSON.stringify(script.selection));
                        renderAllContent();
                        updateResult();
                        
                        // 同时恢复生成的话术文本
                        const generatedContainer = document.getElementById('generatedContainer');
                        const preElement = document.createElement('pre');
                        preElement.className = 'whitespace-pre-wrap font-sans';
                        preElement.textContent = script.generatedText;
                        generatedContainer.innerHTML = '';
                        generatedContainer.appendChild(preElement);
                        
                        // 调整生成文本框高度和更新字数统计
                        adjustGeneratedContainerHeight();
                        updateCharCount();
                        
                        showNotification('选择状态已恢复', 'success');
                    } else {
                        showNotification('没有保存的选择状态', 'warning');
                    }
                });
                
                // 删除收藏话术
                div.querySelector('.delete-script-btn').addEventListener('click', function(e) {
                    e.stopPropagation();
                    deleteFavoriteScript(script.id);
                });
                
                // 编辑收藏话术
                div.querySelector('.edit-script-btn').addEventListener('click', function(e) {
                    e.stopPropagation();
                    editFavoriteScript(script.id);
                });
                
                container.appendChild(div);
            });
            
            updateFavoriteCount(favoriteScripts.length);
            
            // 更新快速访问按钮状态
            updateQuickButtonState();
        }
        
        // 更新收藏夹数量显示
        function updateFavoriteCount(count) {
            const countElement = document.getElementById('favoriteCount');
            if (countElement) {
                countElement.textContent = count;
            }
        }
        
        // 新的收藏夹管理函数
        
        // 收藏夹相关函数已移除

        // 应用收藏话术
        function applyFavoriteScript(scriptId) {
            const script = favoriteScripts.find(s => s.id === scriptId);
            if (script && script.selection) {
                selection = JSON.parse(JSON.stringify(script.selection));
                renderAllContent();
                updateResult();
                
                // 同时恢复生成的话术文本
                const generatedContainer = document.getElementById('generatedContainer');
                const preElement = document.createElement('pre');
                preElement.className = 'whitespace-pre-wrap font-sans';
                preElement.textContent = script.generatedText;
                generatedContainer.innerHTML = '';
                generatedContainer.appendChild(preElement);
                
                // 调整生成文本框高度和更新字数统计
                adjustGeneratedContainerHeight();
                updateCharCount();
                
                showNotification(`已恢复选择：${script.name}`, 'success');
            }
        }
        
        // 复制收藏话术
        function copyFavoriteScript(scriptId) {
            const script = favoriteScripts.find(s => s.id === scriptId);
            if (script && script.generatedText) {
                navigator.clipboard.writeText(script.generatedText.trim()).then(() => {
                    // 记录使用时间
                    recordScriptUsage(scriptId);
                    // 更新按钮状态和计数
                    updateQuickButtonState();
                    showNotification(`已复制话术：${script.name || '未命名话术'}`, 'success');
                }).catch(err => {
                    console.error('复制失败:', err);
                    showNotification('复制失败，请手动复制', 'error');
                });
            }
        }
        
        // 编辑收藏话术
        async function editFavoriteScript(scriptId) {
            const script = favoriteScripts.find(s => s.id === scriptId);
            if (!script) return;
            
            // 创建编辑对话框
            const editDialog = document.createElement('div');
            editDialog.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            editDialog.innerHTML = `
                <div class="bg-white rounded-lg p-6 w-96 max-w-full mx-4">
                    <h3 class="text-lg font-semibold mb-4">编辑收藏话术</h3>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">话术名称</label>
                        <input type="text" id="editScriptName" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary" value="${script.name || ''}" placeholder="请输入话术名称">
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">话术内容</label>
                        <textarea id="editScriptContent" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary h-32 resize-none" placeholder="请输入话术内容">${script.generatedText}</textarea>
                    </div>
                    <div class="flex justify-end space-x-3">
                        <button id="cancelEdit" class="px-4 py-2 text-gray-600 hover:text-gray-800">取消</button>
                        <button id="confirmEdit" class="px-4 py-2 bg-primary text-white rounded-md hover:bg-primary-dark">确定</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(editDialog);
            
            // 聚焦到名称输入框
            const nameInput = editDialog.querySelector('#editScriptName');
            nameInput.focus();
            nameInput.select();
            
            // 取消按钮事件
            editDialog.querySelector('#cancelEdit').addEventListener('click', () => {
                document.body.removeChild(editDialog);
            });
            
            // 确定按钮事件
            editDialog.querySelector('#confirmEdit').addEventListener('click', () => {
                const newName = nameInput.value.trim();
                const newContent = editDialog.querySelector('#editScriptContent').value.trim();
                
                if (!newContent) {
                    showNotification('话术内容不能为空', 'error');
                    return;
                }
                
                script.name = newName;
                script.generatedText = newContent;
                saveFavoriteScripts();
                renderFavoriteScripts();
                showNotification('收藏话术修改成功！', 'success');
                document.body.removeChild(editDialog);
            });
            
            // 点击背景关闭
            editDialog.addEventListener('click', (e) => {
                if (e.target === editDialog) {
                    document.body.removeChild(editDialog);
                }
            });
        }

        // 删除收藏话术
        async function deleteFavoriteScript(scriptId) {
            const script = favoriteScripts.find(s => s.id === scriptId);
            const confirmed = await showCustomConfirm(`确定要删除收藏话术"${script.name || '未命名话术'}"吗？`);
            if (script && confirmed) {
                favoriteScripts = favoriteScripts.filter(s => s.id !== scriptId);
                saveFavoriteScripts();
                renderFavoriteScripts();
                showNotification('收藏话术删除成功！', 'success');
            }
        }
        
        // 同步收藏话术中的标签名称
        function syncFavoriteScriptTags(itemId, subOptionIndex, oldTagName, newTagName) {
            let hasChanges = false;
            
            favoriteScripts.forEach(script => {
                if (script.tags && script.tags.length > 0) {
                    script.tags.forEach(tag => {
                        // 找到匹配的标签并更新
                        if (tag.itemId === itemId && tag.subIndex === subOptionIndex) {
                            if (newTagName) {
                                // 更新标签名称
                                if (tag.name !== newTagName) {
                                    tag.name = newTagName;
                                    hasChanges = true;
                                }
                            } else {
                                // 删除标签（将在下面的过滤中处理）
                                tag.toDelete = true;
                                hasChanges = true;
                            }
                        }
                    });
                    
                    // 移除标记为删除的标签
                    script.tags = script.tags.filter(tag => !tag.toDelete);
                }
            });
            
            if (hasChanges) {
                saveFavoriteScripts();
                renderFavoriteScripts();
            }
        }
        
        // 同步收藏话术中的标签颜色
        function syncFavoriteScriptTagColors(itemId, subOptionIndex, newColor) {
            let hasChanges = false;
            
            favoriteScripts.forEach(script => {
                if (script.tags && script.tags.length > 0) {
                    script.tags.forEach(tag => {
                        // 找到匹配的标签并更新颜色
                        if (tag.itemId === itemId && tag.subIndex === subOptionIndex) {
                            if (tag.color !== newColor) {
                                tag.color = newColor;
                                hasChanges = true;
                            }
                        }
                    });
                }
            });
            
            if (hasChanges) {
                saveFavoriteScripts();
                renderFavoriteScripts();
            }
        }
        
        // 同步收藏话术中的一级选项标签名称
        function syncFavoriteScriptPrimaryTags(itemId, oldTagName, newTagName) {
            let hasChanges = false;
            
            favoriteScripts.forEach(script => {
                if (script.tags && script.tags.length > 0) {
                    script.tags.forEach(tag => {
                        // 找到匹配的一级选项标签并更新
                        if (tag.itemId === itemId && tag.type === 'primary') {
                            if (newTagName) {
                                // 更新标签名称
                                if (tag.name !== newTagName) {
                                    tag.name = newTagName;
                                    hasChanges = true;
                                }
                            } else {
                                // 删除标签（将在下面的过滤中处理）
                                tag.toDelete = true;
                                hasChanges = true;
                            }
                        }
                    });
                    
                    // 移除标记为删除的标签
                    script.tags = script.tags.filter(tag => !tag.toDelete);
                }
            });
            
            if (hasChanges) {
                saveFavoriteScripts();
                renderFavoriteScripts();
            }
        }
        
        // 同步收藏话术中的一级选项标签颜色
        function syncFavoriteScriptPrimaryTagColors(itemId, newColor) {
            let hasChanges = false;
            
            favoriteScripts.forEach(script => {
                if (script.tags && script.tags.length > 0) {
                    script.tags.forEach(tag => {
                        // 找到匹配的一级选项标签并更新颜色
                        if (tag.itemId === itemId && tag.type === 'primary') {
                            if (tag.color !== newColor) {
                                tag.color = newColor;
                                hasChanges = true;
                            }
                        }
                    });
                }
            });
            
            if (hasChanges) {
                saveFavoriteScripts();
                renderFavoriteScripts();
            }
        }
        
        // 应用收藏
        function applyFavorite(favoriteId) {
            const favorite = favorites.find(f => f.id === favoriteId);
            if (favorite && favorite.selection) {
                selection = JSON.parse(JSON.stringify(favorite.selection));
                renderAllContent();
                updateResult();
                
                // 添加到最近使用
                addToRecentFavorites(favoriteId);
                
                showNotification(`已应用收藏：${favorite.name}`, 'success');
            }
        }

        // 收藏夹相关函数已移除
            
            // 收藏夹相关函数已移除


        // 打开网页总设置面板
        function openWebSettings() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center';
            modal.innerHTML = `
                <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
                    <div class="p-6">
                        <h3 class="text-xl font-semibold mb-6 flex items-center gap-2">
                            <i class="fa fa-cogs text-primary"></i>
                            网页总设置
                        </h3>
                        
                        <!-- 设置选项卡 -->
                        <div class="mb-6">
                            <div class="flex border-b">
                                <button class="tab-btn active px-4 py-2 border-b-2 border-primary text-primary font-medium" data-tab="api">
                                    <i class="fa fa-plug mr-1"></i> API配置
                                </button>
                                <button class="tab-btn px-4 py-2 border-b-2 border-transparent text-gray-600 hover:text-primary" data-tab="config">
                                    <i class="fa fa-folder mr-1"></i> 配置管理
                                </button>
                                <button class="tab-btn px-4 py-2 border-b-2 border-transparent text-gray-600 hover:text-primary" data-tab="display">
                                    <i class="fa fa-desktop mr-1"></i> 显示设置
                                </button>
                            </div>
                        </div>
                        
                        <!-- API配置选项卡 -->
                        <div id="apiTab" class="tab-content">
                            <h4 class="text-lg font-medium mb-4 flex items-center gap-2">
                                <i class="fa fa-cog text-primary"></i>
                                API配置设置
                            </h4>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium mb-2">扣子API密钥：</label>
                                <input type="password" id="apiKey" class="w-full p-2 border rounded" placeholder="请输入您的扣子API密钥" value="">
                                <p class="text-xs text-gray-500 mt-1">用于调用扣子智能体API的认证密钥</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">机器人ID：</label>
                                <input type="text" id="botId" class="w-full p-2 border rounded" placeholder="请输入机器人ID" value="">
                                <p class="text-xs text-gray-500 mt-1">您在扣子平台创建的智能体机器人ID</p>
                            </div>
                            <div class="mb-4">
                                <button type="button" id="testApiBtn" class="w-full px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 disabled:bg-gray-400 disabled:cursor-not-allowed">
                                    <i class="fa fa-flask mr-1"></i>
                                    测试API连接
                                </button>
                                <div id="testResult" class="mt-2 text-sm hidden"></div>
                            </div>
                            <div class="bg-green-50 p-3 rounded mb-3">
                                <p class="text-sm text-green-700">
                                    <i class="fa fa-file-code mr-1"></i>
                                    <strong>新特性：</strong> 配置现在直接保存在HTML文件中，不再使用浏览器缓存。即使清除缓存也不会丢失配置！
                                </p>
                            </div>
                                <div class="bg-blue-50 p-3 rounded">
                                    <p class="text-sm text-blue-700">
                                        <i class="fa fa-info-circle mr-1"></i>
                                        配置完成后，点击"生成话术"按钮将调用您的扣子智能体API来优化话术内容。
                                    </p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 配置管理选项卡 -->
                        <div id="configTab" class="tab-content hidden">
                            <h4 class="text-lg font-medium mb-4 flex items-center gap-2">
                                <i class="fa fa-folder text-primary"></i>
                                配置管理
                            </h4>
                            <div class="space-y-4">
                                <!-- 当前配置选择 -->
                                <div class="bg-blue-50 p-4 rounded">
                                    <h5 class="font-medium mb-3 flex items-center gap-2">
                                        <i class="fa fa-list mr-1"></i>
                                        当前配置
                                    </h5>
                                    <div class="flex gap-2 items-center">
                                        <select id="configSelector" class="flex-1 p-2 border rounded">
                                            <option value="default">默认配置</option>
                                        </select>
                                        <button id="switchConfigBtn" class="px-3 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">
                                            <i class="fa fa-exchange mr-1"></i>切换
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- 配置操作 -->
                                <div class="bg-gray-50 p-4 rounded">
                                    <h5 class="font-medium mb-3 flex items-center gap-2">
                                        <i class="fa fa-cogs mr-1"></i>
                                        配置操作
                                    </h5>
                                    <div class="grid grid-cols-2 gap-2">
                                        <button id="createConfigBtn" class="px-3 py-2 bg-green-500 text-white rounded hover:bg-green-600 text-sm">
                                            <i class="fa fa-plus mr-1"></i>新建配置
                                        </button>
                                        <button id="renameConfigBtn" class="px-3 py-2 bg-yellow-500 text-white rounded hover:bg-yellow-600 text-sm">
                                            <i class="fa fa-edit mr-1"></i>重命名
                                        </button>
                                        <button id="duplicateConfigBtn" class="px-3 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 text-sm">
                                            <i class="fa fa-copy mr-1"></i>复制配置
                                        </button>
                                        <button id="deleteConfigBtn" class="px-3 py-2 bg-red-500 text-white rounded hover:bg-red-600 text-sm">
                                            <i class="fa fa-trash mr-1"></i>删除配置
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- 导入导出 -->
                                <div class="bg-green-50 p-4 rounded">
                                    <h5 class="font-medium mb-3 flex items-center gap-2">
                                        <i class="fa fa-exchange mr-1"></i>
                                        导入导出
                                    </h5>
                                    <div class="grid grid-cols-2 gap-2">
                                        <button id="exportConfigBtn" class="px-3 py-2 bg-indigo-500 text-white rounded hover:bg-indigo-600 text-sm">
                                            <i class="fa fa-download mr-1"></i>导出配置
                                        </button>
                                        <button id="importConfigBtn" class="px-3 py-2 bg-purple-500 text-white rounded hover:bg-purple-600 text-sm">
                                            <i class="fa fa-upload mr-1"></i>导入配置
                                        </button>
                                    </div>
                                    <input type="file" id="importConfigFile" accept=".json" class="hidden">
                                </div>
                                
                                <!-- 配置信息 -->
                                <div class="bg-yellow-50 p-4 rounded">
                                    <h5 class="font-medium mb-2 flex items-center gap-2">
                                        <i class="fa fa-info-circle mr-1"></i>
                                        配置说明
                                    </h5>
                                    <div class="text-sm text-gray-600 space-y-1">
                                        <p>• 配置包含：收藏夹内容、选择面板结构、选项类别、标签等</p>
                                        <p>• 所有修改会自动保存到当前配置中</p>
                                        <p>• 导出的配置文件可在其他设备上导入使用</p>
                                        <p>• 导入时会自动处理名称冲突，避免覆盖已有配置</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 显示设置选项卡 -->
                        <div id="displayTab" class="tab-content hidden">
                            <h4 class="text-lg font-medium mb-4 flex items-center gap-2">
                                <i class="fa fa-desktop text-primary"></i>
                                显示设置
                            </h4>
                            <div class="space-y-4">
                                <div class="bg-gray-50 p-4 rounded">
                                    <h5 class="font-medium mb-2">界面主题</h5>
                                    <div class="space-y-2">
                                        <label class="flex items-center">
                                            <input type="radio" name="theme" value="light" class="mr-2" checked>
                                            <span>浅色主题</span>
                                        </label>
                                        <label class="flex items-center">
                                            <input type="radio" name="theme" value="dark" class="mr-2" disabled>
                                            <span class="text-gray-400">深色主题 (开发中)</span>
                                        </label>
                                    </div>
                                </div>
                                <div class="bg-gray-50 p-4 rounded">
                                    <h5 class="font-medium mb-2">字体大小</h5>
                                    <select class="w-full p-2 border rounded">
                                        <option value="small">小号字体</option>
                                        <option value="medium" selected>中号字体</option>
                                        <option value="large">大号字体</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        

                        
                        <div class="flex gap-2 justify-end mt-6">
                            <button type="button" id="cancelSettings" class="px-4 py-2 text-gray-600 hover:text-gray-800">取消</button>
                            <button type="button" id="saveSettings" class="px-4 py-2 bg-primary text-white rounded hover:bg-primary/90">保存设置</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // 设置输入框的默认值
            document.getElementById('apiKey').value = getApiKey();
            document.getElementById('botId').value = getBotId();
            
            // 选项卡切换逻辑
            const tabBtns = modal.querySelectorAll('.tab-btn');
            const tabContents = modal.querySelectorAll('.tab-content');
            
            tabBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    const targetTab = this.getAttribute('data-tab');
                    
                    // 更新按钮状态
                    tabBtns.forEach(b => {
                        b.classList.remove('active', 'border-primary', 'text-primary');
                        b.classList.add('border-transparent', 'text-gray-600');
                    });
                    this.classList.add('active', 'border-primary', 'text-primary');
                    this.classList.remove('border-transparent', 'text-gray-600');
                    
                    // 更新内容显示
                    tabContents.forEach(content => {
                        content.classList.add('hidden');
                    });
                    document.getElementById(targetTab + 'Tab').classList.remove('hidden');
                    
                    // 如果切换到配置管理选项卡，初始化配置选择器
                    if (targetTab === 'config') {
                        updateConfigSelector();
                    }
                });
            });
            
            // 初始化配置管理事件监听器
            setupConfigManagementListeners(modal);
            
            // 取消按钮
            document.getElementById('cancelSettings').addEventListener('click', function() {
                document.body.removeChild(modal);
            });
            
            // 测试API连接按钮
            document.getElementById('testApiBtn').addEventListener('click', async function() {
                const apiKey = document.getElementById('apiKey').value.trim();
                const botId = document.getElementById('botId').value.trim();
                const testBtn = this;
                const testResult = document.getElementById('testResult');
                
                if (!apiKey || !botId) {
                    testResult.className = 'mt-2 text-sm text-red-600';
                    testResult.textContent = '请先填写API密钥和机器人ID';
                    testResult.classList.remove('hidden');
                    return;
                }
                
                // 显示测试中状态
                testBtn.disabled = true;
                testBtn.innerHTML = '<i class="fa fa-spinner fa-spin mr-1"></i>测试中...';
                testResult.className = 'mt-2 text-sm text-blue-600';
                testResult.textContent = '正在测试API连接...';
                testResult.classList.remove('hidden');
                
                try {
                    const response = await fetch('https://api.coze.cn/v3/chat', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${apiKey}`
                        },
                        body: JSON.stringify({
                            bot_id: botId,
                            user_id: '123123',
                            stream: false,
                            auto_save_history: true,
                            additional_messages: [
                                {
                                    role: 'user',
                                    content: '测试连接',
                                    content_type: 'text'
                                }
                            ]
                        })
                    });
                    
                    console.log('API测试响应状态:', response.status);
                    console.log('API测试响应头:', response.headers);
                    
                    if (response.ok) {
                        const data = await response.json();
                        console.log('API测试响应数据:', data);
                        
                        // 检查API响应是否包含有效内容
                        let hasValidResponse = false;
                        let responseContent = '';
                        let debugInfo = '';
                        
                        // 获取消息数组
                        const messages = data.messages || (data.data && data.data.messages) || [];
                        console.log('找到消息数量:', messages.length);
                        
                        if (messages.length > 0) {
                            // 查找assistant消息，使用更宽松的过滤条件
                            const assistantMessages = messages.filter(msg => {
                                const isAssistant = msg.role === 'assistant';
                                const hasContent = msg.content && typeof msg.content === 'string' && msg.content.trim() !== '';
                                console.log(`消息检查 - 角色: ${msg.role}, 有内容: ${hasContent}, 内容: "${msg.content}"`);
                                return isAssistant && hasContent;
                            });
                            
                            console.log('找到assistant消息数量:', assistantMessages.length);
                            
                            if (assistantMessages.length > 0) {
                                hasValidResponse = true;
                                responseContent = assistantMessages[0].content;
                                console.log('使用的回复内容:', responseContent);
                            } else {
                                // 如果没有找到assistant消息，提供调试信息
                                debugInfo = `找到 ${messages.length} 条消息，但没有有效的assistant回复。`;
                                if (messages.length > 0) {
                                    debugInfo += ` 消息角色: ${messages.map(m => m.role).join(', ')}`;
                                }
                            }
                        } else {
                            debugInfo = '响应中没有找到消息数组。';
                        }
                        
                        if (hasValidResponse) {
                            testResult.className = 'mt-2 text-sm text-green-600';
                            testResult.innerHTML = `<i class="fa fa-check-circle mr-1"></i>API连接测试成功！机器人回复："${responseContent.substring(0, 50)}${responseContent.length > 50 ? '...' : ''}"`;
                        } else {
                            testResult.className = 'mt-2 text-sm text-yellow-600';
                            testResult.innerHTML = `<i class="fa fa-exclamation-triangle mr-1"></i>API连接成功，但未获取到有效回复内容。${debugInfo} <a href="debug-api.html" target="_blank" style="color: #007bff; text-decoration: underline;">点击这里使用详细诊断工具</a>`;
                        }
                    } else {
                        const errorText = await response.text();
                        console.log('API测试错误响应:', errorText);
                        
                        let errorMsg = 'API连接失败';
                        if (response.status === 401) {
                            errorMsg = 'API密钥无效或已过期';
                        } else if (response.status === 403) {
                            errorMsg = '权限不足或机器人ID无效';
                        } else if (response.status === 429) {
                            errorMsg = '请求频率过高，请稍后重试';
                        } else if (response.status >= 500) {
                            errorMsg = '服务器内部错误';
                        }
                        
                        testResult.className = 'mt-2 text-sm text-red-600';
                        testResult.innerHTML = `<i class="fa fa-times-circle mr-1"></i>${errorMsg} (状态码: ${response.status})`;
                    }
                } catch (error) {
                    console.error('API测试网络错误:', error);
                    testResult.className = 'mt-2 text-sm text-red-600';
                    testResult.innerHTML = '<i class="fa fa-times-circle mr-1"></i>网络连接错误或CORS问题';
                } finally {
                    // 恢复按钮状态
                    testBtn.disabled = false;
                    testBtn.innerHTML = '<i class="fa fa-flask mr-1"></i>测试API连接';
                }
            });
            
            // 保存设置按钮
            document.getElementById('saveSettings').addEventListener('click', function() {
                // 保存API配置
                const apiKey = document.getElementById('apiKey').value.trim();
                const botId = document.getElementById('botId').value.trim();
                
                if (!apiKey || !botId) {
                    showNotification('请填写完整的API配置信息', 'error');
                    return;
                }
                
                // 保存API配置到文件变量
                saveApiConfig(apiKey, botId);
                
                // 保存显示设置
                const selectedTheme = modal.querySelector('input[name="theme"]:checked')?.value || 'light';
                const selectedFontSize = modal.querySelector('select')?.value || 'medium';
                
                // 这里可以添加保存显示设置的逻辑
                console.log('保存的设置:', { theme: selectedTheme, fontSize: selectedFontSize });
                
                showNotification('设置保存成功！', 'success');
                document.body.removeChild(modal);
            });
            

            
            // 点击模态框外部关闭
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    document.body.removeChild(modal);
                }
            });
        }

        // 打开收藏设置
        function openFavoriteSettings() {
            showNotification('收藏设置功能开发中...', 'info');
        }

        // 获取API密钥
        function getApiKey() {
            return API_CONFIG.apiKey || '';
        }
        
        // 获取机器人ID
        function getBotId() {
            return API_CONFIG.botId || '';
        }
        
        // 保存API配置到文件变量（替代localStorage）
        function saveApiConfig(apiKey, botId) {
            API_CONFIG.apiKey = apiKey || '';
            API_CONFIG.botId = botId || '';
            console.log('API配置已保存到文件变量');
        }
        
        // 清除API配置
        function clearApiConfig() {
            API_CONFIG.apiKey = '';
            API_CONFIG.botId = '';
            console.log('API配置已清除');
        }
        
        // 检查API配置是否完整
        function isApiConfigured() {
            return getApiKey() && getBotId();
        }

        // 页面初始化完成后的额外处理
        document.addEventListener('DOMContentLoaded', function() {
            // 初始化标签按钮状态
            setTimeout(() => {
                initializeTagButtonStates();
            }, 100);
            
            // 初始化字数统计
            updateCharCount();
            
            // 为生成文本框添加输入事件监听器
            const generatedContainer = document.getElementById('generatedContainer');
            if (generatedContainer) {
                generatedContainer.addEventListener('input', updateCharCount);
                generatedContainer.addEventListener('paste', function() {
                    setTimeout(updateCharCount, 10); // 延迟更新以确保粘贴内容已处理
                });
            }
        });
        
        // 设置弹窗相关功能
        document.getElementById('settingsBtn').addEventListener('click', function() {
            document.getElementById('settingsModal').style.display = 'flex';
        });
        
        // 关闭设置弹窗
        function closeSettingsModal() {
            document.getElementById('settingsModal').style.display = 'none';
        }
        
        // 修改类别名称
        function editCategoryName(categoryKey) {
            const currentName = getCategoryDisplayName(categoryKey);
            showInputDialog('修改类别名称', '请输入新的类别名称:', currentName, function(newName) {
                if (newName && newName.trim() && newName !== currentName) {
                    showConfirmDialog(`确定要将"${currentName}"修改为"${newName}"吗？`, function() {
                        // 更新类别显示名称
                        updateCategoryDisplayName(categoryKey, newName.trim());
                        // 重新渲染界面
                        renderAllContent();
                        showNotification('类别名称修改成功！', 'success');
                    });
                }
            });
        }
        
        // 修改类别说明
        function editCategoryDescription(categoryKey) {
            const currentDescription = getCategoryDescription(categoryKey);
            showInputDialog('修改类别说明', '请输入类别说明（可选）:', currentDescription, function(newDescription) {
                // 更新类别说明
                updateCategoryDescription(categoryKey, newDescription ? newDescription.trim() : '');
                // 重新渲染界面
                renderAllContent();
                showNotification('类别说明修改成功！', 'success');
            });
        }
        
        // 新增类别
        function addNewCategory() {
            showInputDialog('新增类别', '请输入新类别的名称:', '', function(categoryName) {
                if (categoryName && categoryName.trim()) {
                    const categoryKey = 'custom_' + Date.now();
                    showConfirmDialog(`确定要添加新类别"${categoryName}"吗？`, function() {
                        // 添加新类别到数据结构
                        addCategory(categoryKey, categoryName.trim());
                        // 重新渲染界面
                        renderAllContent();
                        showNotification('新类别添加成功！', 'success');
                    });
                }
            });
        }
        
        // 删除类别
        function deleteCategory(categoryKey) {
            const categoryName = getCategoryDisplayName(categoryKey);
            const itemCount = getItemCountInCategory(categoryKey);
            const message = itemCount > 0 
                ? `确定要删除类别"${categoryName}"吗？\n这将同时删除该类别下的 ${itemCount} 个选项。`
                : `确定要删除类别"${categoryName}"吗？`;
            
            showConfirmDialog(message, function() {
                // 删除类别及其下的所有选项
                removeCategoryAndItems(categoryKey);
                // 重新渲染界面
                renderAllContent();
                showNotification('类别删除成功！', 'success');
            });
        }
        
        // 显示输入对话框
        function showInputDialog(title, message, defaultValue, callback) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-lg shadow-xl max-w-sm w-full mx-4">
                    <div class="p-6">
                        <h3 class="text-lg font-semibold mb-4">${title}</h3>
                        <p class="text-gray-600 mb-4">${message}</p>
                        <input type="text" id="inputDialogValue" class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" value="${defaultValue}" placeholder="请输入...">
                        <div class="flex gap-2 mt-6">
                            <button onclick="closeInputDialog(false)" class="flex-1 px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600">取消</button>
                            <button onclick="closeInputDialog(true)" class="flex-1 px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">确定</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            const input = document.getElementById('inputDialogValue');
            input.focus();
            input.select();
            
            // 回车确认
            input.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    closeInputDialog(true);
                }
            });
            
            window.closeInputDialog = function(confirmed) {
                const value = input.value.trim();
                document.body.removeChild(modal);
                if (confirmed && callback) {
                    callback(value);
                }
                delete window.closeInputDialog;
            };
        }
        
        // 显示确认对话框
        function showConfirmDialog(message, callback) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-lg shadow-xl max-w-sm w-full mx-4">
                    <div class="p-6">
                        <h3 class="text-lg font-semibold mb-4">确认操作</h3>
                        <p class="text-gray-600 mb-6">${message}</p>
                        <div class="flex gap-2">
                            <button onclick="closeConfirmDialog(false)" class="flex-1 px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600">取消</button>
                            <button onclick="closeConfirmDialog(true)" class="flex-1 px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600">确定</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            window.closeConfirmDialog = function(confirmed) {
                document.body.removeChild(modal);
                if (confirmed && callback) {
                    callback();
                }
                delete window.closeConfirmDialog;
            };
        }
        
        // 获取类别显示名称
        function getCategoryDisplayName(categoryKey) {
            // 先从本地存储获取自定义名称
            const customNames = getCustomCategoryNames();
            if (customNames[categoryKey]) {
                return customNames[categoryKey];
            }
            
            // 如果没有自定义名称，使用默认名称
            const categoryNames = {
                'greeting': '起手称呼式',
                'strength': '优点',
                'issue': '问题',
                'closing': '结尾式'
            };
            return categoryNames[categoryKey] || categoryKey;
        }
        
        // 获取自定义类别名称
        function getCustomCategoryNames() {
            try {
                const saved = localStorage.getItem('customCategoryNames');
                return saved ? JSON.parse(saved) : {};
            } catch (e) {
                console.error('读取自定义类别名称失败:', e);
                return {};
            }
        }

        // 保存自定义类别名称
        function saveCustomCategoryNames(customNames) {
            try {
                localStorage.setItem('customCategoryNames', JSON.stringify(customNames));
            } catch (e) {
                console.error('保存自定义类别名称失败:', e);
            }
        }
        
        // 获取类别说明
        function getCategoryDescription(categoryKey) {
            try {
                const saved = localStorage.getItem('categoryDescriptions');
                const descriptions = saved ? JSON.parse(saved) : {};
                return descriptions[categoryKey] || '';
            } catch (e) {
                console.error('读取类别说明失败:', e);
                return '';
            }
        }
        
        // 保存类别说明
        function saveCategoryDescriptions(descriptions) {
            try {
                localStorage.setItem('categoryDescriptions', JSON.stringify(descriptions));
            } catch (e) {
                console.error('保存类别说明失败:', e);
            }
        }
        
        // 更新类别说明
        function updateCategoryDescription(categoryKey, description) {
            try {
                const saved = localStorage.getItem('categoryDescriptions');
                const descriptions = saved ? JSON.parse(saved) : {};
                if (description && description.trim()) {
                    descriptions[categoryKey] = description.trim();
                } else {
                    delete descriptions[categoryKey];
                }
                saveCategoryDescriptions(descriptions);
                // 更新界面显示
                updateCategoryTitles();
            } catch (e) {
                console.error('更新类别说明失败:', e);
            }
        }
        
        // 更新类别显示名称
        function updateCategoryDisplayName(categoryKey, newName) {
            const customNames = getCustomCategoryNames();
            customNames[categoryKey] = newName;
            saveCustomCategoryNames(customNames);
            // 更新界面显示
            updateCategoryTitles();
        }
        
        // 更新所有类别标题显示
        function updateCategoryTitles() {
            const categories = ['greeting', 'strength', 'issue', 'closing'];
            categories.forEach(categoryKey => {
                const displayName = getCategoryDisplayName(categoryKey);
                const description = getCategoryDescription(categoryKey);
                
                // 更新主页面标题
                const titleElement = document.getElementById(categoryKey + 'Title');
                if (titleElement) {
                    if (description) {
                        titleElement.innerHTML = `${displayName} <span class="text-xs text-gray-500 font-normal">(${description})</span>`;
                    } else {
                        titleElement.textContent = displayName;
                    }
                }
                
                // 更新设置弹窗中的编辑按钮文本
                const editElement = document.getElementById('edit' + categoryKey.charAt(0).toUpperCase() + categoryKey.slice(1) + 'Name');
                if (editElement) {
                    editElement.textContent = displayName;
                }
                
                // 更新设置弹窗中的删除按钮文本
                const deleteElement = document.getElementById('delete' + categoryKey.charAt(0).toUpperCase() + categoryKey.slice(1) + 'Name');
                if (deleteElement) {
                    deleteElement.textContent = displayName;
                }
            });
        }
        
        // 添加新类别
        function addCategory(categoryKey, categoryName) {
            // 这里可以添加保存到本地存储的逻辑
            console.log(`添加新类别 ${categoryKey}: ${categoryName}`);
        }
        
        // 获取类别下的选项数量
        function getItemCountInCategory(categoryKey) {
            const container = document.getElementById(categoryKey + 'Container');
            return container ? container.children.length : 0;
        }
        
        // 删除类别及其选项
        function removeCategoryAndItems(categoryKey) {
            // 这里可以添加从本地存储删除的逻辑
            console.log(`删除类别及其选项: ${categoryKey}`);
        }
    </script>
    
    <!-- 设置弹窗 -->
    <div id="settingsModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" style="display: none;">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4 max-h-[80vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold">修改设置</h3>
                    <button onclick="closeSettingsModal()" class="text-gray-400 hover:text-gray-600 text-xl">
                        <i class="fa fa-times"></i>
                    </button>
                </div>
                
                <div class="space-y-4">
                    <!-- 修改现有类别 -->
                    <div>
                        <h4 class="font-medium mb-2 text-gray-700">修改现有类别</h4>
                        <div class="space-y-2">
                            <div class="border rounded-lg p-3">
                                <div class="flex items-center justify-between mb-2">
                                    <span id="editGreetingName">起手称呼式</span>
                                    <div class="flex flex-col gap-1 items-center">
                                        <button onclick="editCategoryName('greeting')" class="text-blue-500 hover:text-blue-700">
                                            <i class="fa fa-edit"></i>
                                        </button>
                                        <button onclick="deleteCategory('greeting')" class="text-red-600 hover:text-red-700">
                                            <i class="fa fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                                <button onclick="editCategoryDescription('greeting')" class="w-full text-left text-sm text-gray-600 hover:text-blue-600 flex items-center gap-1">
                                    <i class="fa fa-comment-o"></i>
                                    <span>编辑说明</span>
                                </button>
                            </div>
                            <div class="border rounded-lg p-3">
                                <div class="flex items-center justify-between mb-2">
                                    <span id="editStrengthName">优点</span>
                                    <div class="flex flex-col gap-1 items-center">
                                        <button onclick="editCategoryName('strength')" class="text-blue-500 hover:text-blue-700">
                                            <i class="fa fa-edit"></i>
                                        </button>
                                        <button onclick="deleteCategory('strength')" class="text-red-600 hover:text-red-700">
                                            <i class="fa fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                                <button onclick="editCategoryDescription('strength')" class="w-full text-left text-sm text-gray-600 hover:text-blue-600 flex items-center gap-1">
                                    <i class="fa fa-comment-o"></i>
                                    <span>编辑说明</span>
                                </button>
                            </div>
                            <div class="border rounded-lg p-3">
                                <div class="flex items-center justify-between mb-2">
                                    <span id="editIssueName">问题</span>
                                    <div class="flex flex-col gap-1 items-center">
                                        <button onclick="editCategoryName('issue')" class="text-blue-500 hover:text-blue-700">
                                            <i class="fa fa-edit"></i>
                                        </button>
                                        <button onclick="deleteCategory('issue')" class="text-red-600 hover:text-red-700">
                                            <i class="fa fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                                <button onclick="editCategoryDescription('issue')" class="w-full text-left text-sm text-gray-600 hover:text-blue-600 flex items-center gap-1">
                                    <i class="fa fa-comment-o"></i>
                                    <span>编辑说明</span>
                                </button>
                            </div>
                            <div class="border rounded-lg p-3">
                                <div class="flex items-center justify-between mb-2">
                                    <span id="editClosingName">结尾式</span>
                                    <div class="flex flex-col gap-1 items-center">
                                        <button onclick="editCategoryName('closing')" class="text-blue-500 hover:text-blue-700">
                                            <i class="fa fa-edit"></i>
                                        </button>
                                        <button onclick="deleteCategory('closing')" class="text-red-600 hover:text-red-700">
                                            <i class="fa fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                                <button onclick="editCategoryDescription('closing')" class="w-full text-left text-sm text-gray-600 hover:text-blue-600 flex items-center gap-1">
                                    <i class="fa fa-comment-o"></i>
                                    <span>编辑说明</span>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 新增类别 -->
                    <div>
                        <h4 class="font-medium mb-2 text-gray-700">新增类别</h4>
                        <button onclick="addNewCategory()" class="w-full p-3 border-2 border-dashed border-blue-300 rounded-lg hover:border-blue-500 hover:bg-blue-50 text-blue-600 flex items-center justify-center gap-2">
                            <i class="fa fa-plus"></i>
                            <span>添加新类别</span>
                        </button>
                    </div>
                    

                </div>
                
                <div class="mt-6 flex justify-end">
                    <button onclick="closeSettingsModal()" class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600">
                        关闭
                    </button>
                </div>
            </div>
        

        </div>
    </div>
    
    <script>

        
        // 更新配置摘要

        
        // 导出所有数据

        

        

        

        

        

        
        // 下载JSON文件
        function downloadJSON(data, filename) {
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        // 格式化日期
        function formatDate(date) {
            return date.getFullYear() + 
                   String(date.getMonth() + 1).padStart(2, '0') + 
                   String(date.getDate()).padStart(2, '0') + '_' +
                   String(date.getHours()).padStart(2, '0') + 
                   String(date.getMinutes()).padStart(2, '0');
        }
        
        // 显示自定义对话框
        function showCustomDialog(title, content, buttons) {
            const dialog = document.createElement('div');
            dialog.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            dialog.innerHTML = `
                <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4 max-h-96 overflow-y-auto">
                    <h3 class="text-lg font-bold mb-4">${title}</h3>
                    <div class="mb-6">${content}</div>
                    <div class="flex gap-2 justify-end">
                        ${buttons.map(btn => `<button class="px-4 py-2 rounded ${btn.action ? 'bg-blue-500 text-white hover:bg-blue-600' : 'bg-gray-300 text-gray-700 hover:bg-gray-400'}" onclick="${btn.action ? 'this.closest(\'.fixed\').remove(); (' + btn.action + ')()' : 'this.closest(\'.fixed\').remove()'}">${btn.text}</button>`).join('')}
                    </div>
                </div>
            `;
            document.body.appendChild(dialog);
        }

        // ==================== 配置管理功能 ====================
        
        // 配置管理全局变量
        let configurations = {}; // 存储所有配置
        let currentConfigId = 'default'; // 当前配置ID
        
        // 配置数据结构
        function createDefaultConfig() {
            return {
                id: 'default',
                name: '默认配置',
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString(),
                data: {
                    appData: JSON.parse(JSON.stringify(appData)),
                    favoriteScripts: JSON.parse(JSON.stringify(favoriteScripts)),
                    subOptionTags: JSON.parse(JSON.stringify(subOptionTags)),
                    primaryOptionTags: JSON.parse(JSON.stringify(primaryOptionTags)),
                    primaryOptionTagColors: JSON.parse(JSON.stringify(primaryOptionTagColors)),
                    subOptionTagColors: JSON.parse(JSON.stringify(subOptionTagColors)),
                    selection: JSON.parse(JSON.stringify(selection))
                }
            };
        }
        
        // 加载配置管理数据
        function loadConfigurations() {
            try {
                const saved = localStorage.getItem('configurations');
                if (saved) {
                    configurations = JSON.parse(saved);
                } else {
                    // 创建默认配置
                    configurations = {
                        'default': createDefaultConfig()
                    };
                }
                
                // 加载当前配置ID
                const savedCurrentId = localStorage.getItem('currentConfigId');
                if (savedCurrentId && configurations[savedCurrentId]) {
                    currentConfigId = savedCurrentId;
                } else {
                    currentConfigId = 'default';
                }
            } catch (e) {
                console.error('加载配置失败:', e);
                configurations = {
                    'default': createDefaultConfig()
                };
                currentConfigId = 'default';
            }
        }
        
        // 保存配置管理数据
        function saveConfigurations() {
            try {
                localStorage.setItem('configurations', JSON.stringify(configurations));
                localStorage.setItem('currentConfigId', currentConfigId);
            } catch (e) {
                console.error('保存配置失败:', e);
            }
        }
        
        // 更新配置选择器
        function updateConfigSelector() {
            const selector = document.getElementById('configSelector');
            if (!selector) return;
            
            selector.innerHTML = '';
            Object.values(configurations).forEach(config => {
                const option = document.createElement('option');
                option.value = config.id;
                option.textContent = config.name;
                option.selected = config.id === currentConfigId;
                selector.appendChild(option);
            });
        }
        
        // 应用配置数据
        function applyConfiguration(configId) {
            const config = configurations[configId];
            if (!config) {
                console.error('配置不存在:', configId);
                return false;
            }
            
            try {
                // 应用配置数据
                appData = JSON.parse(JSON.stringify(config.data.appData));
                favoriteScripts = JSON.parse(JSON.stringify(config.data.favoriteScripts));
                subOptionTags = JSON.parse(JSON.stringify(config.data.subOptionTags));
                primaryOptionTags = JSON.parse(JSON.stringify(config.data.primaryOptionTags));
                primaryOptionTagColors = JSON.parse(JSON.stringify(config.data.primaryOptionTagColors));
                subOptionTagColors = JSON.parse(JSON.stringify(config.data.subOptionTagColors));
                selection = JSON.parse(JSON.stringify(config.data.selection));
                
                // 重新构建索引和渲染界面
                buildContentIndex();
                renderAllContent();
                renderFavoriteScripts();
                updateResult();
                
                currentConfigId = configId;
                saveConfigurations();
                
                return true;
            } catch (e) {
                console.error('应用配置失败:', e);
                return false;
            }
        }
        
        // 保存当前状态到配置
        function saveCurrentStateToConfig() {
            if (!configurations[currentConfigId]) return;
            
            configurations[currentConfigId].data = {
                appData: JSON.parse(JSON.stringify(appData)),
                favoriteScripts: JSON.parse(JSON.stringify(favoriteScripts)),
                subOptionTags: JSON.parse(JSON.stringify(subOptionTags)),
                primaryOptionTags: JSON.parse(JSON.stringify(primaryOptionTags)),
                primaryOptionTagColors: JSON.parse(JSON.stringify(primaryOptionTagColors)),
                subOptionTagColors: JSON.parse(JSON.stringify(subOptionTagColors)),
                selection: JSON.parse(JSON.stringify(selection))
            };
            configurations[currentConfigId].updatedAt = new Date().toISOString();
            saveConfigurations();
        }
        
        // 创建新配置
        function createNewConfiguration(name) {
            const id = 'config_' + Date.now();
            const newConfig = {
                id: id,
                name: name,
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString(),
                data: {
                    appData: JSON.parse(JSON.stringify(appData)),
                    favoriteScripts: JSON.parse(JSON.stringify(favoriteScripts)),
                    subOptionTags: JSON.parse(JSON.stringify(subOptionTags)),
                    primaryOptionTags: JSON.parse(JSON.stringify(primaryOptionTags)),
                    primaryOptionTagColors: JSON.parse(JSON.stringify(primaryOptionTagColors)),
                    subOptionTagColors: JSON.parse(JSON.stringify(subOptionTagColors)),
                    selection: JSON.parse(JSON.stringify(selection))
                }
            };
            
            configurations[id] = newConfig;
            saveConfigurations();
            updateConfigSelector();
            
            return id;
        }
        
        // 重命名配置
        function renameConfiguration(configId, newName) {
            if (!configurations[configId]) return false;
            
            configurations[configId].name = newName;
            configurations[configId].updatedAt = new Date().toISOString();
            saveConfigurations();
            updateConfigSelector();
            
            return true;
        }
        
        // 复制配置
        function duplicateConfiguration(configId) {
            const sourceConfig = configurations[configId];
            if (!sourceConfig) return null;
            
            const newId = 'config_' + Date.now();
            const newConfig = {
                id: newId,
                name: sourceConfig.name + ' (副本)',
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString(),
                data: JSON.parse(JSON.stringify(sourceConfig.data))
            };
            
            configurations[newId] = newConfig;
            saveConfigurations();
            updateConfigSelector();
            
            return newId;
        }
        
        // 删除配置
        function deleteConfiguration(configId) {
            if (configId === 'default') {
                showNotification('不能删除默认配置', 'warning');
                return false;
            }
            
            if (!configurations[configId]) return false;
            
            delete configurations[configId];
            
            // 如果删除的是当前配置，切换到默认配置
            if (currentConfigId === configId) {
                currentConfigId = 'default';
                applyConfiguration('default');
            }
            
            saveConfigurations();
            updateConfigSelector();
            
            return true;
        }
        
        // 导出配置
        function exportConfiguration(configId) {
            const config = configurations[configId];
            if (!config) return;
            
            const exportData = {
                version: '1.0',
                exportedAt: new Date().toISOString(),
                config: config
            };
            
            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${config.name}_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showNotification('配置导出成功', 'success');
        }
        
        // 导入配置
        function importConfiguration(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importData = JSON.parse(e.target.result);
                    
                    if (!importData.config || !importData.config.name) {
                        throw new Error('无效的配置文件格式');
                    }
                    
                    let config = importData.config;
                    let originalName = config.name;
                    let finalName = originalName;
                    let counter = 1;
                    
                    // 处理名称冲突
                    while (Object.values(configurations).some(c => c.name === finalName)) {
                        finalName = `${originalName} (${counter})`;
                        counter++;
                    }
                    
                    // 创建新的配置ID
                    const newId = 'config_' + Date.now();
                    config.id = newId;
                    config.name = finalName;
                    config.updatedAt = new Date().toISOString();
                    
                    configurations[newId] = config;
                    saveConfigurations();
                    updateConfigSelector();
                    
                    showNotification(`配置导入成功：${finalName}`, 'success');
                } catch (error) {
                    console.error('导入配置失败:', error);
                    showNotification('导入配置失败：' + error.message, 'error');
                }
            };
            reader.readAsText(file);
        }
        
        // 绑定配置管理事件监听器
        function setupConfigManagementListeners(modal) {
            // 切换配置
            const switchBtn = modal.querySelector('#switchConfigBtn');
            const configSelector = modal.querySelector('#configSelector');
            
            if (switchBtn && configSelector) {
                switchBtn.addEventListener('click', function() {
                    const selectedConfigId = configSelector.value;
                    if (selectedConfigId !== currentConfigId) {
                        if (applyConfiguration(selectedConfigId)) {
                            showNotification(`已切换到配置：${configurations[selectedConfigId].name}`, 'success');
                            updateConfigSelector();
                        } else {
                            showNotification('切换配置失败', 'error');
                        }
                    }
                });
            }
            
            // 创建新配置
            const createBtn = modal.querySelector('#createConfigBtn');
            if (createBtn) {
                createBtn.addEventListener('click', function() {
                    const name = prompt('请输入新配置的名称:');
                    if (name && name.trim()) {
                        const newId = createNewConfiguration(name.trim());
                        showNotification(`配置创建成功：${name.trim()}`, 'success');
                    }
                });
            }
            
            // 重命名配置
            const renameBtn = modal.querySelector('#renameConfigBtn');
            if (renameBtn) {
                renameBtn.addEventListener('click', function() {
                    if (currentConfigId === 'default') {
                        showNotification('不能重命名默认配置', 'warning');
                        return;
                    }
                    
                    const currentName = configurations[currentConfigId].name;
                    const newName = prompt('请输入新的配置名称:', currentName);
                    if (newName && newName.trim() && newName.trim() !== currentName) {
                        if (renameConfiguration(currentConfigId, newName.trim())) {
                            showNotification('配置重命名成功', 'success');
                        }
                    }
                });
            }
            
            // 复制配置
            const duplicateBtn = modal.querySelector('#duplicateConfigBtn');
            if (duplicateBtn) {
                duplicateBtn.addEventListener('click', function() {
                    const newId = duplicateConfiguration(currentConfigId);
                    if (newId) {
                        showNotification('配置复制成功', 'success');
                    }
                });
            }
            
            // 删除配置
            const deleteBtn = modal.querySelector('#deleteConfigBtn');
            if (deleteBtn) {
                deleteBtn.addEventListener('click', function() {
                    if (currentConfigId === 'default') {
                        showNotification('不能删除默认配置', 'warning');
                        return;
                    }
                    
                    const configName = configurations[currentConfigId].name;
                    if (confirm(`确定要删除配置"${configName}"吗？此操作不可撤销。`)) {
                        if (deleteConfiguration(currentConfigId)) {
                            showNotification('配置删除成功', 'success');
                        }
                    }
                });
            }
            
            // 导出配置
            const exportBtn = modal.querySelector('#exportConfigBtn');
            if (exportBtn) {
                exportBtn.addEventListener('click', function() {
                    exportConfiguration(currentConfigId);
                });
            }
            
            // 导入配置
            const importBtn = modal.querySelector('#importConfigBtn');
            const importFile = modal.querySelector('#importConfigFile');
            
            if (importBtn && importFile) {
                importBtn.addEventListener('click', function() {
                    importFile.click();
                });
                
                importFile.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    if (file) {
                        importConfiguration(file);
                        e.target.value = ''; // 清空文件选择
                    }
                });
            }
        }
        
        // 重写原有的保存函数，添加自动保存到当前配置
        const originalSaveAppData = saveAppData;
        saveAppData = function() {
            originalSaveAppData();
            saveCurrentStateToConfig();
        };
        
        const originalSaveFavoriteScripts = saveFavoriteScripts;
        saveFavoriteScripts = function() {
            originalSaveFavoriteScripts();
            saveCurrentStateToConfig();
        };
        
        const originalSaveSubOptionTags = saveSubOptionTags;
        saveSubOptionTags = function() {
            originalSaveSubOptionTags();
            saveCurrentStateToConfig();
        };
        
        const originalSavePrimaryOptionTags = savePrimaryOptionTags;
        savePrimaryOptionTags = function() {
            originalSavePrimaryOptionTags();
            saveCurrentStateToConfig();
        };
        
        const originalSavePrimaryOptionTagColors = savePrimaryOptionTagColors;
        savePrimaryOptionTagColors = function() {
            originalSavePrimaryOptionTagColors();
            saveCurrentStateToConfig();
        };
        
        const originalSaveSubOptionTagColors = saveSubOptionTagColors;
        saveSubOptionTagColors = function() {
            originalSaveSubOptionTagColors();
            saveCurrentStateToConfig();
        };
    </script>
</body>
</html>
    