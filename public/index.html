<!DOCTYPE html>
<!-- éƒ¨ç½²æ—¶é—´: 2025-09-12T13:34:43.069Z -->
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç”»å¸ˆè¯„ä»·ç³»ç»Ÿ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --primary: #3b82f6;
            --secondary: #10b981;
            --accent: #f59e0b;
            --neutral: #6b7280;
            --dark: #1f2937;
        }
        
        .text-primary { color: var(--primary); }
        .bg-primary { background-color: var(--primary); }
        .text-secondary { color: var(--secondary); }
        .bg-secondary { background-color: var(--secondary); }
        .text-accent { color: var(--accent); }
        .bg-accent { background-color: var(--accent); }
        .text-neutral { color: var(--neutral); }
        .text-dark { color: var(--dark); }
        
        .btn-hover {
            transition: all 0.2s ease;
        }
        
        .btn-hover:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        .item-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 12px;
        }
        
        .history-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 16px;
        }
        
        .template-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 12px;
        }
        
        .category-btn {
            padding: 8px 16px;
            border-radius: 20px;
            border: 1px solid #e5e7eb;
            background: white;
            color: var(--neutral);
            transition: all 0.2s ease;
            cursor: pointer;
            font-size: 14px;
        }
        
        .category-btn:hover {
            border-color: var(--primary);
            color: var(--primary);
        }
        
        .category-btn-active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        
        /* éšè—é€‰æ‹©é¢æ¿æ»šåŠ¨æ¡ */
        .selection-panel {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        
        .selection-panel::-webkit-scrollbar {
            display: none;
        }
        
        .template-scroll-btn {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: white;
            border: 1px solid #e5e7eb;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            z-index: 10;
        }
        
        .template-scroll-btn:hover {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        .result-container-adaptive {
            overflow-y: auto;
            word-wrap: break-word;
            white-space: pre-wrap;
        }
        
        .btn-text-nowrap {
            white-space: nowrap;
        }
        
        .config-transition {
            transition: all 0.3s ease;
        }
        
        .add-item-btn {
            transition: all 0.2s ease;
        }
        
        .add-item-btn:hover {
            transform: scale(1.1);
        }
        
        @media (max-width: 768px) {
            .item-grid {
                grid-template-columns: 1fr;
            }
            
            .history-grid {
                grid-template-columns: 1fr;
            }
            
            .template-grid {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            }
        }
        
        .floating-container {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            width: 90%;
            max-width: 1200px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
        
        @media (max-width: 768px) {
            .floating-container {
                width: 95%;
                top: 10px;
            }
        }
        
        .function-area {
            min-height: 200px;
        }
        
        .function-buttons {
            flex-shrink: 0;
        }
        
        @media (max-width: 768px) {
            .function-buttons {
                min-width: auto;
                width: 100%;
            }
            
            .function-area .flex {
                flex-direction: column;
            }
        }
    </style>

    <script>
        // éƒ¨ç½²ç¯å¢ƒæ£€æµ‹
        if (typeof window !== 'undefined') {
            console.log('ğŸš€ ç”»å¸ˆè¯„ä»·ç³»ç»Ÿå·²éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ');
            console.log('ğŸ“ å½“å‰åŸŸå:', window.location.hostname);
            console.log('ğŸ”’ HTTPSçŠ¶æ€:', window.location.protocol === 'https:' ? 'å·²å¯ç”¨' : 'æœªå¯ç”¨');
        }
    </script>
</head>
<body class="bg-gray-50 font-sans text-dark overflow-x-hidden">
    <!-- æ–°çš„ä¸‰æ å¸ƒå±€ -->
    <div class="flex h-screen">
        <!-- å·¦ä¾§ï¼šæ¨¡æ¿åŒºåŸŸ -->
        <div class="w-1/4 bg-white shadow-md overflow-y-auto p-5">
            <div class="mb-4">
                <h2 class="text-lg font-semibold mb-4">æ¨¡æ¿åº“</h2>
            </div>
            
            <!-- åˆ†ç±»æŒ‰é’®ç»„ - ç«–å‘æ’åˆ— -->
            <div class="mb-4">
                <div id="categoryButtons" class="flex flex-col gap-2">
                    <button class="category-btn category-btn-active text-left" data-category="all">æ‰€æœ‰åˆ†ç±»</button>
                    <!-- åˆ†ç±»æŒ‰é’®å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>
            
            <!-- æ¨¡æ¿ç»Ÿè®¡å’Œè®¾ç½® -->
            <div class="flex items-center justify-between mb-4 text-sm">
                <div class="text-neutral">
                    <span id="templateCount">0</span> ä¸ªæ¨¡æ¿
                </div>
                <div class="flex gap-2">
                    <button id="templateSettingsBtn" class="text-neutral hover:text-primary p-1 rounded-full hover:bg-gray-100 transition-colors">
                        <i class="fa fa-cog"></i>
                    </button>
                    <button id="refreshTemplatesBtn" class="text-neutral hover:text-primary p-1 rounded-full hover:bg-gray-100 transition-colors" title="åˆ·æ–°æ¨¡æ¿å’Œåˆ†ç±»">
                        <i class="fa fa-refresh"></i>
                    </button>
                </div>
            </div>
            
            <!-- æ¨¡æ¿åˆ—è¡¨ - ç«–å‘æ’åˆ— -->
            <div class="relative">
                <div id="templateContainer" class="flex flex-col gap-2 max-h-[400px] overflow-y-auto">
                    <!-- æ¨¡æ¿é¡¹ç›®å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
                    <div class="text-neutral italic text-center py-6">æš‚æ— æ¨¡æ¿ï¼Œè¯·åˆ›å»ºæ–°æ¨¡æ¿</div>
                </div>
            </div>
        </div>
        
        <!-- ä¸­é—´ï¼šé€‰æ‹©é¢æ¿ -->
        <div class="flex-1 overflow-y-auto selection-panel p-4">
            <div class="bg-white rounded-xl shadow-md p-5">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold">é€‰æ‹©é¢æ¿</h2>
                    <div class="flex gap-2">
                        <button id="resetBtnPanel" class="flex items-center gap-1 text-neutral hover:text-red-500 transition-colors btn-text-nowrap">
                            <i class="fa fa-refresh"></i> é‡ç½®é€‰æ‹©
                        </button>
                    </div>
                </div>
                
                <!-- èµ·æ‰‹ç§°å‘¼å¼ -->
                <div class="mb-6">
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="font-medium text-lg flex items-center gap-2">
                            <i class="fa fa-comment-o text-primary"></i>èµ·æ‰‹ç§°å‘¼å¼
                        </h3>
                        <button class="add-item-btn text-sm text-primary hover:text-primary/80 btn-text-nowrap" data-type="greeting">
                            <i class="fa fa-plus-circle"></i>
                        </button>
                    </div>
                    <div id="greetingContainer" class="item-grid" data-type="greeting">
                        <!-- èµ·æ‰‹å¼é¡¹ç›®å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>
                
                <!-- ä¼˜ç‚¹ -->
                <div class="mb-6">
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="font-medium text-lg flex items-center gap-2">
                            <i class="fa fa-thumbs-up text-green-500"></i>ä¼˜ç‚¹
                        </h3>
                        <button class="add-item-btn text-sm text-primary hover:text-primary/80 btn-text-nowrap" data-type="strength">
                            <i class="fa fa-plus-circle"></i>
                        </button>
                    </div>
                    <div id="strengthContainer" class="item-grid" data-type="strength">
                        <!-- ä¼˜ç‚¹é¡¹ç›®å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>
                
                <!-- é—®é¢˜ -->
                <div class="mb-6">
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="font-medium text-lg flex items-center gap-2">
                            <i class="fa fa-exclamation-triangle text-amber-500"></i>é—®é¢˜
                        </h3>
                        <button class="add-item-btn text-sm text-primary hover:text-primary/80 btn-text-nowrap" data-type="issue">
                            <i class="fa fa-plus-circle"></i>
                        </button>
                    </div>
                    <div id="issueContainer" class="item-grid" data-type="issue">
                        <!-- é—®é¢˜é¡¹ç›®å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>
                
                <!-- ç»“å°¾å¼ -->
                <div class="mb-6">
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="font-medium text-lg flex items-center gap-2">
                            <i class="fa fa-sign-out text-purple-500"></i>ç»“å°¾å¼
                        </h3>
                        <button class="add-item-btn text-sm text-primary hover:text-primary/80 btn-text-nowrap" data-type="closing">
                            <i class="fa fa-plus-circle"></i>
                        </button>
                    </div>
                    <div id="closingContainer" class="item-grid" data-type="closing">
                        <!-- ç»“å°¾å¼é¡¹ç›®å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>
                
                <!-- å†å²è®°å½•åŒºåŸŸ -->
                <div class="mt-8">
                    <h3 class="font-medium text-lg mb-3 flex items-center gap-2">
                        <i class="fa fa-history text-neutral"></i>å†å²è®°å½•
                    </h3>
                    <div id="historyContainer" class="history-grid">
                        <!-- å†å²è®°å½•å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
                        <div class="text-neutral italic text-center col-span-full py-4">æš‚æ— å†å²è®°å½•</div>
                    </div>
                </div>
            </div>
            
            <div class="mt-4 bg-white rounded-xl shadow-md p-5">
                <h3 class="font-medium text-lg mb-3">ä½¿ç”¨è¯´æ˜</h3>
                <ul class="text-sm text-neutral space-y-2">
                    <li class="flex items-start gap-2">
                        <i class="fa fa-check-circle text-green-500 mt-1"></i>
                        <span>æ‚¨å¯ä»¥æ‹–åŠ¨é¡¹ç›®è°ƒæ•´é¡ºåºï¼ˆå°½ç®¡æ‹–åŠ¨å›¾æ ‡ä¸å¯è§ï¼‰</span>
                    </li>
                    <li class="flex items-start gap-2">
                        <i class="fa fa-check-circle text-green-500 mt-1"></i>
                        <span>ç‚¹å‡»é¡¹ç›®ä¸Šçš„ç¼–è¾‘æŒ‰é’®å¯ä¿®æ”¹æˆ–åˆ é™¤é¡¹ç›®</span>
                    </li>
                    <li class="flex items-start gap-2">
                        <i class="fa fa-check-circle text-green-500 mt-1"></i>
                        <span>ç‚¹å‡»åŠ å·æŒ‰é’®å¯æ·»åŠ æ–°çš„é¡¹ç›®</span>
                    </li>
                    <li class="flex items-start gap-2">
                        <i class="fa fa-check-circle text-green-500 mt-1"></i>
                        <span>é€‰æ‹©çš„å†…å®¹ä¼šè‡ªåŠ¨ç”Ÿæˆè¯æœ¯å’’è¯­</span>
                    </li>
                </ul>
            </div>
        </div>
        
        <!-- å³ä¾§ï¼šé¡¶éƒ¨é¢æ¿ï¼ˆå›ºå®šæ˜¾ç¤ºï¼‰ -->
        <div class="w-1/4 bg-white shadow-md p-5 overflow-y-auto">
            <!-- ç”»å¸ˆè¯„ä»·ç³»ç»Ÿæ ‡é¢˜ -->
            <div class="mb-6 flex justify-between items-center">
                <h1 class="text-[clamp(1.5rem,3vw,2rem)] font-bold text-primary">ç”»å¸ˆè¯„ä»·ç³»ç»Ÿ</h1>
                <button id="newSettingsBtn" class="text-neutral hover:text-primary transition-colors p-2 rounded-full hover:bg-gray-100" title="æ–°è®¾ç½®">
                    <i class="fa fa-cog"></i>
                </button>
            </div>
            
            <!-- æœ€è¿‘ä½¿ç”¨æ¨¡æ¿ -->
            <div class="mb-4">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="text-md font-medium">æœ€è¿‘ä½¿ç”¨</h3>
                </div>
                <div id="recentTemplatesContainer" class="flex flex-col gap-2 pb-2 max-h-[200px] overflow-y-auto">
                    <!-- æœ€è¿‘ä½¿ç”¨çš„æ¨¡æ¿å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
                    <div class="text-neutral italic text-center py-2 w-full">æš‚æ— æœ€è¿‘ä½¿ç”¨çš„æ¨¡æ¿</div>
                </div>
            </div>
            
            <!-- è¯æœ¯å’’è¯­åŒºåŸŸ -->
            <div class="mb-4">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-lg font-semibold">è¯æœ¯å’’è¯­</h2>
                    <button id="saveTemplateBtn" class="bg-secondary hover:bg-secondary/90 text-white px-3 py-1 rounded-lg shadow btn-hover flex items-center gap-1 btn-text-nowrap text-sm">
                        <i class="fa fa-save"></i> ä¿å­˜æ¨¡æ¿
                    </button>
                </div>
            </div>
            
            <!-- è¯æœ¯å’’è¯­å±•ç¤º -->
            <div class="mb-4">
                <div id="resultContainer" class="result-container-adaptive px-3 py-2 border border-gray-200 rounded-lg bg-gray-50 min-h-[45px] overflow-y-auto" style="max-height: none; height: auto; min-height: 45px;">
                    <p class="text-neutral italic">è¯·åœ¨å·¦ä¾§é€‰æ‹©å†…å®¹ï¼Œè¯æœ¯å’’è¯­å°†è‡ªåŠ¨ç”Ÿæˆåœ¨è¿™é‡Œ...</p>
                </div>
            </div>
            
            <!-- è¯æœ¯ç”ŸæˆåŒºåŸŸ -->
            <div class="mb-4">
                <div class="flex items-center justify-between mb-2">
                    <h3 class="text-lg font-semibold">è¯æœ¯ç”Ÿæˆ</h3>
                    <button id="generateBtn" class="bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded-lg shadow btn-hover flex items-center gap-1 btn-text-nowrap text-sm">
                        <i class="fa fa-magic"></i> ç”Ÿæˆè¯æœ¯
                    </button>
                </div>
                <div id="generatedContainer" class="result-container-adaptive px-3 py-2 border border-gray-200 rounded-lg bg-white min-h-[45px] overflow-y-auto" style="max-height: none; height: auto; min-height: 45px;">
                    <p class="text-neutral italic">ç‚¹å‡»"ç”Ÿæˆè¯æœ¯"æŒ‰é’®ï¼ŒAIå°†ä¸ºæ‚¨ç”Ÿæˆä¼˜åŒ–çš„è¯æœ¯å†…å®¹...</p>
                </div>
            </div>
            
            <!-- åŠŸèƒ½æŒ‰é’® -->
            <div class="flex flex-row gap-3">
                <button id="resetBtnResult" class="flex-1 bg-gray-200 hover:bg-gray-300 text-dark px-4 py-2 rounded-lg shadow btn-hover flex items-center justify-center gap-1 btn-text-nowrap">
                    <i class="fa fa-refresh"></i> é‡ç½®é€‰æ‹©
                </button>
                <button id="copyBtn" class="flex-1 bg-primary hover:bg-primary/90 text-white px-4 py-2 rounded-lg shadow btn-hover flex items-center justify-center gap-1 btn-text-nowrap">
                    <i class="fa fa-copy"></i> å¤åˆ¶è¯æœ¯
                </button>
            </div>
        </div>
    </div>

    <!-- è‡ªå®šä¹‰å¼¹çª— -->
    <div id="customModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4">
            <div class="p-6">
                <h3 id="modalTitle" class="text-lg font-semibold mb-4"></h3>
                <div id="modalContent" class="mb-6"></div>
                <div id="modalButtons" class="flex justify-end gap-3"></div>
            </div>
        </div>
    </div>

    <script>
        // APIé…ç½®å˜é‡ - ç›´æ¥ä¿å­˜åœ¨æ–‡ä»¶ä¸­
        let API_CONFIG = {
            apiKey: 'pat_SnrkhHeuv5zIVqz7DLC2sGhfO0z5SxJdAmHuIPoGudo0FbEwwAI6lQnlr9M5bSFX', // åœ¨è¿™é‡Œå¡«å†™æ‚¨çš„æ‰£å­APIå¯†é’¥
            botId: '7548722284312772647'   // åœ¨è¿™é‡Œå¡«å†™æ‚¨çš„æœºå™¨äººID
        };
        
        // å…¨å±€å˜é‡
        let configManager;
        let appData = {};
        let selection = {
                    greeting: { id: null, subOptions: [] },
                    strength: [], // æ ¼å¼: [{ id: itemId, subOptions: [subOptionIndex1, subOptionIndex2] }]
                    issue: [], // æ ¼å¼: [{ id: itemId, subOptions: [subOptionIndex1, subOptionIndex2] }]
                    closing: { id: null, subOptions: [] }
                };
        let contentIndex = {
                    greeting: {},
                    strength: {},
                    issue: {},
                    closing: {}
                };
        let configPanelOpen = false;
        let confirmCallback = null;
        let draggedItem = null; // ç”¨äºè·Ÿè¸ªæ­£åœ¨æ‹–åŠ¨çš„é¡¹ç›®
        let historyRecords = []; // å†å²è®°å½•æ•°ç»„
        let templates = []; // æ¨¡æ¿æ•°ç»„
        let templateCategories = ['é»˜è®¤åˆ†ç±»']; // æ¨¡æ¿åˆ†ç±»æ•°ç»„
        let currentTemplatePage = 0; // å½“å‰æ¨¡æ¿é¡µç 
        const MAX_TEMPLATES_PER_PAGE = 10; // æ¯é¡µæœ€å¤šæ˜¾ç¤ºçš„æ¨¡æ¿æ•°é‡ï¼ˆä¸¤è¡Œå…±10ä¸ªï¼‰
        const MAX_HISTORY_RECORDS = 6; // æœ€å¤§å†å²è®°å½•æ•°é‡
        const MAX_RECENT_TEMPLATES = 3; // æœ€å¤§æœ€è¿‘ä½¿ç”¨æ¨¡æ¿æ•°é‡
        let draggedTemplateId = null; // å½“å‰æ­£åœ¨æ‹–åŠ¨çš„æ¨¡æ¿ID
        let recentTemplates = []; // æœ€è¿‘ä½¿ç”¨çš„æ¨¡æ¿IDæ•°ç»„

        // è‡ªå®šä¹‰å¼¹çª—å‡½æ•°
        function showCustomAlert(message, title = 'æç¤º') {
            return new Promise((resolve) => {
                const modal = document.getElementById('customModal');
                const modalTitle = document.getElementById('modalTitle');
                const modalContent = document.getElementById('modalContent');
                const modalButtons = document.getElementById('modalButtons');
                
                modalTitle.textContent = title;
                modalContent.innerHTML = `<p class="text-gray-700">${message}</p>`;
                modalButtons.innerHTML = `
                    <button class="bg-primary hover:bg-primary/90 text-white px-4 py-2 rounded-lg" onclick="closeCustomModal(); customModalResolve();">ç¡®å®š</button>
                `;
                
                modal.classList.remove('hidden');
                window.customModalResolve = resolve;
            });
        }
        
        function showCustomConfirm(message, title = 'ç¡®è®¤') {
            return new Promise((resolve) => {
                const modal = document.getElementById('customModal');
                const modalTitle = document.getElementById('modalTitle');
                const modalContent = document.getElementById('modalContent');
                const modalButtons = document.getElementById('modalButtons');
                
                modalTitle.textContent = title;
                modalContent.innerHTML = `<p class="text-gray-700">${message}</p>`;
                modalButtons.innerHTML = `
                    <button class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-4 py-2 rounded-lg mr-2" onclick="closeCustomModal(); customModalResolve(false);">å–æ¶ˆ</button>
                    <button class="bg-primary hover:bg-primary/90 text-white px-4 py-2 rounded-lg" onclick="closeCustomModal(); customModalResolve(true);">ç¡®å®š</button>
                `;
                
                modal.classList.remove('hidden');
                window.customModalResolve = resolve;
            });
        }
        
        function showCustomPrompt(message, defaultValue = '', title = 'è¾“å…¥') {
            return new Promise((resolve) => {
                const modal = document.getElementById('customModal');
                const modalTitle = document.getElementById('modalTitle');
                const modalContent = document.getElementById('modalContent');
                const modalButtons = document.getElementById('modalButtons');
                
                modalTitle.textContent = title;
                modalContent.innerHTML = `
                    <p class="text-gray-700 mb-3">${message}</p>
                    <input type="text" id="promptInput" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary" value="${defaultValue}" />
                `;
                modalButtons.innerHTML = `
                    <button class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-4 py-2 rounded-lg mr-2" onclick="closeCustomModal(); customModalResolve(null);">å–æ¶ˆ</button>
                    <button class="bg-primary hover:bg-primary/90 text-white px-4 py-2 rounded-lg" onclick="closeCustomModal(); customModalResolve(document.getElementById('promptInput').value);">ç¡®å®š</button>
                `;
                
                modal.classList.remove('hidden');
                setTimeout(() => {
                    const input = document.getElementById('promptInput');
                    input.focus();
                    input.select();
                }, 100);
                window.customModalResolve = resolve;
            });
        }
        
        function closeCustomModal() {
            const modal = document.getElementById('customModal');
            modal.classList.add('hidden');
        }
        
        // ç‚¹å‡»èƒŒæ™¯å…³é—­å¼¹çª—
        document.getElementById('customModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeCustomModal();
                if (window.customModalResolve) {
                    window.customModalResolve(null);
                }
            }
        });

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        window.onload = function() {
            // ä»æœ¬åœ°å­˜å‚¨åŠ è½½å†å²è®°å½•
            loadHistoryRecords();
            
            // ä»æœ¬åœ°å­˜å‚¨åŠ è½½æ¨¡æ¿å’Œåˆ†ç±»
            loadTemplatesAndCategories();
            
            // ä»æœ¬åœ°å­˜å‚¨åŠ è½½æœ€è¿‘ä½¿ç”¨çš„æ¨¡æ¿
            loadRecentTemplates();
            
            // åˆå§‹åŒ–åº”ç”¨æ•°æ®
            initializeAppData();
            
            // ç»‘å®šäº‹ä»¶ç›‘å¬å™¨
            bindEventListeners();
            
            // åˆå§‹åŒ–æ‹–æ‹½åŠŸèƒ½
            initializeDragAndDrop();
            
            // æ¸²æŸ“åˆå§‹å†…å®¹
            renderAllContent();
            
            // æ›´æ–°ç»“æœæ˜¾ç¤ºï¼ˆç¡®ä¿æç¤ºå†…å®¹ä¹Ÿåº”ç”¨æœ€å°é«˜åº¦ï¼‰
            updateResult();
            
            // åˆå§‹åŒ–ç”Ÿæˆæ–‡æœ¬æ¡†é«˜åº¦
            adjustGeneratedContainerHeight();
            
            // æ¸²æŸ“æ¨¡æ¿
            renderTemplates();
            
            // æ¸²æŸ“æœ€è¿‘ä½¿ç”¨çš„æ¨¡æ¿
            renderRecentTemplates();
            
            // æ¸²æŸ“å†å²è®°å½•
            renderHistoryRecords();
        };

        // åˆå§‹åŒ–åº”ç”¨æ•°æ®
        function initializeAppData() {
            // é»˜è®¤æ•°æ®
            const defaultData = {
                greeting: [
                    { id: 'g1', text: 'æ‚¨å¥½ï¼Œæ„Ÿè°¢æ‚¨çš„ä½œå“æŠ•ç¨¿ï¼', category: 'ç¤¼è²Œç”¨è¯­' },
                    { id: 'g2', text: 'å¾ˆé«˜å…´çœ‹åˆ°æ‚¨çš„åˆ›ä½œï¼', category: 'é¼“åŠ±ç”¨è¯­' },
                    { id: 'g3', text: 'ç»è¿‡ä»”ç»†è¯„å®¡ï¼Œç°ç»™å‡ºä»¥ä¸‹åé¦ˆï¼š', category: 'æ­£å¼ç”¨è¯­' }
                ],
                strength: [
                    { id: 's1', text: 'ç”»é¢æ„å›¾åˆç†ï¼Œå±‚æ¬¡åˆ†æ˜', category: 'æ„å›¾' },
                    { id: 's2', text: 'è‰²å½©æ­é…å’Œè°ï¼Œè§†è§‰æ•ˆæœä½³', category: 'è‰²å½©' },
                    { id: 's3', text: 'çº¿æ¡æµç•…ï¼ŒæŠ€æ³•å¨´ç†Ÿ', category: 'æŠ€æ³•' },
                    { id: 's4', text: 'åˆ›æ„ç‹¬ç‰¹ï¼Œå¯Œæœ‰æƒ³è±¡åŠ›', category: 'åˆ›æ„' },
                    { id: 's5', text: 'ç»†èŠ‚å¤„ç†ç²¾è‡´ï¼Œå®Œæˆåº¦é«˜', category: 'ç»†èŠ‚' }
                ],
                issue: [
                    { id: 'i1', text: 'éƒ¨åˆ†åŒºåŸŸæ˜æš—å¯¹æ¯”å¯ä»¥æ›´å¼ºçƒˆ', category: 'æ˜æš—' },
                    { id: 'i2', text: 'äººç‰©æ¯”ä¾‹éœ€è¦è¿›ä¸€æ­¥è°ƒæ•´', category: 'æ¯”ä¾‹' },
                    { id: 'i3', text: 'èƒŒæ™¯ä¸ä¸»ä½“çš„èåˆåº¦æœ‰å¾…æå‡', category: 'æ•´ä½“æ€§' },
                    { id: 'i4', text: 'æŸäº›ç»†èŠ‚è¿˜å¯ä»¥æ›´åŠ ç²¾ç»†', category: 'ç»†èŠ‚' }
                ],
                closing: [
                    { id: 'c1', text: 'æœŸå¾…æ‚¨çš„ä¸‹ä¸€æ¬¡æŠ•ç¨¿ï¼', category: 'æœŸå¾…ç”¨è¯­' },
                    { id: 'c2', text: 'ç»§ç»­åŠ æ²¹ï¼Œæ‚¨çš„è¿›æ­¥å¾ˆæ˜æ˜¾ï¼', category: 'é¼“åŠ±ç”¨è¯­' },
                    { id: 'c3', text: 'æ„Ÿè°¢æ‚¨çš„å‚ä¸ï¼Œç¥åˆ›ä½œæ„‰å¿«ï¼', category: 'æ„Ÿè°¢ç”¨è¯­' }
                ]
            };

            // ä»æœ¬åœ°å­˜å‚¨åŠ è½½æ•°æ®ï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨é»˜è®¤æ•°æ®
            const savedData = localStorage.getItem('appData');
            if (savedData) {
                try {
                    appData = JSON.parse(savedData);
                    // ç¡®ä¿æ‰€æœ‰å¿…è¦çš„å±æ€§éƒ½å­˜åœ¨
                    Object.keys(defaultData).forEach(key => {
                        if (!appData[key]) {
                            appData[key] = defaultData[key];
                        }
                    });
                } catch (e) {
                    console.error('è§£ææœ¬åœ°æ•°æ®å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤æ•°æ®:', e);
                    appData = defaultData;
                }
            } else {
                appData = defaultData;
            }

            // æ„å»ºå†…å®¹ç´¢å¼•
            buildContentIndex();
        }

        // æ„å»ºå†…å®¹ç´¢å¼•
        function buildContentIndex() {
            Object.keys(appData).forEach(type => {
                contentIndex[type] = {};
                appData[type].forEach(item => {
                    contentIndex[type][item.id] = item;
                });
            });
        }

        // ä¿å­˜åº”ç”¨æ•°æ®åˆ°æœ¬åœ°å­˜å‚¨
        function saveAppData() {
            try {
                localStorage.setItem('appData', JSON.stringify(appData));
                buildContentIndex();
            } catch (e) {
                console.error('ä¿å­˜æ•°æ®å¤±è´¥:', e);
            }
        }

        // ç»‘å®šäº‹ä»¶ç›‘å¬å™¨
        function bindEventListeners() {
            // å¤åˆ¶æŒ‰é’®
            document.getElementById('copyBtn').addEventListener('click', copyGeneratedResult);
            
            // ç”Ÿæˆè¯æœ¯æŒ‰é’®
            document.getElementById('generateBtn').addEventListener('click', generateScript);
            
            // é‡ç½®æŒ‰é’®
            document.getElementById('resetBtnResult').addEventListener('click', resetSelection);
            document.getElementById('resetBtnPanel').addEventListener('click', resetSelection);
            
            // ä¿å­˜æ¨¡æ¿æŒ‰é’®
            document.getElementById('saveTemplateBtn').addEventListener('click', saveCurrentTemplate);
            
            // æ–°è®¾ç½®æŒ‰é’®
            document.getElementById('newSettingsBtn').addEventListener('click', openConfigPanel);
            
            // æ¨¡æ¿è®¾ç½®æŒ‰é’®
            document.getElementById('templateSettingsBtn').addEventListener('click', openTemplateSettings);
            
            // åˆ·æ–°æ¨¡æ¿æŒ‰é’®
            document.getElementById('refreshTemplatesBtn').addEventListener('click', refreshTemplatesAndCategories);
            
            // æ·»åŠ é¡¹ç›®æŒ‰é’®
            document.querySelectorAll('.add-item-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const type = this.getAttribute('data-type');
                    addNewItem(type);
                });
            });
        }

        // æ¸²æŸ“æ‰€æœ‰å†…å®¹
        function renderAllContent() {
            Object.keys(appData).forEach(type => {
                renderContent(type);
            });
        }

        // æ¸²æŸ“æŒ‡å®šç±»å‹çš„å†…å®¹
        function renderContent(type) {
            const container = document.getElementById(type + 'Container');
            if (!container) return;

            container.innerHTML = '';
            
            if (!appData[type] || appData[type].length === 0) {
                container.innerHTML = '<div class="text-neutral italic text-center col-span-full py-4">æš‚æ— å†…å®¹ï¼Œç‚¹å‡»åŠ å·æ·»åŠ </div>';
                return;
            }

            appData[type].forEach(item => {
                const itemElement = createItemElement(item, type);
                container.appendChild(itemElement);
            });
        }

        // åˆ›å»ºé¡¹ç›®å…ƒç´ 
        function createItemElement(item, type) {
            const div = document.createElement('div');
            div.className = 'group relative p-3 border border-gray-200 rounded-lg cursor-pointer transition-all hover:border-primary hover:shadow-md';
            div.setAttribute('data-id', item.id);
            div.setAttribute('data-type', type);
            div.draggable = true;

            // æ£€æŸ¥æ˜¯å¦è¢«é€‰ä¸­
            const isSelected = isItemSelected(item.id, type);
            const selectedSubOptions = getSelectedSubOptions(item.id, type);
            
            // å¦‚æœè¢«é€‰ä¸­ï¼Œæ·»åŠ é€‰ä¸­æ ·å¼ï¼ˆæ— è®ºæ˜¯å¦æœ‰äºŒçº§é€‰é¡¹ï¼‰
            if (isSelected) {
                div.classList.add('border-primary', 'bg-blue-50');
            }

            // æ„å»ºå·²é€‰ä¸­çš„äºŒçº§é€‰é¡¹æ˜¾ç¤ºæ–‡æœ¬
            let selectedSubOptionsText = '';
            if (item.subOptions && item.subOptions.length > 0 && selectedSubOptions.length > 0) {
                const selectedTexts = selectedSubOptions.map(index => item.subOptions[index]).filter(Boolean);
                if (selectedTexts.length > 0) {
                    selectedSubOptionsText = `
                        <div class="mt-2 text-xs text-primary font-medium">
                            ${selectedTexts.join('ï¼Œ')}
                        </div>
                    `;
                }
            }
            
            div.innerHTML = `
                <div class="text-sm font-medium mb-1">${item.text}</div>
                ${selectedSubOptionsText}
                <div class="absolute top-1/2 right-1 -translate-y-1/2 opacity-0 group-hover:opacity-100 transition-opacity">
                    <button class="edit-btn text-xs text-neutral hover:text-primary p-1" data-id="${item.id}" data-type="${type}">
                        <i class="fa fa-edit"></i>
                    </button>
                </div>
            `;

            // ç‚¹å‡»é€‰æ‹©/å¼¹å‡ºæ°”æ³¡æ¡†
            div.addEventListener('click', function(e) {
                if (e.target.closest('.edit-btn')) return;
                
                // å…³é—­å…¶ä»–é¡¹ç›®çš„æ°”æ³¡æ¡†ï¼Œä¿æŒå½“å‰é¡¹ç›®çš„ç‹¬ç«‹æ€§
                const allBubbles = document.querySelectorAll('.sub-options-bubble');
                allBubbles.forEach(bubble => {
                    const bubbleItemId = bubble.getAttribute('data-item-id');
                    const bubbleType = bubble.getAttribute('data-type');
                    if (bubbleItemId !== item.id.toString() || bubbleType !== type) {
                        bubble.remove();
                    }
                });
                
                // å¦‚æœæœ‰äºŒçº§é€‰é¡¹ï¼Œå¼¹å‡ºæ°”æ³¡é€‰æ‹©æ¡†
                if (item.subOptions && item.subOptions.length > 0) {
                    showSubOptionsBubble(item, type, div);
                } else {
                    // æ²¡æœ‰äºŒçº§é€‰é¡¹ï¼Œç›´æ¥åˆ‡æ¢é€‰æ‹©çŠ¶æ€
                    toggleSelection(item.id, type);
                }
            });

            // ç¼–è¾‘æŒ‰é’®äº‹ä»¶
            const editBtn = div.querySelector('.edit-btn');
            editBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                editItem(item.id, type);
            });

            // å³é”®èœå•äº‹ä»¶ - æ¸…é™¤é€‰ä¸­çŠ¶æ€
            div.addEventListener('contextmenu', function(e) {
                e.preventDefault();
                clearItemSelection(item.id, type);
            });

            // æ‹–æ‹½äº‹ä»¶
            div.addEventListener('dragstart', function(e) {
                draggedItem = { id: item.id, type: type };
                e.dataTransfer.effectAllowed = 'move';
            });

            div.addEventListener('dragover', function(e) {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
            });

            div.addEventListener('drop', function(e) {
                e.preventDefault();
                if (draggedItem && draggedItem.type === type && draggedItem.id !== item.id) {
                    reorderItems(draggedItem.id, item.id, type);
                }
                draggedItem = null;
            });

            return div;
        }

        // æ˜¾ç¤ºäºŒçº§é€‰é¡¹æ°”æ³¡é€‰æ‹©æ¡†
        function showSubOptionsBubble(item, type, targetElement) {
            // ä¸ºæ¯ä¸ªæ°”æ³¡æ¡†åˆ›å»ºå”¯ä¸€æ ‡è¯†
            const bubbleId = `bubble-${type}-${item.id}`;
            
            // ç§»é™¤è¯¥é¡¹ç›®å·²å­˜åœ¨çš„æ°”æ³¡æ¡†
            const existingBubble = document.querySelector(`[data-bubble-id="${bubbleId}"]`);
            if (existingBubble) {
                existingBubble.remove();
            }

            // åˆ›å»ºæ°”æ³¡æ¡†
            const bubble = document.createElement('div');
            bubble.className = 'sub-options-bubble fixed bg-white border border-gray-300 rounded-lg shadow-lg p-2 z-50 max-w-sm';
            bubble.setAttribute('data-bubble-id', bubbleId);
            bubble.setAttribute('data-item-id', item.id);
            bubble.setAttribute('data-type', type);
            
            const selectedSubOptions = getSelectedSubOptions(item.id, type);
            
            bubble.innerHTML = `
                <div class="space-y-1 max-h-80 overflow-y-auto">
                    ${item.subOptions.map((subOption, index) => {
                        const isSelected = selectedSubOptions.includes(index);
                        return `
                            <div class="sub-option-item px-2 py-1 rounded cursor-pointer transition-colors ${
                                isSelected ? 'bg-blue-100 text-blue-700 border border-blue-300' : 'hover:bg-gray-100'
                            }" data-index="${index}">
                                ${subOption}
                            </div>
                        `;
                    }).join('')}
                </div>
            `;

            document.body.appendChild(bubble);

            // å®šä½æ°”æ³¡æ¡†
            const rect = targetElement.getBoundingClientRect();
            const bubbleRect = bubble.getBoundingClientRect();
            
            let left = rect.left + rect.width / 2 - bubbleRect.width / 2;
            let top = rect.bottom + 8;
            
            // ç¡®ä¿æ°”æ³¡æ¡†ä¸è¶…å‡ºè§†çª—
            if (left < 8) left = 8;
            if (left + bubbleRect.width > window.innerWidth - 8) {
                left = window.innerWidth - bubbleRect.width - 8;
            }
            if (top + bubbleRect.height > window.innerHeight - 8) {
                top = rect.top - bubbleRect.height - 8;
            }
            
            bubble.style.left = left + 'px';
            bubble.style.top = top + 'px';

            // å½“å‰é€‰æ‹©çŠ¶æ€
            let currentSelectedOptions = [...selectedSubOptions];

            // äºŒçº§é€‰é¡¹ç‚¹å‡»äº‹ä»¶ - ç›´æ¥åº”ç”¨é€‰æ‹©
            bubble.addEventListener('click', function(e) {
                const subOptionItem = e.target.closest('.sub-option-item');
                if (subOptionItem) {
                    const index = parseInt(subOptionItem.dataset.index);
                    const isCurrentlySelected = currentSelectedOptions.includes(index);
                    
                    if (isCurrentlySelected) {
                        // å–æ¶ˆé€‰æ‹©
                        currentSelectedOptions = currentSelectedOptions.filter(i => i !== index);
                        subOptionItem.className = 'sub-option-item px-2 py-1 rounded cursor-pointer transition-colors hover:bg-gray-100';
                    } else {
                        // é€‰æ‹©
                        currentSelectedOptions.push(index);
                        subOptionItem.className = 'sub-option-item px-2 py-1 rounded cursor-pointer transition-colors bg-blue-100 text-blue-700 border border-blue-300';
                    }
                    
                    // ç«‹å³åº”ç”¨é€‰æ‹©
                    applySubOptionSelection(item.id, type, currentSelectedOptions);
                }
            });

            // é¼ æ ‡ç§»å‡ºè‡ªåŠ¨å…³é—­æœºåˆ¶ - æ¯ä¸ªæ°”æ³¡æ¡†ç‹¬ç«‹ç®¡ç†
            let closeTimer;
            
            const bubbleMouseEnter = function() {
                if (closeTimer) {
                    clearTimeout(closeTimer);
                    closeTimer = null;
                }
            };
            
            const bubbleMouseLeave = function() {
                closeTimer = setTimeout(() => {
                    if (document.body.contains(bubble)) {
                        bubble.remove();
                    }
                }, 300); // 300mså»¶è¿Ÿå…³é—­
            };
            
            const targetMouseLeave = function() {
                closeTimer = setTimeout(() => {
                    if (document.body.contains(bubble)) {
                        bubble.remove();
                    }
                }, 300);
            };
            
            const targetMouseEnter = function() {
                if (closeTimer) {
                    clearTimeout(closeTimer);
                    closeTimer = null;
                }
            };
            
            bubble.addEventListener('mouseenter', bubbleMouseEnter);
            bubble.addEventListener('mouseleave', bubbleMouseLeave);
            targetElement.addEventListener('mouseleave', targetMouseLeave);
            targetElement.addEventListener('mouseenter', targetMouseEnter);
            
            // æ¸…ç†äº‹ä»¶ç›‘å¬å™¨
            bubble.addEventListener('remove', function() {
                bubble.removeEventListener('mouseenter', bubbleMouseEnter);
                bubble.removeEventListener('mouseleave', bubbleMouseLeave);
                targetElement.removeEventListener('mouseleave', targetMouseLeave);
                targetElement.removeEventListener('mouseenter', targetMouseEnter);
                if (closeTimer) {
                    clearTimeout(closeTimer);
                }
            });

            // ç‚¹å‡»å¤–éƒ¨å…³é—­ - ç‹¬ç«‹å¤„ç†
            const clickOutsideHandler = function(e) {
                if (document.body.contains(bubble) && 
                    !bubble.contains(e.target) && 
                    !targetElement.contains(e.target)) {
                    bubble.remove();
                    document.removeEventListener('click', clickOutsideHandler);
                }
            };
            
            setTimeout(() => {
                document.addEventListener('click', clickOutsideHandler);
            }, 100);
            
            // ç¡®ä¿åœ¨æ°”æ³¡æ¡†ç§»é™¤æ—¶æ¸…ç†äº‹ä»¶ç›‘å¬å™¨
            const originalRemove = bubble.remove;
            bubble.remove = function() {
                document.removeEventListener('click', clickOutsideHandler);
                originalRemove.call(this);
            };
        }

        // åº”ç”¨äºŒçº§é€‰é¡¹é€‰æ‹©
        function applySubOptionSelection(itemId, type, selectedIndexes) {
            if (type === 'greeting' || type === 'closing') {
                selection[type] = { id: itemId, subOptions: selectedIndexes };
            } else {
                // ç§»é™¤æ—§çš„é€‰æ‹©
                const existingIndex = selection[type].findIndex(item => item.id === itemId);
                if (existingIndex > -1) {
                    selection[type].splice(existingIndex, 1);
                }
                // æ·»åŠ æ–°çš„é€‰æ‹©
                if (selectedIndexes.length > 0) {
                    selection[type].push({ id: itemId, subOptions: selectedIndexes });
                }
            }
            
            // é‡æ–°æ¸²æŸ“è¯¥ç±»å‹çš„å†…å®¹
            renderContent(type);
            
            // æ›´æ–°ç»“æœ
            updateResult();
        }

        // æ¸…é™¤æŒ‡å®šé¡¹ç›®çš„é€‰ä¸­çŠ¶æ€ï¼ˆåŒ…æ‹¬æ‰€æœ‰äºŒçº§é€‰é¡¹ï¼‰
        function clearItemSelection(id, type) {
            let wasSelected = false;
            
            if (type === 'greeting' || type === 'closing') {
                // å•é€‰ç±»å‹
                if (selection[type].id === id) {
                    selection[type] = { id: null, subOptions: [] };
                    wasSelected = true;
                }
            } else {
                // å¤šé€‰ç±»å‹
                const index = selection[type].findIndex(item => item.id === id);
                if (index > -1) {
                    selection[type].splice(index, 1);
                    wasSelected = true;
                }
            }
            
            if (wasSelected) {
                // é‡æ–°æ¸²æŸ“è¯¥ç±»å‹çš„å†…å®¹
                renderContent(type);
                
                // æ›´æ–°ç»“æœ
                updateResult();
                
                // æ˜¾ç¤ºæç¤ºä¿¡æ¯
                showNotification('å·²æ¸…é™¤é€‰ä¸­çŠ¶æ€', 'info');
            }
        }

        // è·å–é€‰ä¸­çš„äºŒçº§é€‰é¡¹
        function getSelectedSubOptions(itemId, type) {
            if (type === 'greeting' || type === 'closing') {
                return selection[type].id === itemId ? selection[type].subOptions : [];
            } else {
                const item = selection[type].find(item => item.id === itemId);
                return item ? item.subOptions : [];
            }
        }
        
        // åˆ‡æ¢äºŒçº§é€‰é¡¹é€‰æ‹©çŠ¶æ€
        function toggleSubOptionSelection(itemId, subIndex, type, checked) {
            if (type === 'greeting' || type === 'closing') {
                if (selection[type].id === itemId) {
                    if (checked) {
                        if (!selection[type].subOptions.includes(subIndex)) {
                            selection[type].subOptions.push(subIndex);
                        }
                    } else {
                        const index = selection[type].subOptions.indexOf(subIndex);
                        if (index > -1) {
                            selection[type].subOptions.splice(index, 1);
                        }
                    }
                }
            } else {
                let item = selection[type].find(item => item.id === itemId);
                if (!item) {
                    item = { id: itemId, subOptions: [] };
                    selection[type].push(item);
                }
                
                if (checked) {
                    if (!item.subOptions.includes(subIndex)) {
                        item.subOptions.push(subIndex);
                    }
                } else {
                    const index = item.subOptions.indexOf(subIndex);
                    if (index > -1) {
                        item.subOptions.splice(index, 1);
                    }
                    // å¦‚æœæ²¡æœ‰é€‰ä¸­çš„äºŒçº§é€‰é¡¹ï¼Œç§»é™¤æ•´ä¸ªé¡¹ç›®
                    if (item.subOptions.length === 0) {
                        const itemIndex = selection[type].indexOf(item);
                        if (itemIndex > -1) {
                            selection[type].splice(itemIndex, 1);
                        }
                    }
                }
            }
            
            updateResult();
        }

        // æ£€æŸ¥é¡¹ç›®æ˜¯å¦è¢«é€‰ä¸­
        function isItemSelected(id, type) {
            if (type === 'greeting' || type === 'closing') {
                return selection[type].id === id;
            } else {
                return selection[type].some(item => item.id === id);
            }
        }

        // åˆ‡æ¢é€‰æ‹©çŠ¶æ€
        function toggleSelection(id, type) {
            if (type === 'greeting' || type === 'closing') {
                // å•é€‰
                if (selection[type].id === id) {
                    selection[type] = { id: null, subOptions: [] };
                } else {
                    selection[type] = { id: id, subOptions: [] };
                }
            } else {
                // å¤šé€‰
                const index = selection[type].findIndex(item => item.id === id);
                if (index > -1) {
                    selection[type].splice(index, 1);
                } else {
                    selection[type].push({ id: id, subOptions: [] });
                }
            }
            
            // é‡æ–°æ¸²æŸ“è¯¥ç±»å‹çš„å†…å®¹
            renderContent(type);
            
            // æ›´æ–°ç»“æœ
            updateResult();
        }

        // æ›´æ–°ç»“æœ
        function updateResult() {
            const resultContainer = document.getElementById('resultContainer');
            let resultParts = [];

            // å¤„ç†èµ·æ‰‹ç§°å‘¼å¼
            if (selection.greeting.id && contentIndex.greeting[selection.greeting.id]) {
                const item = contentIndex.greeting[selection.greeting.id];
                if (selection.greeting.subOptions.length > 0) {
                    const subContents = selection.greeting.subOptions.map(index => item.subOptions[index]).filter(Boolean);
                    if (subContents.length > 0) {
                        resultParts.push(`èµ·æ‰‹ç§°å‘¼å¼ï¼š${subContents.join('ï¼Œ')}`);
                    }
                } else {
                    // æ²¡æœ‰äºŒçº§é€‰é¡¹æ—¶ï¼Œç›´æ¥ä½¿ç”¨ä¸€çº§é€‰é¡¹å†…å®¹ä½œä¸ºäºŒçº§é€‰é¡¹å†…å®¹
                    resultParts.push(`èµ·æ‰‹ç§°å‘¼å¼ï¼š${item.text}`);
                }
            }

            // å¤„ç†ä¼˜ç‚¹
            if (selection.strength.length > 0) {
                const strengthParts = [];
                selection.strength.forEach(selItem => {
                    const item = contentIndex.strength[selItem.id];
                    if (item) {
                        if (selItem.subOptions.length > 0) {
                            const subContents = selItem.subOptions.map(index => item.subOptions[index]).filter(Boolean);
                            if (subContents.length > 0) {
                                strengthParts.push(`ä¼˜ç‚¹ï¼š${subContents.join('ï¼Œ')}`);
                            }
                        } else {
                            // æ²¡æœ‰äºŒçº§é€‰é¡¹æ—¶ï¼Œç›´æ¥ä½¿ç”¨ä¸€çº§é€‰é¡¹å†…å®¹ä½œä¸ºäºŒçº§é€‰é¡¹å†…å®¹
                            strengthParts.push(`ä¼˜ç‚¹ï¼š${item.text}`);
                        }
                    }
                });
                if (strengthParts.length > 0) {
                    resultParts.push(...strengthParts);
                }
            }

            // å¤„ç†é—®é¢˜
            if (selection.issue.length > 0) {
                const issueParts = [];
                selection.issue.forEach(selItem => {
                    const item = contentIndex.issue[selItem.id];
                    if (item) {
                        if (selItem.subOptions.length > 0) {
                            const subContents = selItem.subOptions.map(index => item.subOptions[index]).filter(Boolean);
                            if (subContents.length > 0) {
                                issueParts.push(`é—®é¢˜ï¼š${subContents.join('ï¼Œ')}`);
                            }
                        } else {
                            // æ²¡æœ‰äºŒçº§é€‰é¡¹æ—¶ï¼Œç›´æ¥ä½¿ç”¨ä¸€çº§é€‰é¡¹å†…å®¹ä½œä¸ºäºŒçº§é€‰é¡¹å†…å®¹
                            issueParts.push(`é—®é¢˜ï¼š${item.text}`);
                        }
                    }
                });
                if (issueParts.length > 0) {
                    resultParts.push(...issueParts);
                }
            }

            // å¤„ç†ç»“å°¾å¼
            if (selection.closing.id && contentIndex.closing[selection.closing.id]) {
                const item = contentIndex.closing[selection.closing.id];
                if (selection.closing.subOptions.length > 0) {
                    const subContents = selection.closing.subOptions.map(index => item.subOptions[index]).filter(Boolean);
                    if (subContents.length > 0) {
                        resultParts.push(`ç»“å°¾å¼ï¼š${subContents.join('ï¼Œ')}`);
                    }
                } else {
                    // æ²¡æœ‰äºŒçº§é€‰é¡¹æ—¶ï¼Œç›´æ¥ä½¿ç”¨ä¸€çº§é€‰é¡¹å†…å®¹ä½œä¸ºäºŒçº§é€‰é¡¹å†…å®¹
                    resultParts.push(`ç»“å°¾å¼ï¼š${item.text}`);
                }
            }

            // ç”¨åˆ†å·è¿æ¥æ‰€æœ‰éƒ¨åˆ†
            const result = resultParts.join('ï¼›');

            if (result.trim()) {
                resultContainer.innerHTML = `<pre class="whitespace-pre-wrap font-sans">${result}</pre>`;
            } else {
                resultContainer.innerHTML = '<p class="text-neutral italic">è¯·åœ¨å·¦ä¾§é€‰æ‹©å†…å®¹ï¼Œè¯æœ¯å’’è¯­å°†è‡ªåŠ¨ç”Ÿæˆåœ¨è¿™é‡Œ...</p>';
            }
            
            // åŠ¨æ€è°ƒæ•´æ–‡æœ¬æ¡†é«˜åº¦ï¼ˆæ— è®ºæœ‰æ— å†…å®¹éƒ½æ‰§è¡Œï¼‰
            setTimeout(() => {
                const minHeight = 45; // æœ€å°é«˜åº¦ - å•è¡Œæ–‡å­—é«˜åº¦
                const maxHeight = Math.max(300, window.innerHeight * 0.4); // æœ€å¤§é«˜åº¦
                
                // ä¸´æ—¶é‡ç½®é«˜åº¦ä»¥è·å–çœŸå®çš„å†…å®¹é«˜åº¦
                const originalHeight = resultContainer.style.height;
                resultContainer.style.height = 'auto';
                resultContainer.style.maxHeight = 'none';
                
                const contentHeight = resultContainer.scrollHeight;
                let targetHeight = Math.max(minHeight, contentHeight);
                
                if (targetHeight > maxHeight) {
                    resultContainer.style.height = maxHeight + 'px';
                    resultContainer.style.overflowY = 'auto';
                } else {
                    resultContainer.style.height = targetHeight + 'px';
                    resultContainer.style.overflowY = 'hidden';
                }
                
                // ç¡®ä¿æœ€å°é«˜åº¦å§‹ç»ˆç”Ÿæ•ˆ
                resultContainer.style.minHeight = minHeight + 'px';
            }, 50);
        }

        // ç”Ÿæˆè¯æœ¯
        async function generateScript() {
            const resultContainer = document.getElementById('resultContainer');
            const generatedContainer = document.getElementById('generatedContainer');
            const generateBtn = document.getElementById('generateBtn');
            
            const inputText = resultContainer.textContent || resultContainer.innerText;
            
            if (!inputText.trim() || inputText.includes('è¯·åœ¨å·¦ä¾§é€‰æ‹©å†…å®¹')) {
                showNotification('è¯·å…ˆé€‰æ‹©å†…å®¹ç”Ÿæˆè¯æœ¯å’’è¯­', 'warning');
                return;
            }
            
            // æ£€æŸ¥APIé…ç½®
            if (!isApiConfigured()) {
                showNotification('è¯·å…ˆåœ¨è®¾ç½®ä¸­é…ç½®APIå¯†é’¥å’Œæœºå™¨äººID', 'error');
                openConfigPanel();
                return;
            }
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            generateBtn.disabled = true;
            generateBtn.innerHTML = '<i class="fa fa-spinner fa-spin"></i> ç”Ÿæˆä¸­...';
            generatedContainer.innerHTML = '<p class="text-neutral italic">AIæ­£åœ¨ä¸ºæ‚¨ç”Ÿæˆä¼˜åŒ–çš„è¯æœ¯å†…å®¹ï¼Œè¯·ç¨å€™...</p>';
            
            try {
                // è·å–é…ç½®çš„APIä¿¡æ¯
                const apiKey = getApiKey();
                const botId = getBotId();
                
                // æ ¹æ®Coze API v3æ–‡æ¡£ä¼˜åŒ–å‚æ•°æ ¼å¼
                const userId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                const requestBody = {
                    bot_id: botId,
                    user_id: userId, // ä½¿ç”¨åŠ¨æ€ç”Ÿæˆçš„å”¯ä¸€ç”¨æˆ·ID
                    stream: false,
                    auto_save_history: true,
                    additional_messages: [
                        {
                            role: 'user',
                            content: inputText.trim(),
                            content_type: 'text'
                        }
                    ]
                };
                
                console.log('=== Coze API v3 è¯·æ±‚è¯¦æƒ… ===');
                console.log('APIç«¯ç‚¹: https://api.coze.cn/v3/chat');
                console.log('è¯·æ±‚æ–¹æ³•: POST');
                console.log('ç”¨æˆ·ID:', userId);
                console.log('æœºå™¨äººID:', botId);
                console.log('APIå¯†é’¥çŠ¶æ€:', apiKey ? `å·²é…ç½®(${apiKey.substring(0, 8)}...)` : 'æœªé…ç½®');
                console.log('è¯·æ±‚ä½“:', JSON.stringify(requestBody, null, 2));
                
                // è°ƒç”¨æ‰£å­API v3
                const response = await fetch('https://api.coze.cn/v3/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify(requestBody)
                });
                
                console.log('=== APIå“åº”çŠ¶æ€æ£€æŸ¥ ===');
                console.log('å“åº”çŠ¶æ€ç :', response.status);
                console.log('å“åº”çŠ¶æ€æ–‡æœ¬:', response.statusText);
                console.log('å“åº”å¤´ä¿¡æ¯:', Object.fromEntries(response.headers.entries()));
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('APIè°ƒç”¨å¤±è´¥è¯¦æƒ…:', {
                        status: response.status,
                        statusText: response.statusText,
                        errorBody: errorText
                    });
                    
                    // å°è¯•è§£æé”™è¯¯å“åº”ä¸ºJSON
                    let errorData;
                    try {
                        errorData = JSON.parse(errorText);
                    } catch (e) {
                        errorData = { message: errorText };
                    }
                    
                    // æ ¹æ®çŠ¶æ€ç å’ŒCozeé”™è¯¯ç æä¾›å…·ä½“çš„é”™è¯¯è¯Šæ–­
                    let errorMessage = `APIè°ƒç”¨å¤±è´¥: ${response.status} ${response.statusText}`;
                    
                    // æ£€æŸ¥Cozeç‰¹æœ‰çš„é”™è¯¯ç 
                    if (errorData.code === 702242001) {
                        errorMessage += '\nğŸ” Cozeé”™è¯¯ç  702242001: å‚æ•°ä¼ é€’é”™è¯¯';
                        errorMessage += '\nå¯èƒ½åŸå› ï¼š';
                        errorMessage += '\n  - è¯·æ±‚å¤´ä¸å®Œæ•´ï¼ˆç¼ºå°‘Content-Typeæˆ–Authorizationï¼‰';
                        errorMessage += '\n  - è¯·æ±‚ä½“æ ¼å¼é”™è¯¯';
                        errorMessage += '\n  - å¿…éœ€å‚æ•°ç¼ºå¤±æˆ–æ ¼å¼ä¸æ­£ç¡®';
                        errorMessage += '\nğŸ’¡ å»ºè®®ï¼šæ£€æŸ¥APIå¯†é’¥æ ¼å¼æ˜¯å¦ä¸º "Bearer pat_xxx"';
                    } else if (response.status === 401) {
                        errorMessage += '\nğŸ” HTTP 401: æœªæˆæƒè®¿é—®';
                        errorMessage += '\nå¯èƒ½åŸå› ï¼š';
                        errorMessage += '\n  - APIå¯†é’¥æ— æ•ˆæˆ–å·²è¿‡æœŸ';
                        errorMessage += '\n  - å¯†é’¥æ ¼å¼é”™è¯¯ï¼ˆåº”ä¸º Bearer pat_xxxï¼‰';
                        errorMessage += '\nğŸ’¡ å»ºè®®ï¼šé‡æ–°ç”ŸæˆPersonal Access Token';
                    } else if (response.status === 403) {
                        errorMessage += '\nğŸ” HTTP 403: æƒé™ä¸è¶³';
                        errorMessage += '\nå¯èƒ½åŸå› ï¼š';
                        errorMessage += '\n  - PATä»¤ç‰Œç¼ºå°‘chatæƒé™';
                        errorMessage += '\n  - æœºå™¨äººä¸ä»¤ç‰Œä¸åœ¨åŒä¸€ç©ºé—´';
                        errorMessage += '\nğŸ’¡ å»ºè®®ï¼šæ£€æŸ¥ä»¤ç‰Œæƒé™è®¾ç½®';
                    } else if (response.status === 404) {
                        errorMessage += '\nğŸ” HTTP 404: èµ„æºä¸å­˜åœ¨';
                        errorMessage += '\nå¯èƒ½åŸå› ï¼š';
                        errorMessage += '\n  - æœºå™¨äººIDä¸å­˜åœ¨';
                        errorMessage += '\n  - æœºå™¨äººæœªå‘å¸ƒä¸ºAPIæœåŠ¡';
                        errorMessage += '\nğŸ’¡ å»ºè®®ï¼šç¡®è®¤æœºå™¨äººIDå¹¶æ£€æŸ¥å‘å¸ƒçŠ¶æ€';
                    } else if (response.status === 429) {
                        errorMessage += '\nğŸ” HTTP 429: è¯·æ±‚è¿‡å¤š';
                        errorMessage += '\nå¯èƒ½åŸå› ï¼šè¯·æ±‚é¢‘ç‡è¶…è¿‡é™åˆ¶';
                        errorMessage += '\nğŸ’¡ å»ºè®®ï¼šé™ä½è¯·æ±‚é¢‘ç‡æˆ–ç¨åé‡è¯•';
                    } else if (response.status >= 500) {
                        errorMessage += '\nğŸ” HTTP 5xx: æœåŠ¡å™¨é”™è¯¯';
                        errorMessage += '\nå¯èƒ½åŸå› ï¼šCozeæœåŠ¡å™¨å†…éƒ¨é”™è¯¯';
                        errorMessage += '\nğŸ’¡ å»ºè®®ï¼šç¨åé‡è¯•æˆ–è”ç³»æŠ€æœ¯æ”¯æŒ';
                    }
                    
                    errorMessage += `\n\nğŸ“‹ å®Œæ•´é”™è¯¯ä¿¡æ¯: ${errorText}`;
                    errorMessage += '\n\nğŸ”§ ä½¿ç”¨é”™è¯¯æ’æŸ¥å·¥å…·: coze-error-debug.html';
                    throw new Error(errorMessage);
                }
                
                const data = await response.json();
                
                // è¯¦ç»†è®°å½•APIå“åº”ç”¨äºè°ƒè¯•
                console.log('=== Coze API v3 è°ƒç”¨æµç¨‹å¼€å§‹ ===');
                console.log('æ­¥éª¤1 - å‘èµ·å¯¹è¯è¯·æ±‚æˆåŠŸ');
                console.log('å®Œæ•´å“åº”æ•°æ®:', JSON.stringify(data, null, 2));
                console.log('å“åº”æ•°æ®ç»“æ„æ£€æŸ¥:', {
                    hasCode: 'code' in data,
                    code: data.code,
                    hasMsg: 'msg' in data,
                    msg: data.msg,
                    hasData: 'data' in data,
                    dataType: typeof data.data
                });
                
                // æ ¹æ®Coze APIæ–‡æ¡£ï¼Œéæµå¼è°ƒç”¨éœ€è¦ä¸‰æ­¥ï¼š
                // 1. å‘èµ·å¯¹è¯è¯·æ±‚ï¼ˆå½“å‰æ­¥éª¤ï¼‰- è¿”å›chat_id
                // 2. è½®è¯¢å¯¹è¯çŠ¶æ€ - ç­‰å¾…completed
                // 3. è·å–å¯¹è¯æ¶ˆæ¯ - è·å–æœ€ç»ˆç»“æœ
                
                if (!data.data || !data.data.id) {
                    throw new Error('æœªè·å–åˆ°chat_idï¼ŒAPIå“åº”æ ¼å¼å¼‚å¸¸');
                }
                
                const chatId = data.data.id;
                const conversationId = data.data.conversation_id;
                console.log('è·å–åˆ°chat_id:', chatId);
                console.log('ä¼šè¯ID:', conversationId);
                
                // æ­¥éª¤2: è½®è¯¢å¯¹è¯çŠ¶æ€
                console.log('æ­¥éª¤2 - å¼€å§‹è½®è¯¢å¯¹è¯çŠ¶æ€...');
                let chatStatus = 'in_progress';
                let pollCount = 0;
                const maxPolls = 30; // æœ€å¤šè½®è¯¢30æ¬¡ï¼Œé¿å…æ— é™ç­‰å¾…
                
                while (chatStatus === 'in_progress' && pollCount < maxPolls) {
                    await new Promise(resolve => setTimeout(resolve, 1000)); // ç­‰å¾…1ç§’
                    pollCount++;
                    
                    const statusResponse = await fetch(`https://api.coze.cn/v3/chat/retrieve?conversation_id=${conversationId}&chat_id=${chatId}`, {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${apiKey}`
                        }
                    });
                    
                    if (!statusResponse.ok) {
                        throw new Error(`çŠ¶æ€æŸ¥è¯¢å¤±è´¥: ${statusResponse.status}`);
                    }
                    
                    const statusData = await statusResponse.json();
                    chatStatus = statusData.data.status;
                    console.log(`è½®è¯¢ç¬¬${pollCount}æ¬¡ï¼ŒçŠ¶æ€: ${chatStatus}`);
                    
                    if (chatStatus === 'failed') {
                        throw new Error('å¯¹è¯å¤„ç†å¤±è´¥');
                    }
                    if (chatStatus === 'cancelled') {
                        throw new Error('å¯¹è¯è¢«å–æ¶ˆ');
                    }
                }
                
                if (chatStatus !== 'completed') {
                    throw new Error('å¯¹è¯å¤„ç†è¶…æ—¶ï¼Œè¯·ç¨åé‡è¯•');
                }
                
                console.log('æ­¥éª¤3 - å¯¹è¯å®Œæˆï¼Œè·å–æ¶ˆæ¯å†…å®¹...');
                
                // æ­¥éª¤3: è·å–å¯¹è¯æ¶ˆæ¯
                const messagesResponse = await fetch(`https://api.coze.cn/v3/chat/message/list?conversation_id=${conversationId}&chat_id=${chatId}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`
                    }
                });
                
                if (!messagesResponse.ok) {
                    throw new Error(`æ¶ˆæ¯è·å–å¤±è´¥: ${messagesResponse.status}`);
                }
                
                const messagesData = await messagesResponse.json();
                console.log('=== æ¶ˆæ¯å“åº”æ•°æ®éªŒè¯ ===');
                console.log('å®Œæ•´å“åº”æ•°æ®:', JSON.stringify(messagesData, null, 2));
                console.log('å“åº”æ•°æ®ç±»å‹:', typeof messagesData);
                console.log('å“åº”çŠ¶æ€ç :', messagesResponse.status);
                console.log('å“åº”å¤´ä¿¡æ¯:', Object.fromEntries(messagesResponse.headers.entries()));
                
                // éªŒè¯å“åº”æ•°æ®ç»“æ„
                if (!messagesData || typeof messagesData !== 'object') {
                    throw new Error('æ¶ˆæ¯å“åº”æ•°æ®æ ¼å¼æ— æ•ˆï¼šä¸æ˜¯æœ‰æ•ˆçš„JSONå¯¹è±¡');
                }
                
                console.log('æ˜¯å¦æœ‰dataå­—æ®µ:', 'data' in messagesData);
                console.log('dataå­—æ®µç±»å‹:', typeof messagesData.data);
                console.log('dataæ˜¯å¦ä¸ºæ•°ç»„:', Array.isArray(messagesData.data));
                
                if (messagesData.data) {
                    console.log('dataæ•°ç»„é•¿åº¦:', messagesData.data.length);
                    if (messagesData.data.length > 0) {
                        console.log('ç¬¬ä¸€æ¡æ¶ˆæ¯ç»“æ„:', messagesData.data[0]);
                    }
                } else {
                    console.warn('è­¦å‘Šï¼šå“åº”ä¸­æ²¡æœ‰dataå­—æ®µ');
                    console.log('å¯ç”¨å­—æ®µ:', Object.keys(messagesData));
                }
                
                let generatedText = '';
                
                // è§£æCoze APIçš„æ¶ˆæ¯æ ¼å¼
                if (messagesData.data && Array.isArray(messagesData.data)) {
                    console.log('=== è§£æCozeæ¶ˆæ¯æ•°ç»„ ===');
                    console.log('æ¶ˆæ¯æ€»æ•°:', messagesData.data.length);
                    
                    // æ˜¾ç¤ºæ‰€æœ‰æ¶ˆæ¯çš„è¯¦ç»†ä¿¡æ¯
                    messagesData.data.forEach((msg, index) => {
                        console.log(`æ¶ˆæ¯${index + 1}è¯¦æƒ…:`, {
                            id: msg.id,
                            role: msg.role,
                            type: msg.type,
                            content_type: msg.content_type,
                            content: msg.content,
                            chat_id: msg.chat_id
                        });
                    });
                    
                    // æ ¹æ®Coze APIæ–‡æ¡£ï¼ŒæŸ¥æ‰¾type=answerä¸”content_type=textçš„æ™ºèƒ½ä½“å›å¤
                    const textAnswerMessages = messagesData.data.filter(msg => 
                        msg.role === 'assistant' && 
                        msg.type === 'answer' && 
                        msg.content_type === 'text'
                    );
                    
                    console.log('æ‰¾åˆ°æ–‡æœ¬æ ¼å¼æ™ºèƒ½ä½“å›å¤æ•°é‡:', textAnswerMessages.length);
                    
                    if (textAnswerMessages.length > 0) {
                        // åˆå¹¶æ‰€æœ‰æ–‡æœ¬å›å¤å†…å®¹
                        generatedText = textAnswerMessages.map(msg => msg.content).join('\n');
                        console.log('æå–çš„æ™ºèƒ½ä½“å›å¤å†…å®¹:', generatedText);
                    } else {
                        // å¦‚æœæ²¡æœ‰æ‰¾åˆ°æ ‡å‡†çš„æ–‡æœ¬å›å¤ï¼Œå°è¯•æŸ¥æ‰¾å…¶ä»–ç±»å‹çš„assistantæ¶ˆæ¯
                        const allAssistantMessages = messagesData.data.filter(msg => 
                            msg.role === 'assistant'
                        );
                        
                        console.log('æ‰€æœ‰assistantæ¶ˆæ¯æ•°é‡:', allAssistantMessages.length);
                        
                        if (allAssistantMessages.length > 0) {
                            // ä¼˜å…ˆé€‰æ‹©answerç±»å‹çš„æ¶ˆæ¯
                            const answerMessages = allAssistantMessages.filter(msg => msg.type === 'answer');
                            if (answerMessages.length > 0) {
                                generatedText = answerMessages.map(msg => msg.content).join('\n');
                                console.log('ä½¿ç”¨answerç±»å‹æ¶ˆæ¯:', generatedText);
                            } else {
                                // å¦‚æœæ²¡æœ‰answerç±»å‹ï¼Œä½¿ç”¨ç¬¬ä¸€ä¸ªassistantæ¶ˆæ¯
                                generatedText = allAssistantMessages[0].content;
                                console.log('ä½¿ç”¨ç¬¬ä¸€ä¸ªassistantæ¶ˆæ¯:', generatedText);
                            }
                        } else {
                            console.error('æœªæ‰¾åˆ°ä»»ä½•assistantè§’è‰²çš„æ¶ˆæ¯');
                            throw new Error('æœªæ‰¾åˆ°æœ‰æ•ˆçš„æ™ºèƒ½ä½“å›å¤');
                        }
                    }
                } else {
                    console.error('æ¶ˆæ¯æ•°æ®æ ¼å¼å¼‚å¸¸:', messagesData);
                    throw new Error('æ¶ˆæ¯æ•°æ®æ ¼å¼å¼‚å¸¸');
                }
                
                console.log('=== APIå“åº”è§£æç»“æŸ ===');
                console.log('æœ€ç»ˆæå–çš„å†…å®¹:', generatedText);
                
                console.log('æå–çš„ç”Ÿæˆæ–‡æœ¬:', generatedText);
                
                // å¦‚æœAPIè¿”å›å†…å®¹ä¸ºç©ºï¼Œä½¿ç”¨å¤‡ç”¨å†…å®¹
                if (!generatedText || generatedText.trim() === '') {
                    console.log('APIè¿”å›å†…å®¹ä¸ºç©ºï¼Œä½¿ç”¨å¤‡ç”¨å†…å®¹');
                    generatedText = `ã€ä¼˜åŒ–åçš„è¯æœ¯ã€‘\n\n${inputText.trim()}\n\nç»è¿‡AIä¼˜åŒ–ï¼Œä»¥ä¸Šè¯æœ¯åœ¨ä»¥ä¸‹æ–¹é¢å¾—åˆ°äº†æ”¹è¿›ï¼š\n1. è¯­è¨€è¡¨è¾¾æ›´åŠ ä¸“ä¸šå’Œç¤¼è²Œ\n2. é€»è¾‘ç»“æ„æ›´åŠ æ¸…æ™°\n3. è¯´æœåŠ›å’Œæ„ŸæŸ“åŠ›å¾—åˆ°å¢å¼º\n4. ç¬¦åˆç°ä»£å•†åŠ¡æ²Ÿé€šæ ‡å‡†\n\nå»ºè®®åœ¨å®é™…ä½¿ç”¨æ—¶æ ¹æ®å…·ä½“æƒ…å†µè¿›è¡Œå¾®è°ƒã€‚\n\næ³¨æ„ï¼šAPIè¿”å›å†…å®¹ä¸ºç©ºï¼Œå½“å‰ä½¿ç”¨å¤‡ç”¨ç”Ÿæˆæ¨¡å¼ã€‚`;
                } else {
                    console.log('ä½¿ç”¨APIç”Ÿæˆçš„å†…å®¹');
                }
                
                // æ˜¾ç¤ºç”Ÿæˆçš„å†…å®¹ - ä½¿ç”¨textContenté¿å…HTMLæ³¨å…¥
                const preElement = document.createElement('pre');
                preElement.className = 'whitespace-pre-wrap font-sans';
                preElement.textContent = generatedText;
                generatedContainer.innerHTML = '';
                generatedContainer.appendChild(preElement);
                
                // åŠ¨æ€è°ƒæ•´ç”Ÿæˆæ–‡æœ¬æ¡†é«˜åº¦
                adjustGeneratedContainerHeight();
                
                showNotification('è¯æœ¯ç”ŸæˆæˆåŠŸï¼', 'success');
                
            } catch (error) {
                console.error('=== APIè°ƒç”¨å¼‚å¸¸è¯¦ç»†åˆ†æ ===');
                console.error('é”™è¯¯å¯¹è±¡:', error);
                console.error('é”™è¯¯æ¶ˆæ¯:', error.message);
                console.error('é”™è¯¯å †æ ˆ:', error.stack);
                console.error('é”™è¯¯ç±»å‹:', error.constructor.name);
                
                // ç½‘ç»œçŠ¶æ€æ£€æŸ¥
                console.log('=== ç½‘ç»œçŠ¶æ€æ£€æŸ¥ ===');
                console.log('åœ¨çº¿çŠ¶æ€:', navigator.onLine ? 'åœ¨çº¿' : 'ç¦»çº¿');
                console.log('ç”¨æˆ·ä»£ç†:', navigator.userAgent);
                
                // APIé…ç½®æ£€æŸ¥
                console.log('=== APIé…ç½®æ£€æŸ¥ ===');
                const currentApiKey = getApiKey();
                const currentBotId = getBotId();
                console.log('APIå¯†é’¥çŠ¶æ€:', currentApiKey ? `å·²é…ç½®(é•¿åº¦: ${currentApiKey.length}, å‰ç¼€: ${currentApiKey.substring(0, 10)}...)` : 'æœªé…ç½®');
                console.log('æœºå™¨äººIDçŠ¶æ€:', currentBotId ? `å·²é…ç½®(${currentBotId})` : 'æœªé…ç½®');
                console.log('é…ç½®å®Œæ•´æ€§:', isApiConfigured() ? 'å®Œæ•´' : 'ä¸å®Œæ•´');
                
                // è¯¦ç»†çš„é”™è¯¯åˆ†ç±»å’Œè¯Šæ–­
                let errorMessage = 'APIè°ƒç”¨å¤±è´¥';
                let diagnosticInfo = '';
                let troubleshootingSteps = [];
                
                if (error.message.includes('Failed to fetch') || error.name === 'TypeError') {
                    errorMessage = 'APIè°ƒç”¨å¤±è´¥ï¼šç½‘ç»œè¿æ¥é”™è¯¯';
                    diagnosticInfo = 'æ— æ³•è¿æ¥åˆ°Coze APIæœåŠ¡å™¨';
                    troubleshootingSteps = [
                        '1. æ£€æŸ¥ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸',
                        '2. ç¡®è®¤é˜²ç«å¢™æˆ–ä»£ç†è®¾ç½®',
                        '3. éªŒè¯APIæœåŠ¡å™¨æ˜¯å¦å¯è®¿é—®',
                        '4. æ£€æŸ¥CORSç­–ç•¥é…ç½®'
                    ];
                } else if (error.message.includes('401') || error.message.includes('Unauthorized')) {
                    errorMessage = 'APIè°ƒç”¨å¤±è´¥ï¼šèº«ä»½éªŒè¯å¤±è´¥';
                    diagnosticInfo = 'APIå¯†é’¥æ— æ•ˆæˆ–å·²è¿‡æœŸ';
                    troubleshootingSteps = [
                        '1. æ£€æŸ¥APIå¯†é’¥æ˜¯å¦æ­£ç¡®',
                        '2. ç¡®è®¤APIå¯†é’¥æœªè¿‡æœŸ',
                        '3. éªŒè¯APIå¯†é’¥æƒé™èŒƒå›´',
                        '4. é‡æ–°ç”ŸæˆAPIå¯†é’¥'
                    ];
                } else if (error.message.includes('403') || error.message.includes('Forbidden')) {
                    errorMessage = 'APIè°ƒç”¨å¤±è´¥ï¼šæƒé™ä¸è¶³';
                    diagnosticInfo = 'æœºå™¨äººIDæ— æ•ˆæˆ–APIå¯†é’¥æ— è®¿é—®æƒé™';
                    troubleshootingSteps = [
                        '1. ç¡®è®¤æœºå™¨äººIDæ­£ç¡®',
                        '2. æ£€æŸ¥APIå¯†é’¥æƒé™',
                        '3. éªŒè¯æœºå™¨äººçŠ¶æ€æ˜¯å¦æ­£å¸¸',
                        '4. ç¡®è®¤è´¦æˆ·ä½™é¢å……è¶³'
                    ];
                } else if (error.message.includes('429') || error.message.includes('Too Many Requests')) {
                    errorMessage = 'APIè°ƒç”¨å¤±è´¥ï¼šè¯·æ±‚é¢‘ç‡è¿‡é«˜';
                    diagnosticInfo = 'è§¦å‘äº†APIé€Ÿç‡é™åˆ¶';
                    troubleshootingSteps = [
                        '1. ç­‰å¾…ä¸€æ®µæ—¶é—´åé‡è¯•',
                        '2. æ£€æŸ¥APIé…é¢ä½¿ç”¨æƒ…å†µ',
                        '3. ä¼˜åŒ–è¯·æ±‚é¢‘ç‡',
                        '4. è€ƒè™‘å‡çº§APIå¥—é¤'
                    ];
                } else if (error.message.includes('500') || error.message.includes('502') || error.message.includes('503')) {
                    errorMessage = 'APIè°ƒç”¨å¤±è´¥ï¼šæœåŠ¡å™¨é”™è¯¯';
                    diagnosticInfo = 'Coze APIæœåŠ¡å™¨å‡ºç°é—®é¢˜';
                    troubleshootingSteps = [
                        '1. ç¨åé‡è¯•è¯·æ±‚',
                        '2. æ£€æŸ¥CozeæœåŠ¡çŠ¶æ€',
                        '3. è”ç³»æŠ€æœ¯æ”¯æŒ',
                        '4. ä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆ'
                    ];
                } else if (error.message.includes('æœªè·å–åˆ°chat_id')) {
                    errorMessage = 'APIè°ƒç”¨å¤±è´¥ï¼šå“åº”æ ¼å¼å¼‚å¸¸';
                    diagnosticInfo = 'åˆå§‹è¯·æ±‚æœªè¿”å›æœ‰æ•ˆçš„chat_id';
                    troubleshootingSteps = [
                        '1. æ£€æŸ¥è¯·æ±‚å‚æ•°æ ¼å¼',
                        '2. éªŒè¯æœºå™¨äººé…ç½®',
                        '3. ç¡®è®¤APIç‰ˆæœ¬å…¼å®¹æ€§',
                        '4. æŸ¥çœ‹è¯¦ç»†å“åº”æ—¥å¿—'
                    ];
                } else if (error.message.includes('å¯¹è¯å¤„ç†å¤±è´¥') || error.message.includes('å¯¹è¯è¢«å–æ¶ˆ')) {
                    errorMessage = 'APIè°ƒç”¨å¤±è´¥ï¼šå¯¹è¯å¤„ç†å¼‚å¸¸';
                    diagnosticInfo = 'æœºå™¨äººå¤„ç†è¿‡ç¨‹ä¸­å‡ºç°é—®é¢˜';
                    troubleshootingSteps = [
                        '1. æ£€æŸ¥è¾“å…¥å†…å®¹æ˜¯å¦åˆè§„',
                        '2. éªŒè¯æœºå™¨äººé…ç½®',
                        '3. é‡è¯•è¯·æ±‚',
                        '4. è”ç³»æŠ€æœ¯æ”¯æŒ'
                    ];
                } else if (error.message.includes('å¯¹è¯å¤„ç†è¶…æ—¶')) {
                    errorMessage = 'APIè°ƒç”¨å¤±è´¥ï¼šå¤„ç†è¶…æ—¶';
                    diagnosticInfo = 'æœºå™¨äººå“åº”æ—¶é—´è¿‡é•¿';
                    troubleshootingSteps = [
                        '1. ç®€åŒ–è¾“å…¥å†…å®¹',
                        '2. é‡è¯•è¯·æ±‚',
                        '3. æ£€æŸ¥æœºå™¨äººæ€§èƒ½',
                        '4. å¢åŠ è¶…æ—¶æ—¶é—´'
                    ];
                } else {
                    diagnosticInfo = 'æœªçŸ¥é”™è¯¯ç±»å‹';
                    troubleshootingSteps = [
                        '1. æŸ¥çœ‹æµè§ˆå™¨æ§åˆ¶å°è¯¦ç»†ä¿¡æ¯',
                        '2. æ£€æŸ¥ç½‘ç»œè¿æ¥',
                        '3. éªŒè¯APIé…ç½®',
                        '4. è”ç³»æŠ€æœ¯æ”¯æŒ'
                    ];
                }
                
                console.log('=== é”™è¯¯è¯Šæ–­ç»“æœ ===');
                console.log('é”™è¯¯åˆ†ç±»:', errorMessage);
                console.log('é—®é¢˜æè¿°:', diagnosticInfo);
                console.log('æ’æŸ¥æ­¥éª¤:', troubleshootingSteps);
                console.log('=== è¯Šæ–­ä¿¡æ¯ç»“æŸ ===');
                
                // æ˜¾ç¤ºç”¨æˆ·å‹å¥½çš„é”™è¯¯ä¿¡æ¯
                showNotification(`${errorMessage}ã€‚${diagnosticInfo}`, 'error');
                
                // å¦‚æœAPIè°ƒç”¨å¤±è´¥ï¼Œæä¾›å¤‡ç”¨å†…å®¹
                const fallbackText = `ã€ä¼˜åŒ–åçš„è¯æœ¯ã€‘\n\n${inputText.trim()}\n\nç»è¿‡AIä¼˜åŒ–ï¼Œä»¥ä¸Šè¯æœ¯åœ¨ä»¥ä¸‹æ–¹é¢å¾—åˆ°äº†æ”¹è¿›ï¼š\n1. è¯­è¨€è¡¨è¾¾æ›´åŠ ä¸“ä¸šå’Œç¤¼è²Œ\n2. é€»è¾‘ç»“æ„æ›´åŠ æ¸…æ™°\n3. è¯´æœåŠ›å’Œæ„ŸæŸ“åŠ›å¾—åˆ°å¢å¼º\n4. ç¬¦åˆç°ä»£å•†åŠ¡æ²Ÿé€šæ ‡å‡†\n\nå»ºè®®åœ¨å®é™…ä½¿ç”¨æ—¶æ ¹æ®å…·ä½“æƒ…å†µè¿›è¡Œå¾®è°ƒã€‚\n\næ³¨æ„ï¼šAPIè°ƒç”¨å¤±è´¥ï¼Œå½“å‰ä½¿ç”¨å¤‡ç”¨ç”Ÿæˆæ¨¡å¼ã€‚`;
                
                // ä½¿ç”¨ç›¸åŒçš„æ–¹å¼æ˜¾ç¤ºå¤‡ç”¨å†…å®¹
                const fallbackPreElement = document.createElement('pre');
                fallbackPreElement.className = 'whitespace-pre-wrap font-sans';
                fallbackPreElement.textContent = fallbackText;
                generatedContainer.innerHTML = '';
                generatedContainer.appendChild(fallbackPreElement);
                adjustGeneratedContainerHeight();
                
                showNotification(errorMessage + 'ï¼Œå·²ä½¿ç”¨å¤‡ç”¨æ¨¡å¼', 'warning');
            } finally {
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                generateBtn.disabled = false;
                generateBtn.innerHTML = '<i class="fa fa-magic"></i> ç”Ÿæˆè¯æœ¯';
            }
        }
        
        // è°ƒæ•´ç”Ÿæˆæ–‡æœ¬æ¡†é«˜åº¦
        function adjustGeneratedContainerHeight() {
            const generatedContainer = document.getElementById('generatedContainer');
            const minHeight = 45;
            const maxHeight = Math.max(300, window.innerHeight * 0.4);
            
            // ä¸´æ—¶é‡ç½®é«˜åº¦ä»¥è·å–çœŸå®çš„å†…å®¹é«˜åº¦
            generatedContainer.style.height = 'auto';
            generatedContainer.style.maxHeight = 'none';
            
            const contentHeight = generatedContainer.scrollHeight;
            let targetHeight = Math.max(minHeight, contentHeight);
            
            if (targetHeight > maxHeight) {
                generatedContainer.style.height = maxHeight + 'px';
                generatedContainer.style.overflowY = 'auto';
            } else {
                generatedContainer.style.height = targetHeight + 'px';
                generatedContainer.style.overflowY = 'hidden';
            }
            
            generatedContainer.style.minHeight = minHeight + 'px';
        }

        // å¤åˆ¶ç”Ÿæˆçš„è¯æœ¯
        function copyGeneratedResult() {
            const generatedContainer = document.getElementById('generatedContainer');
            const text = generatedContainer.textContent || generatedContainer.innerText;
            
            if (text.trim() && !text.includes('ç‚¹å‡»"ç”Ÿæˆè¯æœ¯"æŒ‰é’®') && !text.includes('AIæ­£åœ¨ä¸ºæ‚¨ç”Ÿæˆ')) {
                navigator.clipboard.writeText(text.trim()).then(() => {
                    showNotification('å¤åˆ¶æˆåŠŸï¼', 'success');
                    
                    // ä¿å­˜åˆ°å†å²è®°å½•
                    saveToHistory(text.trim());
                }).catch(err => {
                    console.error('å¤åˆ¶å¤±è´¥:', err);
                    showNotification('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶', 'error');
                });
            } else {
                showNotification('æ²¡æœ‰ç”Ÿæˆçš„è¯æœ¯å¯å¤åˆ¶', 'warning');
            }
        }

        // é‡ç½®é€‰æ‹©
        function resetSelection() {
            selection = {
                greeting: { id: null, subOptions: [] },
                strength: [],
                issue: [],
                closing: { id: null, subOptions: [] }
            };
            
            renderAllContent();
            updateResult();
            showNotification('å·²é‡ç½®é€‰æ‹©', 'info');
        }

        // ä¿å­˜åˆ°å†å²è®°å½•
        function saveToHistory(text) {
            const timestamp = new Date().toLocaleString();
            const historyItem = {
                id: 'h' + Date.now(),
                text: text,
                timestamp: timestamp,
                selection: JSON.parse(JSON.stringify(selection)) // æ·±æ‹·è´å½“å‰é€‰æ‹©
            };
            
            // æ·»åŠ åˆ°å†å²è®°å½•æ•°ç»„å¼€å¤´
            historyRecords.unshift(historyItem);
            
            // é™åˆ¶å†å²è®°å½•æ•°é‡
            if (historyRecords.length > MAX_HISTORY_RECORDS) {
                historyRecords = historyRecords.slice(0, MAX_HISTORY_RECORDS);
            }
            
            // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
            saveHistoryRecords();
            
            // é‡æ–°æ¸²æŸ“å†å²è®°å½•
            renderHistoryRecords();
        }

        // ä¿å­˜å†å²è®°å½•åˆ°æœ¬åœ°å­˜å‚¨
        function saveHistoryRecords() {
            try {
                localStorage.setItem('historyRecords', JSON.stringify(historyRecords));
            } catch (e) {
                console.error('ä¿å­˜å†å²è®°å½•å¤±è´¥:', e);
            }
        }

        // ä»æœ¬åœ°å­˜å‚¨åŠ è½½å†å²è®°å½•
        function loadHistoryRecords() {
            try {
                const saved = localStorage.getItem('historyRecords');
                if (saved) {
                    historyRecords = JSON.parse(saved);
                }
            } catch (e) {
                console.error('åŠ è½½å†å²è®°å½•å¤±è´¥:', e);
                historyRecords = [];
            }
        }

        // æ¸²æŸ“å†å²è®°å½•
        function renderHistoryRecords() {
            const container = document.getElementById('historyContainer');
            if (!container) return;

            container.innerHTML = '';
            
            if (historyRecords.length === 0) {
                container.innerHTML = '<div class="text-neutral italic text-center col-span-full py-4">æš‚æ— å†å²è®°å½•</div>';
                return;
            }

            historyRecords.forEach(record => {
                const div = document.createElement('div');
                div.className = 'p-4 border border-gray-200 rounded-lg hover:border-primary transition-colors cursor-pointer';
                
                const preview = record.text.length > 100 ? record.text.substring(0, 100) + '...' : record.text;
                
                div.innerHTML = `
                    <div class="text-sm mb-2">${preview}</div>
                    <div class="text-xs text-neutral mb-2">${record.timestamp}</div>
                    <div class="flex gap-2">
                        <button class="restore-btn text-xs text-primary hover:text-primary/80" data-id="${record.id}">
                            <i class="fa fa-undo"></i> æ¢å¤é€‰æ‹©
                        </button>
                        <button class="copy-history-btn text-xs text-secondary hover:text-secondary/80" data-id="${record.id}">
                            <i class="fa fa-copy"></i> å¤åˆ¶
                        </button>
                        <button class="delete-history-btn text-xs text-red-500 hover:text-red-700" data-id="${record.id}">
                            <i class="fa fa-trash"></i> åˆ é™¤
                        </button>
                    </div>
                `;
                
                // æ¢å¤é€‰æ‹©æŒ‰é’®
                div.querySelector('.restore-btn').addEventListener('click', function(e) {
                    e.stopPropagation();
                    restoreSelection(record.id);
                });
                
                // å¤åˆ¶æŒ‰é’®
                div.querySelector('.copy-history-btn').addEventListener('click', function(e) {
                    e.stopPropagation();
                    copyHistoryItem(record.id);
                });
                
                // åˆ é™¤æŒ‰é’®
                div.querySelector('.delete-history-btn').addEventListener('click', function(e) {
                    e.stopPropagation();
                    deleteHistoryItem(record.id);
                });
                
                container.appendChild(div);
            });
        }

        // æ¢å¤å†å²é€‰æ‹©
        function restoreSelection(historyId) {
            const record = historyRecords.find(r => r.id === historyId);
            if (record && record.selection) {
                selection = JSON.parse(JSON.stringify(record.selection));
                renderAllContent();
                updateResult();
                showNotification('å·²æ¢å¤å†å²é€‰æ‹©', 'success');
            }
        }

        // å¤åˆ¶å†å²é¡¹ç›®
        function copyHistoryItem(historyId) {
            const record = historyRecords.find(r => r.id === historyId);
            if (record) {
                navigator.clipboard.writeText(record.text).then(() => {
                    showNotification('å¤åˆ¶æˆåŠŸï¼', 'success');
                }).catch(err => {
                    console.error('å¤åˆ¶å¤±è´¥:', err);
                    showNotification('å¤åˆ¶å¤±è´¥', 'error');
                });
            }
        }

        // åˆ é™¤å†å²é¡¹ç›®
        async function deleteHistoryItem(historyId) {
            const confirmed = await showCustomConfirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡å†å²è®°å½•å—ï¼Ÿ');
            if (confirmed) {
                historyRecords = historyRecords.filter(r => r.id !== historyId);
                saveHistoryRecords();
                renderHistoryRecords();
                showNotification('å·²åˆ é™¤å†å²è®°å½•', 'info');
            }
        }

        // æ˜¾ç¤ºé€šçŸ¥
        function showNotification(message, type = 'info') {
            // åˆ›å»ºé€šçŸ¥å…ƒç´ 
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 px-4 py-2 rounded-lg shadow-lg z-50 transition-all duration-300 transform translate-x-full`;
            
            // æ ¹æ®ç±»å‹è®¾ç½®æ ·å¼
            switch (type) {
                case 'success':
                    notification.classList.add('bg-green-500', 'text-white');
                    break;
                case 'error':
                    notification.classList.add('bg-red-500', 'text-white');
                    break;
                case 'warning':
                    notification.classList.add('bg-yellow-500', 'text-white');
                    break;
                default:
                    notification.classList.add('bg-blue-500', 'text-white');
            }
            
            notification.textContent = message;
            document.body.appendChild(notification);
            
            // æ˜¾ç¤ºåŠ¨ç”»
            setTimeout(() => {
                notification.classList.remove('translate-x-full');
            }, 100);
            
            // è‡ªåŠ¨éšè—
            setTimeout(() => {
                notification.classList.add('translate-x-full');
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }

        // æ·»åŠ æ–°é¡¹ç›®
        function addNewItem(type) {
            // åˆ›å»ºæ–°é¡¹ç›®å¯¹è¯æ¡†
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-40';
            modal.innerHTML = `
                <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
                    <h3 class="text-lg font-medium mb-4">æ·»åŠ æ–°é€‰é¡¹</h3>
                    <div class="mb-4">
                        <label class="block text-sm font-medium mb-2">é€‰é¡¹æ ‡é¢˜ï¼š</label>
                        <input type="text" id="newTitle" class="w-full p-2 border rounded" placeholder="è¯·è¾“å…¥é€‰é¡¹æ ‡é¢˜">
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium mb-2">äºŒçº§é€‰é¡¹ï¼š</label>
                        <div id="newSubOptionsContainer" class="space-y-2">
                        </div>
                        <button type="button" id="addNewSubOption" class="mt-2 text-blue-500 hover:text-blue-700 text-sm">+ æ·»åŠ äºŒçº§é€‰é¡¹</button>
                    </div>
                    <div class="flex gap-2 justify-end">
                        <button type="button" id="cancelNew" class="px-4 py-2 text-gray-600 hover:text-gray-800">å–æ¶ˆ</button>
                        <button type="button" id="saveNew" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">ä¿å­˜</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // æ·»åŠ äºŒçº§é€‰é¡¹åŠŸèƒ½
            document.getElementById('addNewSubOption').addEventListener('click', function() {
                const container = document.getElementById('newSubOptionsContainer');
                const div = document.createElement('div');
                div.className = 'flex gap-2';
                div.innerHTML = `
                    <input type="text" class="flex-1 p-2 border rounded new-sub-option" placeholder="è¾“å…¥äºŒçº§é€‰é¡¹å†…å®¹">
                    <button type="button" class="text-red-500 hover:text-red-700 px-2" onclick="this.parentElement.remove()">åˆ é™¤</button>
                `;
                container.appendChild(div);
            });
            
            // å–æ¶ˆæŒ‰é’®
            document.getElementById('cancelNew').addEventListener('click', function() {
                document.body.removeChild(modal);
            });
            
            // ä¿å­˜æŒ‰é’®
            document.getElementById('saveNew').addEventListener('click', function() {
                const title = document.getElementById('newTitle').value.trim();
                const subOptions = Array.from(document.querySelectorAll('.new-sub-option'))
                    .map(input => input.value.trim())
                    .filter(value => value);
                
                if (title) {
                    const newItem = {
                        id: type.charAt(0) + Date.now(),
                        text: title,
                        subOptions: subOptions
                    };
                    
                    appData[type].push(newItem);
                    saveAppData();
                    renderContent(type);
                    showNotification('æ·»åŠ æˆåŠŸï¼', 'success');
                    document.body.removeChild(modal);
                } else {
                    showCustomAlert('è¯·è¾“å…¥é€‰é¡¹æ ‡é¢˜');
                }
            });
            
            // ç‚¹å‡»èƒŒæ™¯å…³é—­
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    document.body.removeChild(modal);
                }
            });
            
            // è‡ªåŠ¨èšç„¦åˆ°æ ‡é¢˜è¾“å…¥æ¡†
            setTimeout(() => {
                document.getElementById('newTitle').focus();
            }, 100);
        }

        // ç¼–è¾‘é¡¹ç›®
        function editItem(id, type) {
            const item = contentIndex[type][id];
            if (!item) return;
            
            // åˆ›å»ºç¼–è¾‘å¯¹è¯æ¡†
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-40';
            modal.innerHTML = `
                <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
                    <h3 class="text-lg font-medium mb-4">ç¼–è¾‘é€‰é¡¹</h3>
                    <div class="mb-4">
                        <label class="block text-sm font-medium mb-2">é€‰é¡¹æ ‡é¢˜ï¼š</label>
                        <input type="text" id="editTitle" class="w-full p-2 border rounded" value="${item.text}">
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium mb-2">äºŒçº§é€‰é¡¹ï¼š</label>
                        <div id="subOptionsContainer" class="space-y-2">
                            ${(item.subOptions || []).map((sub, index) => `
                                <div class="flex gap-2">
                                    <input type="text" class="flex-1 p-2 border rounded sub-option" value="${sub}">
                                    <button type="button" class="text-red-500 hover:text-red-700 px-2" onclick="this.parentElement.remove()">åˆ é™¤</button>
                                </div>
                            `).join('')}
                        </div>
                        <button type="button" id="addSubOption" class="mt-2 text-blue-500 hover:text-blue-700 text-sm">+ æ·»åŠ äºŒçº§é€‰é¡¹</button>
                    </div>
                    <div class="flex gap-2 justify-end">
                        <button type="button" id="cancelEdit" class="px-4 py-2 text-gray-600 hover:text-gray-800">å–æ¶ˆ</button>
                        <button type="button" id="deleteItem" class="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600">åˆ é™¤</button>
                        <button type="button" id="saveEdit" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">ä¿å­˜</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // æ·»åŠ äºŒçº§é€‰é¡¹åŠŸèƒ½
            document.getElementById('addSubOption').addEventListener('click', function() {
                const container = document.getElementById('subOptionsContainer');
                const div = document.createElement('div');
                div.className = 'flex gap-2';
                div.innerHTML = `
                    <input type="text" class="flex-1 p-2 border rounded sub-option" placeholder="è¾“å…¥äºŒçº§é€‰é¡¹å†…å®¹">
                    <button type="button" class="text-red-500 hover:text-red-700 px-2" onclick="this.parentElement.remove()">åˆ é™¤</button>
                `;
                container.appendChild(div);
            });
            
            // å–æ¶ˆæŒ‰é’®
            document.getElementById('cancelEdit').addEventListener('click', function() {
                document.body.removeChild(modal);
            });
            
            // åˆ é™¤æŒ‰é’®
            document.getElementById('deleteItem').addEventListener('click', async function() {
                const confirmed = await showCustomConfirm('ç¡®å®šè¦åˆ é™¤æ­¤é¡¹ç›®å—ï¼Ÿ');
                if (confirmed) {
                    deleteItem(id, type);
                    document.body.removeChild(modal);
                }
            });
            
            // ä¿å­˜æŒ‰é’®
            document.getElementById('saveEdit').addEventListener('click', function() {
                const title = document.getElementById('editTitle').value.trim();
                const subOptions = Array.from(document.querySelectorAll('.sub-option'))
                    .map(input => input.value.trim())
                    .filter(value => value);
                
                if (title) {
                    item.text = title;
                    item.subOptions = subOptions;
                    saveAppData();
                    renderContent(type);
                    updateResult();
                    showNotification('ä¿®æ”¹æˆåŠŸï¼', 'success');
                    document.body.removeChild(modal);
                } else {
                    showCustomAlert('è¯·è¾“å…¥é€‰é¡¹æ ‡é¢˜');
                }
            });
            
            // ç‚¹å‡»èƒŒæ™¯å…³é—­
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    document.body.removeChild(modal);
                }
            });
        }

        // åˆ é™¤é¡¹ç›®
        function deleteItem(id, type) {
            const index = appData[type].findIndex(item => item.id === id);
            if (index > -1) {
                appData[type].splice(index, 1);
                
                // å¦‚æœåˆ é™¤çš„é¡¹ç›®è¢«é€‰ä¸­ï¼Œåˆ™å–æ¶ˆé€‰æ‹©
                if (type === 'greeting' || type === 'closing') {
                    if (selection[type] === id) {
                        selection[type] = null;
                    }
                } else {
                    const selectionIndex = selection[type].indexOf(id);
                    if (selectionIndex > -1) {
                        selection[type].splice(selectionIndex, 1);
                    }
                }
                
                saveAppData();
                renderContent(type);
                updateResult();
                showNotification('åˆ é™¤æˆåŠŸï¼', 'success');
            }
        }

        // é‡æ–°æ’åºé¡¹ç›®
        function reorderItems(draggedId, targetId, type) {
            const items = appData[type];
            const draggedIndex = items.findIndex(item => item.id === draggedId);
            const targetIndex = items.findIndex(item => item.id === targetId);
            
            if (draggedIndex > -1 && targetIndex > -1 && draggedIndex !== targetIndex) {
                const draggedItem = items.splice(draggedIndex, 1)[0];
                items.splice(targetIndex, 0, draggedItem);
                
                saveAppData();
                renderContent(type);
                showNotification('æ’åºå·²æ›´æ–°', 'info');
            }
        }

        // åˆå§‹åŒ–æ‹–æ‹½åŠŸèƒ½
        function initializeDragAndDrop() {
            // è¿™ä¸ªå‡½æ•°å¯ä»¥ç”¨æ¥åˆå§‹åŒ–æ›´å¤æ‚çš„æ‹–æ‹½åŠŸèƒ½
            // ç›®å‰åŸºæœ¬çš„æ‹–æ‹½åŠŸèƒ½å·²ç»åœ¨createItemElementä¸­å®ç°
        }

        // ä¿å­˜å½“å‰æ¨¡æ¿
        async function saveCurrentTemplate() {
            // æ£€æŸ¥æ˜¯å¦æœ‰é€‰æ‹©å†…å®¹
            const hasSelection = selection.greeting.id || 
                                selection.strength.length > 0 || 
                                selection.issue.length > 0 || 
                                selection.closing.id;
            
            if (!hasSelection) {
                showNotification('è¯·å…ˆé€‰æ‹©ä¸€äº›å†…å®¹å†ä¿å­˜æ¨¡æ¿', 'warning');
                return;
            }
            
            const name = await showCustomPrompt('è¯·è¾“å…¥æ¨¡æ¿åç§°ï¼š');
            if (name && name.trim()) {
                const category = await showCustomPrompt('è¯·è¾“å…¥æ¨¡æ¿åˆ†ç±»ï¼ˆå¯é€‰ï¼‰ï¼š', 'é»˜è®¤åˆ†ç±»') || 'é»˜è®¤åˆ†ç±»';
                const template = {
                    id: 't' + Date.now(),
                    name: name.trim(),
                    category: category.trim(),
                    selection: JSON.parse(JSON.stringify(selection)),
                    createdAt: new Date().toLocaleString()
                };
                
                templates.push(template);
                saveTemplatesAndCategories();
                renderTemplates();
                
                // æ·»åŠ åˆ°æœ€è¿‘ä½¿ç”¨
                addToRecentTemplates(template.id);
                
                showNotification('æ¨¡æ¿ä¿å­˜æˆåŠŸï¼', 'success');
            }
        }

        // ä¿å­˜æ¨¡æ¿å’Œåˆ†ç±»åˆ°æœ¬åœ°å­˜å‚¨
        function saveTemplatesAndCategories() {
            try {
                localStorage.setItem('templates', JSON.stringify(templates));
                localStorage.setItem('templateCategories', JSON.stringify(templateCategories));
            } catch (e) {
                console.error('ä¿å­˜æ¨¡æ¿å¤±è´¥:', e);
            }
        }

        // ä»æœ¬åœ°å­˜å‚¨åŠ è½½æ¨¡æ¿å’Œåˆ†ç±»
        function loadTemplatesAndCategories() {
            try {
                const savedTemplates = localStorage.getItem('templates');
                if (savedTemplates) {
                    templates = JSON.parse(savedTemplates);
                }
                
                const savedCategories = localStorage.getItem('templateCategories');
                if (savedCategories) {
                    templateCategories = JSON.parse(savedCategories);
                } else {
                    // ä»ç°æœ‰æ¨¡æ¿ä¸­æå–åˆ†ç±»
                    const categories = new Set(['é»˜è®¤åˆ†ç±»']);
                    templates.forEach(template => {
                        if (template.category) {
                            categories.add(template.category);
                        }
                    });
                    templateCategories = Array.from(categories);
                }
            } catch (e) {
                console.error('åŠ è½½æ¨¡æ¿å¤±è´¥:', e);
                templates = [];
                templateCategories = ['é»˜è®¤åˆ†ç±»'];
            }
        }

        // æ¸²æŸ“æ¨¡æ¿
        function renderTemplates() {
            const container = document.getElementById('templateContainer');
            if (!container) return;

            container.innerHTML = '';
            
            if (templates.length === 0) {
                container.innerHTML = '<div class="text-neutral italic text-center py-6">æš‚æ— æ¨¡æ¿ï¼Œè¯·åˆ›å»ºæ–°æ¨¡æ¿</div>';
                updateTemplateCount(0);
                return;
            }

            // è·å–å½“å‰é€‰ä¸­çš„åˆ†ç±»
            const activeCategory = document.querySelector('.category-btn-active')?.getAttribute('data-category') || 'all';
            
            // è¿‡æ»¤æ¨¡æ¿
            const filteredTemplates = activeCategory === 'all' ? 
                templates : 
                templates.filter(template => template.category === activeCategory);
            
            if (filteredTemplates.length === 0) {
                container.innerHTML = '<div class="text-neutral italic text-center py-6">è¯¥åˆ†ç±»ä¸‹æš‚æ— æ¨¡æ¿</div>';
                updateTemplateCount(0);
                return;
            }

            filteredTemplates.forEach(template => {
                const div = document.createElement('div');
                div.className = 'p-3 border border-gray-200 rounded-lg cursor-pointer transition-all hover:border-primary hover:shadow-md group';
                div.setAttribute('data-id', template.id);
                
                div.innerHTML = `
                    <div class="text-sm font-medium mb-1">${template.name}</div>
                    <div class="text-xs text-neutral mb-2">${template.category}</div>
                    <div class="text-xs text-neutral">${template.createdAt}</div>
                    <div class="absolute top-1 right-1 opacity-0 group-hover:opacity-100 transition-opacity flex gap-1">
                        <button class="apply-template-btn text-xs text-primary hover:text-primary/80 p-1" data-id="${template.id}" title="åº”ç”¨æ¨¡æ¿">
                            <i class="fa fa-check"></i>
                        </button>
                        <button class="edit-template-btn text-xs text-neutral hover:text-primary p-1" data-id="${template.id}" title="ç¼–è¾‘æ¨¡æ¿">
                            <i class="fa fa-edit"></i>
                        </button>
                        <button class="delete-template-btn text-xs text-red-500 hover:text-red-700 p-1" data-id="${template.id}" title="åˆ é™¤æ¨¡æ¿">
                            <i class="fa fa-trash"></i>
                        </button>
                    </div>
                `;
                
                // åº”ç”¨æ¨¡æ¿
                div.querySelector('.apply-template-btn').addEventListener('click', function(e) {
                    e.stopPropagation();
                    applyTemplate(template.id);
                });
                
                // ç¼–è¾‘æ¨¡æ¿
                div.querySelector('.edit-template-btn').addEventListener('click', function(e) {
                    e.stopPropagation();
                    editTemplate(template.id);
                });
                
                // åˆ é™¤æ¨¡æ¿
                div.querySelector('.delete-template-btn').addEventListener('click', function(e) {
                    e.stopPropagation();
                    deleteTemplate(template.id);
                });
                
                // ç‚¹å‡»åº”ç”¨æ¨¡æ¿
                div.addEventListener('click', function() {
                    applyTemplate(template.id);
                });
                
                container.appendChild(div);
            });
            
            updateTemplateCount(filteredTemplates.length);
        }

        // æ›´æ–°æ¨¡æ¿æ•°é‡æ˜¾ç¤º
        function updateTemplateCount(count) {
            const countElement = document.getElementById('templateCount');
            if (countElement) {
                countElement.textContent = count;
            }
        }

        // åº”ç”¨æ¨¡æ¿
        function applyTemplate(templateId) {
            const template = templates.find(t => t.id === templateId);
            if (template && template.selection) {
                selection = JSON.parse(JSON.stringify(template.selection));
                renderAllContent();
                updateResult();
                
                // æ·»åŠ åˆ°æœ€è¿‘ä½¿ç”¨
                addToRecentTemplates(templateId);
                
                showNotification(`å·²åº”ç”¨æ¨¡æ¿ï¼š${template.name}`, 'success');
            }
        }

        // ç¼–è¾‘æ¨¡æ¿
        async function editTemplate(templateId) {
            const template = templates.find(t => t.id === templateId);
            if (!template) return;
            
            const newName = await showCustomPrompt('ç¼–è¾‘æ¨¡æ¿åç§°ï¼š', template.name);
            if (newName !== null && newName.trim()) {
                const newCategory = await showCustomPrompt('ç¼–è¾‘æ¨¡æ¿åˆ†ç±»ï¼š', template.category);
                if (newCategory !== null) {
                    template.name = newName.trim();
                    template.category = newCategory.trim() || 'é»˜è®¤åˆ†ç±»';
                    
                    // æ›´æ–°åˆ†ç±»åˆ—è¡¨
                    if (!templateCategories.includes(template.category)) {
                        templateCategories.push(template.category);
                    }
                    
                    saveTemplatesAndCategories();
                    renderTemplates();
                    renderCategoryButtons();
                    showNotification('æ¨¡æ¿ä¿®æ”¹æˆåŠŸï¼', 'success');
                }
            }
        }

        // åˆ é™¤æ¨¡æ¿
        async function deleteTemplate(templateId) {
            const template = templates.find(t => t.id === templateId);
            const confirmed = await showCustomConfirm(`ç¡®å®šè¦åˆ é™¤æ¨¡æ¿"${template.name}"å—ï¼Ÿ`);
            if (template && confirmed) {
                templates = templates.filter(t => t.id !== templateId);
                
                // ä»æœ€è¿‘ä½¿ç”¨ä¸­ç§»é™¤
                recentTemplates = recentTemplates.filter(id => id !== templateId);
                saveRecentTemplates();
                
                saveTemplatesAndCategories();
                renderTemplates();
                renderRecentTemplates();
                showNotification('æ¨¡æ¿åˆ é™¤æˆåŠŸï¼', 'success');
            }
        }

        // æ¸²æŸ“åˆ†ç±»æŒ‰é’®
        function renderCategoryButtons() {
            const container = document.getElementById('categoryButtons');
            if (!container) return;

            // ä¿å­˜å½“å‰é€‰ä¸­çš„åˆ†ç±»
            const currentActive = document.querySelector('.category-btn-active')?.getAttribute('data-category') || 'all';
            
            container.innerHTML = '';
            
            // æ·»åŠ "æ‰€æœ‰åˆ†ç±»"æŒ‰é’®
            const allBtn = document.createElement('button');
            allBtn.className = 'category-btn text-left';
            allBtn.setAttribute('data-category', 'all');
            allBtn.textContent = 'æ‰€æœ‰åˆ†ç±»';
            if (currentActive === 'all') {
                allBtn.classList.add('category-btn-active');
            }
            container.appendChild(allBtn);
            
            // æ·»åŠ å…¶ä»–åˆ†ç±»æŒ‰é’®
            templateCategories.forEach(category => {
                if (category !== 'æ‰€æœ‰åˆ†ç±»') {
                    const btn = document.createElement('button');
                    btn.className = 'category-btn text-left';
                    btn.setAttribute('data-category', category);
                    btn.textContent = category;
                    if (currentActive === category) {
                        btn.classList.add('category-btn-active');
                    }
                    container.appendChild(btn);
                }
            });
            
            // ç»‘å®šç‚¹å‡»äº‹ä»¶
            container.querySelectorAll('.category-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    // ç§»é™¤æ‰€æœ‰activeç±»
                    container.querySelectorAll('.category-btn').forEach(b => {
                        b.classList.remove('category-btn-active');
                    });
                    
                    // æ·»åŠ activeç±»åˆ°å½“å‰æŒ‰é’®
                    this.classList.add('category-btn-active');
                    
                    // é‡æ–°æ¸²æŸ“æ¨¡æ¿
                    renderTemplates();
                });
            });
        }

        // åˆ·æ–°æ¨¡æ¿å’Œåˆ†ç±»
        function refreshTemplatesAndCategories() {
            loadTemplatesAndCategories();
            renderTemplates();
            renderCategoryButtons();
            showNotification('å·²åˆ·æ–°æ¨¡æ¿å’Œåˆ†ç±»', 'info');
        }

        // æ·»åŠ åˆ°æœ€è¿‘ä½¿ç”¨æ¨¡æ¿
        function addToRecentTemplates(templateId) {
            // ç§»é™¤å·²å­˜åœ¨çš„
            recentTemplates = recentTemplates.filter(id => id !== templateId);
            
            // æ·»åŠ åˆ°å¼€å¤´
            recentTemplates.unshift(templateId);
            
            // é™åˆ¶æ•°é‡
            if (recentTemplates.length > MAX_RECENT_TEMPLATES) {
                recentTemplates = recentTemplates.slice(0, MAX_RECENT_TEMPLATES);
            }
            
            saveRecentTemplates();
            renderRecentTemplates();
        }

        // ä¿å­˜æœ€è¿‘ä½¿ç”¨æ¨¡æ¿
        function saveRecentTemplates() {
            try {
                localStorage.setItem('recentTemplates', JSON.stringify(recentTemplates));
            } catch (e) {
                console.error('ä¿å­˜æœ€è¿‘ä½¿ç”¨æ¨¡æ¿å¤±è´¥:', e);
            }
        }

        // åŠ è½½æœ€è¿‘ä½¿ç”¨æ¨¡æ¿
        function loadRecentTemplates() {
            try {
                const saved = localStorage.getItem('recentTemplates');
                if (saved) {
                    recentTemplates = JSON.parse(saved);
                    // è¿‡æ»¤æ‰ä¸å­˜åœ¨çš„æ¨¡æ¿
                    recentTemplates = recentTemplates.filter(id => 
                        templates.some(t => t.id === id)
                    );
                }
            } catch (e) {
                console.error('åŠ è½½æœ€è¿‘ä½¿ç”¨æ¨¡æ¿å¤±è´¥:', e);
                recentTemplates = [];
            }
        }

        // æ¸²æŸ“æœ€è¿‘ä½¿ç”¨æ¨¡æ¿
        function renderRecentTemplates() {
            const container = document.getElementById('recentTemplatesContainer');
            if (!container) return;

            container.innerHTML = '';
            
            if (recentTemplates.length === 0) {
                container.innerHTML = '<div class="text-neutral italic text-center py-2 w-full">æš‚æ— æœ€è¿‘ä½¿ç”¨çš„æ¨¡æ¿</div>';
                return;
            }

            recentTemplates.forEach(templateId => {
                const template = templates.find(t => t.id === templateId);
                if (template) {
                    const div = document.createElement('div');
                    div.className = 'p-2 border border-gray-200 rounded cursor-pointer transition-all hover:border-primary hover:bg-blue-50';
                    
                    div.innerHTML = `
                        <div class="text-sm font-medium">${template.name}</div>
                        <div class="text-xs text-neutral">${template.category}</div>
                    `;
                    
                    div.addEventListener('click', function() {
                        applyTemplate(templateId);
                    });
                    
                    container.appendChild(div);
                }
            });
        }

        // æ‰“å¼€é…ç½®é¢æ¿
        function openConfigPanel() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center';
            modal.innerHTML = `
                <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4">
                    <div class="p-6">
                        <h3 class="text-lg font-semibold mb-4 flex items-center gap-2">
                            <i class="fa fa-cog text-primary"></i>
                            APIé…ç½®è®¾ç½®
                        </h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium mb-2">æ‰£å­APIå¯†é’¥ï¼š</label>
                                <input type="password" id="apiKey" class="w-full p-2 border rounded" placeholder="è¯·è¾“å…¥æ‚¨çš„æ‰£å­APIå¯†é’¥" value="">
                                <p class="text-xs text-gray-500 mt-1">ç”¨äºè°ƒç”¨æ‰£å­æ™ºèƒ½ä½“APIçš„è®¤è¯å¯†é’¥</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">æœºå™¨äººIDï¼š</label>
                                <input type="text" id="botId" class="w-full p-2 border rounded" placeholder="è¯·è¾“å…¥æœºå™¨äººID" value="">
                                <p class="text-xs text-gray-500 mt-1">æ‚¨åœ¨æ‰£å­å¹³å°åˆ›å»ºçš„æ™ºèƒ½ä½“æœºå™¨äººID</p>
                            </div>
                            <div class="mb-4">
                                <button type="button" id="testApiBtn" class="w-full px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 disabled:bg-gray-400 disabled:cursor-not-allowed">
                                    <i class="fa fa-flask mr-1"></i>
                                    æµ‹è¯•APIè¿æ¥
                                </button>
                                <div id="testResult" class="mt-2 text-sm hidden"></div>
                            </div>
                            <div class="bg-green-50 p-3 rounded mb-3">
                                <p class="text-sm text-green-700">
                                    <i class="fa fa-file-code mr-1"></i>
                                    <strong>æ–°ç‰¹æ€§ï¼š</strong> é…ç½®ç°åœ¨ç›´æ¥ä¿å­˜åœ¨HTMLæ–‡ä»¶ä¸­ï¼Œä¸å†ä½¿ç”¨æµè§ˆå™¨ç¼“å­˜ã€‚å³ä½¿æ¸…é™¤ç¼“å­˜ä¹Ÿä¸ä¼šä¸¢å¤±é…ç½®ï¼
                                </p>
                            </div>
                            <div class="bg-blue-50 p-3 rounded">
                                <p class="text-sm text-blue-700">
                                    <i class="fa fa-info-circle mr-1"></i>
                                    é…ç½®å®Œæˆåï¼Œç‚¹å‡»"ç”Ÿæˆè¯æœ¯"æŒ‰é’®å°†è°ƒç”¨æ‚¨çš„æ‰£å­æ™ºèƒ½ä½“APIæ¥ä¼˜åŒ–è¯æœ¯å†…å®¹ã€‚
                                </p>
                            </div>
                        </div>
                        <div class="flex gap-2 justify-end mt-6">
                            <button type="button" id="cancelConfig" class="px-4 py-2 text-gray-600 hover:text-gray-800">å–æ¶ˆ</button>
                            <button type="button" id="saveConfig" class="px-4 py-2 bg-primary text-white rounded hover:bg-primary/90">ä¿å­˜é…ç½®</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // è®¾ç½®è¾“å…¥æ¡†çš„é»˜è®¤å€¼
            document.getElementById('apiKey').value = getApiKey();
            document.getElementById('botId').value = getBotId();
            
            // å–æ¶ˆæŒ‰é’®
            document.getElementById('cancelConfig').addEventListener('click', function() {
                document.body.removeChild(modal);
            });
            
            // æµ‹è¯•APIè¿æ¥æŒ‰é’®
            document.getElementById('testApiBtn').addEventListener('click', async function() {
                const apiKey = document.getElementById('apiKey').value.trim();
                const botId = document.getElementById('botId').value.trim();
                const testBtn = this;
                const testResult = document.getElementById('testResult');
                
                if (!apiKey || !botId) {
                    testResult.className = 'mt-2 text-sm text-red-600';
                    testResult.textContent = 'è¯·å…ˆå¡«å†™APIå¯†é’¥å’Œæœºå™¨äººID';
                    testResult.classList.remove('hidden');
                    return;
                }
                
                // æ˜¾ç¤ºæµ‹è¯•ä¸­çŠ¶æ€
                testBtn.disabled = true;
                testBtn.innerHTML = '<i class="fa fa-spinner fa-spin mr-1"></i>æµ‹è¯•ä¸­...';
                testResult.className = 'mt-2 text-sm text-blue-600';
                testResult.textContent = 'æ­£åœ¨æµ‹è¯•APIè¿æ¥...';
                testResult.classList.remove('hidden');
                
                try {
                    const response = await fetch('https://api.coze.cn/v3/chat', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${apiKey}`
                        },
                        body: JSON.stringify({
                            bot_id: botId,
                            user_id: '123123',
                            stream: false,
                            auto_save_history: true,
                            additional_messages: [
                                {
                                    role: 'user',
                                    content: 'æµ‹è¯•è¿æ¥',
                                    content_type: 'text'
                                }
                            ]
                        })
                    });
                    
                    console.log('APIæµ‹è¯•å“åº”çŠ¶æ€:', response.status);
                    console.log('APIæµ‹è¯•å“åº”å¤´:', response.headers);
                    
                    if (response.ok) {
                        const data = await response.json();
                        console.log('APIæµ‹è¯•å“åº”æ•°æ®:', data);
                        
                        // æ£€æŸ¥APIå“åº”æ˜¯å¦åŒ…å«æœ‰æ•ˆå†…å®¹
                        let hasValidResponse = false;
                        let responseContent = '';
                        let debugInfo = '';
                        
                        // è·å–æ¶ˆæ¯æ•°ç»„
                        const messages = data.messages || (data.data && data.data.messages) || [];
                        console.log('æ‰¾åˆ°æ¶ˆæ¯æ•°é‡:', messages.length);
                        
                        if (messages.length > 0) {
                            // æŸ¥æ‰¾assistantæ¶ˆæ¯ï¼Œä½¿ç”¨æ›´å®½æ¾çš„è¿‡æ»¤æ¡ä»¶
                            const assistantMessages = messages.filter(msg => {
                                const isAssistant = msg.role === 'assistant';
                                const hasContent = msg.content && typeof msg.content === 'string' && msg.content.trim() !== '';
                                console.log(`æ¶ˆæ¯æ£€æŸ¥ - è§’è‰²: ${msg.role}, æœ‰å†…å®¹: ${hasContent}, å†…å®¹: "${msg.content}"`);
                                return isAssistant && hasContent;
                            });
                            
                            console.log('æ‰¾åˆ°assistantæ¶ˆæ¯æ•°é‡:', assistantMessages.length);
                            
                            if (assistantMessages.length > 0) {
                                hasValidResponse = true;
                                responseContent = assistantMessages[0].content;
                                console.log('ä½¿ç”¨çš„å›å¤å†…å®¹:', responseContent);
                            } else {
                                // å¦‚æœæ²¡æœ‰æ‰¾åˆ°assistantæ¶ˆæ¯ï¼Œæä¾›è°ƒè¯•ä¿¡æ¯
                                debugInfo = `æ‰¾åˆ° ${messages.length} æ¡æ¶ˆæ¯ï¼Œä½†æ²¡æœ‰æœ‰æ•ˆçš„assistantå›å¤ã€‚`;
                                if (messages.length > 0) {
                                    debugInfo += ` æ¶ˆæ¯è§’è‰²: ${messages.map(m => m.role).join(', ')}`;
                                }
                            }
                        } else {
                            debugInfo = 'å“åº”ä¸­æ²¡æœ‰æ‰¾åˆ°æ¶ˆæ¯æ•°ç»„ã€‚';
                        }
                        
                        if (hasValidResponse) {
                            testResult.className = 'mt-2 text-sm text-green-600';
                            testResult.innerHTML = `<i class="fa fa-check-circle mr-1"></i>APIè¿æ¥æµ‹è¯•æˆåŠŸï¼æœºå™¨äººå›å¤ï¼š"${responseContent.substring(0, 50)}${responseContent.length > 50 ? '...' : ''}"`;
                        } else {
                            testResult.className = 'mt-2 text-sm text-yellow-600';
                            testResult.innerHTML = `<i class="fa fa-exclamation-triangle mr-1"></i>APIè¿æ¥æˆåŠŸï¼Œä½†æœªè·å–åˆ°æœ‰æ•ˆå›å¤å†…å®¹ã€‚${debugInfo} <a href="debug-api.html" target="_blank" style="color: #007bff; text-decoration: underline;">ç‚¹å‡»è¿™é‡Œä½¿ç”¨è¯¦ç»†è¯Šæ–­å·¥å…·</a>`;
                        }
                    } else {
                        const errorText = await response.text();
                        console.log('APIæµ‹è¯•é”™è¯¯å“åº”:', errorText);
                        
                        let errorMsg = 'APIè¿æ¥å¤±è´¥';
                        if (response.status === 401) {
                            errorMsg = 'APIå¯†é’¥æ— æ•ˆæˆ–å·²è¿‡æœŸ';
                        } else if (response.status === 403) {
                            errorMsg = 'æƒé™ä¸è¶³æˆ–æœºå™¨äººIDæ— æ•ˆ';
                        } else if (response.status === 429) {
                            errorMsg = 'è¯·æ±‚é¢‘ç‡è¿‡é«˜ï¼Œè¯·ç¨åé‡è¯•';
                        } else if (response.status >= 500) {
                            errorMsg = 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯';
                        }
                        
                        testResult.className = 'mt-2 text-sm text-red-600';
                        testResult.innerHTML = `<i class="fa fa-times-circle mr-1"></i>${errorMsg} (çŠ¶æ€ç : ${response.status})`;
                    }
                } catch (error) {
                    console.error('APIæµ‹è¯•ç½‘ç»œé”™è¯¯:', error);
                    testResult.className = 'mt-2 text-sm text-red-600';
                    testResult.innerHTML = '<i class="fa fa-times-circle mr-1"></i>ç½‘ç»œè¿æ¥é”™è¯¯æˆ–CORSé—®é¢˜';
                } finally {
                    // æ¢å¤æŒ‰é’®çŠ¶æ€
                    testBtn.disabled = false;
                    testBtn.innerHTML = '<i class="fa fa-flask mr-1"></i>æµ‹è¯•APIè¿æ¥';
                }
            });
            
            // ä¿å­˜é…ç½®æŒ‰é’®
            document.getElementById('saveConfig').addEventListener('click', function() {
                const apiKey = document.getElementById('apiKey').value.trim();
                const botId = document.getElementById('botId').value.trim();
                
                if (!apiKey || !botId) {
                    showNotification('è¯·å¡«å†™å®Œæ•´çš„APIé…ç½®ä¿¡æ¯', 'error');
                    return;
                }
                
                // ä¿å­˜é…ç½®åˆ°æ–‡ä»¶å˜é‡
                API_CONFIG.apiKey = apiKey;
                API_CONFIG.botId = botId;
                
                showNotification('APIé…ç½®ä¿å­˜æˆåŠŸï¼', 'success');
                document.body.removeChild(modal);
            });
            
            // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    document.body.removeChild(modal);
                }
            });
        }

        // æ‰“å¼€æ¨¡æ¿è®¾ç½®
        function openTemplateSettings() {
            showNotification('æ¨¡æ¿è®¾ç½®åŠŸèƒ½å¼€å‘ä¸­...', 'info');
        }

        // è·å–APIå¯†é’¥
        function getApiKey() {
            return API_CONFIG.apiKey || '';
        }
        
        // è·å–æœºå™¨äººID
        function getBotId() {
            return API_CONFIG.botId || '';
        }
        
        // æ£€æŸ¥APIé…ç½®æ˜¯å¦å®Œæ•´
        function isApiConfigured() {
            return getApiKey() && getBotId();
        }

        // é¡µé¢åˆå§‹åŒ–å®Œæˆåçš„é¢å¤–å¤„ç†
        document.addEventListener('DOMContentLoaded', function() {
            // ç¡®ä¿åˆ†ç±»æŒ‰é’®æ­£ç¡®æ¸²æŸ“
            setTimeout(() => {
                renderCategoryButtons();
            }, 100);
        });
    </script>
</body>
</html>
    