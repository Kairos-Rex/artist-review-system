<!DOCTYPE html>
<!-- éƒ¨ç½²æ—¶é—´: 2025-09-12T13:34:43.069Z -->
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç”»å¸ˆè¯„ä»·ç³»ç»Ÿ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --primary: #3b82f6;
            --secondary: #10b981;
            --accent: #f59e0b;
            --neutral: #6b7280;
            --dark: #1f2937;
        }
        
        .text-primary { color: var(--primary); }
        .bg-primary { background-color: var(--primary); }
        .text-secondary { color: var(--secondary); }
        .bg-secondary { background-color: var(--secondary); }
        .text-accent { color: var(--accent); }
        .bg-accent { background-color: var(--accent); }
        .text-neutral { color: var(--neutral); }
        .text-dark { color: var(--dark); }
        
        .btn-hover {
            transition: all 0.2s ease;
        }
        
        .btn-hover:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        .item-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 12px;
        }
        
        .history-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }
        
        .template-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 12px;
        }
        
        .category-btn {
            padding: 8px 16px;
            border-radius: 20px;
            border: 1px solid #e5e7eb;
            background: white;
            color: var(--neutral);
            transition: all 0.2s ease;
            cursor: pointer;
            font-size: 14px;
        }
        
        .category-btn:hover {
            border-color: var(--primary);
            color: var(--primary);
        }
        
        .category-btn-active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        
        /* éšè—é€‰æ‹©é¢æ¿æ»šåŠ¨æ¡ */
        .selection-panel {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        
        .selection-panel::-webkit-scrollbar {
            display: none;
        }
        
        /* éšè—å³ä¾§æ æ»šåŠ¨æ¡ */
        .result-container-adaptive {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        
        .result-container-adaptive::-webkit-scrollbar {
            display: none;
        }
        
        /* éšè—æœ€è¿‘ä½¿ç”¨æ¨¡æ¿åŒºåŸŸæ»šåŠ¨æ¡ */
        #recentTemplatesContainer {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        
        #recentTemplatesContainer::-webkit-scrollbar {
            display: none;
        }
        
        /* éšè—å³ä¾§æ ä¸»å®¹å™¨æ»šåŠ¨æ¡ */
        .right-panel {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        
        .right-panel::-webkit-scrollbar {
            display: none;
        }
        
        .template-scroll-btn {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: white;
            border: 1px solid #e5e7eb;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            z-index: 10;
        }
        
        .template-scroll-btn:hover {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        .result-container-adaptive {
            overflow-y: auto;
            word-wrap: break-word;
            white-space: pre-wrap;
        }
        
        .btn-text-nowrap {
            white-space: nowrap;
        }
        
        .config-transition {
            transition: all 0.3s ease;
        }
        
        .add-item-btn {
            transition: all 0.2s ease;
        }
        
        .add-item-btn:hover {
            transform: scale(1.1);
        }
        
        @media (max-width: 768px) {
            .item-grid {
                grid-template-columns: 1fr;
            }
            
            .history-grid {
                grid-template-columns: 1fr;
            }
            
            .template-grid {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            }
        }
        
        .floating-container {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            width: 90%;
            max-width: 1200px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
        
        @media (max-width: 768px) {
            .floating-container {
                width: 95%;
                top: 10px;
            }
        }
        
        .function-area {
            min-height: 200px;
        }
        
        .function-buttons {
            flex-shrink: 0;
        }
        
        @media (max-width: 768px) {
            .function-buttons {
                min-width: auto;
                width: 100%;
            }
            
            .function-area .flex {
                flex-direction: column;
            }
        }
    </style>

    <script>
        // éƒ¨ç½²ç¯å¢ƒæ£€æµ‹
        if (typeof window !== 'undefined') {
            console.log('ğŸš€ ç”»å¸ˆè¯„ä»·ç³»ç»Ÿå·²éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ');
            console.log('ğŸ“ å½“å‰åŸŸå:', window.location.hostname);
            console.log('ğŸ”’ HTTPSçŠ¶æ€:', window.location.protocol === 'https:' ? 'å·²å¯ç”¨' : 'æœªå¯ç”¨');
        }
    </script>
</head>
<body class="bg-gray-50 font-sans text-dark overflow-x-hidden">
    <!-- æ–°çš„ä¸‰æ å¸ƒå±€ -->
    <div class="flex h-screen">
        <!-- å·¦ä¾§ï¼šæ”¶è—å¤¹æ¨¡å— -->
        <div class="w-1/4 bg-white shadow-md overflow-y-auto p-5 flex flex-col scrollbar-hide">
            <!-- æ”¶è—å¤¹æ ‡é¢˜å’Œæœç´¢ -->
            <div class="flex items-center justify-between mb-4 gap-3">
                <div class="flex items-center">
                    <h2 class="text-lg font-semibold text-gray-800">
                        <i class="fas fa-star text-yellow-500 mr-2"></i>
                        æ”¶è—å¤¹
                    </h2>
                    <span id="favoriteCount" class="text-sm text-gray-500 ml-2">0</span>
                </div>
                
                <!-- ç´§å‡‘æœç´¢æ¡† -->
                <div class="relative flex-1 max-w-xs">
                    <input type="text" id="favoriteSearch" placeholder="æœç´¢..." 
                           class="w-full px-3 py-1.5 border border-gray-300 rounded-md text-sm focus:outline-none focus:ring-1 focus:ring-blue-500">
                    <i class="fas fa-search absolute right-2 top-2 text-gray-400 text-xs"></i>
                </div>
            </div>
            
            <!-- å¿«é€Ÿè®¿é—®æŒ‰é’® -->
            <div class="mb-4 flex gap-2">
                <!-- æ™ºèƒ½ç­›é€‰æŒ‰é’® -->
                <button id="smartFilterBtn" class="flex-1 px-3 py-3 bg-gray-100 text-gray-700 rounded-lg font-medium border border-gray-200 hover:bg-gray-200 transition-all duration-200 transform hover:scale-105 flex items-center justify-center gap-2">
                    <i class="fas fa-brain"></i>
                    <span>æ™ºèƒ½ç­›é€‰</span>
                </button>
                
                <!-- æœ€è¿‘ä½¿ç”¨æŒ‰é’® -->
                <button id="recentUsedBtn" class="flex-1 px-3 py-3 bg-gray-100 text-gray-700 rounded-lg font-medium border border-gray-200 hover:bg-gray-200 transition-all duration-200 transform hover:scale-105 flex items-center justify-center gap-2">
                    <i class="fas fa-clock"></i>
                    <span>æœ€è¿‘ä½¿ç”¨</span>
                </button>
                
                <!-- æ‰€æœ‰æ ‡ç­¾æŒ‰é’® -->
                <button id="allTagsQuickBtn" class="flex-1 px-3 py-3 bg-gray-100 text-gray-700 rounded-lg font-medium border border-gray-200 hover:bg-gray-200 transition-all duration-200 transform hover:scale-105 flex items-center justify-center gap-2">
                    <i class="fas fa-tags"></i>
                    <span>æ‰€æœ‰æ ‡ç­¾</span>
                </button>
            </div>
            
            <!-- æ ‡ç­¾åˆ†ç±»ç­›é€‰ -->
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700 mb-2">æ ‡ç­¾åˆ†ç±»</label>
                <select id="tagFilter" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 bg-gray-50">
                    <option value="">é€‰æ‹©æ ‡ç­¾åˆ†ç±»</option>
                </select>
            </div>
            
            <!-- æ”¶è—è¯æœ¯åˆ—è¡¨ -->
            <div class="flex-1 overflow-y-auto">
                <div id="favoritesList" class="space-y-3">
                    <!-- æ”¶è—è¯æœ¯é¡¹ç›®å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                </div>
                
                <!-- ç©ºçŠ¶æ€æç¤º -->
                <div id="emptyFavorites" class="text-center py-8 text-gray-500 hidden">
                    <i class="fas fa-star text-4xl text-gray-300 mb-3"></i>
                    <p class="text-sm">è¿˜æ²¡æœ‰æ”¶è—çš„è¯æœ¯</p>
                    <p class="text-xs mt-1">ç‚¹å‡»"æ”¶è—è¯æœ¯"æŒ‰é’®å¼€å§‹æ”¶è—</p>
                </div>
            </div>
        </div>
        
        <!-- ä¸­é—´ï¼šé€‰æ‹©é¢æ¿ -->
        <div class="flex-1 overflow-y-auto selection-panel p-4">
            <div class="bg-white rounded-xl shadow-md p-5">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-semibold">é€‰æ‹©é¢æ¿</h2>
                    <div class="flex gap-2">
                        <button id="settingsBtn" class="flex items-center gap-1 text-neutral hover:text-blue-500 transition-colors btn-text-nowrap">
                            <i class="fa fa-cogs"></i> ç½‘é¡µæ€»è®¾ç½®
                        </button>
                        <button id="resetBtnPanel" class="flex items-center gap-1 text-neutral hover:text-red-500 transition-colors btn-text-nowrap">
                            <i class="fa fa-refresh"></i> é‡ç½®é€‰æ‹©
                        </button>
                    </div>
                </div>
                
                <!-- èµ·æ‰‹ç§°å‘¼å¼ -->
                <div class="mb-6">
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="font-bold text-lg flex items-center gap-2">
                            <i class="fa fa-comment-o text-primary"></i><span id="greetingTitle">èµ·æ‰‹ç§°å‘¼å¼</span>
                        </h3>
                        <button class="add-item-btn text-sm text-primary hover:text-primary/80 btn-text-nowrap" data-type="greeting">
                            <i class="fa fa-plus-circle"></i>
                        </button>
                    </div>
                    <div id="greetingContainer" class="item-grid" data-type="greeting">
                        <!-- èµ·æ‰‹å¼é¡¹ç›®å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>
                
                <!-- ä¼˜ç‚¹ -->
                <div class="mb-6">
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="font-bold text-lg flex items-center gap-2">
                            <i class="fa fa-thumbs-up text-green-500"></i><span id="strengthTitle">ä¼˜ç‚¹</span>
                        </h3>
                        <button class="add-item-btn text-sm text-primary hover:text-primary/80 btn-text-nowrap" data-type="strength">
                            <i class="fa fa-plus-circle"></i>
                        </button>
                    </div>
                    <div id="strengthContainer" class="item-grid" data-type="strength">
                        <!-- ä¼˜ç‚¹é¡¹ç›®å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>
                
                <!-- é—®é¢˜ -->
                <div class="mb-6">
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="font-bold text-lg flex items-center gap-2">
                            <i class="fa fa-exclamation-triangle text-amber-500"></i><span id="issueTitle">é—®é¢˜</span>
                        </h3>
                        <button class="add-item-btn text-sm text-primary hover:text-primary/80 btn-text-nowrap" data-type="issue">
                            <i class="fa fa-plus-circle"></i>
                        </button>
                    </div>
                    <div id="issueContainer" class="item-grid" data-type="issue">
                        <!-- é—®é¢˜é¡¹ç›®å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>
                
                <!-- ç»“å°¾å¼ -->
                <div class="mb-6">
                    <div class="flex justify-between items-center mb-3">
                        <h3 class="font-bold text-lg flex items-center gap-2">
                            <i class="fa fa-sign-out text-purple-500"></i><span id="closingTitle">ç»“å°¾å¼</span>
                        </h3>
                        <button class="add-item-btn text-sm text-primary hover:text-primary/80 btn-text-nowrap" data-type="closing">
                            <i class="fa fa-plus-circle"></i>
                        </button>
                    </div>
                    <div id="closingContainer" class="item-grid" data-type="closing">
                        <!-- ç»“å°¾å¼é¡¹ç›®å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>
                

            </div>
            
            <div class="mt-4 bg-white rounded-xl shadow-md p-5">
                <h3 class="font-medium text-lg mb-3">ä½¿ç”¨è¯´æ˜</h3>
                <ul class="text-sm text-neutral space-y-2">
                    <li class="flex items-start gap-2">
                        <i class="fa fa-check-circle text-green-500 mt-1"></i>
                        <span>æ‚¨å¯ä»¥æ‹–åŠ¨é¡¹ç›®è°ƒæ•´é¡ºåºï¼ˆå°½ç®¡æ‹–åŠ¨å›¾æ ‡ä¸å¯è§ï¼‰</span>
                    </li>
                    <li class="flex items-start gap-2">
                        <i class="fa fa-check-circle text-green-500 mt-1"></i>
                        <span>ç‚¹å‡»é¡¹ç›®ä¸Šçš„ç¼–è¾‘æŒ‰é’®å¯ä¿®æ”¹æˆ–åˆ é™¤é¡¹ç›®</span>
                    </li>
                    <li class="flex items-start gap-2">
                        <i class="fa fa-check-circle text-green-500 mt-1"></i>
                        <span>ç‚¹å‡»åŠ å·æŒ‰é’®å¯æ·»åŠ æ–°çš„é¡¹ç›®</span>
                    </li>
                    <li class="flex items-start gap-2">
                        <i class="fa fa-check-circle text-green-500 mt-1"></i>
                        <span>é€‰æ‹©çš„å†…å®¹ä¼šè‡ªåŠ¨ç”Ÿæˆè¯æœ¯å’’è¯­</span>
                    </li>
                </ul>
            </div>
        </div>
        
        <!-- å³ä¾§ï¼šé¡¶éƒ¨é¢æ¿ï¼ˆå›ºå®šæ˜¾ç¤ºï¼‰ -->
        <div class="w-1/4 bg-white shadow-md p-5 overflow-y-auto right-panel">
            <!-- ç”»å¸ˆè¯„ä»·ç³»ç»Ÿæ ‡é¢˜ -->
            <div class="mb-6 flex justify-between items-center">
                <h1 class="text-[clamp(1.5rem,3vw,2rem)] font-bold text-primary">ç”»å¸ˆè¯„ä»·ç³»ç»Ÿ</h1>
                <button id="newSettingsBtn" class="text-neutral hover:text-primary transition-colors p-2 rounded-full hover:bg-gray-100" title="æ–°è®¾ç½®">
                    <i class="fa fa-cog"></i>
                </button>
            </div>
            
            <!-- æœ€è¿‘ä½¿ç”¨æ¨¡æ¿ -->
            <div class="mb-4">
                <div class="flex justify-between items-center mb-2">
                    <h3 class="text-md font-medium">æœ€è¿‘ä½¿ç”¨</h3>
                </div>
                <div id="recentTemplatesContainer" class="flex flex-col gap-2 pb-2 max-h-[200px] overflow-y-auto">
                    <!-- æœ€è¿‘ä½¿ç”¨çš„æ¨¡æ¿å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
                    <div class="text-neutral italic text-center py-2 w-full">æš‚æ— æœ€è¿‘ä½¿ç”¨çš„æ”¶è—</div>
                </div>
            </div>
            
            <!-- è¯æœ¯å’’è¯­åŒºåŸŸ -->
            <div class="mb-4">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-lg font-semibold">è¯æœ¯å’’è¯­</h2>
                </div>
            </div>
            
            <!-- è¯æœ¯å’’è¯­å±•ç¤º -->
            <div class="mb-4">
                <div id="resultContainer" class="result-container-adaptive px-3 py-2 border border-gray-200 rounded-lg bg-gray-50 min-h-[45px] overflow-y-auto" style="max-height: none; height: auto; min-height: 45px;">
                    <p class="text-neutral italic">è¯·åœ¨å·¦ä¾§é€‰æ‹©å†…å®¹ï¼Œè¯æœ¯å’’è¯­å°†è‡ªåŠ¨ç”Ÿæˆåœ¨è¿™é‡Œ...</p>
                </div>
            </div>
            
            <!-- è¯æœ¯ç”ŸæˆåŒºåŸŸ -->
            <div class="mb-4">
                <div class="flex items-center justify-between mb-2">
                    <h3 class="text-lg font-semibold">è¯æœ¯ç”Ÿæˆ</h3>
                    <div class="flex items-center gap-2">
                        <span id="charCount" class="text-sm text-gray-500">0 å­—</span>

                        <button id="saveTemplateBtn" class="bg-yellow-500 hover:bg-yellow-600 text-white px-3 py-1 rounded-lg shadow btn-hover flex items-center gap-1 btn-text-nowrap text-sm">
                            <i class="fa fa-star"></i> æ”¶è—è¯æœ¯
                        </button>
                        <button id="copyBtn" class="bg-primary hover:bg-primary/90 text-white px-3 py-1 rounded-lg shadow btn-hover flex items-center gap-1 btn-text-nowrap text-sm">
                            <i class="fa fa-copy"></i> å¤åˆ¶è¯æœ¯
                        </button>
                    </div>
                </div>
                <div id="generatedContainer" class="result-container-adaptive px-3 py-2 border border-gray-200 rounded-lg bg-white min-h-[45px] overflow-y-auto" style="max-height: none; height: auto; min-height: 45px;">
                    <p class="text-neutral italic">ç‚¹å‡»"ç”Ÿæˆè¯æœ¯"æŒ‰é’®ï¼ŒAIå°†ä¸ºæ‚¨ç”Ÿæˆä¼˜åŒ–çš„è¯æœ¯å†…å®¹...</p>
                </div>
            </div>
            
            <!-- åŠŸèƒ½æŒ‰é’® -->
            <div class="flex flex-row gap-3">
                <button id="resetBtnResult" class="flex-1 bg-gray-200 hover:bg-gray-300 text-dark px-4 py-2 rounded-lg shadow btn-hover flex items-center justify-center gap-1 btn-text-nowrap">
                    <i class="fa fa-refresh"></i> é‡ç½®é€‰æ‹©
                </button>
                <button id="generateBtn" class="flex-1 bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded-lg shadow btn-hover flex items-center justify-center gap-1 btn-text-nowrap">
                    <i class="fa fa-magic"></i> ç”Ÿæˆè¯æœ¯
                </button>
            </div>
            
            <!-- å†å²è®°å½•åŒºåŸŸ -->
            <div class="mt-4">
                <h3 class="font-medium text-lg mb-3 flex items-center gap-2">
                    <i class="fa fa-history text-neutral"></i>å†å²è®°å½•
                </h3>
                <div id="historyContainer" class="history-grid">
                    <!-- å†å²è®°å½•å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
                    <div class="text-neutral italic text-center col-span-full py-4">æš‚æ— å†å²è®°å½•</div>
                </div>
            </div>
        </div>
    </div>

    <!-- è‡ªå®šä¹‰å¼¹çª— -->
    <div id="customModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4">
            <div class="p-6">
                <h3 id="modalTitle" class="text-lg font-semibold mb-4"></h3>
                <div id="modalContent" class="mb-6"></div>
                <div id="modalButtons" class="flex justify-end gap-3"></div>
            </div>
        </div>
    </div>

    <script>
        // APIé…ç½®å˜é‡ - ç›´æ¥ä¿å­˜åœ¨æ–‡ä»¶ä¸­
        let API_CONFIG = {
            apiKey: 'pat_SnrkhHeuv5zIVqz7DLC2sGhfO0z5SxJdAmHuIPoGudo0FbEwwAI6lQnlr9M5bSFX', // åœ¨è¿™é‡Œå¡«å†™æ‚¨çš„æ‰£å­APIå¯†é’¥
            botId: '7548722284312772647'   // åœ¨è¿™é‡Œå¡«å†™æ‚¨çš„æœºå™¨äººID
        };
        
        // å…¨å±€å˜é‡
        let configManager;
        let appData = {};
        let selection = {
                    greeting: [], // æ ¼å¼: [{ id: itemId, subOptions: [subOptionIndex1, subOptionIndex2] }]
                    strength: [], // æ ¼å¼: [{ id: itemId, subOptions: [subOptionIndex1, subOptionIndex2] }]
                    issue: [], // æ ¼å¼: [{ id: itemId, subOptions: [subOptionIndex1, subOptionIndex2] }]
                    closing: [] // æ ¼å¼: [{ id: itemId, subOptions: [subOptionIndex1, subOptionIndex2] }]
                };
        let contentIndex = {
                    greeting: {},
                    strength: {},
                    issue: {},
                    closing: {}
                };
        let configPanelOpen = false;
        let confirmCallback = null;
        let draggedItem = null; // ç”¨äºè·Ÿè¸ªæ­£åœ¨æ‹–åŠ¨çš„é¡¹ç›®
        let historyRecords = []; // å†å²è®°å½•æ•°ç»„
        // æ”¶è—å¤¹ç›¸å…³å˜é‡å·²ç§»é™¤
        
        let subOptionTags = {
            "i4": {
                "0": "ğŸŒ¿è¿‡è‰",
                "1": "ğŸ–¼æ„å›¾",
                "2": "ğŸ–Œï¸åˆ»ç”»",
                "3": "ğŸ§¶çº¿æ¡",
                "4": "â˜€ï¸å…‰å½±",
                "5": "âŒå®Œå…¨ä¸è¡Œ"
            },
            "i1": {
                "0": "ğŸ‘‹æ‰‹",
                "1": "ğŸ¤·å¤´é¢ˆè‚©",
                "2": "ğŸ¤¾ğŸ»æ•´ä½“"
            },
            "i2": {
                "0": "ğŸ‘€çœ¼ç›",
                "1": "ğŸ‘ƒäº”å®˜",
                "2": "ğŸ’€å¤´éª¨",
                "3": "ğŸª®å‘å‹"
            },
            "i3": {
                "0": "ğŸ–Œç¬”è§¦",
                "1": "âš«ï¸è‰²è„",
                "2": "ğŸ¨é…è‰²",
                "3": "ğŸŒˆè¿‡é¥±å’Œ",
                "4": "ğŸ–¼è‰²è°ƒ"
            },
            "i1757606284297": {
                "0": "ğŸ§©è¿‡ç¨‹",
                "1": "ğŸ“„ææ–™",
                "2": "ğŸ¤–AI"
            },
            "g1757749288217": {
                "0": "å¤´åƒ",
                "1": "æ’ç”»",
                "2": "ç«‹ç»˜",
                "3": "æœè®¾",
                "4": "åœºæ™¯",
                "5": "æ’ç”»"
            },
            "g1": {
                "0": "å›½é£",
                "1": "Qç‰ˆ",
                "2": "æ¬§ç¾å¡é€š",
                "3": "å†™å®"
            }
        }; // äºŒçº§é€‰é¡¹æ ‡ç­¾å­˜å‚¨ {itemId: {subOptionIndex: tagName}}
        let customCategoryNames = {}; // è‡ªå®šä¹‰ç±»åˆ«åç§°å­˜å‚¨
        let categoryDescriptions = {}; // ç±»åˆ«æè¿°å­˜å‚¨

        // è‡ªå®šä¹‰å¼¹çª—å‡½æ•°
        function showCustomAlert(message, title = 'æç¤º') {
            return new Promise((resolve) => {
                const modal = document.getElementById('customModal');
                const modalTitle = document.getElementById('modalTitle');
                const modalContent = document.getElementById('modalContent');
                const modalButtons = document.getElementById('modalButtons');
                
                modalTitle.textContent = title;
                modalContent.innerHTML = `<p class="text-gray-700">${message}</p>`;
                modalButtons.innerHTML = `
                    <button class="bg-primary hover:bg-primary/90 text-white px-4 py-2 rounded-lg" onclick="closeCustomModal(); customModalResolve();">ç¡®å®š</button>
                `;
                
                modal.classList.remove('hidden');
                window.customModalResolve = resolve;
            });
        }
        
        function showCustomConfirm(message, title = 'ç¡®è®¤') {
            return new Promise((resolve) => {
                const modal = document.getElementById('customModal');
                const modalTitle = document.getElementById('modalTitle');
                const modalContent = document.getElementById('modalContent');
                const modalButtons = document.getElementById('modalButtons');
                
                modalTitle.textContent = title;
                modalContent.innerHTML = `<p class="text-gray-700">${message}</p>`;
                modalButtons.innerHTML = `
                    <button class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-4 py-2 rounded-lg mr-2" onclick="closeCustomModal(); customModalResolve(false);">å–æ¶ˆ</button>
                    <button class="bg-primary hover:bg-primary/90 text-white px-4 py-2 rounded-lg" onclick="closeCustomModal(); customModalResolve(true);">ç¡®å®š</button>
                `;
                
                modal.classList.remove('hidden');
                window.customModalResolve = resolve;
            });
        }
        
        function showCustomPrompt(message, defaultValue = '', title = 'è¾“å…¥') {
            return new Promise((resolve) => {
                const modal = document.getElementById('customModal');
                const modalTitle = document.getElementById('modalTitle');
                const modalContent = document.getElementById('modalContent');
                const modalButtons = document.getElementById('modalButtons');
                
                modalTitle.textContent = title;
                modalContent.innerHTML = `
                    <p class="text-gray-700 mb-3">${message}</p>
                    <input type="text" id="promptInput" class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary" value="${defaultValue}" />
                `;
                modalButtons.innerHTML = `
                    <button class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-4 py-2 rounded-lg mr-2" onclick="closeCustomModal(); customModalResolve(null);">å–æ¶ˆ</button>
                    <button class="bg-primary hover:bg-primary/90 text-white px-4 py-2 rounded-lg" onclick="closeCustomModal(); customModalResolve(document.getElementById('promptInput').value);">ç¡®å®š</button>
                `;
                
                modal.classList.remove('hidden');
                setTimeout(() => {
                    const input = document.getElementById('promptInput');
                    input.focus();
                    input.select();
                }, 100);
                window.customModalResolve = resolve;
            });
        }
        
        function closeCustomModal() {
            const modal = document.getElementById('customModal');
            modal.classList.add('hidden');
        }
        
        // ç‚¹å‡»èƒŒæ™¯å…³é—­å¼¹çª—
        document.getElementById('customModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeCustomModal();
                if (window.customModalResolve) {
                    window.customModalResolve(null);
                }
            }
        });

        // äºŒçº§é€‰é¡¹æ ‡ç­¾ç®¡ç†å‡½æ•°
        function loadSubOptionTags() {
            try {
                const saved = localStorage.getItem('subOptionTags');
                if (saved) {
                    subOptionTags = JSON.parse(saved);
                } else {
                    subOptionTags = {};
                }
            } catch (e) {
                console.error('åŠ è½½äºŒçº§é€‰é¡¹æ ‡ç­¾å¤±è´¥:', e);
                subOptionTags = {};
            }
        }
        
        function saveSubOptionTags() {
            try {
                localStorage.setItem('subOptionTags', JSON.stringify(subOptionTags));
            } catch (e) {
                console.error('ä¿å­˜äºŒçº§é€‰é¡¹æ ‡ç­¾å¤±è´¥:', e);
            }
        }
        
        // è·å–äºŒçº§é€‰é¡¹çš„æ ‡ç­¾
        function getSubOptionTag(itemId, subOptionIndex) {
            return subOptionTags[itemId] && subOptionTags[itemId][subOptionIndex] || null;
        }
        
        // è®¾ç½®äºŒçº§é€‰é¡¹çš„æ ‡ç­¾
        function setSubOptionTag(itemId, subOptionIndex, tagName) {
            // è·å–æ—§æ ‡ç­¾åç§°ç”¨äºåŒæ­¥
            const oldTagName = getSubOptionTag(itemId, subOptionIndex);
            
            if (!subOptionTags[itemId]) {
                subOptionTags[itemId] = {};
            }
            if (tagName && tagName.trim()) {
                subOptionTags[itemId][subOptionIndex] = tagName.trim();
            } else {
                delete subOptionTags[itemId][subOptionIndex];
                // å¦‚æœè¯¥é¡¹ç›®æ²¡æœ‰ä»»ä½•æ ‡ç­¾ï¼Œåˆ é™¤æ•´ä¸ªé¡¹ç›®
                if (Object.keys(subOptionTags[itemId]).length === 0) {
                    delete subOptionTags[itemId];
                }
            }
            saveSubOptionTags();
            
            // åŒæ­¥æ›´æ–°æ”¶è—è¯æœ¯æ˜¾ç¤º
            renderFavoriteScripts();
            
            // åŒæ­¥æ›´æ–°æ”¶è—è¯æœ¯ä¸­çš„æ ‡ç­¾
            syncFavoriteScriptTags(itemId, subOptionIndex, oldTagName, tagName ? tagName.trim() : null);
        }
        
        // è·å–äºŒçº§é€‰é¡¹çš„æ˜¾ç¤ºæ–‡æœ¬ï¼ˆä¼˜å…ˆæ˜¾ç¤ºæ ‡ç­¾ï¼‰
        function getSubOptionDisplayText(itemId, subOptionIndex, originalText) {
            const tag = getSubOptionTag(itemId, subOptionIndex);
            return tag || originalText;
        }
        
        // ä¸€çº§é€‰é¡¹æ ‡ç­¾ç®¡ç†å‡½æ•°
        let primaryOptionTags = {};
        
        function loadPrimaryOptionTags() {
            try {
                const saved = localStorage.getItem('primaryOptionTags');
                if (saved) {
                    primaryOptionTags = JSON.parse(saved);
                } else {
                    primaryOptionTags = {};
                }
            } catch (e) {
                console.error('åŠ è½½ä¸€çº§é€‰é¡¹æ ‡ç­¾å¤±è´¥:', e);
                primaryOptionTags = {};
            }
        }
        
        function savePrimaryOptionTags() {
            try {
                localStorage.setItem('primaryOptionTags', JSON.stringify(primaryOptionTags));
            } catch (e) {
                console.error('ä¿å­˜ä¸€çº§é€‰é¡¹æ ‡ç­¾å¤±è´¥:', e);
            }
        }
        
        // è·å–ä¸€çº§é€‰é¡¹çš„æ ‡ç­¾
        function getPrimaryOptionTag(itemId) {
            return primaryOptionTags[itemId] || null;
        }
        
        // è®¾ç½®ä¸€çº§é€‰é¡¹çš„æ ‡ç­¾
        function setPrimaryOptionTag(itemId, tagName) {
            // è·å–æ—§æ ‡ç­¾åç§°ç”¨äºåŒæ­¥
            const oldTagName = getPrimaryOptionTag(itemId);
            
            if (tagName && tagName.trim()) {
                primaryOptionTags[itemId] = tagName.trim();
            } else {
                delete primaryOptionTags[itemId];
            }
            savePrimaryOptionTags();
            
            // åŒæ­¥æ›´æ–°æ”¶è—è¯æœ¯æ˜¾ç¤º
            renderFavoriteScripts();
            
            // åŒæ­¥æ›´æ–°æ”¶è—è¯æœ¯ä¸­çš„æ ‡ç­¾
            syncFavoriteScriptPrimaryTags(itemId, oldTagName, tagName ? tagName.trim() : null);
        }
        
        // ä¸€çº§é€‰é¡¹æ ‡ç­¾é¢œè‰²å­˜å‚¨
        let primaryOptionTagColors = {};
        
        function loadPrimaryOptionTagColors() {
            try {
                const saved = localStorage.getItem('primaryOptionTagColors');
                primaryOptionTagColors = saved ? JSON.parse(saved) : {};
            } catch (e) {
                console.error('åŠ è½½ä¸€çº§é€‰é¡¹æ ‡ç­¾é¢œè‰²å¤±è´¥:', e);
                primaryOptionTagColors = {};
            }
        }
        
        function savePrimaryOptionTagColors() {
            try {
                localStorage.setItem('primaryOptionTagColors', JSON.stringify(primaryOptionTagColors));
            } catch (e) {
                console.error('ä¿å­˜ä¸€çº§é€‰é¡¹æ ‡ç­¾é¢œè‰²å¤±è´¥:', e);
            }
        }
        
        // è·å–ä¸€çº§é€‰é¡¹çš„æ ‡ç­¾é¢œè‰²
        function getPrimaryOptionTagColor(itemId) {
            return primaryOptionTagColors[itemId] || defaultTagColors[0]; // é»˜è®¤ä½¿ç”¨ç¬¬ä¸€ä¸ªé¢œè‰²
        }
        
        // è®¾ç½®ä¸€çº§é€‰é¡¹çš„æ ‡ç­¾é¢œè‰²
        function setPrimaryOptionTagColor(itemId, color) {
            primaryOptionTagColors[itemId] = color;
            savePrimaryOptionTagColors();
            
            // åŒæ­¥æ›´æ–°æ”¶è—è¯æœ¯æ˜¾ç¤º
            renderFavoriteScripts();
            
            // åŒæ­¥æ›´æ–°æ”¶è—è¯æœ¯ä¸­çš„æ ‡ç­¾é¢œè‰²
            syncFavoriteScriptPrimaryTagColors(itemId, color);
        }
        
        // æ ‡ç­¾é¢œè‰²å­˜å‚¨
        let subOptionTagColors = {
            "i4": {
                "0": "#FCA5A5",
                "1": "#FCA5A5",
                "2": "#FCA5A5",
                "4": "#FCA5A5",
                "5": "#FCA5A5"
            },
            "i1": {
                "0": "#FCA5A5",
                "1": "#FCA5A5",
                "2": "#FCA5A5"
            },
            "i2": {
                "0": "#FCA5A5",
                "1": "#FCA5A5",
                "2": "#FCA5A5"
            },
            "i3": {
                "0": "#FCA5A5",
                "1": "#FCA5A5",
                "2": "#FCA5A5",
                "4": "#FCA5A5"
            },
            "i1757606284297": {
                "0": "#FCA5A5",
                "1": "#FCA5A5",
                "2": "#FCA5A5"
            },
            "g1757749288217": {
                "0": "#C4B5FD",
                "1": "#C4B5FD",
                "2": "#C4B5FD",
                "3": "#C4B5FD",
                "5": "#C4B5FD"
            },
            "g1": {
                "0": "#C4B5FD",
                "1": "#C4B5FD",
                "2": "#C4B5FD",
                "3": "#C4B5FD"
            }
        };
        
        // é»˜è®¤æ ‡ç­¾é¢œè‰²ï¼ˆæ·¡é›…é…è‰²ï¼ŒæŸ”å’Œæ˜åº¦ï¼‰
        const defaultTagColors = [
            '#6EE7B7', // æ·¡ç»¿è‰²
            '#93C5FD', // æ·¡è“è‰²
            '#FCD34D', // æ·¡é»„è‰²
            '#FCA5A5', // æ·¡çº¢è‰²
            '#C4B5FD', // æ·¡ç´«è‰²
            '#67E8F9', // æ·¡é’è‰²
            '#FDBA74', // æ·¡æ©™è‰²
            '#BEF264'  // æ·¡é’ç»¿è‰²
        ];
        
        // RGBé¢œè‰²å€¼è½¬æ¢ä¸ºåå…­è¿›åˆ¶
        function rgbToHex(rgb) {
            const result = rgb.match(/\d+/g);
            if (result && result.length >= 3) {
                return '#' + ((1 << 24) + (parseInt(result[0]) << 16) + (parseInt(result[1]) << 8) + parseInt(result[2])).toString(16).slice(1).toUpperCase();
            }
            return rgb;
        }
        
        // è·å–äºŒçº§é€‰é¡¹çš„æ ‡ç­¾é¢œè‰²
        function getSubOptionTagColor(itemId, subOptionIndex) {
            if (subOptionTagColors[itemId] && subOptionTagColors[itemId][subOptionIndex]) {
                return subOptionTagColors[itemId][subOptionIndex];
            }
            // ä½¿ç”¨é»˜è®¤é¢œè‰²ï¼ˆåŸºäºç´¢å¼•å¾ªç¯ï¼‰
            return defaultTagColors[subOptionIndex % defaultTagColors.length];
        }
        
        // è®¾ç½®äºŒçº§é€‰é¡¹çš„æ ‡ç­¾é¢œè‰²
        function setSubOptionTagColor(itemId, subOptionIndex, color) {
            if (!subOptionTagColors[itemId]) {
                subOptionTagColors[itemId] = {};
            }
            subOptionTagColors[itemId][subOptionIndex] = color;
            saveSubOptionTagColors();
            
            // åŒæ­¥æ›´æ–°æ”¶è—è¯æœ¯æ˜¾ç¤º
            renderFavoriteScripts();
            
            // åŒæ­¥æ›´æ–°æ”¶è—è¯æœ¯ä¸­çš„æ ‡ç­¾é¢œè‰²
            syncFavoriteScriptTagColors(itemId, subOptionIndex, color);
        }
        
        // åŠ è½½æ ‡ç­¾é¢œè‰²
        function loadSubOptionTagColors() {
            try {
                const saved = localStorage.getItem('subOptionTagColors');
                subOptionTagColors = saved ? JSON.parse(saved) : {};
            } catch (e) {
                console.error('åŠ è½½äºŒçº§é€‰é¡¹æ ‡ç­¾é¢œè‰²å¤±è´¥:', e);
                subOptionTagColors = {};
            }
        }
        
        // ä¿å­˜æ ‡ç­¾é¢œè‰²
        function saveSubOptionTagColors() {
            try {
                localStorage.setItem('subOptionTagColors', JSON.stringify(subOptionTagColors));
            } catch (e) {
                console.error('ä¿å­˜äºŒçº§é€‰é¡¹æ ‡ç­¾é¢œè‰²å¤±è´¥:', e);
            }
        }
        
        // åˆ‡æ¢æ ‡ç­¾è¡¨å•çš„æ˜¾ç¤º/éšè—
        function toggleTagForm(button) {
            const tagForm = button.parentElement.querySelector('.tag-form');
            const toggleText = button.querySelector('.toggle-text');
            const colorPicker = button.parentElement.querySelector('.flex.gap-1');
            const existingColorPicker = button.parentElement.querySelector('.tag-color-picker');
            
            // æ ‡ç­¾å”¯ä¸€æ€§çº¦æŸï¼šå¦‚æœå·²å­˜åœ¨æ ‡ç­¾ï¼Œåªå…è®¸ä¿®æ”¹ï¼Œä¸å…è®¸åˆ›å»ºæ–°æ ‡ç­¾
            if (existingColorPicker) {
                // å·²å­˜åœ¨æ ‡ç­¾æ—¶ï¼Œåªèƒ½ä¿®æ”¹ç°æœ‰æ ‡ç­¾
                // åªæœ‰åœ¨è¡¨å•éšè—æ—¶æ‰å±•å¼€ï¼Œé¿å…é‡å¤æ“ä½œ
                if (tagForm.style.display === 'none' || tagForm.style.display === '') {
                    tagForm.style.display = 'block';
                    
                    // ä¿®æ”¹ç°æœ‰æ ‡ç­¾æ—¶ï¼Œè®¾ç½®ç¡®è®¤æŒ‰é’®çš„é¢œè‰²å±æ€§å’Œè¾“å…¥æ¡†çš„å€¼
                    const confirmButton = tagForm.querySelector('.confirm-tag');
                    const tagInput = tagForm.querySelector('.sub-option-tag');
                    const existingSpan = existingColorPicker.querySelector('span');
                    
                    // å¡«å……ç°æœ‰æ ‡ç­¾åç§°
                    if (confirmButton && tagInput) {
                        const existingTagName = confirmButton.getAttribute('data-tag-name');
                        if (existingTagName) {
                            tagInput.value = existingTagName;
                        }
                    }
                    
                    // è®¾ç½®ç°æœ‰é¢œè‰²ï¼Œç¡®ä¿ä¿®æ”¹æ—¶ä¿æŒåŸæœ‰é…è‰²
                    if (confirmButton && existingSpan && existingSpan.style.backgroundColor) {
                        const currentColor = existingSpan.style.backgroundColor.startsWith('rgb') ? 
                            rgbToHex(existingSpan.style.backgroundColor) : existingSpan.style.backgroundColor;
                        confirmButton.setAttribute('data-tag-color', currentColor);
                    }
                    
                    // ä¿®æ”¹æ ‡ç­¾æ—¶ä¸æ˜¾ç¤ºé…è‰²é€‰æ‹©å™¨
                    const existingColorSelector = existingColorPicker.querySelector('.flex.gap-1');
                    if (existingColorSelector) {
                        existingColorSelector.style.display = 'none';
                    }
                    
                    // éšè—tagFormå†…éƒ¨çš„é…è‰²é€‰æ‹©æ¡†ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                    if (colorPicker) {
                        colorPicker.style.display = 'none';
                    }
                }
            } else {
                // æ²¡æœ‰ç°æœ‰æ ‡ç­¾æ—¶ï¼Œå…è®¸æ·»åŠ æ–°æ ‡ç­¾
                // åªæœ‰åœ¨è¡¨å•éšè—æ—¶æ‰å±•å¼€ï¼Œé¿å…é‡å¤æ“ä½œ
                if (tagForm.style.display === 'none' || tagForm.style.display === '') {
                    tagForm.style.display = 'block';
                    
                    // éšè—é…è‰²é€‰æ‹©æ¡†
                    if (colorPicker) {
                        colorPicker.style.display = 'none';
                    }
                }
            }
        }
        
        // åˆå§‹åŒ–æ ‡ç­¾æŒ‰é’®çŠ¶æ€
        function initializeTagButtonStates() {
            // æŸ¥æ‰¾æ‰€æœ‰çš„æ ‡ç­¾å®¹å™¨
            document.querySelectorAll('.tag-form').forEach(tagForm => {
                const tagContainer = tagForm.parentElement;
                const existingColorPicker = tagContainer.querySelector('.tag-color-picker');
                const toggleButton = tagContainer.querySelector('.toggle-tag-form');
                const toggleText = toggleButton ? toggleButton.querySelector('.toggle-text') : null;
                
                if (existingColorPicker && toggleText) {
                    // å¦‚æœå­˜åœ¨æ ‡ç­¾ï¼Œè®¾ç½®æŒ‰é’®æ–‡æœ¬ä¸º"ä¿®æ”¹æ ‡ç­¾"
                    toggleText.textContent = 'ä¿®æ”¹æ ‡ç­¾';
                    console.log('åˆå§‹åŒ–æ ‡ç­¾æŒ‰é’®çŠ¶æ€: è®¾ç½®ä¸ºä¿®æ”¹æ¨¡å¼');
                } else if (toggleText) {
                    // å¦‚æœä¸å­˜åœ¨æ ‡ç­¾ï¼Œè®¾ç½®æŒ‰é’®æ–‡æœ¬ä¸º"+ æ·»åŠ æ ‡ç­¾"
                    toggleText.textContent = '+ æ·»åŠ æ ‡ç­¾';
                    console.log('åˆå§‹åŒ–æ ‡ç­¾æŒ‰é’®çŠ¶æ€: è®¾ç½®ä¸ºæ·»åŠ æ¨¡å¼');
                }
            });
        }
        
        // ç¡®è®¤æ ‡ç­¾åˆ›å»º
        function confirmTag(button) {
            const tagInput = button.parentElement.querySelector('.sub-option-tag');
            const tagForm = button.closest('.tag-form');
            const toggleButton = tagForm.parentElement.querySelector('.toggle-tag-form');
            const toggleText = toggleButton.querySelector('.toggle-text');
            const tagContainer = tagForm.parentElement;
            
            if (tagInput.value.trim()) {
                const tagName = tagInput.value.trim();
                
                // æ ¹æ®æ˜¯å¦å­˜åœ¨æ ‡ç­¾æ¥åŒºåˆ†åˆ›å»ºå’Œä¿®æ”¹æ“ä½œ
                const existingColorPicker = tagContainer.querySelector('.tag-color-picker');
                const isModifying = existingColorPicker !== null;
                
                let selectedColor;
                if (isModifying) {
                    // ä¿®æ”¹ç°æœ‰æ ‡ç­¾æ—¶ï¼Œä¸¥æ ¼ä¿æŒåŸæœ‰èƒŒæ™¯é¢œè‰²é…ç½®ä¸å˜
                    const currentColor = existingColorPicker ? 
                        existingColorPicker.querySelector('span').style.backgroundColor || 
                        button.getAttribute('data-tag-color') || 
                        defaultTagColors[0] : 
                        button.getAttribute('data-tag-color') || defaultTagColors[0];
                    selectedColor = currentColor.startsWith('rgb') ? 
                        rgbToHex(currentColor) : currentColor;
                    
                    // ç¡®ä¿ä¿®æ”¹æ—¶é¢œè‰²å®Œå…¨ä¸å˜
                    console.log('ä¿®æ”¹æ ‡ç­¾æ—¶ä¿æŒåŸæœ‰é¢œè‰²:', selectedColor);
                } else {
                    // åˆ›å»ºæ–°æ ‡ç­¾æ—¶ï¼Œä½¿ç”¨é»˜è®¤é…è‰²
                    selectedColor = defaultTagColors[0];
                }
                
                // é¢„è§ˆåŠŸèƒ½å·²åˆ é™¤
                
                // æ”¶èµ·è¡¨å•
                tagForm.style.display = 'none';
                // ç¡®è®¤æ ‡ç­¾åï¼ŒæŒ‰é’®æ–‡æœ¬åº”è¯¥æ˜¯ä¿®æ”¹æ ‡ç­¾ï¼ˆå› ä¸ºç°åœ¨æœ‰æ ‡ç­¾äº†ï¼‰
                toggleText.textContent = 'ä¿®æ”¹æ ‡ç­¾';
                toggleButton.classList.remove('text-green-600', 'hover:text-green-800');
                toggleButton.classList.add('text-blue-600', 'hover:text-blue-800');
                
                // ä¿å­˜æ ‡ç­¾é¢œè‰²ä¿¡æ¯åˆ°æŒ‰é’®çš„æ•°æ®å±æ€§ä¸­
                button.setAttribute('data-tag-name', tagName);
                button.setAttribute('data-tag-color', selectedColor);
                
                // è·å–é¡¹ç›®IDå’ŒäºŒçº§é€‰é¡¹ç´¢å¼•ï¼Œä¿å­˜æ ‡ç­¾æ•°æ®
                const itemContainer = tagContainer.closest('[data-id]');
                if (itemContainer) {
                    const itemId = itemContainer.getAttribute('data-id');
                    const subOptionIndex = Array.from(itemContainer.querySelectorAll('.tag-form')).indexOf(tagForm);
                    
                    // ä¿å­˜æ ‡ç­¾åç§°å’Œé¢œè‰²åˆ°æ•°æ®å­˜å‚¨
                    setSubOptionTag(itemId, subOptionIndex, tagName);
                    setSubOptionTagColor(itemId, subOptionIndex, selectedColor);
                    
                    // åˆ·æ–°æ”¶è—è¯æœ¯æ˜¾ç¤ºä»¥åæ˜ æ ‡ç­¾å˜åŒ–
                    renderFavoriteScripts();
                }
                
                // ç«‹å³åœ¨ç•Œé¢ä¸Šæ˜¾ç¤ºæ ‡ç­¾å’Œé…è‰²æ¡†
                let colorPickerDiv = tagContainer.querySelector('.tag-color-picker');
                if (!colorPickerDiv) {
                    // åˆ›å»ºæ–°æ ‡ç­¾æ—¶ï¼Œåˆ›å»ºå®Œæ•´çš„é…è‰²é€‰æ‹©å™¨
                    colorPickerDiv = document.createElement('div');
                    colorPickerDiv.className = 'tag-color-picker flex gap-1 mt-2';
                    tagContainer.insertBefore(colorPickerDiv, tagForm);
                    
                    // åˆ›å»ºæ ‡ç­¾æ˜¾ç¤ºå’Œé…è‰²é€‰æ‹©å™¨
                    colorPickerDiv.innerHTML = `
                        <span class="inline-block px-2 py-1 text-sm rounded text-white mr-2" style="background-color: ${selectedColor}">${tagName}</span>
                        <div class="flex gap-1">
                            ${defaultTagColors.map(color => `
                                <div class="w-6 h-6 rounded border-2 cursor-pointer hover:scale-110 transition-transform ${selectedColor === color ? 'border-gray-800' : 'border-gray-300'}" 
                                     style="background-color: ${color}" 
                                     onclick="updateTagColorInEdit(this, '${color}', '${tagName}')"
                                     title="ç‚¹å‡»åˆ‡æ¢é¢œè‰²">
                                </div>
                            `).join('')}
                        </div>
                    `;
                } else {
                    // ä¿®æ”¹ç°æœ‰æ ‡ç­¾æ—¶ï¼Œåªæ›´æ–°æ ‡ç­¾åç§°ï¼Œä¿æŒåŸæœ‰é…è‰²ä¸å˜
                    const existingSpan = colorPickerDiv.querySelector('span');
                    if (existingSpan) {
                        existingSpan.textContent = tagName;
                        // ä¿æŒåŸæœ‰èƒŒæ™¯é¢œè‰²ä¸å˜
                        console.log('ä¿®æ”¹æ ‡ç­¾åç§°ï¼Œä¿æŒåŸæœ‰é…è‰²:', existingSpan.style.backgroundColor);
                    }
                    
                    // æ›´æ–°é…è‰²é€‰æ‹©å™¨ä¸­çš„onclickäº‹ä»¶ï¼Œä½¿ç”¨æ–°çš„æ ‡ç­¾åç§°
                    const colorDivs = colorPickerDiv.querySelectorAll('.w-6.h-6.rounded');
                    colorDivs.forEach((colorDiv, index) => {
                        const color = defaultTagColors[index];
                        colorDiv.setAttribute('onclick', `updateTagColorInEdit(this, '${color}', '${tagName}')`);
                    });
                }
                
                // ç¡®è®¤åæ˜¾ç¤ºé…è‰²é€‰æ‹©å™¨ï¼Œè®©ç”¨æˆ·å¯ä»¥ç»§ç»­ä¿®æ”¹é¢œè‰²
                const existingColorSelector = colorPickerDiv.querySelector('.flex.gap-1');
                if (existingColorSelector) {
                    existingColorSelector.style.display = 'flex';
                }
            } else {
                alert('è¯·è¾“å…¥æ ‡ç­¾åç§°');
            }
        }
        
        // åœ¨ç¼–è¾‘æ¨¡å¼ä¸‹æ›´æ–°æ ‡ç­¾é¢œè‰²
        function updateTagColorInEdit(element, newColor, tagName) {
            const colorContainer = element.parentElement;
            const tagSpan = colorContainer.parentElement.querySelector('span');
            const confirmButton = colorContainer.parentElement.parentElement.querySelector('.confirm-tag');
            
            // æ›´æ–°æ ‡ç­¾æ˜¾ç¤ºé¢œè‰²
            if (tagSpan) {
                tagSpan.style.backgroundColor = newColor;
            }
            
            // æ›´æ–°é…è‰²é€‰æ‹©æ¡†çš„é€‰ä¸­çŠ¶æ€
            colorContainer.querySelectorAll('.w-6.h-6.rounded').forEach(colorDiv => {
                colorDiv.className = colorDiv.className.replace('border-gray-800', 'border-gray-300');
            });
            element.className = element.className.replace('border-gray-300', 'border-gray-800');
            
            // æ›´æ–°ç¡®è®¤æŒ‰é’®çš„æ•°æ®å±æ€§
            if (confirmButton) {
                confirmButton.setAttribute('data-tag-color', newColor);
            }
            
            // ä¿å­˜é¢œè‰²åˆ°æ•°æ®å­˜å‚¨
            const itemContainer = element.closest('[data-id]');
            if (itemContainer) {
                const itemId = itemContainer.getAttribute('data-id');
                const tagForm = element.closest('.tag-color-picker').nextElementSibling;
                const subOptionIndex = Array.from(itemContainer.querySelectorAll('.tag-form')).indexOf(tagForm);
                
                // ä¿å­˜æ ‡ç­¾é¢œè‰²åˆ°æ•°æ®å­˜å‚¨
                setSubOptionTagColor(itemId, subOptionIndex, newColor);
                
                // åˆ·æ–°æ”¶è—è¯æœ¯æ˜¾ç¤ºä»¥åæ˜ æ ‡ç­¾é¢œè‰²å˜åŒ–
                renderFavoriteScripts();
            }
            
            // æ˜¾ç¤ºæˆåŠŸæç¤º
            showNotification('æ ‡ç­¾é¢œè‰²å·²æ›´æ–°', 'success');
        }
        
        // ç›´æ¥åˆ‡æ¢æ ‡ç­¾é¢œè‰²
        function changeTagColor(itemId, subIndex, newColor, element) {
            // æ›´æ–°é¢œè‰²å­˜å‚¨
            setSubOptionTagColor(itemId, subIndex, newColor);
            
            // æ›´æ–°å½“å‰é¡µé¢æ˜¾ç¤ºçš„æ ‡ç­¾é¢œè‰²
            const container = element.closest('.border.rounded.p-3');
            const tagElement = container.querySelector('.flex.items-center.px-2.py-1.rounded.text-white.text-sm');
            if (tagElement) {
                tagElement.style.backgroundColor = newColor;
            }
            
            // æ›´æ–°é…è‰²é€‰æ‹©æ¡†çš„é€‰ä¸­çŠ¶æ€
            const colorContainer = element.parentElement;
            colorContainer.querySelectorAll('.w-6.h-6.rounded').forEach(colorDiv => {
                colorDiv.className = colorDiv.className.replace('border-gray-800', 'border-gray-300');
            });
            element.className = element.className.replace('border-gray-300', 'border-gray-800');
            
            // æ›´æ–°ç¡®è®¤æŒ‰é’®çš„æ•°æ®å±æ€§ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            const confirmButton = container.querySelector('.confirm-tag');
            if (confirmButton) {
                confirmButton.setAttribute('data-tag-color', newColor);
            }
            
            // ä¿å­˜é¢œè‰²åˆ°æ•°æ®å­˜å‚¨ï¼ˆè¿™ä¸ªå‡½æ•°å·²ç»è°ƒç”¨äº†setSubOptionTagColorï¼‰
            // setSubOptionTagColor(itemId, subIndex, newColor); å·²åœ¨å‡½æ•°å¼€å¤´è°ƒç”¨
            
            // åˆ·æ–°æ”¶è—è¯æœ¯æ˜¾ç¤ºä»¥åæ˜ æ ‡ç­¾é¢œè‰²å˜åŒ–
            renderFavoriteScripts();
            
            // æ˜¾ç¤ºæˆåŠŸæç¤º
            showNotification('æ ‡ç­¾é¢œè‰²å·²æ›´æ–°', 'success');
        }
        
        // æ›´æ–°æ ‡ç­¾å®æ—¶é¢„è§ˆ
        function updateTagPreview(input) {
            const tagName = input.value.trim();
            const tagContainer = input.closest('.tag-form').parentElement;
            const confirmButton = input.parentElement.querySelector('.confirm-tag');
            const toggleButton = tagContainer.querySelector('.toggle-tag-form');
            const toggleText = toggleButton ? toggleButton.querySelector('.toggle-text') : null;
            
            // æ ¹æ®æ˜¯å¦å­˜åœ¨æ ‡ç­¾æ¥åŒºåˆ†åˆ›å»ºå’Œä¿®æ”¹æ“ä½œ
            const existingColorPicker = tagContainer.querySelector('.tag-color-picker');
            const isModifying = existingColorPicker !== null;
            
            let currentColor;
            if (isModifying) {
                // ä¿®æ”¹ç°æœ‰æ ‡ç­¾æ—¶ï¼Œä¿ç•™ç°æœ‰é…è‰²
                // ä¼˜å…ˆä»ç¡®è®¤æŒ‰é’®çš„æ•°æ®å±æ€§è·å–é¢œè‰²
                if (confirmButton && confirmButton.getAttribute('data-tag-color')) {
                    currentColor = confirmButton.getAttribute('data-tag-color');
                } else if (existingColorPicker) {
                    // ä»ç°æœ‰é…è‰²é€‰æ‹©å™¨è·å–
                    const existingSpan = existingColorPicker.querySelector('span');
                    if (existingSpan && existingSpan.style.backgroundColor) {
                        currentColor = existingSpan.style.backgroundColor.startsWith('rgb') ? 
                            rgbToHex(existingSpan.style.backgroundColor) : existingSpan.style.backgroundColor;
                    } else {
                        currentColor = defaultTagColors[0];
                    }
                } else {
                    currentColor = defaultTagColors[0];
                }
            } else {
                // åˆ›å»ºæ–°æ ‡ç­¾æ—¶ï¼Œä½¿ç”¨é»˜è®¤é…è‰²
                currentColor = defaultTagColors[0];
            }
            
            // é¢„è§ˆåŠŸèƒ½å·²åˆ é™¤
        }
        
        // æ˜¾ç¤ºæ ‡ç­¾é¢œè‰²é€‰æ‹©å™¨
        function showTagColorPicker(tagName, callback) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-lg p-6 max-w-sm w-full mx-4">
                    <h3 class="text-lg font-medium mb-4">é€‰æ‹©æ ‡ç­¾é¢œè‰²</h3>
                    <p class="text-sm text-gray-600 mb-4">ä¸ºæ ‡ç­¾ "${tagName}" é€‰æ‹©é¢œè‰²ï¼š</p>
                    <div class="grid grid-cols-4 gap-3 mb-6">
                        ${defaultTagColors.map(color => `
                            <button type="button" class="color-option w-12 h-12 rounded border-2 border-gray-300 hover:border-gray-500 transition-colors" 
                                    style="background-color: ${color}" data-color="${color}">
                            </button>
                        `).join('')}
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium mb-2">è‡ªå®šä¹‰é¢œè‰²ï¼š</label>
                        <input type="color" id="customColor" class="w-full h-10 border rounded" value="#3B82F6">
                    </div>
                    <div class="flex gap-2 justify-end">
                        <button type="button" id="cancelColor" class="px-4 py-2 text-gray-600 hover:text-gray-800">å–æ¶ˆ</button>
                        <button type="button" id="confirmColor" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">ç¡®è®¤</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            let selectedColor = defaultTagColors[0];
            
            // é¢„è®¾é¢œè‰²é€‰æ‹©
            modal.querySelectorAll('.color-option').forEach(btn => {
                btn.addEventListener('click', function() {
                    modal.querySelectorAll('.color-option').forEach(b => b.classList.remove('ring-4', 'ring-blue-500'));
                    this.classList.add('ring-4', 'ring-blue-500');
                    selectedColor = this.getAttribute('data-color');
                });
            });
            
            // è‡ªå®šä¹‰é¢œè‰²é€‰æ‹©
            const customColorInput = modal.querySelector('#customColor');
            customColorInput.addEventListener('change', function() {
                modal.querySelectorAll('.color-option').forEach(b => b.classList.remove('ring-4', 'ring-blue-500'));
                selectedColor = this.value;
            });
            
            // ç¡®è®¤æŒ‰é’®
            modal.querySelector('#confirmColor').addEventListener('click', function() {
                document.body.removeChild(modal);
                callback(selectedColor);
            });
            
            // å–æ¶ˆæŒ‰é’®
            modal.querySelector('#cancelColor').addEventListener('click', function() {
                document.body.removeChild(modal);
            });
            
            // ç‚¹å‡»èƒŒæ™¯å…³é—­
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    document.body.removeChild(modal);
                }
            });
            
            // é»˜è®¤é€‰ä¸­ç¬¬ä¸€ä¸ªé¢œè‰²
            modal.querySelector('.color-option').classList.add('ring-4', 'ring-blue-500');
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        window.onload = function() {
            // åˆå§‹åŒ–é…ç½®ç®¡ç†åŠŸèƒ½
            loadConfigurations();
            
            // åˆå§‹åŒ–å½“å‰é€‰ä¸­çš„åˆ†ç±»
            currentActiveCategory = 'all';
            
            // ä»æœ¬åœ°å­˜å‚¨åŠ è½½å†å²è®°å½•
            loadHistoryRecords();
            
            // æ”¶è—å¤¹ç›¸å…³åˆå§‹åŒ–ä»£ç å·²ç§»é™¤
            
            // ä»æœ¬åœ°å­˜å‚¨åŠ è½½æ”¶è—è¯æœ¯
            loadFavoriteScripts();
            
            // äºŒçº§é€‰é¡¹æ ‡ç­¾æ•°æ®å·²å†…ç½®ï¼Œæ— éœ€ä»localStorageåŠ è½½
            
            // åˆå§‹åŒ–åº”ç”¨æ•°æ®
            initializeAppData();
            
            // ç»‘å®šäº‹ä»¶ç›‘å¬å™¨
            bindEventListeners();
            
            // åˆå§‹åŒ–æ‹–æ‹½åŠŸèƒ½
            initializeDragAndDrop();
            
            // æ¸²æŸ“åˆå§‹å†…å®¹
            renderAllContent();
            
            // æ›´æ–°ç»“æœæ˜¾ç¤ºï¼ˆç¡®ä¿æç¤ºå†…å®¹ä¹Ÿåº”ç”¨æœ€å°é«˜åº¦ï¼‰
            updateResult();
            
            // åˆå§‹åŒ–ç”Ÿæˆæ–‡æœ¬æ¡†é«˜åº¦
            adjustGeneratedContainerHeight();
            
            // æ”¶è—å¤¹ç›¸å…³æ¸²æŸ“ä»£ç å·²ç§»é™¤
            
            // æ¸²æŸ“æ”¶è—è¯æœ¯
            renderFavoriteScripts();
            
            // æ¸²æŸ“å†å²è®°å½•
            renderHistoryRecords();
            
            // æ›´æ–°ç±»åˆ«æ ‡é¢˜æ˜¾ç¤º
            updateCategoryTitles();
        };

        // åˆå§‹åŒ–åº”ç”¨æ•°æ®
        function initializeAppData() {
            // é»˜è®¤æ•°æ®
            const defaultData = {
                greeting: [
                    { id: 'g1', text: 'æ‚¨å¥½ï¼Œæ„Ÿè°¢æ‚¨çš„ä½œå“æŠ•ç¨¿ï¼', category: 'ç¤¼è²Œç”¨è¯­' },
                    { id: 'g2', text: 'å¾ˆé«˜å…´çœ‹åˆ°æ‚¨çš„åˆ›ä½œï¼', category: 'é¼“åŠ±ç”¨è¯­' },
                    { id: 'g3', text: 'ç»è¿‡ä»”ç»†è¯„å®¡ï¼Œç°ç»™å‡ºä»¥ä¸‹åé¦ˆï¼š', category: 'æ­£å¼ç”¨è¯­' }
                ],
                strength: [
                    { id: 's1', text: 'ç”»é¢æ„å›¾åˆç†ï¼Œå±‚æ¬¡åˆ†æ˜', category: 'æ„å›¾' },
                    { id: 's2', text: 'è‰²å½©æ­é…å’Œè°ï¼Œè§†è§‰æ•ˆæœä½³', category: 'è‰²å½©' },
                    { id: 's3', text: 'çº¿æ¡æµç•…ï¼ŒæŠ€æ³•å¨´ç†Ÿ', category: 'æŠ€æ³•' },
                    { id: 's4', text: 'åˆ›æ„ç‹¬ç‰¹ï¼Œå¯Œæœ‰æƒ³è±¡åŠ›', category: 'åˆ›æ„' },
                    { id: 's5', text: 'ç»†èŠ‚å¤„ç†ç²¾è‡´ï¼Œå®Œæˆåº¦é«˜', category: 'ç»†èŠ‚' }
                ],
                issue: [
                    { id: 'i1', text: 'éƒ¨åˆ†åŒºåŸŸæ˜æš—å¯¹æ¯”å¯ä»¥æ›´å¼ºçƒˆ', category: 'æ˜æš—' },
                    { id: 'i2', text: 'äººç‰©æ¯”ä¾‹éœ€è¦è¿›ä¸€æ­¥è°ƒæ•´', category: 'æ¯”ä¾‹' },
                    { id: 'i3', text: 'èƒŒæ™¯ä¸ä¸»ä½“çš„èåˆåº¦æœ‰å¾…æå‡', category: 'æ•´ä½“æ€§' },
                    { id: 'i4', text: 'æŸäº›ç»†èŠ‚è¿˜å¯ä»¥æ›´åŠ ç²¾ç»†', category: 'ç»†èŠ‚' }
                ],
                closing: [
                    { id: 'c1', text: 'æœŸå¾…æ‚¨çš„ä¸‹ä¸€æ¬¡æŠ•ç¨¿ï¼', category: 'æœŸå¾…ç”¨è¯­' },
                    { id: 'c2', text: 'ç»§ç»­åŠ æ²¹ï¼Œæ‚¨çš„è¿›æ­¥å¾ˆæ˜æ˜¾ï¼', category: 'é¼“åŠ±ç”¨è¯­' },
                    { id: 'c3', text: 'æ„Ÿè°¢æ‚¨çš„å‚ä¸ï¼Œç¥åˆ›ä½œæ„‰å¿«ï¼', category: 'æ„Ÿè°¢ç”¨è¯­' }
                ]
            };

            // ä»æœ¬åœ°å­˜å‚¨åŠ è½½æ•°æ®ï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨é»˜è®¤æ•°æ®
            const savedData = localStorage.getItem('appData');
            if (savedData) {
                try {
                    appData = JSON.parse(savedData);
                    // ç¡®ä¿æ‰€æœ‰å¿…è¦çš„å±æ€§éƒ½å­˜åœ¨
                    Object.keys(defaultData).forEach(key => {
                        if (!appData[key]) {
                            appData[key] = defaultData[key];
                        }
                    });
                } catch (e) {
                    console.error('è§£ææœ¬åœ°æ•°æ®å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤æ•°æ®:', e);
                    appData = defaultData;
                }
            } else {
                appData = defaultData;
            }

            // æ„å»ºå†…å®¹ç´¢å¼•
            buildContentIndex();
        }

        // æ„å»ºå†…å®¹ç´¢å¼•
        function buildContentIndex() {
            Object.keys(appData).forEach(type => {
                contentIndex[type] = {};
                appData[type].forEach(item => {
                    contentIndex[type][item.id] = item;
                });
            });
        }

        // ä¿å­˜åº”ç”¨æ•°æ®åˆ°æœ¬åœ°å­˜å‚¨
        function saveAppData() {
            try {
                localStorage.setItem('appData', JSON.stringify(appData));
                buildContentIndex();
                saveSubOptionTags();
            } catch (e) {
                console.error('ä¿å­˜æ•°æ®å¤±è´¥:', e);
            }
        }

        // ç»‘å®šäº‹ä»¶ç›‘å¬å™¨
        function bindEventListeners() {
            // å¤åˆ¶æŒ‰é’®
            document.getElementById('copyBtn').addEventListener('click', copyGeneratedResult);
            
            // ç”Ÿæˆè¯æœ¯æŒ‰é’®
            document.getElementById('generateBtn').addEventListener('click', generateScript);
            
            // é‡ç½®æŒ‰é’®
            document.getElementById('resetBtnResult').addEventListener('click', resetSelection);
            document.getElementById('resetBtnPanel').addEventListener('click', resetSelection);
            
            // æ–°è®¾ç½®æŒ‰é’®
            document.getElementById('newSettingsBtn').addEventListener('click', openWebSettings);
            
            // æ”¶è—è¯æœ¯æŒ‰é’®
            document.getElementById('saveTemplateBtn').addEventListener('click', saveCurrentFavorite);
            
            // æ”¶è—å¤¹æœç´¢åŠŸèƒ½
            const favoriteSearch = document.getElementById('favoriteSearch');
            if (favoriteSearch) {
                favoriteSearch.addEventListener('input', renderFavoriteScripts);
            }
            
            // æ™ºèƒ½ç­›é€‰æŒ‰é’®
            const smartFilterBtn = document.getElementById('smartFilterBtn');
            if (smartFilterBtn) {
                smartFilterBtn.addEventListener('click', function() {
                    // åˆ‡æ¢åˆ°æ™ºèƒ½ç­›é€‰æ¨¡å¼
                    toggleSmartFilterMode();
                });
            }
            
            // æœ€è¿‘ä½¿ç”¨æŒ‰é’®
            const recentUsedBtn = document.getElementById('recentUsedBtn');
            if (recentUsedBtn) {
                recentUsedBtn.addEventListener('click', function() {
                    // åˆ‡æ¢åˆ°æœ€è¿‘ä½¿ç”¨æ¨¡å¼
                    toggleRecentUsedMode();
                });
            }
            
            // æ‰€æœ‰æ ‡ç­¾å¿«é€Ÿè®¿é—®æŒ‰é’®
            const allTagsQuickBtn = document.getElementById('allTagsQuickBtn');
            if (allTagsQuickBtn) {
                allTagsQuickBtn.addEventListener('click', function() {
                    // é‡ç½®æ ‡ç­¾ç­›é€‰ä¸ºæ‰€æœ‰æ ‡ç­¾
                    const tagFilter = document.getElementById('tagFilter');
                    if (tagFilter) {
                        tagFilter.value = '';
                    }
                    // å…³é—­æ‰€æœ‰ç­›é€‰æ¨¡å¼
                    isSmartFilterMode = false;
                    isRecentUsedMode = false;
                    // é‡æ–°æ¸²æŸ“æ”¶è—è¯æœ¯
                    renderFavoriteScripts();
                    // æ›´æ–°æŒ‰é’®çŠ¶æ€
                    updateQuickButtonState();
                });
            }
            
            // æ”¶è—å¤¹æ ‡ç­¾ç­›é€‰
            const tagFilter = document.getElementById('tagFilter');
            if (tagFilter) {
                tagFilter.addEventListener('change', function() {
                    renderFavoriteScripts();
                    updateQuickButtonState();
                });
            }
            
            // æ”¶è—å¤¹ç›¸å…³äº‹ä»¶ç›‘å¬å™¨å·²ç§»é™¤
            
            // æ·»åŠ é¡¹ç›®æŒ‰é’®
            document.querySelectorAll('.add-item-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const type = this.getAttribute('data-type');
                    addNewItem(type);
                });
            });
        }

        // æ¸²æŸ“æ‰€æœ‰å†…å®¹
        function renderAllContent() {
            Object.keys(appData).forEach(type => {
                renderContent(type);
            });
        }

        // æ¸²æŸ“æŒ‡å®šç±»å‹çš„å†…å®¹
        function renderContent(type) {
            const container = document.getElementById(type + 'Container');
            if (!container) return;

            container.innerHTML = '';
            
            if (!appData[type] || appData[type].length === 0) {
                container.innerHTML = '<div class="text-neutral italic text-center col-span-full py-4">æš‚æ— å†…å®¹ï¼Œç‚¹å‡»åŠ å·æ·»åŠ </div>';
                return;
            }

            appData[type].forEach(item => {
                const itemElement = createItemElement(item, type);
                container.appendChild(itemElement);
            });
            
            // åˆå§‹åŒ–æ ‡ç­¾æŒ‰é’®çŠ¶æ€
            initializeTagButtonStates();
        }

        // åˆ›å»ºé¡¹ç›®å…ƒç´ 
        function createItemElement(item, type) {
            const div = document.createElement('div');
            div.className = 'group relative p-3 border border-gray-200 rounded-lg cursor-pointer transition-all hover:border-primary hover:shadow-md';
            div.setAttribute('data-id', item.id);
            div.setAttribute('data-type', type);
            div.draggable = true;

            // æ£€æŸ¥æ˜¯å¦è¢«é€‰ä¸­
            const isSelected = isItemSelected(item.id, type);
            const selectedSubOptions = getSelectedSubOptions(item.id, type);
            
            // å¦‚æœè¢«é€‰ä¸­ï¼Œæ·»åŠ é€‰ä¸­æ ·å¼ï¼ˆæ— è®ºæ˜¯å¦æœ‰äºŒçº§é€‰é¡¹ï¼‰
            if (isSelected) {
                div.classList.add('border-primary', 'bg-blue-50');
            }

            // æ„å»ºå·²é€‰ä¸­çš„äºŒçº§é€‰é¡¹æ˜¾ç¤ºæ–‡æœ¬
            let selectedSubOptionsText = '';
            if (item.subOptions && item.subOptions.length > 0 && selectedSubOptions.length > 0) {
                const selectedItems = selectedSubOptions.map(index => {
                    const originalText = item.subOptions[index];
                    const tag = getSubOptionTag(item.id, index);
                    const tagColor = getSubOptionTagColor(item.id, index);
                    
                    if (tag) {
                        return `<span class="inline-block px-2 py-1 text-sm rounded" style="background-color: ${tagColor}; color: white; margin-right: 4px; border-radius: 4px;">${tag}</span>`;
                    } else {
                        return `<span class="text-primary">${originalText}</span>`;
                    }
                }).filter(Boolean);
                
                if (selectedItems.length > 0) {
                    selectedSubOptionsText = `
                        <div class="mt-2 text-xs font-medium flex flex-wrap gap-1">
                            ${selectedItems.join('')}
                        </div>
                    `;
                }
            }
            
            div.innerHTML = `
                <div class="text-base font-medium mb-1">${item.text}</div>
                ${selectedSubOptionsText}
                <div class="absolute top-1/2 right-1 -translate-y-1/2 opacity-0 group-hover:opacity-100 transition-opacity">
                    <button class="edit-btn text-xs text-neutral hover:text-primary p-1" data-id="${item.id}" data-type="${type}">
                        <i class="fa fa-edit"></i>
                    </button>
                </div>
            `;

            // ç‚¹å‡»é€‰æ‹©ï¼ˆä»…é’ˆå¯¹æ²¡æœ‰äºŒçº§é€‰é¡¹çš„é¡¹ç›®ï¼‰
            div.addEventListener('click', function(e) {
                if (e.target.closest('.edit-btn')) return;
                
                // å¦‚æœæ²¡æœ‰äºŒçº§é€‰é¡¹ï¼Œç›´æ¥åˆ‡æ¢é€‰æ‹©çŠ¶æ€
                if (!item.subOptions || item.subOptions.length === 0) {
                    toggleSelection(item.id, type);
                }
            });
            
            // é¼ æ ‡æ‚¬åœæ˜¾ç¤ºäºŒçº§é€‰é¡¹æ°”æ³¡
            if (item.subOptions && item.subOptions.length > 0) {
                let hoverTimer;
                
                div.addEventListener('mouseenter', function(e) {
                    if (e.target.closest('.edit-btn')) return;
                    
                    // ç«‹å³æ˜¾ç¤ºæ°”æ³¡
                    // å…³é—­å…¶ä»–é¡¹ç›®çš„æ°”æ³¡æ¡†ï¼Œä¿æŒå½“å‰é¡¹ç›®çš„ç‹¬ç«‹æ€§
                    const allBubbles = document.querySelectorAll('.sub-options-bubble');
                    allBubbles.forEach(bubble => {
                        const bubbleItemId = bubble.getAttribute('data-item-id');
                        const bubbleType = bubble.getAttribute('data-type');
                        if (bubbleItemId !== item.id.toString() || bubbleType !== type) {
                            bubble.remove();
                        }
                    });
                    
                    showSubOptionsBubble(item, type, div);
                });
                
                div.addEventListener('mouseleave', function(e) {
                    if (hoverTimer) {
                        clearTimeout(hoverTimer);
                        hoverTimer = null;
                    }
                });
            }

            // ç¼–è¾‘æŒ‰é’®äº‹ä»¶
            const editBtn = div.querySelector('.edit-btn');
            editBtn.addEventListener('click', function(e) {
                e.stopPropagation();
                editItem(item.id, type);
            });

            // å³é”®èœå•äº‹ä»¶ - æ¸…é™¤é€‰ä¸­çŠ¶æ€
            div.addEventListener('contextmenu', function(e) {
                e.preventDefault();
                clearItemSelection(item.id, type);
            });

            // æ‹–æ‹½äº‹ä»¶
            div.addEventListener('dragstart', function(e) {
                draggedItem = { id: item.id, type: type };
                e.dataTransfer.effectAllowed = 'move';
            });

            div.addEventListener('dragover', function(e) {
                e.preventDefault();
                e.dataTransfer.dropEffect = 'move';
            });

            div.addEventListener('drop', function(e) {
                e.preventDefault();
                if (draggedItem && draggedItem.type === type && draggedItem.id !== item.id) {
                    reorderItems(draggedItem.id, item.id, type);
                }
                draggedItem = null;
            });

            return div;
        }

        // æ˜¾ç¤ºäºŒçº§é€‰é¡¹æ°”æ³¡é€‰æ‹©æ¡†
        function showSubOptionsBubble(item, type, targetElement) {
            // ä¸ºæ¯ä¸ªæ°”æ³¡æ¡†åˆ›å»ºå”¯ä¸€æ ‡è¯†
            const bubbleId = `bubble-${type}-${item.id}`;
            
            // ç§»é™¤è¯¥é¡¹ç›®å·²å­˜åœ¨çš„æ°”æ³¡æ¡†
            const existingBubble = document.querySelector(`[data-bubble-id="${bubbleId}"]`);
            if (existingBubble) {
                existingBubble.remove();
            }

            // åˆ›å»ºæ°”æ³¡æ¡†
            const bubble = document.createElement('div');
            bubble.className = 'sub-options-bubble fixed bg-white border border-gray-300 rounded-lg shadow-lg p-2 z-50 max-w-sm';
            bubble.setAttribute('data-bubble-id', bubbleId);
            bubble.setAttribute('data-item-id', item.id);
            bubble.setAttribute('data-type', type);
            
            const selectedSubOptions = getSelectedSubOptions(item.id, type);
            
            bubble.innerHTML = `
                <div class="space-y-1 max-h-80 overflow-y-auto">
                    ${item.subOptions.map((subOption, index) => {
                        const isSelected = selectedSubOptions.includes(index);
                        const displayText = getSubOptionDisplayText(item.id, index, subOption);
                        const tag = getSubOptionTag(item.id, index);
                        const tagColor = getSubOptionTagColor(item.id, index);
                        
                        let tagHtml = '';
                        if (tag) {
                            tagHtml = `<span class="inline-block px-2 py-1 text-sm rounded" style="background-color: ${tagColor}; color: white; margin-right: 6px; border-radius: 4px;">${tag}</span>`;
                        }
                        
                        return `
                            <div class="sub-option-item px-2 py-1 rounded cursor-pointer transition-colors ${
                                isSelected ? 'bg-blue-100 text-blue-700 border border-blue-300' : 'hover:bg-gray-100'
                            }" data-index="${index}">
                                ${tagHtml}${subOption}
                            </div>
                        `;
                    }).join('')}
                </div>
            `;

            document.body.appendChild(bubble);

            // å®šä½æ°”æ³¡æ¡†
            const rect = targetElement.getBoundingClientRect();
            const bubbleRect = bubble.getBoundingClientRect();
            
            let left = rect.left + rect.width / 2 - bubbleRect.width / 2;
            let top = rect.bottom + 0;
            
            // ç¡®ä¿æ°”æ³¡æ¡†ä¸è¶…å‡ºè§†çª—
            if (left < 8) left = 8;
            if (left + bubbleRect.width > window.innerWidth - 8) {
                left = window.innerWidth - bubbleRect.width - 8;
            }
            if (top + bubbleRect.height > window.innerHeight - 8) {
                top = rect.top - bubbleRect.height - 8;
            }
            
            bubble.style.left = left + 'px';
            bubble.style.top = top + 'px';

            // å½“å‰é€‰æ‹©çŠ¶æ€
            let currentSelectedOptions = [...selectedSubOptions];

            // äºŒçº§é€‰é¡¹ç‚¹å‡»äº‹ä»¶ - ç›´æ¥åº”ç”¨é€‰æ‹©
            bubble.addEventListener('click', function(e) {
                const subOptionItem = e.target.closest('.sub-option-item');
                if (subOptionItem) {
                    const index = parseInt(subOptionItem.dataset.index);
                    const isCurrentlySelected = currentSelectedOptions.includes(index);
                    
                    if (isCurrentlySelected) {
                        // å–æ¶ˆé€‰æ‹©
                        currentSelectedOptions = currentSelectedOptions.filter(i => i !== index);
                        subOptionItem.className = 'sub-option-item px-2 py-1 rounded cursor-pointer transition-colors hover:bg-gray-100';
                    } else {
                        // é€‰æ‹©
                        currentSelectedOptions.push(index);
                        subOptionItem.className = 'sub-option-item px-2 py-1 rounded cursor-pointer transition-colors bg-blue-100 text-blue-700 border border-blue-300';
                    }
                    
                    // ç«‹å³åº”ç”¨é€‰æ‹©
                    applySubOptionSelection(item.id, type, currentSelectedOptions);
                }
            });

            // é¼ æ ‡ç§»å‡ºè‡ªåŠ¨å…³é—­æœºåˆ¶ - æ¯ä¸ªæ°”æ³¡æ¡†ç‹¬ç«‹ç®¡ç†
            let closeTimer;
            
            const bubbleMouseEnter = function() {
                if (closeTimer) {
                    clearTimeout(closeTimer);
                    closeTimer = null;
                }
            };
            
            const bubbleMouseLeave = function() {
                closeTimer = setTimeout(() => {
                    if (document.body.contains(bubble)) {
                        bubble.remove();
                    }
                }, 100); // 100mså»¶è¿Ÿå…³é—­
            };
            
            const targetMouseLeave = function() {
                closeTimer = setTimeout(() => {
                    if (document.body.contains(bubble)) {
                        bubble.remove();
                    }
                }, 100);
            };
            
            const targetMouseEnter = function() {
                if (closeTimer) {
                    clearTimeout(closeTimer);
                    closeTimer = null;
                }
            };
            
            bubble.addEventListener('mouseenter', bubbleMouseEnter);
            bubble.addEventListener('mouseleave', bubbleMouseLeave);
            targetElement.addEventListener('mouseleave', targetMouseLeave);
            targetElement.addEventListener('mouseenter', targetMouseEnter);
            
            // æ¸…ç†äº‹ä»¶ç›‘å¬å™¨
            bubble.addEventListener('remove', function() {
                bubble.removeEventListener('mouseenter', bubbleMouseEnter);
                bubble.removeEventListener('mouseleave', bubbleMouseLeave);
                targetElement.removeEventListener('mouseleave', targetMouseLeave);
                targetElement.removeEventListener('mouseenter', targetMouseEnter);
                if (closeTimer) {
                    clearTimeout(closeTimer);
                }
            });

            // ç‚¹å‡»å¤–éƒ¨å…³é—­ - ç‹¬ç«‹å¤„ç†
            const clickOutsideHandler = function(e) {
                if (document.body.contains(bubble) && 
                    !bubble.contains(e.target) && 
                    !targetElement.contains(e.target)) {
                    bubble.remove();
                    document.removeEventListener('click', clickOutsideHandler);
                }
            };
            
            setTimeout(() => {
                document.addEventListener('click', clickOutsideHandler);
            }, 100);
            
            // ç¡®ä¿åœ¨æ°”æ³¡æ¡†ç§»é™¤æ—¶æ¸…ç†äº‹ä»¶ç›‘å¬å™¨
            const originalRemove = bubble.remove;
            bubble.remove = function() {
                document.removeEventListener('click', clickOutsideHandler);
                originalRemove.call(this);
            };
        }

        // åº”ç”¨äºŒçº§é€‰é¡¹é€‰æ‹©
        function applySubOptionSelection(itemId, type, selectedIndexes) {
            // ç§»é™¤æ—§çš„é€‰æ‹©
            const existingIndex = selection[type].findIndex(item => item.id === itemId);
            if (existingIndex > -1) {
                selection[type].splice(existingIndex, 1);
            }
            // æ·»åŠ æ–°çš„é€‰æ‹©
            if (selectedIndexes.length > 0) {
                selection[type].push({ id: itemId, subOptions: selectedIndexes });
            }
            
            // é‡æ–°æ¸²æŸ“è¯¥ç±»å‹çš„å†…å®¹
            renderContent(type);
            
            // æ›´æ–°ç»“æœ
            updateResult();
        }

        // æ¸…é™¤æŒ‡å®šé¡¹ç›®çš„é€‰ä¸­çŠ¶æ€ï¼ˆåŒ…æ‹¬æ‰€æœ‰äºŒçº§é€‰é¡¹ï¼‰
        function clearItemSelection(id, type) {
            let wasSelected = false;
            
            // å¤šé€‰ç±»å‹
            const index = selection[type].findIndex(item => item.id === id);
            if (index > -1) {
                selection[type].splice(index, 1);
                wasSelected = true;
            }
            
            if (wasSelected) {
                // é‡æ–°æ¸²æŸ“è¯¥ç±»å‹çš„å†…å®¹
                renderContent(type);
                
                // æ›´æ–°ç»“æœ
                updateResult();
                
                // æ˜¾ç¤ºæç¤ºä¿¡æ¯
                showNotification('å·²æ¸…é™¤é€‰ä¸­çŠ¶æ€', 'info');
            }
        }

        // è·å–é€‰ä¸­çš„äºŒçº§é€‰é¡¹
        function getSelectedSubOptions(itemId, type) {
            const item = selection[type].find(item => item.id === itemId);
            return item ? item.subOptions : [];
        }
        
        // åˆ‡æ¢äºŒçº§é€‰é¡¹é€‰æ‹©çŠ¶æ€
        function toggleSubOptionSelection(itemId, subIndex, type, checked) {
            let item = selection[type].find(item => item.id === itemId);
            if (!item) {
                item = { id: itemId, subOptions: [] };
                selection[type].push(item);
            }
            
            if (checked) {
                if (!item.subOptions.includes(subIndex)) {
                    item.subOptions.push(subIndex);
                }
            } else {
                const index = item.subOptions.indexOf(subIndex);
                if (index > -1) {
                    item.subOptions.splice(index, 1);
                }
                // å¦‚æœæ²¡æœ‰é€‰ä¸­çš„äºŒçº§é€‰é¡¹ï¼Œç§»é™¤æ•´ä¸ªé¡¹ç›®
                if (item.subOptions.length === 0) {
                    const itemIndex = selection[type].indexOf(item);
                    if (itemIndex > -1) {
                        selection[type].splice(itemIndex, 1);
                    }
                }
            }
            
            updateResult();
        }

        // æ£€æŸ¥é¡¹ç›®æ˜¯å¦è¢«é€‰ä¸­
        function isItemSelected(id, type) {
            return selection[type].some(item => item.id === id);
        }

        // åˆ‡æ¢é€‰æ‹©çŠ¶æ€
        function toggleSelection(id, type) {
            // å¤šé€‰
            const index = selection[type].findIndex(item => item.id === id);
            if (index > -1) {
                selection[type].splice(index, 1);
            } else {
                selection[type].push({ id: id, subOptions: [] });
                
                // æ£€æŸ¥æ˜¯å¦ä¸ºä¸€çº§é€‰é¡¹ä¸”æ— äºŒçº§é€‰é¡¹ï¼Œå¦‚æœæ˜¯åˆ™è‡ªåŠ¨è®°å½•ä¸ºæ ‡ç­¾
                const item = contentIndex[type][id];
                if (item && (!item.subOptions || item.subOptions.length === 0)) {
                    // è‡ªåŠ¨è®¾ç½®ä¸€çº§é€‰é¡¹æ ‡ç­¾
                    setPrimaryOptionTag(id, item.text);
                }
            }
            
            // é‡æ–°æ¸²æŸ“è¯¥ç±»å‹çš„å†…å®¹
            renderContent(type);
            
            // æ›´æ–°ç»“æœ
            updateResult();
        }

        // æ›´æ–°ç»“æœ
        function updateResult() {
            const resultContainer = document.getElementById('resultContainer');
            let resultParts = [];
            
            // å¦‚æœå¤„äºæ™ºèƒ½ç­›é€‰æ¨¡å¼ï¼Œå®æ—¶æ›´æ–°æ”¶è—è¯æœ¯ç­›é€‰
            if (isSmartFilterMode) {
                renderFavoriteScripts();
                updateQuickButtonState();
            }

            // å¤„ç†èµ·æ‰‹ç§°å‘¼å¼
            if (selection.greeting.length > 0) {
                const greetingContents = [];
                const categoryName = getCategoryDisplayName('greeting');
                selection.greeting.forEach(selItem => {
                    const item = contentIndex.greeting[selItem.id];
                    if (item) {
                        if (selItem.subOptions.length > 0) {
                            const subContents = selItem.subOptions.map(index => item.subOptions[index]).filter(Boolean);
                            if (subContents.length > 0) {
                                greetingContents.push(...subContents);
                            }
                        } else {
                            // æ²¡æœ‰äºŒçº§é€‰é¡¹æ—¶ï¼Œç›´æ¥ä½¿ç”¨ä¸€çº§é€‰é¡¹å†…å®¹ä½œä¸ºäºŒçº§é€‰é¡¹å†…å®¹
                            greetingContents.push(item.text);
                        }
                    }
                });
                if (greetingContents.length > 0) {
                    resultParts.push(`${categoryName}ï¼š${greetingContents.join('ï¼Œ')}`);
                }
            }

            // å¤„ç†ä¼˜ç‚¹
            if (selection.strength.length > 0) {
                const strengthContents = [];
                const categoryName = getCategoryDisplayName('strength');
                selection.strength.forEach(selItem => {
                    const item = contentIndex.strength[selItem.id];
                    if (item) {
                        if (selItem.subOptions.length > 0) {
                            const subContents = selItem.subOptions.map(index => item.subOptions[index]).filter(Boolean);
                            if (subContents.length > 0) {
                                strengthContents.push(...subContents);
                            }
                        } else {
                            // æ²¡æœ‰äºŒçº§é€‰é¡¹æ—¶ï¼Œç›´æ¥ä½¿ç”¨ä¸€çº§é€‰é¡¹å†…å®¹ä½œä¸ºäºŒçº§é€‰é¡¹å†…å®¹
                            strengthContents.push(item.text);
                        }
                    }
                });
                if (strengthContents.length > 0) {
                    resultParts.push(`${categoryName}ï¼š${strengthContents.join('ï¼Œ')}`);
                }
            }

            // å¤„ç†é—®é¢˜
            if (selection.issue.length > 0) {
                const issueContents = [];
                const categoryName = getCategoryDisplayName('issue');
                selection.issue.forEach(selItem => {
                    const item = contentIndex.issue[selItem.id];
                    if (item) {
                        if (selItem.subOptions.length > 0) {
                            const subContents = selItem.subOptions.map(index => item.subOptions[index]).filter(Boolean);
                            if (subContents.length > 0) {
                                issueContents.push(...subContents);
                            }
                        } else {
                            // æ²¡æœ‰äºŒçº§é€‰é¡¹æ—¶ï¼Œç›´æ¥ä½¿ç”¨ä¸€çº§é€‰é¡¹å†…å®¹ä½œä¸ºäºŒçº§é€‰é¡¹å†…å®¹
                            issueContents.push(item.text);
                        }
                    }
                });
                if (issueContents.length > 0) {
                    resultParts.push(`${categoryName}ï¼š${issueContents.join('ï¼Œ')}`);
                }
            }

            // å¤„ç†ç»“å°¾å¼
            if (selection.closing.length > 0) {
                const closingContents = [];
                const categoryName = getCategoryDisplayName('closing');
                selection.closing.forEach(selItem => {
                    const item = contentIndex.closing[selItem.id];
                    if (item) {
                        if (selItem.subOptions.length > 0) {
                            const subContents = selItem.subOptions.map(index => item.subOptions[index]).filter(Boolean);
                            if (subContents.length > 0) {
                                closingContents.push(...subContents);
                            }
                        } else {
                            // æ²¡æœ‰äºŒçº§é€‰é¡¹æ—¶ï¼Œç›´æ¥ä½¿ç”¨ä¸€çº§é€‰é¡¹å†…å®¹ä½œä¸ºäºŒçº§é€‰é¡¹å†…å®¹
                            closingContents.push(item.text);
                        }
                    }
                });
                if (closingContents.length > 0) {
                    resultParts.push(`${categoryName}ï¼š${closingContents.join('ï¼Œ')}`);
                }
            }

            // ç”¨åˆ†å·è¿æ¥æ‰€æœ‰éƒ¨åˆ†
            const result = resultParts.join('ï¼›');

            if (result.trim()) {
                resultContainer.innerHTML = `<pre class="whitespace-pre-wrap font-sans">${result}</pre>`;
            } else {
                resultContainer.innerHTML = '<p class="text-neutral italic">è¯·åœ¨å·¦ä¾§é€‰æ‹©å†…å®¹ï¼Œè¯æœ¯å’’è¯­å°†è‡ªåŠ¨ç”Ÿæˆåœ¨è¿™é‡Œ...</p>';
            }
            
            // åŠ¨æ€è°ƒæ•´æ–‡æœ¬æ¡†é«˜åº¦ï¼ˆæ— è®ºæœ‰æ— å†…å®¹éƒ½æ‰§è¡Œï¼‰
            setTimeout(() => {
                const minHeight = 45; // æœ€å°é«˜åº¦ - å•è¡Œæ–‡å­—é«˜åº¦
                const maxHeight = Math.max(300, window.innerHeight * 0.4); // æœ€å¤§é«˜åº¦
                
                // ä¸´æ—¶é‡ç½®é«˜åº¦ä»¥è·å–çœŸå®çš„å†…å®¹é«˜åº¦
                const originalHeight = resultContainer.style.height;
                resultContainer.style.height = 'auto';
                resultContainer.style.maxHeight = 'none';
                
                const contentHeight = resultContainer.scrollHeight;
                let targetHeight = Math.max(minHeight, contentHeight);
                
                if (targetHeight > maxHeight) {
                    resultContainer.style.height = maxHeight + 'px';
                    resultContainer.style.overflowY = 'auto';
                } else {
                    resultContainer.style.height = targetHeight + 'px';
                    resultContainer.style.overflowY = 'hidden';
                }
                
                // ç¡®ä¿æœ€å°é«˜åº¦å§‹ç»ˆç”Ÿæ•ˆ
                resultContainer.style.minHeight = minHeight + 'px';
            }, 50);
        }

        // ç”Ÿæˆè¯æœ¯
        async function generateScript() {
            const resultContainer = document.getElementById('resultContainer');
            const generatedContainer = document.getElementById('generatedContainer');
            const generateBtn = document.getElementById('generateBtn');
            
            const inputText = resultContainer.textContent || resultContainer.innerText;
            
            if (!inputText.trim() || inputText.includes('è¯·åœ¨å·¦ä¾§é€‰æ‹©å†…å®¹')) {
                showNotification('è¯·å…ˆé€‰æ‹©å†…å®¹ç”Ÿæˆè¯æœ¯å’’è¯­', 'warning');
                return;
            }
            
            // æ£€æŸ¥APIé…ç½®
            if (!isApiConfigured()) {
                showNotification('è¯·å…ˆåœ¨è®¾ç½®ä¸­é…ç½®APIå¯†é’¥å’Œæœºå™¨äººID', 'error');
                openConfigPanel();
                return;
            }
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            generateBtn.disabled = true;
            generateBtn.innerHTML = '<i class="fa fa-spinner fa-spin"></i> ç”Ÿæˆä¸­...';
            generatedContainer.innerHTML = '<p class="text-neutral italic">AIæ­£åœ¨ä¸ºæ‚¨ç”Ÿæˆä¼˜åŒ–çš„è¯æœ¯å†…å®¹ï¼Œè¯·ç¨å€™...</p>';
            
            try {
                // è·å–é…ç½®çš„APIä¿¡æ¯
                const apiKey = getApiKey();
                const botId = getBotId();
                
                // æ ¹æ®Coze API v3æ–‡æ¡£ä¼˜åŒ–å‚æ•°æ ¼å¼
                const userId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                const requestBody = {
                    bot_id: botId,
                    user_id: userId, // ä½¿ç”¨åŠ¨æ€ç”Ÿæˆçš„å”¯ä¸€ç”¨æˆ·ID
                    stream: false,
                    auto_save_history: true,
                    additional_messages: [
                        {
                            role: 'user',
                            content: inputText.trim(),
                            content_type: 'text'
                        }
                    ]
                };
                
                console.log('=== Coze API v3 è¯·æ±‚è¯¦æƒ… ===');
                console.log('APIç«¯ç‚¹: https://api.coze.cn/v3/chat');
                console.log('è¯·æ±‚æ–¹æ³•: POST');
                console.log('ç”¨æˆ·ID:', userId);
                console.log('æœºå™¨äººID:', botId);
                console.log('APIå¯†é’¥çŠ¶æ€:', apiKey ? `å·²é…ç½®(${apiKey.substring(0, 8)}...)` : 'æœªé…ç½®');
                console.log('è¯·æ±‚ä½“:', JSON.stringify(requestBody, null, 2));
                
                // è°ƒç”¨æ‰£å­API v3
                const response = await fetch('https://api.coze.cn/v3/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify(requestBody)
                });
                
                console.log('=== APIå“åº”çŠ¶æ€æ£€æŸ¥ ===');
                console.log('å“åº”çŠ¶æ€ç :', response.status);
                console.log('å“åº”çŠ¶æ€æ–‡æœ¬:', response.statusText);
                console.log('å“åº”å¤´ä¿¡æ¯:', Object.fromEntries(response.headers.entries()));
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('APIè°ƒç”¨å¤±è´¥è¯¦æƒ…:', {
                        status: response.status,
                        statusText: response.statusText,
                        errorBody: errorText
                    });
                    
                    // å°è¯•è§£æé”™è¯¯å“åº”ä¸ºJSON
                    let errorData;
                    try {
                        errorData = JSON.parse(errorText);
                    } catch (e) {
                        errorData = { message: errorText };
                    }
                    
                    // æ ¹æ®çŠ¶æ€ç å’ŒCozeé”™è¯¯ç æä¾›å…·ä½“çš„é”™è¯¯è¯Šæ–­
                    let errorMessage = `APIè°ƒç”¨å¤±è´¥: ${response.status} ${response.statusText}`;
                    
                    // æ£€æŸ¥Cozeç‰¹æœ‰çš„é”™è¯¯ç 
                    if (errorData.code === 702242001) {
                        errorMessage += '\nğŸ” Cozeé”™è¯¯ç  702242001: å‚æ•°ä¼ é€’é”™è¯¯';
                        errorMessage += '\nå¯èƒ½åŸå› ï¼š';
                        errorMessage += '\n  - è¯·æ±‚å¤´ä¸å®Œæ•´ï¼ˆç¼ºå°‘Content-Typeæˆ–Authorizationï¼‰';
                        errorMessage += '\n  - è¯·æ±‚ä½“æ ¼å¼é”™è¯¯';
                        errorMessage += '\n  - å¿…éœ€å‚æ•°ç¼ºå¤±æˆ–æ ¼å¼ä¸æ­£ç¡®';
                        errorMessage += '\nğŸ’¡ å»ºè®®ï¼šæ£€æŸ¥APIå¯†é’¥æ ¼å¼æ˜¯å¦ä¸º "Bearer pat_xxx"';
                    } else if (response.status === 401) {
                        errorMessage += '\nğŸ” HTTP 401: æœªæˆæƒè®¿é—®';
                        errorMessage += '\nå¯èƒ½åŸå› ï¼š';
                        errorMessage += '\n  - APIå¯†é’¥æ— æ•ˆæˆ–å·²è¿‡æœŸ';
                        errorMessage += '\n  - å¯†é’¥æ ¼å¼é”™è¯¯ï¼ˆåº”ä¸º Bearer pat_xxxï¼‰';
                        errorMessage += '\nğŸ’¡ å»ºè®®ï¼šé‡æ–°ç”ŸæˆPersonal Access Token';
                    } else if (response.status === 403) {
                        errorMessage += '\nğŸ” HTTP 403: æƒé™ä¸è¶³';
                        errorMessage += '\nå¯èƒ½åŸå› ï¼š';
                        errorMessage += '\n  - PATä»¤ç‰Œç¼ºå°‘chatæƒé™';
                        errorMessage += '\n  - æœºå™¨äººä¸ä»¤ç‰Œä¸åœ¨åŒä¸€ç©ºé—´';
                        errorMessage += '\nğŸ’¡ å»ºè®®ï¼šæ£€æŸ¥ä»¤ç‰Œæƒé™è®¾ç½®';
                    } else if (response.status === 404) {
                        errorMessage += '\nğŸ” HTTP 404: èµ„æºä¸å­˜åœ¨';
                        errorMessage += '\nå¯èƒ½åŸå› ï¼š';
                        errorMessage += '\n  - æœºå™¨äººIDä¸å­˜åœ¨';
                        errorMessage += '\n  - æœºå™¨äººæœªå‘å¸ƒä¸ºAPIæœåŠ¡';
                        errorMessage += '\nğŸ’¡ å»ºè®®ï¼šç¡®è®¤æœºå™¨äººIDå¹¶æ£€æŸ¥å‘å¸ƒçŠ¶æ€';
                    } else if (response.status === 429) {
                        errorMessage += '\nğŸ” HTTP 429: è¯·æ±‚è¿‡å¤š';
                        errorMessage += '\nå¯èƒ½åŸå› ï¼šè¯·æ±‚é¢‘ç‡è¶…è¿‡é™åˆ¶';
                        errorMessage += '\nğŸ’¡ å»ºè®®ï¼šé™ä½è¯·æ±‚é¢‘ç‡æˆ–ç¨åé‡è¯•';
                    } else if (response.status >= 500) {
                        errorMessage += '\nğŸ” HTTP 5xx: æœåŠ¡å™¨é”™è¯¯';
                        errorMessage += '\nå¯èƒ½åŸå› ï¼šCozeæœåŠ¡å™¨å†…éƒ¨é”™è¯¯';
                        errorMessage += '\nğŸ’¡ å»ºè®®ï¼šç¨åé‡è¯•æˆ–è”ç³»æŠ€æœ¯æ”¯æŒ';
                    }
                    
                    errorMessage += `\n\nğŸ“‹ å®Œæ•´é”™è¯¯ä¿¡æ¯: ${errorText}`;
                    errorMessage += '\n\nğŸ”§ ä½¿ç”¨é”™è¯¯æ’æŸ¥å·¥å…·: coze-error-debug.html';
                    throw new Error(errorMessage);
                }
                
                const data = await response.json();
                
                // è¯¦ç»†è®°å½•APIå“åº”ç”¨äºè°ƒè¯•
                console.log('=== Coze API v3 è°ƒç”¨æµç¨‹å¼€å§‹ ===');
                console.log('æ­¥éª¤1 - å‘èµ·å¯¹è¯è¯·æ±‚æˆåŠŸ');
                console.log('å®Œæ•´å“åº”æ•°æ®:', JSON.stringify(data, null, 2));
                console.log('å“åº”æ•°æ®ç»“æ„æ£€æŸ¥:', {
                    hasCode: 'code' in data,
                    code: data.code,
                    hasMsg: 'msg' in data,
                    msg: data.msg,
                    hasData: 'data' in data,
                    dataType: typeof data.data
                });
                
                // æ ¹æ®Coze APIæ–‡æ¡£ï¼Œéæµå¼è°ƒç”¨éœ€è¦ä¸‰æ­¥ï¼š
                // 1. å‘èµ·å¯¹è¯è¯·æ±‚ï¼ˆå½“å‰æ­¥éª¤ï¼‰- è¿”å›chat_id
                // 2. è½®è¯¢å¯¹è¯çŠ¶æ€ - ç­‰å¾…completed
                // 3. è·å–å¯¹è¯æ¶ˆæ¯ - è·å–æœ€ç»ˆç»“æœ
                
                if (!data.data || !data.data.id) {
                    throw new Error('æœªè·å–åˆ°chat_idï¼ŒAPIå“åº”æ ¼å¼å¼‚å¸¸');
                }
                
                const chatId = data.data.id;
                const conversationId = data.data.conversation_id;
                console.log('è·å–åˆ°chat_id:', chatId);
                console.log('ä¼šè¯ID:', conversationId);
                
                // æ­¥éª¤2: è½®è¯¢å¯¹è¯çŠ¶æ€
                console.log('æ­¥éª¤2 - å¼€å§‹è½®è¯¢å¯¹è¯çŠ¶æ€...');
                let chatStatus = 'in_progress';
                let pollCount = 0;
                const maxPolls = 30; // æœ€å¤šè½®è¯¢30æ¬¡ï¼Œé¿å…æ— é™ç­‰å¾…
                
                while (chatStatus === 'in_progress' && pollCount < maxPolls) {
                    await new Promise(resolve => setTimeout(resolve, 1000)); // ç­‰å¾…1ç§’
                    pollCount++;
                    
                    const statusResponse = await fetch(`https://api.coze.cn/v3/chat/retrieve?conversation_id=${conversationId}&chat_id=${chatId}`, {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${apiKey}`
                        }
                    });
                    
                    if (!statusResponse.ok) {
                        throw new Error(`çŠ¶æ€æŸ¥è¯¢å¤±è´¥: ${statusResponse.status}`);
                    }
                    
                    const statusData = await statusResponse.json();
                    chatStatus = statusData.data.status;
                    console.log(`è½®è¯¢ç¬¬${pollCount}æ¬¡ï¼ŒçŠ¶æ€: ${chatStatus}`);
                    
                    if (chatStatus === 'failed') {
                        throw new Error('å¯¹è¯å¤„ç†å¤±è´¥');
                    }
                    if (chatStatus === 'cancelled') {
                        throw new Error('å¯¹è¯è¢«å–æ¶ˆ');
                    }
                }
                
                if (chatStatus !== 'completed') {
                    throw new Error('å¯¹è¯å¤„ç†è¶…æ—¶ï¼Œè¯·ç¨åé‡è¯•');
                }
                
                console.log('æ­¥éª¤3 - å¯¹è¯å®Œæˆï¼Œè·å–æ¶ˆæ¯å†…å®¹...');
                
                // æ­¥éª¤3: è·å–å¯¹è¯æ¶ˆæ¯
                const messagesResponse = await fetch(`https://api.coze.cn/v3/chat/message/list?conversation_id=${conversationId}&chat_id=${chatId}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`
                    }
                });
                
                if (!messagesResponse.ok) {
                    throw new Error(`æ¶ˆæ¯è·å–å¤±è´¥: ${messagesResponse.status}`);
                }
                
                const messagesData = await messagesResponse.json();
                console.log('=== æ¶ˆæ¯å“åº”æ•°æ®éªŒè¯ ===');
                console.log('å®Œæ•´å“åº”æ•°æ®:', JSON.stringify(messagesData, null, 2));
                console.log('å“åº”æ•°æ®ç±»å‹:', typeof messagesData);
                console.log('å“åº”çŠ¶æ€ç :', messagesResponse.status);
                console.log('å“åº”å¤´ä¿¡æ¯:', Object.fromEntries(messagesResponse.headers.entries()));
                
                // éªŒè¯å“åº”æ•°æ®ç»“æ„
                if (!messagesData || typeof messagesData !== 'object') {
                    throw new Error('æ¶ˆæ¯å“åº”æ•°æ®æ ¼å¼æ— æ•ˆï¼šä¸æ˜¯æœ‰æ•ˆçš„JSONå¯¹è±¡');
                }
                
                console.log('æ˜¯å¦æœ‰dataå­—æ®µ:', 'data' in messagesData);
                console.log('dataå­—æ®µç±»å‹:', typeof messagesData.data);
                console.log('dataæ˜¯å¦ä¸ºæ•°ç»„:', Array.isArray(messagesData.data));
                
                if (messagesData.data) {
                    console.log('dataæ•°ç»„é•¿åº¦:', messagesData.data.length);
                    if (messagesData.data.length > 0) {
                        console.log('ç¬¬ä¸€æ¡æ¶ˆæ¯ç»“æ„:', messagesData.data[0]);
                    }
                } else {
                    console.warn('è­¦å‘Šï¼šå“åº”ä¸­æ²¡æœ‰dataå­—æ®µ');
                    console.log('å¯ç”¨å­—æ®µ:', Object.keys(messagesData));
                }
                
                let generatedText = '';
                
                // è§£æCoze APIçš„æ¶ˆæ¯æ ¼å¼
                if (messagesData.data && Array.isArray(messagesData.data)) {
                    console.log('=== è§£æCozeæ¶ˆæ¯æ•°ç»„ ===');
                    console.log('æ¶ˆæ¯æ€»æ•°:', messagesData.data.length);
                    
                    // æ˜¾ç¤ºæ‰€æœ‰æ¶ˆæ¯çš„è¯¦ç»†ä¿¡æ¯
                    messagesData.data.forEach((msg, index) => {
                        console.log(`æ¶ˆæ¯${index + 1}è¯¦æƒ…:`, {
                            id: msg.id,
                            role: msg.role,
                            type: msg.type,
                            content_type: msg.content_type,
                            content: msg.content,
                            chat_id: msg.chat_id
                        });
                    });
                    
                    // æ ¹æ®Coze APIæ–‡æ¡£ï¼ŒæŸ¥æ‰¾type=answerä¸”content_type=textçš„æ™ºèƒ½ä½“å›å¤
                    const textAnswerMessages = messagesData.data.filter(msg => 
                        msg.role === 'assistant' && 
                        msg.type === 'answer' && 
                        msg.content_type === 'text'
                    );
                    
                    console.log('æ‰¾åˆ°æ–‡æœ¬æ ¼å¼æ™ºèƒ½ä½“å›å¤æ•°é‡:', textAnswerMessages.length);
                    
                    if (textAnswerMessages.length > 0) {
                        // åˆå¹¶æ‰€æœ‰æ–‡æœ¬å›å¤å†…å®¹
                        generatedText = textAnswerMessages.map(msg => msg.content).join('\n');
                        console.log('æå–çš„æ™ºèƒ½ä½“å›å¤å†…å®¹:', generatedText);
                    } else {
                        // å¦‚æœæ²¡æœ‰æ‰¾åˆ°æ ‡å‡†çš„æ–‡æœ¬å›å¤ï¼Œå°è¯•æŸ¥æ‰¾å…¶ä»–ç±»å‹çš„assistantæ¶ˆæ¯
                        const allAssistantMessages = messagesData.data.filter(msg => 
                            msg.role === 'assistant'
                        );
                        
                        console.log('æ‰€æœ‰assistantæ¶ˆæ¯æ•°é‡:', allAssistantMessages.length);
                        
                        if (allAssistantMessages.length > 0) {
                            // ä¼˜å…ˆé€‰æ‹©answerç±»å‹çš„æ¶ˆæ¯
                            const answerMessages = allAssistantMessages.filter(msg => msg.type === 'answer');
                            if (answerMessages.length > 0) {
                                generatedText = answerMessages.map(msg => msg.content).join('\n');
                                console.log('ä½¿ç”¨answerç±»å‹æ¶ˆæ¯:', generatedText);
                            } else {
                                // å¦‚æœæ²¡æœ‰answerç±»å‹ï¼Œä½¿ç”¨ç¬¬ä¸€ä¸ªassistantæ¶ˆæ¯
                                generatedText = allAssistantMessages[0].content;
                                console.log('ä½¿ç”¨ç¬¬ä¸€ä¸ªassistantæ¶ˆæ¯:', generatedText);
                            }
                        } else {
                            console.error('æœªæ‰¾åˆ°ä»»ä½•assistantè§’è‰²çš„æ¶ˆæ¯');
                            throw new Error('æœªæ‰¾åˆ°æœ‰æ•ˆçš„æ™ºèƒ½ä½“å›å¤');
                        }
                    }
                } else {
                    console.error('æ¶ˆæ¯æ•°æ®æ ¼å¼å¼‚å¸¸:', messagesData);
                    throw new Error('æ¶ˆæ¯æ•°æ®æ ¼å¼å¼‚å¸¸');
                }
                
                console.log('=== APIå“åº”è§£æç»“æŸ ===');
                console.log('æœ€ç»ˆæå–çš„å†…å®¹:', generatedText);
                
                console.log('æå–çš„ç”Ÿæˆæ–‡æœ¬:', generatedText);
                
                // å¦‚æœAPIè¿”å›å†…å®¹ä¸ºç©ºï¼Œä½¿ç”¨å¤‡ç”¨å†…å®¹
                if (!generatedText || generatedText.trim() === '') {
                    console.log('APIè¿”å›å†…å®¹ä¸ºç©ºï¼Œä½¿ç”¨å¤‡ç”¨å†…å®¹');
                    generatedText = `ã€ä¼˜åŒ–åçš„è¯æœ¯ã€‘\n\n${inputText.trim()}\n\nç»è¿‡AIä¼˜åŒ–ï¼Œä»¥ä¸Šè¯æœ¯åœ¨ä»¥ä¸‹æ–¹é¢å¾—åˆ°äº†æ”¹è¿›ï¼š\n1. è¯­è¨€è¡¨è¾¾æ›´åŠ ä¸“ä¸šå’Œç¤¼è²Œ\n2. é€»è¾‘ç»“æ„æ›´åŠ æ¸…æ™°\n3. è¯´æœåŠ›å’Œæ„ŸæŸ“åŠ›å¾—åˆ°å¢å¼º\n4. ç¬¦åˆç°ä»£å•†åŠ¡æ²Ÿé€šæ ‡å‡†\n\nå»ºè®®åœ¨å®é™…ä½¿ç”¨æ—¶æ ¹æ®å…·ä½“æƒ…å†µè¿›è¡Œå¾®è°ƒã€‚\n\næ³¨æ„ï¼šAPIè¿”å›å†…å®¹ä¸ºç©ºï¼Œå½“å‰ä½¿ç”¨å¤‡ç”¨ç”Ÿæˆæ¨¡å¼ã€‚`;
                } else {
                    console.log('ä½¿ç”¨APIç”Ÿæˆçš„å†…å®¹');
                }
                
                // æ˜¾ç¤ºç”Ÿæˆçš„å†…å®¹ - ä½¿ç”¨textContenté¿å…HTMLæ³¨å…¥
                const preElement = document.createElement('pre');
                preElement.className = 'whitespace-pre-wrap font-sans';
                preElement.textContent = generatedText;
                generatedContainer.innerHTML = '';
                generatedContainer.appendChild(preElement);
                
                // åŠ¨æ€è°ƒæ•´ç”Ÿæˆæ–‡æœ¬æ¡†é«˜åº¦
                adjustGeneratedContainerHeight();
                
                // æ›´æ–°å­—æ•°ç»Ÿè®¡
                updateCharCount();
                
                showNotification('è¯æœ¯ç”ŸæˆæˆåŠŸï¼', 'success');
                
                // è‡ªåŠ¨å¤åˆ¶ç”Ÿæˆçš„è¯æœ¯åˆ°å‰ªåˆ‡æ¿
                copyGeneratedResult();
                
            } catch (error) {
                console.error('=== APIè°ƒç”¨å¼‚å¸¸è¯¦ç»†åˆ†æ ===');
                console.error('é”™è¯¯å¯¹è±¡:', error);
                console.error('é”™è¯¯æ¶ˆæ¯:', error.message);
                console.error('é”™è¯¯å †æ ˆ:', error.stack);
                console.error('é”™è¯¯ç±»å‹:', error.constructor.name);
                
                // ç½‘ç»œçŠ¶æ€æ£€æŸ¥
                console.log('=== ç½‘ç»œçŠ¶æ€æ£€æŸ¥ ===');
                console.log('åœ¨çº¿çŠ¶æ€:', navigator.onLine ? 'åœ¨çº¿' : 'ç¦»çº¿');
                console.log('ç”¨æˆ·ä»£ç†:', navigator.userAgent);
                
                // APIé…ç½®æ£€æŸ¥
                console.log('=== APIé…ç½®æ£€æŸ¥ ===');
                const currentApiKey = getApiKey();
                const currentBotId = getBotId();
                console.log('APIå¯†é’¥çŠ¶æ€:', currentApiKey ? `å·²é…ç½®(é•¿åº¦: ${currentApiKey.length}, å‰ç¼€: ${currentApiKey.substring(0, 10)}...)` : 'æœªé…ç½®');
                console.log('æœºå™¨äººIDçŠ¶æ€:', currentBotId ? `å·²é…ç½®(${currentBotId})` : 'æœªé…ç½®');
                console.log('é…ç½®å®Œæ•´æ€§:', isApiConfigured() ? 'å®Œæ•´' : 'ä¸å®Œæ•´');
                
                // è¯¦ç»†çš„é”™è¯¯åˆ†ç±»å’Œè¯Šæ–­
                let errorMessage = 'APIè°ƒç”¨å¤±è´¥';
                let diagnosticInfo = '';
                let troubleshootingSteps = [];
                
                if (error.message.includes('Failed to fetch') || error.name === 'TypeError') {
                    errorMessage = 'APIè°ƒç”¨å¤±è´¥ï¼šç½‘ç»œè¿æ¥é”™è¯¯';
                    diagnosticInfo = 'æ— æ³•è¿æ¥åˆ°Coze APIæœåŠ¡å™¨';
                    troubleshootingSteps = [
                        '1. æ£€æŸ¥ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸',
                        '2. ç¡®è®¤é˜²ç«å¢™æˆ–ä»£ç†è®¾ç½®',
                        '3. éªŒè¯APIæœåŠ¡å™¨æ˜¯å¦å¯è®¿é—®',
                        '4. æ£€æŸ¥CORSç­–ç•¥é…ç½®'
                    ];
                } else if (error.message.includes('401') || error.message.includes('Unauthorized')) {
                    errorMessage = 'APIè°ƒç”¨å¤±è´¥ï¼šèº«ä»½éªŒè¯å¤±è´¥';
                    diagnosticInfo = 'APIå¯†é’¥æ— æ•ˆæˆ–å·²è¿‡æœŸ';
                    troubleshootingSteps = [
                        '1. æ£€æŸ¥APIå¯†é’¥æ˜¯å¦æ­£ç¡®',
                        '2. ç¡®è®¤APIå¯†é’¥æœªè¿‡æœŸ',
                        '3. éªŒè¯APIå¯†é’¥æƒé™èŒƒå›´',
                        '4. é‡æ–°ç”ŸæˆAPIå¯†é’¥'
                    ];
                } else if (error.message.includes('403') || error.message.includes('Forbidden')) {
                    errorMessage = 'APIè°ƒç”¨å¤±è´¥ï¼šæƒé™ä¸è¶³';
                    diagnosticInfo = 'æœºå™¨äººIDæ— æ•ˆæˆ–APIå¯†é’¥æ— è®¿é—®æƒé™';
                    troubleshootingSteps = [
                        '1. ç¡®è®¤æœºå™¨äººIDæ­£ç¡®',
                        '2. æ£€æŸ¥APIå¯†é’¥æƒé™',
                        '3. éªŒè¯æœºå™¨äººçŠ¶æ€æ˜¯å¦æ­£å¸¸',
                        '4. ç¡®è®¤è´¦æˆ·ä½™é¢å……è¶³'
                    ];
                } else if (error.message.includes('429') || error.message.includes('Too Many Requests')) {
                    errorMessage = 'APIè°ƒç”¨å¤±è´¥ï¼šè¯·æ±‚é¢‘ç‡è¿‡é«˜';
                    diagnosticInfo = 'è§¦å‘äº†APIé€Ÿç‡é™åˆ¶';
                    troubleshootingSteps = [
                        '1. ç­‰å¾…ä¸€æ®µæ—¶é—´åé‡è¯•',
                        '2. æ£€æŸ¥APIé…é¢ä½¿ç”¨æƒ…å†µ',
                        '3. ä¼˜åŒ–è¯·æ±‚é¢‘ç‡',
                        '4. è€ƒè™‘å‡çº§APIå¥—é¤'
                    ];
                } else if (error.message.includes('500') || error.message.includes('502') || error.message.includes('503')) {
                    errorMessage = 'APIè°ƒç”¨å¤±è´¥ï¼šæœåŠ¡å™¨é”™è¯¯';
                    diagnosticInfo = 'Coze APIæœåŠ¡å™¨å‡ºç°é—®é¢˜';
                    troubleshootingSteps = [
                        '1. ç¨åé‡è¯•è¯·æ±‚',
                        '2. æ£€æŸ¥CozeæœåŠ¡çŠ¶æ€',
                        '3. è”ç³»æŠ€æœ¯æ”¯æŒ',
                        '4. ä½¿ç”¨å¤‡ç”¨æ–¹æ¡ˆ'
                    ];
                } else if (error.message.includes('æœªè·å–åˆ°chat_id')) {
                    errorMessage = 'APIè°ƒç”¨å¤±è´¥ï¼šå“åº”æ ¼å¼å¼‚å¸¸';
                    diagnosticInfo = 'åˆå§‹è¯·æ±‚æœªè¿”å›æœ‰æ•ˆçš„chat_id';
                    troubleshootingSteps = [
                        '1. æ£€æŸ¥è¯·æ±‚å‚æ•°æ ¼å¼',
                        '2. éªŒè¯æœºå™¨äººé…ç½®',
                        '3. ç¡®è®¤APIç‰ˆæœ¬å…¼å®¹æ€§',
                        '4. æŸ¥çœ‹è¯¦ç»†å“åº”æ—¥å¿—'
                    ];
                } else if (error.message.includes('å¯¹è¯å¤„ç†å¤±è´¥') || error.message.includes('å¯¹è¯è¢«å–æ¶ˆ')) {
                    errorMessage = 'APIè°ƒç”¨å¤±è´¥ï¼šå¯¹è¯å¤„ç†å¼‚å¸¸';
                    diagnosticInfo = 'æœºå™¨äººå¤„ç†è¿‡ç¨‹ä¸­å‡ºç°é—®é¢˜';
                    troubleshootingSteps = [
                        '1. æ£€æŸ¥è¾“å…¥å†…å®¹æ˜¯å¦åˆè§„',
                        '2. éªŒè¯æœºå™¨äººé…ç½®',
                        '3. é‡è¯•è¯·æ±‚',
                        '4. è”ç³»æŠ€æœ¯æ”¯æŒ'
                    ];
                } else if (error.message.includes('å¯¹è¯å¤„ç†è¶…æ—¶')) {
                    errorMessage = 'APIè°ƒç”¨å¤±è´¥ï¼šå¤„ç†è¶…æ—¶';
                    diagnosticInfo = 'æœºå™¨äººå“åº”æ—¶é—´è¿‡é•¿';
                    troubleshootingSteps = [
                        '1. ç®€åŒ–è¾“å…¥å†…å®¹',
                        '2. é‡è¯•è¯·æ±‚',
                        '3. æ£€æŸ¥æœºå™¨äººæ€§èƒ½',
                        '4. å¢åŠ è¶…æ—¶æ—¶é—´'
                    ];
                } else {
                    diagnosticInfo = 'æœªçŸ¥é”™è¯¯ç±»å‹';
                    troubleshootingSteps = [
                        '1. æŸ¥çœ‹æµè§ˆå™¨æ§åˆ¶å°è¯¦ç»†ä¿¡æ¯',
                        '2. æ£€æŸ¥ç½‘ç»œè¿æ¥',
                        '3. éªŒè¯APIé…ç½®',
                        '4. è”ç³»æŠ€æœ¯æ”¯æŒ'
                    ];
                }
                
                console.log('=== é”™è¯¯è¯Šæ–­ç»“æœ ===');
                console.log('é”™è¯¯åˆ†ç±»:', errorMessage);
                console.log('é—®é¢˜æè¿°:', diagnosticInfo);
                console.log('æ’æŸ¥æ­¥éª¤:', troubleshootingSteps);
                console.log('=== è¯Šæ–­ä¿¡æ¯ç»“æŸ ===');
                
                // æ˜¾ç¤ºç”¨æˆ·å‹å¥½çš„é”™è¯¯ä¿¡æ¯
                showNotification(`${errorMessage}ã€‚${diagnosticInfo}`, 'error');
                
                // å¦‚æœAPIè°ƒç”¨å¤±è´¥ï¼Œæä¾›å¤‡ç”¨å†…å®¹
                const fallbackText = `ã€ä¼˜åŒ–åçš„è¯æœ¯ã€‘\n\n${inputText.trim()}\n\nç»è¿‡AIä¼˜åŒ–ï¼Œä»¥ä¸Šè¯æœ¯åœ¨ä»¥ä¸‹æ–¹é¢å¾—åˆ°äº†æ”¹è¿›ï¼š\n1. è¯­è¨€è¡¨è¾¾æ›´åŠ ä¸“ä¸šå’Œç¤¼è²Œ\n2. é€»è¾‘ç»“æ„æ›´åŠ æ¸…æ™°\n3. è¯´æœåŠ›å’Œæ„ŸæŸ“åŠ›å¾—åˆ°å¢å¼º\n4. ç¬¦åˆç°ä»£å•†åŠ¡æ²Ÿé€šæ ‡å‡†\n\nå»ºè®®åœ¨å®é™…ä½¿ç”¨æ—¶æ ¹æ®å…·ä½“æƒ…å†µè¿›è¡Œå¾®è°ƒã€‚\n\næ³¨æ„ï¼šAPIè°ƒç”¨å¤±è´¥ï¼Œå½“å‰ä½¿ç”¨å¤‡ç”¨ç”Ÿæˆæ¨¡å¼ã€‚`;
                
                // ä½¿ç”¨ç›¸åŒçš„æ–¹å¼æ˜¾ç¤ºå¤‡ç”¨å†…å®¹
                const fallbackPreElement = document.createElement('pre');
                fallbackPreElement.className = 'whitespace-pre-wrap font-sans';
                fallbackPreElement.textContent = fallbackText;
                generatedContainer.innerHTML = '';
                generatedContainer.appendChild(fallbackPreElement);
                adjustGeneratedContainerHeight();
                
                // æ›´æ–°å­—æ•°ç»Ÿè®¡
                updateCharCount();
                
                showNotification(errorMessage + 'ï¼Œå·²ä½¿ç”¨å¤‡ç”¨æ¨¡å¼', 'warning');
            } finally {
                // æ¢å¤æŒ‰é’®çŠ¶æ€
                generateBtn.disabled = false;
                generateBtn.innerHTML = '<i class="fa fa-magic"></i> ç”Ÿæˆè¯æœ¯';
            }
        }
        
        // è°ƒæ•´ç”Ÿæˆæ–‡æœ¬æ¡†é«˜åº¦
        function adjustGeneratedContainerHeight() {
            const generatedContainer = document.getElementById('generatedContainer');
            const minHeight = 45;
            const maxHeight = Math.max(300, window.innerHeight * 0.4);
            
            // ä¸´æ—¶é‡ç½®é«˜åº¦ä»¥è·å–çœŸå®çš„å†…å®¹é«˜åº¦
            generatedContainer.style.height = 'auto';
            generatedContainer.style.maxHeight = 'none';
            
            const contentHeight = generatedContainer.scrollHeight;
            let targetHeight = Math.max(minHeight, contentHeight);
            
            if (targetHeight > maxHeight) {
                generatedContainer.style.height = maxHeight + 'px';
                generatedContainer.style.overflowY = 'auto';
            } else {
                generatedContainer.style.height = targetHeight + 'px';
                generatedContainer.style.overflowY = 'hidden';
            }
            
            generatedContainer.style.minHeight = minHeight + 'px';
        }

        // æ›´æ–°å­—æ•°ç»Ÿè®¡
        function updateCharCount() {
            const generatedContainer = document.getElementById('generatedContainer');
            const charCountElement = document.getElementById('charCount');
            
            if (!generatedContainer || !charCountElement) return;
            
            const text = generatedContainer.textContent || generatedContainer.innerText || '';
            
            // è¿‡æ»¤æ‰é»˜è®¤æç¤ºæ–‡æœ¬
            if (text.includes('ç‚¹å‡»"ç”Ÿæˆè¯æœ¯"æŒ‰é’®') || text.includes('AIæ­£åœ¨ä¸ºæ‚¨ç”Ÿæˆ')) {
                charCountElement.textContent = '0 å­—';
                return;
            }
            
            const charCount = text.trim().length;
            charCountElement.textContent = `${charCount} å­—`;
            
            // æ ¹æ®å­—æ•°æ·»åŠ é¢œè‰²æç¤º
            charCountElement.className = 'text-sm';
            if (charCount === 0) {
                charCountElement.className += ' text-gray-500';
            } else if (charCount < 100) {
                charCountElement.className += ' text-green-600';
            } else if (charCount < 500) {
                charCountElement.className += ' text-blue-600';
            } else {
                charCountElement.className += ' text-orange-600';
            }
        }

        // å¤åˆ¶ç”Ÿæˆçš„è¯æœ¯
        function copyGeneratedResult() {
            const generatedContainer = document.getElementById('generatedContainer');
            const text = generatedContainer.textContent || generatedContainer.innerText;
            
            if (text.trim() && !text.includes('ç‚¹å‡»"ç”Ÿæˆè¯æœ¯"æŒ‰é’®') && !text.includes('AIæ­£åœ¨ä¸ºæ‚¨ç”Ÿæˆ')) {
                navigator.clipboard.writeText(text.trim()).then(() => {
                    showNotification('å·²è‡ªåŠ¨å¤åˆ¶åˆ°å‰ªåˆ‡æ¿', 'success');
                    
                    // ä¿å­˜åˆ°å†å²è®°å½•
                    saveToHistory(text.trim());
                }).catch(err => {
                    console.error('å¤åˆ¶å¤±è´¥:', err);
                    showNotification('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶', 'error');
                });
            } else {
                showNotification('æ²¡æœ‰ç”Ÿæˆçš„è¯æœ¯å¯å¤åˆ¶', 'warning');
            }
        }

        // é‡ç½®é€‰æ‹©
        function resetSelection() {
            selection = {
                greeting: [],
                strength: [],
                issue: [],
                closing: []
            };
            
            renderAllContent();
            updateResult();
            showNotification('å·²é‡ç½®é€‰æ‹©', 'info');
        }

        // ä¿å­˜åˆ°å†å²è®°å½•
        function saveToHistory(text) {
            const timestamp = new Date().toLocaleString();
            const historyItem = {
                id: 'h' + Date.now(),
                text: text,
                timestamp: timestamp,
                selection: JSON.parse(JSON.stringify(selection)) // æ·±æ‹·è´å½“å‰é€‰æ‹©
            };
            
            // æ·»åŠ åˆ°å†å²è®°å½•æ•°ç»„å¼€å¤´
            historyRecords.unshift(historyItem);
            
            // é™åˆ¶å†å²è®°å½•æ•°é‡
            if (historyRecords.length > MAX_HISTORY_RECORDS) {
                historyRecords = historyRecords.slice(0, MAX_HISTORY_RECORDS);
            }
            
            // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
            saveHistoryRecords();
            
            // é‡æ–°æ¸²æŸ“å†å²è®°å½•
            renderHistoryRecords();
        }

        // ä¿å­˜å†å²è®°å½•åˆ°æœ¬åœ°å­˜å‚¨
        function saveHistoryRecords() {
            try {
                localStorage.setItem('historyRecords', JSON.stringify(historyRecords));
            } catch (e) {
                console.error('ä¿å­˜å†å²è®°å½•å¤±è´¥:', e);
            }
        }

        // ä»æœ¬åœ°å­˜å‚¨åŠ è½½å†å²è®°å½•
        function loadHistoryRecords() {
            try {
                const saved = localStorage.getItem('historyRecords');
                if (saved) {
                    historyRecords = JSON.parse(saved);
                }
            } catch (e) {
                console.error('åŠ è½½å†å²è®°å½•å¤±è´¥:', e);
                historyRecords = [];
            }
        }

        // æ¸²æŸ“å†å²è®°å½•
        function renderHistoryRecords() {
            const container = document.getElementById('historyContainer');
            if (!container) return;

            container.innerHTML = '';
            
            if (historyRecords.length === 0) {
                container.innerHTML = '<div class="text-neutral italic text-center col-span-full py-4">æš‚æ— å†å²è®°å½•</div>';
                return;
            }

            historyRecords.forEach(record => {
                const div = document.createElement('div');
                div.className = 'p-4 border border-gray-200 rounded-lg hover:border-primary transition-colors cursor-pointer';
                
                const preview = record.text.length > 100 ? record.text.substring(0, 100) + '...' : record.text;
                
                div.innerHTML = `
                    <div class="text-sm mb-2">${preview}</div>
                    <div class="text-xs text-neutral mb-2">${record.timestamp}</div>
                    <div class="flex gap-2">
                        <button class="restore-btn text-xs text-primary hover:text-primary/80" data-id="${record.id}">
                            <i class="fa fa-undo"></i> æ¢å¤é€‰æ‹©
                        </button>
                        <button class="copy-history-btn text-xs text-secondary hover:text-secondary/80" data-id="${record.id}">
                            <i class="fa fa-copy"></i> å¤åˆ¶
                        </button>
                        <button class="delete-history-btn text-xs text-red-500 hover:text-red-700" data-id="${record.id}">
                            <i class="fa fa-trash"></i> åˆ é™¤
                        </button>
                    </div>
                `;
                
                // æ¢å¤é€‰æ‹©æŒ‰é’®
                div.querySelector('.restore-btn').addEventListener('click', function(e) {
                    e.stopPropagation();
                    restoreSelection(record.id);
                });
                
                // å¤åˆ¶æŒ‰é’®
                div.querySelector('.copy-history-btn').addEventListener('click', function(e) {
                    e.stopPropagation();
                    copyHistoryItem(record.id);
                });
                
                // åˆ é™¤æŒ‰é’®
                div.querySelector('.delete-history-btn').addEventListener('click', function(e) {
                    e.stopPropagation();
                    deleteHistoryItem(record.id);
                });
                
                container.appendChild(div);
            });
        }

        // æ¢å¤å†å²é€‰æ‹©
        function restoreSelection(historyId) {
            const record = historyRecords.find(r => r.id === historyId);
            if (record && record.selection) {
                selection = JSON.parse(JSON.stringify(record.selection));
                renderAllContent();
                updateResult();
                showNotification('å·²æ¢å¤å†å²é€‰æ‹©', 'success');
            }
        }

        // å¤åˆ¶å†å²é¡¹ç›®
        function copyHistoryItem(historyId) {
            const record = historyRecords.find(r => r.id === historyId);
            if (record) {
                navigator.clipboard.writeText(record.text).then(() => {
                    showNotification('å¤åˆ¶æˆåŠŸï¼', 'success');
                }).catch(err => {
                    console.error('å¤åˆ¶å¤±è´¥:', err);
                    showNotification('å¤åˆ¶å¤±è´¥', 'error');
                });
            }
        }

        // åˆ é™¤å†å²é¡¹ç›®
        async function deleteHistoryItem(historyId) {
            const confirmed = await showCustomConfirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡å†å²è®°å½•å—ï¼Ÿ');
            if (confirmed) {
                historyRecords = historyRecords.filter(r => r.id !== historyId);
                saveHistoryRecords();
                renderHistoryRecords();
                showNotification('å·²åˆ é™¤å†å²è®°å½•', 'info');
            }
        }

        // æ˜¾ç¤ºé€šçŸ¥
        function showNotification(message, type = 'info') {
            // åˆ›å»ºé€šçŸ¥å…ƒç´ 
            const notification = document.createElement('div');
            notification.className = `fixed bottom-4 left-1/2 transform -translate-x-1/2 px-6 py-3 rounded-lg shadow-lg z-50 transition-all duration-300 translate-y-full text-lg min-w-64`;
            
            // æ ¹æ®ç±»å‹è®¾ç½®æ ·å¼
            switch (type) {
                case 'success':
                    notification.classList.add('bg-green-500', 'text-white');
                    break;
                case 'error':
                    notification.classList.add('bg-red-500', 'text-white');
                    break;
                case 'warning':
                    notification.classList.add('bg-yellow-500', 'text-white');
                    break;
                default:
                    notification.classList.add('bg-blue-500', 'text-white');
            }
            
            notification.textContent = message;
            document.body.appendChild(notification);
            
            // æ˜¾ç¤ºåŠ¨ç”»
            setTimeout(() => {
                notification.classList.remove('translate-y-full');
            }, 100);
            
            // è‡ªåŠ¨éšè—
            setTimeout(() => {
                notification.classList.add('translate-y-full');
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }

        // æ·»åŠ æ–°é¡¹ç›®
        function addNewItem(type) {
            // åˆ›å»ºæ–°é¡¹ç›®å¯¹è¯æ¡†
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-40';
            modal.innerHTML = `
                <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
                    <h3 class="text-lg font-medium mb-4">æ·»åŠ æ–°é€‰é¡¹</h3>
                    <div class="mb-4">
                        <label class="block text-sm font-medium mb-2">é€‰é¡¹æ ‡é¢˜ï¼š</label>
                        <input type="text" id="newTitle" class="w-full p-2 border rounded" placeholder="è¯·è¾“å…¥é€‰é¡¹æ ‡é¢˜">
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium mb-2">äºŒçº§é€‰é¡¹ï¼š</label>
                        <div id="newSubOptionsContainer" class="space-y-2">
                        </div>
                        <button type="button" id="addNewSubOption" class="mt-2 text-blue-500 hover:text-blue-700 text-sm">+ æ·»åŠ äºŒçº§é€‰é¡¹</button>
                    </div>
                    <div class="flex gap-2 justify-end">
                        <button type="button" id="cancelNew" class="px-4 py-2 text-gray-600 hover:text-gray-800">å–æ¶ˆ</button>
                        <button type="button" id="saveNew" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">ä¿å­˜</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // æ·»åŠ äºŒçº§é€‰é¡¹åŠŸèƒ½
            document.getElementById('addNewSubOption').addEventListener('click', function() {
                const container = document.getElementById('newSubOptionsContainer');
                const div = document.createElement('div');
                div.className = 'border rounded p-3 bg-gray-50';
                div.innerHTML = `
                    <div class="flex gap-2 mb-2">
                        <input type="text" class="flex-1 p-2 border rounded new-sub-option" placeholder="äºŒçº§é€‰é¡¹å†…å®¹">
                        <button type="button" class="text-red-500 hover:text-red-700 px-2" onclick="this.parentElement.parentElement.remove()">åˆ é™¤</button>
                    </div>
                    <div class="mt-2">
                        <button type="button" class="text-sm text-blue-600 hover:text-blue-800 toggle-tag-form" onclick="toggleTagForm(this)">
                            <span class="toggle-text">+ æ·»åŠ æ ‡ç­¾</span>
                        </button>
                        <div class="tag-form mt-2" style="display: none;">
                            <div class="flex gap-2">
                                <input type="text" class="flex-1 p-2 border rounded new-sub-option-tag" placeholder="æ ‡ç­¾åç§°" >
                                <button type="button" class="px-3 py-2 bg-green-500 text-white rounded hover:bg-green-600 text-sm confirm-tag" onclick="confirmTag(this)">ç¡®è®¤</button>
                            </div>
                        </div>
                    </div>
                `;
                container.appendChild(div);
            });
            
            // å–æ¶ˆæŒ‰é’®
            document.getElementById('cancelNew').addEventListener('click', function() {
                document.body.removeChild(modal);
            });
            
            // ä¿å­˜æŒ‰é’®
            document.getElementById('saveNew').addEventListener('click', function() {
                const title = document.getElementById('newTitle').value.trim();
                const subOptionContainers = document.querySelectorAll('#newSubOptionsContainer > div');
                const subOptions = [];
                
                if (title) {
                    const newItem = {
                        id: type.charAt(0) + Date.now(),
                        text: title,
                        subOptions: subOptions
                    };
                    
                    // å¤„ç†äºŒçº§é€‰é¡¹å’Œæ ‡ç­¾
                    subOptionContainers.forEach((container, index) => {
                        const subOptionInput = container.querySelector('.new-sub-option');
                        const tagInput = container.querySelector('.new-sub-option-tag');
                        const confirmButton = container.querySelector('.tag-form button');
                        
                        if (subOptionInput && subOptionInput.value.trim()) {
                            const subOptionText = subOptionInput.value.trim();
                            const tagText = tagInput ? tagInput.value.trim() : '';
                            
                            subOptions.push(subOptionText);
                            
                            // ä¿å­˜æ ‡ç­¾ï¼ˆå¦‚æœæœ‰ï¼‰
                            if (tagText) {
                                setSubOptionTag(newItem.id, index, tagText);
                                
                                // ä¿å­˜æ ‡ç­¾é¢œè‰²ï¼ˆä»ç¡®è®¤æŒ‰é’®çš„æ•°æ®å±æ€§ä¸­è·å–ï¼‰
                                const tagColor = confirmButton ? confirmButton.getAttribute('data-tag-color') : null;
                                if (tagColor) {
                                    setSubOptionTagColor(newItem.id, index, tagColor);
                                }
                            }
                        }
                    });
                    
                    appData[type].push(newItem);
                    saveAppData();
                    renderContent(type);
                    showNotification('æ·»åŠ æˆåŠŸï¼', 'success');
                    document.body.removeChild(modal);
                } else {
                    showCustomAlert('è¯·è¾“å…¥é€‰é¡¹æ ‡é¢˜');
                }
            });
            
            // ç‚¹å‡»èƒŒæ™¯å…³é—­
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    document.body.removeChild(modal);
                }
            });
            
            // è‡ªåŠ¨èšç„¦åˆ°æ ‡é¢˜è¾“å…¥æ¡†
            setTimeout(() => {
                document.getElementById('newTitle').focus();
            }, 100);
        }

        // ç¼–è¾‘é¡¹ç›®
        function editItem(id, type) {
            const item = contentIndex[type][id];
            if (!item) return;
            
            // åˆ›å»ºç¼–è¾‘å¯¹è¯æ¡†
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-40';
            modal.innerHTML = `
                <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
                    <h3 class="text-lg font-medium mb-4">ç¼–è¾‘é€‰é¡¹</h3>
                    <div class="mb-4">
                        <label class="block text-sm font-medium mb-2">é€‰é¡¹æ ‡é¢˜ï¼š</label>
                        <input type="text" id="editTitle" class="w-full p-2 border rounded" value="${item.text}">
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium mb-2">äºŒçº§é€‰é¡¹ï¼š</label>
                        <div id="subOptionsContainer" class="space-y-2">
                            ${(item.subOptions || []).map((sub, index) => {
                                const tag = getSubOptionTag(item.id, index);
                                const tagColor = getSubOptionTagColor(item.id, index);
                                const hasTag = tag && tag.trim();
                                return `
                                <div class="border rounded p-3 bg-gray-50" data-sub-index="${index}">
                                    <div class="flex gap-2 mb-2">
                                        ${hasTag ? `<div class="flex items-center px-2 py-1 rounded text-white text-sm" style="background-color: ${tagColor}; min-width: fit-content;">${tag}</div>` : ''}
                                        <input type="text" class="flex-1 p-2 border rounded sub-option" value="${sub}" placeholder="äºŒçº§é€‰é¡¹å†…å®¹">
                                        <button type="button" class="text-red-500 hover:text-red-700 px-2" onclick="this.parentElement.parentElement.remove()">åˆ é™¤</button>
                                    </div>
                                    <div class="mt-2 flex items-center gap-2">
                                        <button type="button" class="text-sm text-blue-600 hover:text-blue-800 toggle-tag-form" onclick="toggleTagForm(this)">
                                            <span class="toggle-text">${hasTag ? 'ä¿®æ”¹æ ‡ç­¾' : '+ æ·»åŠ æ ‡ç­¾'}</span>
                                        </button>
                                        ${hasTag ? `
                                        <div class="flex gap-1">
                                            ${defaultTagColors.map(color => `
                                                <div class="w-6 h-6 rounded border-2 cursor-pointer hover:scale-110 transition-transform ${tagColor === color ? 'border-gray-800' : 'border-gray-300'}" 
                                                     style="background-color: ${color}" 
                                                     onclick="changeTagColor('${item.id}', ${index}, '${color}', this)"
                                                     title="ç‚¹å‡»åˆ‡æ¢é¢œè‰²">
                                                </div>
                                            `).join('')}
                                        </div>` : ''}
                                        <div class="tag-form mt-2" style="display: none;">
                                            <div class="flex gap-2">
                                                <input type="text" class="flex-1 p-2 border rounded sub-option-tag" value="${tag || ''}" placeholder="æ ‡ç­¾åç§°" >
                                                <button type="button" class="px-3 py-2 bg-green-500 text-white rounded hover:bg-green-600 text-sm confirm-tag" onclick="confirmTag(this)">ç¡®è®¤</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `}).join('')}
                        </div>
                        <button type="button" id="addSubOption" class="mt-2 text-blue-500 hover:text-blue-700 text-sm">+ æ·»åŠ äºŒçº§é€‰é¡¹</button>
                    </div>
                    <div class="flex gap-2 justify-end">
                        <button type="button" id="cancelEdit" class="px-4 py-2 text-gray-600 hover:text-gray-800">å–æ¶ˆ</button>
                        <button type="button" id="deleteItem" class="px-4 py-2 bg-red-500 text-white rounded hover:bg-red-600">åˆ é™¤</button>
                        <button type="button" id="saveEdit" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">ä¿å­˜</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // æ·»åŠ äºŒçº§é€‰é¡¹åŠŸèƒ½
            document.getElementById('addSubOption').addEventListener('click', function() {
                const container = document.getElementById('subOptionsContainer');
                const div = document.createElement('div');
                div.className = 'border rounded p-3 bg-gray-50';
                div.setAttribute('data-sub-index', 'new');
                div.innerHTML = `
                    <div class="flex gap-2 mb-2">
                        <input type="text" class="flex-1 p-2 border rounded sub-option" placeholder="äºŒçº§é€‰é¡¹å†…å®¹">
                        <button type="button" class="text-red-500 hover:text-red-700 px-2" onclick="this.parentElement.parentElement.remove()">åˆ é™¤</button>
                    </div>
                    <div class="mt-2">
                        <button type="button" class="text-sm text-blue-600 hover:text-blue-800 toggle-tag-form" onclick="toggleTagForm(this)">
                            <span class="toggle-text">+ æ·»åŠ æ ‡ç­¾</span>
                        </button>
                        <div class="tag-form mt-2" style="display: none;">
                            <div class="flex gap-2">
                                <input type="text" class="flex-1 p-2 border rounded sub-option-tag" placeholder="æ ‡ç­¾åç§°">
                                <button type="button" class="px-3 py-2 bg-green-500 text-white rounded hover:bg-green-600 text-sm confirm-tag" onclick="confirmTag(this)">ç¡®è®¤</button>
                            </div>
                        </div>
                    </div>
                `;
                container.appendChild(div);
            });
            
            // å–æ¶ˆæŒ‰é’®
            document.getElementById('cancelEdit').addEventListener('click', function() {
                document.body.removeChild(modal);
            });
            
            // åˆ é™¤æŒ‰é’®
            document.getElementById('deleteItem').addEventListener('click', async function() {
                const confirmed = await showCustomConfirm('ç¡®å®šè¦åˆ é™¤æ­¤é¡¹ç›®å—ï¼Ÿ');
                if (confirmed) {
                    deleteItem(id, type);
                    document.body.removeChild(modal);
                }
            });
            
            // ä¿å­˜æŒ‰é’®
            document.getElementById('saveEdit').addEventListener('click', function() {
                const title = document.getElementById('editTitle').value.trim();
                const subOptionContainers = document.querySelectorAll('#subOptionsContainer > div');
                const subOptions = [];
                
                // æ¸…é™¤è¯¥é¡¹ç›®çš„æ‰€æœ‰æ ‡ç­¾
                if (subOptionTags[item.id]) {
                    delete subOptionTags[item.id];
                }
                
                subOptionContainers.forEach((container, newIndex) => {
                    const subOptionInput = container.querySelector('.sub-option');
                    const tagInput = container.querySelector('.sub-option-tag');
                    const confirmButton = container.querySelector('.tag-form button');
                    
                    if (subOptionInput && subOptionInput.value.trim()) {
                        const subOptionText = subOptionInput.value.trim();
                        const tagText = tagInput ? tagInput.value.trim() : '';
                        
                        subOptions.push(subOptionText);
                        
                        // ä¿å­˜æ ‡ç­¾ï¼ˆå¦‚æœæœ‰ï¼‰
                        if (tagText) {
                            setSubOptionTag(item.id, newIndex, tagText);
                            
                            // ä¿å­˜æ ‡ç­¾é¢œè‰²ï¼ˆä»ç¡®è®¤æŒ‰é’®çš„æ•°æ®å±æ€§ä¸­è·å–ï¼‰
                            const tagColor = confirmButton ? confirmButton.getAttribute('data-tag-color') : null;
                            if (tagColor) {
                                setSubOptionTagColor(item.id, newIndex, tagColor);
                            }
                        }
                    }
                });
                
                if (title) {
                    // è·å–æ—§çš„ä¸€çº§é€‰é¡¹åç§°ç”¨äºåŒæ­¥
                    const oldText = item.text;
                    
                    item.text = title;
                    item.subOptions = subOptions;
                    
                    // å¦‚æœä¸€çº§é€‰é¡¹åç§°å‘ç”Ÿå˜æ›´ï¼Œéœ€è¦åŒæ­¥æ›´æ–°æ ‡ç­¾
                    if (oldText !== title) {
                        // æ£€æŸ¥æ˜¯å¦æœ‰ä¸€çº§é€‰é¡¹æ ‡ç­¾éœ€è¦æ›´æ–°
                        const primaryTag = getPrimaryOptionTag(item.id);
                        if (primaryTag === oldText) {
                            // æ›´æ–°ä¸€çº§é€‰é¡¹æ ‡ç­¾ä¸ºæ–°åç§°
                            setPrimaryOptionTag(item.id, title);
                            // åŒæ­¥æ›´æ–°æ”¶è—è¯æœ¯ä¸­çš„ä¸€çº§é€‰é¡¹æ ‡ç­¾
                            syncFavoriteScriptPrimaryTags(item.id, oldText, title);
                        }
                    }
                    
                    saveAppData();
                    renderContent(type);
                    updateResult();
                    showNotification('ä¿®æ”¹æˆåŠŸï¼', 'success');
                    document.body.removeChild(modal);
                } else {
                    showCustomAlert('è¯·è¾“å…¥é€‰é¡¹æ ‡é¢˜');
                }
            });
            
            // ç‚¹å‡»èƒŒæ™¯å…³é—­
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    document.body.removeChild(modal);
                }
            });
        }

        // åˆ é™¤é¡¹ç›®
        function deleteItem(id, type) {
            const index = appData[type].findIndex(item => item.id === id);
            if (index > -1) {
                appData[type].splice(index, 1);
                
                // å¦‚æœåˆ é™¤çš„é¡¹ç›®è¢«é€‰ä¸­ï¼Œåˆ™å–æ¶ˆé€‰æ‹©
                const selectionIndex = selection[type].findIndex(item => item.id === id);
                if (selectionIndex > -1) {
                    selection[type].splice(selectionIndex, 1);
                }
                
                saveAppData();
                renderContent(type);
                updateResult();
                showNotification('åˆ é™¤æˆåŠŸï¼', 'success');
            }
        }

        // é‡æ–°æ’åºé¡¹ç›®
        function reorderItems(draggedId, targetId, type) {
            const items = appData[type];
            const draggedIndex = items.findIndex(item => item.id === draggedId);
            const targetIndex = items.findIndex(item => item.id === targetId);
            
            if (draggedIndex > -1 && targetIndex > -1 && draggedIndex !== targetIndex) {
                const draggedItem = items.splice(draggedIndex, 1)[0];
                items.splice(targetIndex, 0, draggedItem);
                
                saveAppData();
                renderContent(type);
                showNotification('æ’åºå·²æ›´æ–°', 'info');
            }
        }

        // åˆå§‹åŒ–æ‹–æ‹½åŠŸèƒ½
        function initializeDragAndDrop() {
            // è¿™ä¸ªå‡½æ•°å¯ä»¥ç”¨æ¥åˆå§‹åŒ–æ›´å¤æ‚çš„æ‹–æ‹½åŠŸèƒ½
            // ç›®å‰åŸºæœ¬çš„æ‹–æ‹½åŠŸèƒ½å·²ç»åœ¨createItemElementä¸­å®ç°
        }

        // æ”¶è—è¯æœ¯æ•°ç»„
        let favoriteScripts = [];
        
        // æ™ºèƒ½ç­›é€‰æ¨¡å¼çŠ¶æ€
        let isSmartFilterMode = true;
        
        // æœ€è¿‘ä½¿ç”¨æ¨¡å¼çŠ¶æ€
        let isRecentUsedMode = false;
        
        // æ”¶è—è¯æœ¯ä½¿ç”¨è®°å½•ï¼ˆå­˜å‚¨å¤åˆ¶æ—¶é—´ï¼‰
        let scriptUsageRecords = JSON.parse(localStorage.getItem('scriptUsageRecords') || '{}');
        
        // åˆ‡æ¢æ™ºèƒ½ç­›é€‰æ¨¡å¼
        function toggleSmartFilterMode() {
            isSmartFilterMode = !isSmartFilterMode;
            
            // å¦‚æœå¼€å¯æ™ºèƒ½ç­›é€‰æ¨¡å¼ï¼Œå…³é—­å…¶ä»–æ¨¡å¼
            if (isSmartFilterMode) {
                isRecentUsedMode = false;
                const tagFilter = document.getElementById('tagFilter');
                if (tagFilter) {
                    tagFilter.value = '';
                }
            }
            
            // é‡æ–°æ¸²æŸ“æ”¶è—è¯æœ¯
            renderFavoriteScripts();
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            updateQuickButtonState();
        }
        
        // åˆ‡æ¢æœ€è¿‘ä½¿ç”¨æ¨¡å¼
        function toggleRecentUsedMode() {
            isRecentUsedMode = !isRecentUsedMode;
            
            // å¦‚æœå¼€å¯æœ€è¿‘ä½¿ç”¨æ¨¡å¼ï¼Œå…³é—­å…¶ä»–æ¨¡å¼
            if (isRecentUsedMode) {
                isSmartFilterMode = false;
                const tagFilter = document.getElementById('tagFilter');
                if (tagFilter) {
                    tagFilter.value = '';
                }
            }
            
            // é‡æ–°æ¸²æŸ“æ”¶è—è¯æœ¯
            renderFavoriteScripts();
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            updateQuickButtonState();
        }
        
        // è®°å½•æ”¶è—è¯æœ¯çš„ä½¿ç”¨æ—¶é—´
        function recordScriptUsage(scriptId) {
            scriptUsageRecords[scriptId] = Date.now();
            localStorage.setItem('scriptUsageRecords', JSON.stringify(scriptUsageRecords));
        }
        
        // æœ€è¿‘ä½¿ç”¨ç­›é€‰å‡½æ•°ï¼šæ ¹æ®ä½¿ç”¨æ—¶é—´é™åºæ’åˆ—æ”¶è—è¯æœ¯
        function getRecentUsedScripts() {
            if (!isRecentUsedMode) {
                return favoriteScripts;
            }
            
            // è·å–æœ‰ä½¿ç”¨è®°å½•çš„æ”¶è—è¯æœ¯
            const scriptsWithUsage = favoriteScripts.filter(script => {
                return scriptUsageRecords[script.id];
            });
            
            // æŒ‰ä½¿ç”¨æ—¶é—´é™åºæ’åºï¼ˆæœ€è¿‘ä½¿ç”¨çš„åœ¨å‰é¢ï¼‰
            scriptsWithUsage.sort((a, b) => {
                const timeA = scriptUsageRecords[a.id] || 0;
                const timeB = scriptUsageRecords[b.id] || 0;
                return timeB - timeA; // é™åºæ’åˆ—
            });
            
            return scriptsWithUsage;
        }
        
        // æ™ºèƒ½ç­›é€‰å‡½æ•°ï¼šæ ¹æ®å½“å‰é€‰æ‹©é¢æ¿çš„å·²é€‰é¡¹ç­›é€‰æ”¶è—è¯æœ¯
        function getSmartFilteredScripts() {
            if (!isSmartFilterMode) {
                return favoriteScripts;
            }
            
            // è·å–å½“å‰é€‰æ‹©é¢æ¿ä¸­çš„å·²é€‰é¡¹
            const currentSelections = {
                greeting: selection.greeting || [],
                strength: selection.strength || [],
                issue: selection.issue || [],
                closing: selection.closing || []
            };
            
            // æ£€æŸ¥æ˜¯å¦æœ‰ä»»ä½•é€‰æ‹©
            const hasAnySelection = Object.values(currentSelections).some(arr => arr.length > 0);
            if (!hasAnySelection) {
                return favoriteScripts; // å¦‚æœæ²¡æœ‰é€‰æ‹©ä»»ä½•é¡¹ï¼Œæ˜¾ç¤ºæ‰€æœ‰æ”¶è—
            }
            
            // ç­›é€‰åŒ¹é…çš„æ”¶è—è¯æœ¯
            return favoriteScripts.filter(script => {
                if (!script.tags || script.tags.length === 0) {
                    return false; // æ²¡æœ‰æ ‡ç­¾çš„è¯æœ¯ä¸åŒ¹é…
                }
                
                // æ”¶é›†æ‰€æœ‰é€‰ä¸­çš„ç­›é€‰æ¡ä»¶
                const allSelectedConditions = [];
                Object.entries(currentSelections).forEach(([type, selections]) => {
                    selections.forEach(selection => {
                        if (selection.subOptions && selection.subOptions.length > 0) {
                            // å¦‚æœæœ‰äºŒçº§é€‰é¡¹ï¼Œåªæ·»åŠ äºŒçº§é€‰é¡¹çš„ç»„åˆID
                            selection.subOptions.forEach(subIndex => {
                                allSelectedConditions.push(`${selection.id}-${subIndex}`);
                            });
                        } else {
                            // å¦‚æœæ²¡æœ‰äºŒçº§é€‰é¡¹ï¼Œæ·»åŠ ä¸€çº§é€‰é¡¹ID
                            allSelectedConditions.push(selection.id);
                        }
                    });
                });
                
                if (allSelectedConditions.length === 0) {
                    return true; // å¦‚æœæ²¡æœ‰é€‰æ‹©ä»»ä½•é¡¹ï¼Œæ˜¾ç¤ºæ‰€æœ‰æ”¶è—
                }
                
                // æ£€æŸ¥æ”¶è—è¯æœ¯æ˜¯å¦åŒæ—¶æ»¡è¶³æ‰€æœ‰é€‰ä¸­çš„ç­›é€‰æ¡ä»¶ï¼ˆANDé€»è¾‘ï¼‰
                return allSelectedConditions.every(condition => {
                    return script.tags.some(tag => {
                        if (tag.type === 'sub') {
                            // äºŒçº§é€‰é¡¹æ ‡ç­¾ï¼ŒåŒ¹é…æ ¼å¼ï¼šitemId-subIndex
                            const tagId = `${tag.itemId}-${tag.subIndex}`;
                            return tagId === condition;
                        } else {
                            // ä¸€çº§é€‰é¡¹æ ‡ç­¾ï¼Œç›´æ¥åŒ¹é…itemId
                            return tag.itemId === condition;
                        }
                    });
                });
            });
        }
        
        // æ”¶è—å¤¹ç›¸å…³å‡½æ•°å·²ç§»é™¤
        
        // æ”¶è—å½“å‰è¯æœ¯
        async function saveCurrentFavorite() {
            // æ£€æŸ¥æ˜¯å¦æœ‰é€‰æ‹©å†…å®¹
            const hasSelection = selection.greeting.length > 0 || 
                                selection.strength.length > 0 || 
                                selection.issue.length > 0 || 
                                selection.closing.length > 0;
            
            if (!hasSelection) {
                showNotification('è¯·å…ˆé€‰æ‹©ä¸€äº›å†…å®¹å†æ”¶è—è¯æœ¯', 'warning');
                return;
            }
            
            // è·å–å½“å‰ç”Ÿæˆçš„è¯æœ¯æ–‡æœ¬
            const generatedContainer = document.getElementById('generatedContainer');
            const generatedText = generatedContainer.textContent || generatedContainer.innerText || '';
            
            // æ£€æŸ¥æ˜¯å¦æœ‰ç”Ÿæˆçš„è¯æœ¯
            if (!generatedText.trim() || generatedText.includes('ç‚¹å‡»"ç”Ÿæˆè¯æœ¯"æŒ‰é’®') || generatedText.includes('AIæ­£åœ¨ä¸ºæ‚¨ç”Ÿæˆ')) {
                showNotification('è¯·å…ˆç”Ÿæˆè¯æœ¯å†è¿›è¡Œæ”¶è—', 'warning');
                return;
            }
            
            // è¯¢é—®ç”¨æˆ·æ˜¯å¦è¦ä¸ºè¯æœ¯è®¾ç½®åç§°
            const scriptName = await showCustomPrompt('ä¸ºæ”¶è—çš„è¯æœ¯è®¾ç½®åç§°ï¼ˆå¯ç•™ç©ºï¼‰ï¼š', '');
            if (scriptName !== null) {
                // æ„å»ºæ ‡ç­¾æ•°æ® - ä»é€‰ä¸­çš„äºŒçº§é€‰é¡¹å’Œä¸€çº§é€‰é¡¹ä¸­æå–æ ‡ç­¾ä¿¡æ¯
                const tags = [];
                
                // å¤„ç†greetingç±»å‹çš„æ ‡ç­¾
                selection.greeting.forEach(item => {
                    if (item.subOptions && item.subOptions.length > 0) {
                        // æœ‰äºŒçº§é€‰é¡¹æ—¶ï¼Œæ”¶é›†äºŒçº§é€‰é¡¹æ ‡ç­¾
                        item.subOptions.forEach(subIndex => {
                            const tag = getSubOptionTag(item.id, subIndex);
                            const color = getSubOptionTagColor(item.id, subIndex);
                            if (tag) {
                                tags.push({ name: tag, color: color, itemId: item.id, subIndex: subIndex, type: 'sub' });
                            }
                        });
                    } else {
                        // æ— äºŒçº§é€‰é¡¹æ—¶ï¼Œæ”¶é›†ä¸€çº§é€‰é¡¹æ ‡ç­¾
                        const tag = getPrimaryOptionTag(item.id);
                        const color = getPrimaryOptionTagColor(item.id);
                        if (tag) {
                            tags.push({ name: tag, color: color, itemId: item.id, type: 'primary' });
                        }
                    }
                });
                
                // å¤„ç†strengthç±»å‹çš„æ ‡ç­¾
                selection.strength.forEach(item => {
                    if (item.subOptions && item.subOptions.length > 0) {
                        // æœ‰äºŒçº§é€‰é¡¹æ—¶ï¼Œæ”¶é›†äºŒçº§é€‰é¡¹æ ‡ç­¾
                        item.subOptions.forEach(subIndex => {
                            const tag = getSubOptionTag(item.id, subIndex);
                            const color = getSubOptionTagColor(item.id, subIndex);
                            if (tag) {
                                tags.push({ name: tag, color: color, itemId: item.id, subIndex: subIndex, type: 'sub' });
                            }
                        });
                    } else {
                        // æ— äºŒçº§é€‰é¡¹æ—¶ï¼Œæ”¶é›†ä¸€çº§é€‰é¡¹æ ‡ç­¾
                        const tag = getPrimaryOptionTag(item.id);
                        const color = getPrimaryOptionTagColor(item.id);
                        if (tag) {
                            tags.push({ name: tag, color: color, itemId: item.id, type: 'primary' });
                        }
                    }
                });
                
                // å¤„ç†issueç±»å‹çš„æ ‡ç­¾
                selection.issue.forEach(item => {
                    if (item.subOptions && item.subOptions.length > 0) {
                        // æœ‰äºŒçº§é€‰é¡¹æ—¶ï¼Œæ”¶é›†äºŒçº§é€‰é¡¹æ ‡ç­¾
                        item.subOptions.forEach(subIndex => {
                            const tag = getSubOptionTag(item.id, subIndex);
                            const color = getSubOptionTagColor(item.id, subIndex);
                            if (tag) {
                                tags.push({ name: tag, color: color, itemId: item.id, subIndex: subIndex, type: 'sub' });
                            }
                        });
                    } else {
                        // æ— äºŒçº§é€‰é¡¹æ—¶ï¼Œæ”¶é›†ä¸€çº§é€‰é¡¹æ ‡ç­¾
                        const tag = getPrimaryOptionTag(item.id);
                        const color = getPrimaryOptionTagColor(item.id);
                        if (tag) {
                            tags.push({ name: tag, color: color, itemId: item.id, type: 'primary' });
                        }
                    }
                });
                
                // å¤„ç†closingç±»å‹çš„æ ‡ç­¾
                if (selection.closing.id) {
                    if (selection.closing.subOptions.length > 0) {
                        // æœ‰äºŒçº§é€‰é¡¹æ—¶ï¼Œæ”¶é›†äºŒçº§é€‰é¡¹æ ‡ç­¾
                        selection.closing.subOptions.forEach(subIndex => {
                            const tag = getSubOptionTag(selection.closing.id, subIndex);
                            const color = getSubOptionTagColor(selection.closing.id, subIndex);
                            if (tag) {
                                tags.push({ name: tag, color: color, itemId: selection.closing.id, subIndex: subIndex, type: 'sub' });
                            }
                        });
                    } else {
                        // æ— äºŒçº§é€‰é¡¹æ—¶ï¼Œæ”¶é›†ä¸€çº§é€‰é¡¹æ ‡ç­¾
                        const tag = getPrimaryOptionTag(selection.closing.id);
                        const color = getPrimaryOptionTagColor(selection.closing.id);
                        if (tag) {
                            tags.push({ name: tag, color: color, itemId: selection.closing.id, type: 'primary' });
                        }
                    }
                }
                
                const favoriteScript = {
                    id: 'fs' + Date.now(),
                    name: scriptName.trim() || '',
                    generatedText: generatedText.trim(),
                    selection: JSON.parse(JSON.stringify(selection)),
                    tags: tags,
                    createdAt: new Date().toLocaleString()
                };
                
                favoriteScripts.push(favoriteScript);
                saveFavoriteScripts();
                renderFavoriteScripts();
                
                showNotification('è¯æœ¯æ”¶è—æˆåŠŸï¼', 'success');
            }
        }

        // ä¿å­˜æ”¶è—è¯æœ¯åˆ°æœ¬åœ°å­˜å‚¨
        function saveFavoriteScripts() {
            try {
                localStorage.setItem('favoriteScripts', JSON.stringify(favoriteScripts));
            } catch (e) {
                console.error('ä¿å­˜æ”¶è—è¯æœ¯å¤±è´¥:', e);
            }
        }
        
        // ä»æœ¬åœ°å­˜å‚¨åŠ è½½æ”¶è—è¯æœ¯
        function loadFavoriteScripts() {
            try {
                const saved = localStorage.getItem('favoriteScripts');
                if (saved) {
                    favoriteScripts = JSON.parse(saved);
                }
            } catch (e) {
                console.error('åŠ è½½æ”¶è—è¯æœ¯å¤±è´¥:', e);
                favoriteScripts = [];
            }
        }
        
        // æ›´æ–°æ ‡ç­¾ç­›é€‰é€‰é¡¹
        function updateTagFilterOptions() {
            const tagFilter = document.getElementById('tagFilter');
            if (!tagFilter) return;
            
            // æ”¶é›†æ‰€æœ‰æ ‡ç­¾
            const allTags = new Set();
            favoriteScripts.forEach(script => {
                if (script.tags) {
                    script.tags.forEach(tag => {
                        // è·å–æœ€æ–°çš„æ ‡ç­¾åç§°
                        let currentTagName;
                        if (tag.type === 'sub') {
                            currentTagName = getSubOptionTag(tag.itemId, tag.subIndex) || tag.name;
                        } else {
                            currentTagName = getPrimaryOptionTag(tag.itemId) || tag.name;
                        }
                        if (currentTagName) {
                            allTags.add(currentTagName);
                        }
                    });
                }
            });
            
            // ä¿å­˜å½“å‰é€‰æ‹©çš„å€¼
            const currentValue = tagFilter.value;
            
            // æ¸…ç©ºå¹¶é‡æ–°å¡«å……é€‰é¡¹
            tagFilter.innerHTML = '<option value="">é€‰æ‹©æ ‡ç­¾åˆ†ç±»</option>';
            Array.from(allTags).sort().forEach(tagName => {
                const option = document.createElement('option');
                option.value = tagName;
                option.textContent = tagName;
                tagFilter.appendChild(option);
            });
            
            // æ¢å¤ä¹‹å‰çš„é€‰æ‹©ï¼ˆå¦‚æœä»ç„¶å­˜åœ¨ï¼‰
            if (currentValue && allTags.has(currentValue)) {
                tagFilter.value = currentValue;
            }
        }
        
        // æ›´æ–°å¿«é€Ÿè®¿é—®æŒ‰é’®çŠ¶æ€
        function updateQuickButtonState() {
            const allTagsQuickBtn = document.getElementById('allTagsQuickBtn');
            const smartFilterBtn = document.getElementById('smartFilterBtn');
            const recentUsedBtn = document.getElementById('recentUsedBtn');
            const tagFilter = document.getElementById('tagFilter');
            
            if (!allTagsQuickBtn || !smartFilterBtn || !recentUsedBtn) return;
            
            // é‡ç½®æ‰€æœ‰æŒ‰é’®ä¸ºé»˜è®¤çŠ¶æ€
            [smartFilterBtn, recentUsedBtn, allTagsQuickBtn].forEach(btn => {
                btn.classList.remove('bg-gradient-to-r', 'from-purple-500', 'to-purple-600', 'from-green-500', 'to-green-600', 'from-blue-500', 'to-blue-600', 'text-white', 'shadow-md');
                btn.classList.add('bg-gray-100', 'text-gray-700', 'border', 'border-gray-200', 'hover:bg-gray-200');
            });
            
            // æ›´æ–°æ™ºèƒ½ç­›é€‰æŒ‰é’®çŠ¶æ€
            if (isSmartFilterMode) {
                smartFilterBtn.classList.remove('bg-gray-100', 'text-gray-700', 'border', 'border-gray-200', 'hover:bg-gray-200');
                smartFilterBtn.classList.add('bg-gradient-to-r', 'from-purple-500', 'to-purple-600', 'text-white', 'shadow-md');
            }
            
            // æ›´æ–°æœ€è¿‘ä½¿ç”¨æŒ‰é’®çŠ¶æ€
            if (isRecentUsedMode) {
                recentUsedBtn.classList.remove('bg-gray-100', 'text-gray-700', 'border', 'border-gray-200', 'hover:bg-gray-200');
                recentUsedBtn.classList.add('bg-gradient-to-r', 'from-green-500', 'to-green-600', 'text-white', 'shadow-md');
            }
            
            // æ›´æ–°æ‰€æœ‰æ ‡ç­¾æŒ‰é’®çŠ¶æ€ï¼ˆå½“å‰æ˜¯å¦é€‰æ‹©äº†"æ‰€æœ‰æ ‡ç­¾"ä¸”æœªå¼€å¯å…¶ä»–ç­›é€‰æ¨¡å¼ï¼‰
            const isAllTagsSelected = !isSmartFilterMode && !isRecentUsedMode && !tagFilter?.value;
            if (isAllTagsSelected) {
                allTagsQuickBtn.classList.remove('bg-gray-100', 'text-gray-700', 'border', 'border-gray-200', 'hover:bg-gray-200');
                allTagsQuickBtn.classList.add('bg-gradient-to-r', 'from-blue-500', 'to-blue-600', 'text-white', 'shadow-md');
            }
        }
        
        // æ¸²æŸ“æ”¶è—è¯æœ¯åˆ°å·¦ä¾§æ”¶è—å¤¹
        function renderFavoriteScripts() {
            // æ›´æ–°æ ‡ç­¾ç­›é€‰é€‰é¡¹
            updateTagFilterOptions();
            const container = document.getElementById('favoritesList');
            const emptyState = document.getElementById('emptyFavorites');
            const countElement = document.getElementById('favoriteCount');
            
            if (!container) return;
            
            // è·å–ç­›é€‰æ¡ä»¶
            const searchTerm = document.getElementById('favoriteSearch')?.value.toLowerCase() || '';
            const selectedTag = document.getElementById('tagFilter')?.value || '';
            
            // è·å–åŸºç¡€ç­›é€‰ç»“æœï¼ˆæœ€è¿‘ä½¿ç”¨ã€æ™ºèƒ½ç­›é€‰æˆ–å…¨éƒ¨ï¼‰
            let baseScripts;
            if (isRecentUsedMode) {
                baseScripts = getRecentUsedScripts();
            } else {
                baseScripts = getSmartFilteredScripts();
            }
            
            // åº”ç”¨æœç´¢å’Œæ ‡ç­¾ç­›é€‰
            let filteredScripts = baseScripts.filter(script => {
                const matchesSearch = !searchTerm || 
                    script.name.toLowerCase().includes(searchTerm) ||
                    script.generatedText.toLowerCase().includes(searchTerm);
                
                // åœ¨æ™ºèƒ½ç­›é€‰æ¨¡å¼æˆ–æœ€è¿‘ä½¿ç”¨æ¨¡å¼ä¸‹å¿½ç•¥æ ‡ç­¾ç­›é€‰ï¼Œå¦åˆ™åº”ç”¨æ ‡ç­¾ç­›é€‰
                const matchesTag = isSmartFilterMode || isRecentUsedMode || !selectedTag || 
                    script.tags.some(tag => {
                        // è·å–æœ€æ–°çš„æ ‡ç­¾åç§°
                        let currentTagName;
                        if (tag.type === 'sub') {
                            currentTagName = getSubOptionTag(tag.itemId, tag.subIndex) || tag.name;
                        } else {
                            currentTagName = getPrimaryOptionTag(tag.itemId) || tag.name;
                        }
                        return currentTagName === selectedTag;
                    });
                
                return matchesSearch && matchesTag;
            });
            
            // æ›´æ–°è®¡æ•°
            if (countElement) {
                countElement.textContent = filteredScripts.length;
            }
            
            // æ¸…ç©ºå®¹å™¨å¹¶è®¾ç½®ä¸¤åˆ—ç½‘æ ¼å¸ƒå±€
            container.innerHTML = '';
            container.className = 'grid grid-cols-2 gap-3 p-2';
            
            // æ˜¾ç¤º/éšè—ç©ºçŠ¶æ€
            if (filteredScripts.length === 0) {
                if (emptyState) {
                    emptyState.classList.remove('hidden');
                }
                return;
            } else {
                if (emptyState) {
                    emptyState.classList.add('hidden');
                }
            }
            
            // æ¸²æŸ“æ”¶è—è¯æœ¯é¡¹ç›®
            filteredScripts.forEach(script => {
                const div = document.createElement('div');
                div.className = 'group relative p-2 border border-gray-200 rounded-lg cursor-pointer transition-all hover:border-blue-400 hover:shadow-sm bg-white overflow-hidden';
                div.setAttribute('data-id', script.id);
                
                // æ„å»ºæ ‡ç­¾æ˜¾ç¤ºï¼Œä¸äºŒçº§é€‰é¡¹æ˜¾ç¤ºé€»è¾‘ä¿æŒä¸€è‡´
                let tagsHtml = '';
                if (script.tags && script.tags.length > 0) {
                    const tagElements = script.tags.map(tag => {
                        // è·å–æœ€æ–°çš„æ ‡ç­¾ä¿¡æ¯ï¼ˆå®æ—¶åŒæ­¥ï¼‰
                        let currentTagName, currentTagColor;
                        if (tag.type === 'sub') {
                            currentTagName = getSubOptionTag(tag.itemId, tag.subIndex) || tag.name;
                            currentTagColor = getSubOptionTagColor(tag.itemId, tag.subIndex) || tag.color;
                        } else {
                            currentTagName = getPrimaryOptionTag(tag.itemId) || tag.name;
                            currentTagColor = getPrimaryOptionTagColor(tag.itemId) || tag.color;
                        }
                        
                        return `<span class="inline-block px-1.5 py-0.5 text-xs rounded text-white font-medium mr-1 mb-1" style="background-color: ${currentTagColor || '#6b7280'}">${currentTagName}</span>`;
                    }).join('');
                    tagsHtml = `<div class="flex flex-wrap mb-2">${tagElements}</div>`;
                }
                
                div.innerHTML = `
                    <div class="relative h-full">
                        <!-- åˆ é™¤æŒ‰é’® - å³ä¸Šè§’å¤–è¾¹ç¼˜ -->
                        <button class="delete-script-btn absolute -top-2 -right-2 w-5 h-5 bg-red-500 hover:bg-red-600 text-white rounded-full opacity-0 group-hover:opacity-100 transition-opacity z-10 flex items-center justify-center" title="åˆ é™¤">
                            <i class="fas fa-times text-xs"></i>
                        </button>
                        
                        <!-- ç¼–è¾‘æŒ‰é’® - å³ä¸‹è§’ -->
                        <button class="edit-script-btn absolute -bottom-2 -right-2 w-5 h-5 bg-blue-500 hover:bg-blue-600 text-white rounded-full opacity-0 group-hover:opacity-100 transition-opacity z-10 flex items-center justify-center" title="ç¼–è¾‘">
                            <i class="fas fa-edit text-xs"></i>
                        </button>
                        
                        <!-- è¯æœ¯åç§° -->
                        <div class="mb-2">
                            ${script.name && script.name.trim() ? 
                                `<h4 class="font-medium text-sm text-gray-900 group-hover:text-blue-600 transition-colors truncate" title="${script.name}">${script.name}</h4>` : 
                                `<div class="h-5"></div>`
                            }
                        </div>
                        
                        <!-- æ ‡ç­¾ -->
                        ${tagsHtml}
                        
                        <!-- è¯æœ¯é¢„è§ˆ -->
                        <div class="text-xs text-gray-600 line-clamp-3 leading-relaxed">
                            ${script.generatedText.substring(0, 60)}${script.generatedText.length > 60 ? '...' : ''}
                        </div>
                        

                    </div>
                `;
                
                // æ·»åŠ å·¦é”®ç‚¹å‡»å¤åˆ¶äº‹ä»¶
                div.addEventListener('click', function(e) {
                    // é˜»æ­¢ç¼–è¾‘å’Œåˆ é™¤æŒ‰é’®çš„äº‹ä»¶å†’æ³¡
                    if (e.target.closest('.edit-script-btn') || e.target.closest('.delete-script-btn')) {
                        return;
                    }
                    
                    // å¤åˆ¶è¯æœ¯åˆ°å‰ªè´´æ¿
                    navigator.clipboard.writeText(script.generatedText).then(() => {
                        showNotification('è¯æœ¯å·²å¤åˆ¶åˆ°å‰ªè´´æ¿', 'success');
                    }).catch(err => {
                        console.error('å¤åˆ¶å¤±è´¥:', err);
                        showNotification('å¤åˆ¶å¤±è´¥', 'error');
                    });
                });
                
                // æ·»åŠ å³é”®ç‚¹å‡»æ¢å¤äº‹ä»¶
                div.addEventListener('contextmenu', function(e) {
                    e.preventDefault();
                    
                    // é˜»æ­¢ç¼–è¾‘å’Œåˆ é™¤æŒ‰é’®çš„äº‹ä»¶å†’æ³¡
                    if (e.target.closest('.edit-script-btn') || e.target.closest('.delete-script-btn')) {
                        return;
                    }
                    
                    // æ¢å¤é€‰æ‹©çŠ¶æ€
                    if (script.selection) {
                        selection = JSON.parse(JSON.stringify(script.selection));
                        renderAllContent();
                        updateResult();
                        
                        // åŒæ—¶æ¢å¤ç”Ÿæˆçš„è¯æœ¯æ–‡æœ¬
                        const generatedContainer = document.getElementById('generatedContainer');
                        const preElement = document.createElement('pre');
                        preElement.className = 'whitespace-pre-wrap font-sans';
                        preElement.textContent = script.generatedText;
                        generatedContainer.innerHTML = '';
                        generatedContainer.appendChild(preElement);
                        
                        // è°ƒæ•´ç”Ÿæˆæ–‡æœ¬æ¡†é«˜åº¦å’Œæ›´æ–°å­—æ•°ç»Ÿè®¡
                        adjustGeneratedContainerHeight();
                        updateCharCount();
                        
                        showNotification('é€‰æ‹©çŠ¶æ€å·²æ¢å¤', 'success');
                    } else {
                        showNotification('æ²¡æœ‰ä¿å­˜çš„é€‰æ‹©çŠ¶æ€', 'warning');
                    }
                });
                
                // åˆ é™¤æ”¶è—è¯æœ¯
                div.querySelector('.delete-script-btn').addEventListener('click', function(e) {
                    e.stopPropagation();
                    deleteFavoriteScript(script.id);
                });
                
                // ç¼–è¾‘æ”¶è—è¯æœ¯
                div.querySelector('.edit-script-btn').addEventListener('click', function(e) {
                    e.stopPropagation();
                    editFavoriteScript(script.id);
                });
                
                container.appendChild(div);
            });
            
            updateFavoriteCount(favoriteScripts.length);
            
            // æ›´æ–°å¿«é€Ÿè®¿é—®æŒ‰é’®çŠ¶æ€
            updateQuickButtonState();
        }
        
        // æ›´æ–°æ”¶è—å¤¹æ•°é‡æ˜¾ç¤º
        function updateFavoriteCount(count) {
            const countElement = document.getElementById('favoriteCount');
            if (countElement) {
                countElement.textContent = count;
            }
        }
        
        // æ–°çš„æ”¶è—å¤¹ç®¡ç†å‡½æ•°
        
        // æ”¶è—å¤¹ç›¸å…³å‡½æ•°å·²ç§»é™¤

        // åº”ç”¨æ”¶è—è¯æœ¯
        function applyFavoriteScript(scriptId) {
            const script = favoriteScripts.find(s => s.id === scriptId);
            if (script && script.selection) {
                selection = JSON.parse(JSON.stringify(script.selection));
                renderAllContent();
                updateResult();
                
                // åŒæ—¶æ¢å¤ç”Ÿæˆçš„è¯æœ¯æ–‡æœ¬
                const generatedContainer = document.getElementById('generatedContainer');
                const preElement = document.createElement('pre');
                preElement.className = 'whitespace-pre-wrap font-sans';
                preElement.textContent = script.generatedText;
                generatedContainer.innerHTML = '';
                generatedContainer.appendChild(preElement);
                
                // è°ƒæ•´ç”Ÿæˆæ–‡æœ¬æ¡†é«˜åº¦å’Œæ›´æ–°å­—æ•°ç»Ÿè®¡
                adjustGeneratedContainerHeight();
                updateCharCount();
                
                showNotification(`å·²æ¢å¤é€‰æ‹©ï¼š${script.name}`, 'success');
            }
        }
        
        // å¤åˆ¶æ”¶è—è¯æœ¯
        function copyFavoriteScript(scriptId) {
            const script = favoriteScripts.find(s => s.id === scriptId);
            if (script && script.generatedText) {
                navigator.clipboard.writeText(script.generatedText.trim()).then(() => {
                    // è®°å½•ä½¿ç”¨æ—¶é—´
                    recordScriptUsage(scriptId);
                    // æ›´æ–°æŒ‰é’®çŠ¶æ€å’Œè®¡æ•°
                    updateQuickButtonState();
                    showNotification(`å·²å¤åˆ¶è¯æœ¯ï¼š${script.name || 'æœªå‘½åè¯æœ¯'}`, 'success');
                }).catch(err => {
                    console.error('å¤åˆ¶å¤±è´¥:', err);
                    showNotification('å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨å¤åˆ¶', 'error');
                });
            }
        }
        
        // ç¼–è¾‘æ”¶è—è¯æœ¯
        async function editFavoriteScript(scriptId) {
            const script = favoriteScripts.find(s => s.id === scriptId);
            if (!script) return;
            
            // åˆ›å»ºç¼–è¾‘å¯¹è¯æ¡†
            const editDialog = document.createElement('div');
            editDialog.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            editDialog.innerHTML = `
                <div class="bg-white rounded-lg p-6 w-96 max-w-full mx-4">
                    <h3 class="text-lg font-semibold mb-4">ç¼–è¾‘æ”¶è—è¯æœ¯</h3>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">è¯æœ¯åç§°</label>
                        <input type="text" id="editScriptName" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary" value="${script.name || ''}" placeholder="è¯·è¾“å…¥è¯æœ¯åç§°">
                    </div>
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 mb-2">è¯æœ¯å†…å®¹</label>
                        <textarea id="editScriptContent" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary h-32 resize-none" placeholder="è¯·è¾“å…¥è¯æœ¯å†…å®¹">${script.generatedText}</textarea>
                    </div>
                    <div class="flex justify-end space-x-3">
                        <button id="cancelEdit" class="px-4 py-2 text-gray-600 hover:text-gray-800">å–æ¶ˆ</button>
                        <button id="confirmEdit" class="px-4 py-2 bg-primary text-white rounded-md hover:bg-primary-dark">ç¡®å®š</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(editDialog);
            
            // èšç„¦åˆ°åç§°è¾“å…¥æ¡†
            const nameInput = editDialog.querySelector('#editScriptName');
            nameInput.focus();
            nameInput.select();
            
            // å–æ¶ˆæŒ‰é’®äº‹ä»¶
            editDialog.querySelector('#cancelEdit').addEventListener('click', () => {
                document.body.removeChild(editDialog);
            });
            
            // ç¡®å®šæŒ‰é’®äº‹ä»¶
            editDialog.querySelector('#confirmEdit').addEventListener('click', () => {
                const newName = nameInput.value.trim();
                const newContent = editDialog.querySelector('#editScriptContent').value.trim();
                
                if (!newContent) {
                    showNotification('è¯æœ¯å†…å®¹ä¸èƒ½ä¸ºç©º', 'error');
                    return;
                }
                
                script.name = newName;
                script.generatedText = newContent;
                saveFavoriteScripts();
                renderFavoriteScripts();
                showNotification('æ”¶è—è¯æœ¯ä¿®æ”¹æˆåŠŸï¼', 'success');
                document.body.removeChild(editDialog);
            });
            
            // ç‚¹å‡»èƒŒæ™¯å…³é—­
            editDialog.addEventListener('click', (e) => {
                if (e.target === editDialog) {
                    document.body.removeChild(editDialog);
                }
            });
        }

        // åˆ é™¤æ”¶è—è¯æœ¯
        async function deleteFavoriteScript(scriptId) {
            const script = favoriteScripts.find(s => s.id === scriptId);
            const confirmed = await showCustomConfirm(`ç¡®å®šè¦åˆ é™¤æ”¶è—è¯æœ¯"${script.name || 'æœªå‘½åè¯æœ¯'}"å—ï¼Ÿ`);
            if (script && confirmed) {
                favoriteScripts = favoriteScripts.filter(s => s.id !== scriptId);
                saveFavoriteScripts();
                renderFavoriteScripts();
                showNotification('æ”¶è—è¯æœ¯åˆ é™¤æˆåŠŸï¼', 'success');
            }
        }
        
        // åŒæ­¥æ”¶è—è¯æœ¯ä¸­çš„æ ‡ç­¾åç§°
        function syncFavoriteScriptTags(itemId, subOptionIndex, oldTagName, newTagName) {
            let hasChanges = false;
            
            favoriteScripts.forEach(script => {
                if (script.tags && script.tags.length > 0) {
                    script.tags.forEach(tag => {
                        // æ‰¾åˆ°åŒ¹é…çš„æ ‡ç­¾å¹¶æ›´æ–°
                        if (tag.itemId === itemId && tag.subIndex === subOptionIndex) {
                            if (newTagName) {
                                // æ›´æ–°æ ‡ç­¾åç§°
                                if (tag.name !== newTagName) {
                                    tag.name = newTagName;
                                    hasChanges = true;
                                }
                            } else {
                                // åˆ é™¤æ ‡ç­¾ï¼ˆå°†åœ¨ä¸‹é¢çš„è¿‡æ»¤ä¸­å¤„ç†ï¼‰
                                tag.toDelete = true;
                                hasChanges = true;
                            }
                        }
                    });
                    
                    // ç§»é™¤æ ‡è®°ä¸ºåˆ é™¤çš„æ ‡ç­¾
                    script.tags = script.tags.filter(tag => !tag.toDelete);
                }
            });
            
            if (hasChanges) {
                saveFavoriteScripts();
                renderFavoriteScripts();
            }
        }
        
        // åŒæ­¥æ”¶è—è¯æœ¯ä¸­çš„æ ‡ç­¾é¢œè‰²
        function syncFavoriteScriptTagColors(itemId, subOptionIndex, newColor) {
            let hasChanges = false;
            
            favoriteScripts.forEach(script => {
                if (script.tags && script.tags.length > 0) {
                    script.tags.forEach(tag => {
                        // æ‰¾åˆ°åŒ¹é…çš„æ ‡ç­¾å¹¶æ›´æ–°é¢œè‰²
                        if (tag.itemId === itemId && tag.subIndex === subOptionIndex) {
                            if (tag.color !== newColor) {
                                tag.color = newColor;
                                hasChanges = true;
                            }
                        }
                    });
                }
            });
            
            if (hasChanges) {
                saveFavoriteScripts();
                renderFavoriteScripts();
            }
        }
        
        // åŒæ­¥æ”¶è—è¯æœ¯ä¸­çš„ä¸€çº§é€‰é¡¹æ ‡ç­¾åç§°
        function syncFavoriteScriptPrimaryTags(itemId, oldTagName, newTagName) {
            let hasChanges = false;
            
            favoriteScripts.forEach(script => {
                if (script.tags && script.tags.length > 0) {
                    script.tags.forEach(tag => {
                        // æ‰¾åˆ°åŒ¹é…çš„ä¸€çº§é€‰é¡¹æ ‡ç­¾å¹¶æ›´æ–°
                        if (tag.itemId === itemId && tag.type === 'primary') {
                            if (newTagName) {
                                // æ›´æ–°æ ‡ç­¾åç§°
                                if (tag.name !== newTagName) {
                                    tag.name = newTagName;
                                    hasChanges = true;
                                }
                            } else {
                                // åˆ é™¤æ ‡ç­¾ï¼ˆå°†åœ¨ä¸‹é¢çš„è¿‡æ»¤ä¸­å¤„ç†ï¼‰
                                tag.toDelete = true;
                                hasChanges = true;
                            }
                        }
                    });
                    
                    // ç§»é™¤æ ‡è®°ä¸ºåˆ é™¤çš„æ ‡ç­¾
                    script.tags = script.tags.filter(tag => !tag.toDelete);
                }
            });
            
            if (hasChanges) {
                saveFavoriteScripts();
                renderFavoriteScripts();
            }
        }
        
        // åŒæ­¥æ”¶è—è¯æœ¯ä¸­çš„ä¸€çº§é€‰é¡¹æ ‡ç­¾é¢œè‰²
        function syncFavoriteScriptPrimaryTagColors(itemId, newColor) {
            let hasChanges = false;
            
            favoriteScripts.forEach(script => {
                if (script.tags && script.tags.length > 0) {
                    script.tags.forEach(tag => {
                        // æ‰¾åˆ°åŒ¹é…çš„ä¸€çº§é€‰é¡¹æ ‡ç­¾å¹¶æ›´æ–°é¢œè‰²
                        if (tag.itemId === itemId && tag.type === 'primary') {
                            if (tag.color !== newColor) {
                                tag.color = newColor;
                                hasChanges = true;
                            }
                        }
                    });
                }
            });
            
            if (hasChanges) {
                saveFavoriteScripts();
                renderFavoriteScripts();
            }
        }
        
        // åº”ç”¨æ”¶è—
        function applyFavorite(favoriteId) {
            const favorite = favorites.find(f => f.id === favoriteId);
            if (favorite && favorite.selection) {
                selection = JSON.parse(JSON.stringify(favorite.selection));
                renderAllContent();
                updateResult();
                
                // æ·»åŠ åˆ°æœ€è¿‘ä½¿ç”¨
                addToRecentFavorites(favoriteId);
                
                showNotification(`å·²åº”ç”¨æ”¶è—ï¼š${favorite.name}`, 'success');
            }
        }

        // æ”¶è—å¤¹ç›¸å…³å‡½æ•°å·²ç§»é™¤
            
            // æ”¶è—å¤¹ç›¸å…³å‡½æ•°å·²ç§»é™¤


        // æ‰“å¼€ç½‘é¡µæ€»è®¾ç½®é¢æ¿
        function openWebSettings() {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center';
            modal.innerHTML = `
                <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto">
                    <div class="p-6">
                        <h3 class="text-xl font-semibold mb-6 flex items-center gap-2">
                            <i class="fa fa-cogs text-primary"></i>
                            ç½‘é¡µæ€»è®¾ç½®
                        </h3>
                        
                        <!-- è®¾ç½®é€‰é¡¹å¡ -->
                        <div class="mb-6">
                            <div class="flex border-b">
                                <button class="tab-btn active px-4 py-2 border-b-2 border-primary text-primary font-medium" data-tab="api">
                                    <i class="fa fa-plug mr-1"></i> APIé…ç½®
                                </button>
                                <button class="tab-btn px-4 py-2 border-b-2 border-transparent text-gray-600 hover:text-primary" data-tab="config">
                                    <i class="fa fa-folder mr-1"></i> é…ç½®ç®¡ç†
                                </button>
                                <button class="tab-btn px-4 py-2 border-b-2 border-transparent text-gray-600 hover:text-primary" data-tab="display">
                                    <i class="fa fa-desktop mr-1"></i> æ˜¾ç¤ºè®¾ç½®
                                </button>
                            </div>
                        </div>
                        
                        <!-- APIé…ç½®é€‰é¡¹å¡ -->
                        <div id="apiTab" class="tab-content">
                            <h4 class="text-lg font-medium mb-4 flex items-center gap-2">
                                <i class="fa fa-cog text-primary"></i>
                                APIé…ç½®è®¾ç½®
                            </h4>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium mb-2">æ‰£å­APIå¯†é’¥ï¼š</label>
                                <input type="password" id="apiKey" class="w-full p-2 border rounded" placeholder="è¯·è¾“å…¥æ‚¨çš„æ‰£å­APIå¯†é’¥" value="">
                                <p class="text-xs text-gray-500 mt-1">ç”¨äºè°ƒç”¨æ‰£å­æ™ºèƒ½ä½“APIçš„è®¤è¯å¯†é’¥</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-2">æœºå™¨äººIDï¼š</label>
                                <input type="text" id="botId" class="w-full p-2 border rounded" placeholder="è¯·è¾“å…¥æœºå™¨äººID" value="">
                                <p class="text-xs text-gray-500 mt-1">æ‚¨åœ¨æ‰£å­å¹³å°åˆ›å»ºçš„æ™ºèƒ½ä½“æœºå™¨äººID</p>
                            </div>
                            <div class="mb-4">
                                <button type="button" id="testApiBtn" class="w-full px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 disabled:bg-gray-400 disabled:cursor-not-allowed">
                                    <i class="fa fa-flask mr-1"></i>
                                    æµ‹è¯•APIè¿æ¥
                                </button>
                                <div id="testResult" class="mt-2 text-sm hidden"></div>
                            </div>
                            <div class="bg-green-50 p-3 rounded mb-3">
                                <p class="text-sm text-green-700">
                                    <i class="fa fa-file-code mr-1"></i>
                                    <strong>æ–°ç‰¹æ€§ï¼š</strong> é…ç½®ç°åœ¨ç›´æ¥ä¿å­˜åœ¨HTMLæ–‡ä»¶ä¸­ï¼Œä¸å†ä½¿ç”¨æµè§ˆå™¨ç¼“å­˜ã€‚å³ä½¿æ¸…é™¤ç¼“å­˜ä¹Ÿä¸ä¼šä¸¢å¤±é…ç½®ï¼
                                </p>
                            </div>
                                <div class="bg-blue-50 p-3 rounded">
                                    <p class="text-sm text-blue-700">
                                        <i class="fa fa-info-circle mr-1"></i>
                                        é…ç½®å®Œæˆåï¼Œç‚¹å‡»"ç”Ÿæˆè¯æœ¯"æŒ‰é’®å°†è°ƒç”¨æ‚¨çš„æ‰£å­æ™ºèƒ½ä½“APIæ¥ä¼˜åŒ–è¯æœ¯å†…å®¹ã€‚
                                    </p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- é…ç½®ç®¡ç†é€‰é¡¹å¡ -->
                        <div id="configTab" class="tab-content hidden">
                            <h4 class="text-lg font-medium mb-4 flex items-center gap-2">
                                <i class="fa fa-folder text-primary"></i>
                                é…ç½®ç®¡ç†
                            </h4>
                            <div class="space-y-4">
                                <!-- å½“å‰é…ç½®é€‰æ‹© -->
                                <div class="bg-blue-50 p-4 rounded">
                                    <h5 class="font-medium mb-3 flex items-center gap-2">
                                        <i class="fa fa-list mr-1"></i>
                                        å½“å‰é…ç½®
                                    </h5>
                                    <div class="flex gap-2 items-center">
                                        <select id="configSelector" class="flex-1 p-2 border rounded">
                                            <option value="default">é»˜è®¤é…ç½®</option>
                                        </select>
                                        <button id="switchConfigBtn" class="px-3 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">
                                            <i class="fa fa-exchange mr-1"></i>åˆ‡æ¢
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- é…ç½®æ“ä½œ -->
                                <div class="bg-gray-50 p-4 rounded">
                                    <h5 class="font-medium mb-3 flex items-center gap-2">
                                        <i class="fa fa-cogs mr-1"></i>
                                        é…ç½®æ“ä½œ
                                    </h5>
                                    <div class="grid grid-cols-2 gap-2">
                                        <button id="createConfigBtn" class="px-3 py-2 bg-green-500 text-white rounded hover:bg-green-600 text-sm">
                                            <i class="fa fa-plus mr-1"></i>æ–°å»ºé…ç½®
                                        </button>
                                        <button id="renameConfigBtn" class="px-3 py-2 bg-yellow-500 text-white rounded hover:bg-yellow-600 text-sm">
                                            <i class="fa fa-edit mr-1"></i>é‡å‘½å
                                        </button>
                                        <button id="duplicateConfigBtn" class="px-3 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 text-sm">
                                            <i class="fa fa-copy mr-1"></i>å¤åˆ¶é…ç½®
                                        </button>
                                        <button id="deleteConfigBtn" class="px-3 py-2 bg-red-500 text-white rounded hover:bg-red-600 text-sm">
                                            <i class="fa fa-trash mr-1"></i>åˆ é™¤é…ç½®
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- å¯¼å…¥å¯¼å‡º -->
                                <div class="bg-green-50 p-4 rounded">
                                    <h5 class="font-medium mb-3 flex items-center gap-2">
                                        <i class="fa fa-exchange mr-1"></i>
                                        å¯¼å…¥å¯¼å‡º
                                    </h5>
                                    <div class="grid grid-cols-2 gap-2">
                                        <button id="exportConfigBtn" class="px-3 py-2 bg-indigo-500 text-white rounded hover:bg-indigo-600 text-sm">
                                            <i class="fa fa-download mr-1"></i>å¯¼å‡ºé…ç½®
                                        </button>
                                        <button id="importConfigBtn" class="px-3 py-2 bg-purple-500 text-white rounded hover:bg-purple-600 text-sm">
                                            <i class="fa fa-upload mr-1"></i>å¯¼å…¥é…ç½®
                                        </button>
                                    </div>
                                    <input type="file" id="importConfigFile" accept=".json" class="hidden">
                                </div>
                                
                                <!-- é…ç½®ä¿¡æ¯ -->
                                <div class="bg-yellow-50 p-4 rounded">
                                    <h5 class="font-medium mb-2 flex items-center gap-2">
                                        <i class="fa fa-info-circle mr-1"></i>
                                        é…ç½®è¯´æ˜
                                    </h5>
                                    <div class="text-sm text-gray-600 space-y-1">
                                        <p>â€¢ é…ç½®åŒ…å«ï¼šæ”¶è—å¤¹å†…å®¹ã€é€‰æ‹©é¢æ¿ç»“æ„ã€é€‰é¡¹ç±»åˆ«ã€æ ‡ç­¾ç­‰</p>
                                        <p>â€¢ æ‰€æœ‰ä¿®æ”¹ä¼šè‡ªåŠ¨ä¿å­˜åˆ°å½“å‰é…ç½®ä¸­</p>
                                        <p>â€¢ å¯¼å‡ºçš„é…ç½®æ–‡ä»¶å¯åœ¨å…¶ä»–è®¾å¤‡ä¸Šå¯¼å…¥ä½¿ç”¨</p>
                                        <p>â€¢ å¯¼å…¥æ—¶ä¼šè‡ªåŠ¨å¤„ç†åç§°å†²çªï¼Œé¿å…è¦†ç›–å·²æœ‰é…ç½®</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- æ˜¾ç¤ºè®¾ç½®é€‰é¡¹å¡ -->
                        <div id="displayTab" class="tab-content hidden">
                            <h4 class="text-lg font-medium mb-4 flex items-center gap-2">
                                <i class="fa fa-desktop text-primary"></i>
                                æ˜¾ç¤ºè®¾ç½®
                            </h4>
                            <div class="space-y-4">
                                <div class="bg-gray-50 p-4 rounded">
                                    <h5 class="font-medium mb-2">ç•Œé¢ä¸»é¢˜</h5>
                                    <div class="space-y-2">
                                        <label class="flex items-center">
                                            <input type="radio" name="theme" value="light" class="mr-2" checked>
                                            <span>æµ…è‰²ä¸»é¢˜</span>
                                        </label>
                                        <label class="flex items-center">
                                            <input type="radio" name="theme" value="dark" class="mr-2" disabled>
                                            <span class="text-gray-400">æ·±è‰²ä¸»é¢˜ (å¼€å‘ä¸­)</span>
                                        </label>
                                    </div>
                                </div>
                                <div class="bg-gray-50 p-4 rounded">
                                    <h5 class="font-medium mb-2">å­—ä½“å¤§å°</h5>
                                    <select class="w-full p-2 border rounded">
                                        <option value="small">å°å·å­—ä½“</option>
                                        <option value="medium" selected>ä¸­å·å­—ä½“</option>
                                        <option value="large">å¤§å·å­—ä½“</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        

                        
                        <div class="flex gap-2 justify-end mt-6">
                            <button type="button" id="cancelSettings" class="px-4 py-2 text-gray-600 hover:text-gray-800">å–æ¶ˆ</button>
                            <button type="button" id="saveSettings" class="px-4 py-2 bg-primary text-white rounded hover:bg-primary/90">ä¿å­˜è®¾ç½®</button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // è®¾ç½®è¾“å…¥æ¡†çš„é»˜è®¤å€¼
            document.getElementById('apiKey').value = getApiKey();
            document.getElementById('botId').value = getBotId();
            
            // é€‰é¡¹å¡åˆ‡æ¢é€»è¾‘
            const tabBtns = modal.querySelectorAll('.tab-btn');
            const tabContents = modal.querySelectorAll('.tab-content');
            
            tabBtns.forEach(btn => {
                btn.addEventListener('click', function() {
                    const targetTab = this.getAttribute('data-tab');
                    
                    // æ›´æ–°æŒ‰é’®çŠ¶æ€
                    tabBtns.forEach(b => {
                        b.classList.remove('active', 'border-primary', 'text-primary');
                        b.classList.add('border-transparent', 'text-gray-600');
                    });
                    this.classList.add('active', 'border-primary', 'text-primary');
                    this.classList.remove('border-transparent', 'text-gray-600');
                    
                    // æ›´æ–°å†…å®¹æ˜¾ç¤º
                    tabContents.forEach(content => {
                        content.classList.add('hidden');
                    });
                    document.getElementById(targetTab + 'Tab').classList.remove('hidden');
                    
                    // å¦‚æœåˆ‡æ¢åˆ°é…ç½®ç®¡ç†é€‰é¡¹å¡ï¼Œåˆå§‹åŒ–é…ç½®é€‰æ‹©å™¨
                    if (targetTab === 'config') {
                        updateConfigSelector();
                    }
                });
            });
            
            // åˆå§‹åŒ–é…ç½®ç®¡ç†äº‹ä»¶ç›‘å¬å™¨
            setupConfigManagementListeners(modal);
            
            // å–æ¶ˆæŒ‰é’®
            document.getElementById('cancelSettings').addEventListener('click', function() {
                document.body.removeChild(modal);
            });
            
            // æµ‹è¯•APIè¿æ¥æŒ‰é’®
            document.getElementById('testApiBtn').addEventListener('click', async function() {
                const apiKey = document.getElementById('apiKey').value.trim();
                const botId = document.getElementById('botId').value.trim();
                const testBtn = this;
                const testResult = document.getElementById('testResult');
                
                if (!apiKey || !botId) {
                    testResult.className = 'mt-2 text-sm text-red-600';
                    testResult.textContent = 'è¯·å…ˆå¡«å†™APIå¯†é’¥å’Œæœºå™¨äººID';
                    testResult.classList.remove('hidden');
                    return;
                }
                
                // æ˜¾ç¤ºæµ‹è¯•ä¸­çŠ¶æ€
                testBtn.disabled = true;
                testBtn.innerHTML = '<i class="fa fa-spinner fa-spin mr-1"></i>æµ‹è¯•ä¸­...';
                testResult.className = 'mt-2 text-sm text-blue-600';
                testResult.textContent = 'æ­£åœ¨æµ‹è¯•APIè¿æ¥...';
                testResult.classList.remove('hidden');
                
                try {
                    const response = await fetch('https://api.coze.cn/v3/chat', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${apiKey}`
                        },
                        body: JSON.stringify({
                            bot_id: botId,
                            user_id: '123123',
                            stream: false,
                            auto_save_history: true,
                            additional_messages: [
                                {
                                    role: 'user',
                                    content: 'æµ‹è¯•è¿æ¥',
                                    content_type: 'text'
                                }
                            ]
                        })
                    });
                    
                    console.log('APIæµ‹è¯•å“åº”çŠ¶æ€:', response.status);
                    console.log('APIæµ‹è¯•å“åº”å¤´:', response.headers);
                    
                    if (response.ok) {
                        const data = await response.json();
                        console.log('APIæµ‹è¯•å“åº”æ•°æ®:', data);
                        
                        // æ£€æŸ¥APIå“åº”æ˜¯å¦åŒ…å«æœ‰æ•ˆå†…å®¹
                        let hasValidResponse = false;
                        let responseContent = '';
                        let debugInfo = '';
                        
                        // è·å–æ¶ˆæ¯æ•°ç»„
                        const messages = data.messages || (data.data && data.data.messages) || [];
                        console.log('æ‰¾åˆ°æ¶ˆæ¯æ•°é‡:', messages.length);
                        
                        if (messages.length > 0) {
                            // æŸ¥æ‰¾assistantæ¶ˆæ¯ï¼Œä½¿ç”¨æ›´å®½æ¾çš„è¿‡æ»¤æ¡ä»¶
                            const assistantMessages = messages.filter(msg => {
                                const isAssistant = msg.role === 'assistant';
                                const hasContent = msg.content && typeof msg.content === 'string' && msg.content.trim() !== '';
                                console.log(`æ¶ˆæ¯æ£€æŸ¥ - è§’è‰²: ${msg.role}, æœ‰å†…å®¹: ${hasContent}, å†…å®¹: "${msg.content}"`);
                                return isAssistant && hasContent;
                            });
                            
                            console.log('æ‰¾åˆ°assistantæ¶ˆæ¯æ•°é‡:', assistantMessages.length);
                            
                            if (assistantMessages.length > 0) {
                                hasValidResponse = true;
                                responseContent = assistantMessages[0].content;
                                console.log('ä½¿ç”¨çš„å›å¤å†…å®¹:', responseContent);
                            } else {
                                // å¦‚æœæ²¡æœ‰æ‰¾åˆ°assistantæ¶ˆæ¯ï¼Œæä¾›è°ƒè¯•ä¿¡æ¯
                                debugInfo = `æ‰¾åˆ° ${messages.length} æ¡æ¶ˆæ¯ï¼Œä½†æ²¡æœ‰æœ‰æ•ˆçš„assistantå›å¤ã€‚`;
                                if (messages.length > 0) {
                                    debugInfo += ` æ¶ˆæ¯è§’è‰²: ${messages.map(m => m.role).join(', ')}`;
                                }
                            }
                        } else {
                            debugInfo = 'å“åº”ä¸­æ²¡æœ‰æ‰¾åˆ°æ¶ˆæ¯æ•°ç»„ã€‚';
                        }
                        
                        if (hasValidResponse) {
                            testResult.className = 'mt-2 text-sm text-green-600';
                            testResult.innerHTML = `<i class="fa fa-check-circle mr-1"></i>APIè¿æ¥æµ‹è¯•æˆåŠŸï¼æœºå™¨äººå›å¤ï¼š"${responseContent.substring(0, 50)}${responseContent.length > 50 ? '...' : ''}"`;
                        } else {
                            testResult.className = 'mt-2 text-sm text-yellow-600';
                            testResult.innerHTML = `<i class="fa fa-exclamation-triangle mr-1"></i>APIè¿æ¥æˆåŠŸï¼Œä½†æœªè·å–åˆ°æœ‰æ•ˆå›å¤å†…å®¹ã€‚${debugInfo} <a href="debug-api.html" target="_blank" style="color: #007bff; text-decoration: underline;">ç‚¹å‡»è¿™é‡Œä½¿ç”¨è¯¦ç»†è¯Šæ–­å·¥å…·</a>`;
                        }
                    } else {
                        const errorText = await response.text();
                        console.log('APIæµ‹è¯•é”™è¯¯å“åº”:', errorText);
                        
                        let errorMsg = 'APIè¿æ¥å¤±è´¥';
                        if (response.status === 401) {
                            errorMsg = 'APIå¯†é’¥æ— æ•ˆæˆ–å·²è¿‡æœŸ';
                        } else if (response.status === 403) {
                            errorMsg = 'æƒé™ä¸è¶³æˆ–æœºå™¨äººIDæ— æ•ˆ';
                        } else if (response.status === 429) {
                            errorMsg = 'è¯·æ±‚é¢‘ç‡è¿‡é«˜ï¼Œè¯·ç¨åé‡è¯•';
                        } else if (response.status >= 500) {
                            errorMsg = 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯';
                        }
                        
                        testResult.className = 'mt-2 text-sm text-red-600';
                        testResult.innerHTML = `<i class="fa fa-times-circle mr-1"></i>${errorMsg} (çŠ¶æ€ç : ${response.status})`;
                    }
                } catch (error) {
                    console.error('APIæµ‹è¯•ç½‘ç»œé”™è¯¯:', error);
                    testResult.className = 'mt-2 text-sm text-red-600';
                    testResult.innerHTML = '<i class="fa fa-times-circle mr-1"></i>ç½‘ç»œè¿æ¥é”™è¯¯æˆ–CORSé—®é¢˜';
                } finally {
                    // æ¢å¤æŒ‰é’®çŠ¶æ€
                    testBtn.disabled = false;
                    testBtn.innerHTML = '<i class="fa fa-flask mr-1"></i>æµ‹è¯•APIè¿æ¥';
                }
            });
            
            // ä¿å­˜è®¾ç½®æŒ‰é’®
            document.getElementById('saveSettings').addEventListener('click', function() {
                // ä¿å­˜APIé…ç½®
                const apiKey = document.getElementById('apiKey').value.trim();
                const botId = document.getElementById('botId').value.trim();
                
                if (!apiKey || !botId) {
                    showNotification('è¯·å¡«å†™å®Œæ•´çš„APIé…ç½®ä¿¡æ¯', 'error');
                    return;
                }
                
                // ä¿å­˜APIé…ç½®åˆ°æ–‡ä»¶å˜é‡
                saveApiConfig(apiKey, botId);
                
                // ä¿å­˜æ˜¾ç¤ºè®¾ç½®
                const selectedTheme = modal.querySelector('input[name="theme"]:checked')?.value || 'light';
                const selectedFontSize = modal.querySelector('select')?.value || 'medium';
                
                // è¿™é‡Œå¯ä»¥æ·»åŠ ä¿å­˜æ˜¾ç¤ºè®¾ç½®çš„é€»è¾‘
                console.log('ä¿å­˜çš„è®¾ç½®:', { theme: selectedTheme, fontSize: selectedFontSize });
                
                showNotification('è®¾ç½®ä¿å­˜æˆåŠŸï¼', 'success');
                document.body.removeChild(modal);
            });
            

            
            // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    document.body.removeChild(modal);
                }
            });
        }

        // æ‰“å¼€æ”¶è—è®¾ç½®
        function openFavoriteSettings() {
            showNotification('æ”¶è—è®¾ç½®åŠŸèƒ½å¼€å‘ä¸­...', 'info');
        }

        // è·å–APIå¯†é’¥
        function getApiKey() {
            return API_CONFIG.apiKey || '';
        }
        
        // è·å–æœºå™¨äººID
        function getBotId() {
            return API_CONFIG.botId || '';
        }
        
        // ä¿å­˜APIé…ç½®åˆ°æ–‡ä»¶å˜é‡ï¼ˆæ›¿ä»£localStorageï¼‰
        function saveApiConfig(apiKey, botId) {
            API_CONFIG.apiKey = apiKey || '';
            API_CONFIG.botId = botId || '';
            console.log('APIé…ç½®å·²ä¿å­˜åˆ°æ–‡ä»¶å˜é‡');
        }
        
        // æ¸…é™¤APIé…ç½®
        function clearApiConfig() {
            API_CONFIG.apiKey = '';
            API_CONFIG.botId = '';
            console.log('APIé…ç½®å·²æ¸…é™¤');
        }
        
        // æ£€æŸ¥APIé…ç½®æ˜¯å¦å®Œæ•´
        function isApiConfigured() {
            return getApiKey() && getBotId();
        }

        // é¡µé¢åˆå§‹åŒ–å®Œæˆåçš„é¢å¤–å¤„ç†
        document.addEventListener('DOMContentLoaded', function() {
            // åˆå§‹åŒ–æ ‡ç­¾æŒ‰é’®çŠ¶æ€
            setTimeout(() => {
                initializeTagButtonStates();
            }, 100);
            
            // åˆå§‹åŒ–å­—æ•°ç»Ÿè®¡
            updateCharCount();
            
            // ä¸ºç”Ÿæˆæ–‡æœ¬æ¡†æ·»åŠ è¾“å…¥äº‹ä»¶ç›‘å¬å™¨
            const generatedContainer = document.getElementById('generatedContainer');
            if (generatedContainer) {
                generatedContainer.addEventListener('input', updateCharCount);
                generatedContainer.addEventListener('paste', function() {
                    setTimeout(updateCharCount, 10); // å»¶è¿Ÿæ›´æ–°ä»¥ç¡®ä¿ç²˜è´´å†…å®¹å·²å¤„ç†
                });
            }
        });
        
        // è®¾ç½®å¼¹çª—ç›¸å…³åŠŸèƒ½
        document.getElementById('settingsBtn').addEventListener('click', function() {
            document.getElementById('settingsModal').style.display = 'flex';
        });
        
        // å…³é—­è®¾ç½®å¼¹çª—
        function closeSettingsModal() {
            document.getElementById('settingsModal').style.display = 'none';
        }
        
        // ä¿®æ”¹ç±»åˆ«åç§°
        function editCategoryName(categoryKey) {
            const currentName = getCategoryDisplayName(categoryKey);
            showInputDialog('ä¿®æ”¹ç±»åˆ«åç§°', 'è¯·è¾“å…¥æ–°çš„ç±»åˆ«åç§°:', currentName, function(newName) {
                if (newName && newName.trim() && newName !== currentName) {
                    showConfirmDialog(`ç¡®å®šè¦å°†"${currentName}"ä¿®æ”¹ä¸º"${newName}"å—ï¼Ÿ`, function() {
                        // æ›´æ–°ç±»åˆ«æ˜¾ç¤ºåç§°
                        updateCategoryDisplayName(categoryKey, newName.trim());
                        // é‡æ–°æ¸²æŸ“ç•Œé¢
                        renderAllContent();
                        showNotification('ç±»åˆ«åç§°ä¿®æ”¹æˆåŠŸï¼', 'success');
                    });
                }
            });
        }
        
        // ä¿®æ”¹ç±»åˆ«è¯´æ˜
        function editCategoryDescription(categoryKey) {
            const currentDescription = getCategoryDescription(categoryKey);
            showInputDialog('ä¿®æ”¹ç±»åˆ«è¯´æ˜', 'è¯·è¾“å…¥ç±»åˆ«è¯´æ˜ï¼ˆå¯é€‰ï¼‰:', currentDescription, function(newDescription) {
                // æ›´æ–°ç±»åˆ«è¯´æ˜
                updateCategoryDescription(categoryKey, newDescription ? newDescription.trim() : '');
                // é‡æ–°æ¸²æŸ“ç•Œé¢
                renderAllContent();
                showNotification('ç±»åˆ«è¯´æ˜ä¿®æ”¹æˆåŠŸï¼', 'success');
            });
        }
        
        // æ–°å¢ç±»åˆ«
        function addNewCategory() {
            showInputDialog('æ–°å¢ç±»åˆ«', 'è¯·è¾“å…¥æ–°ç±»åˆ«çš„åç§°:', '', function(categoryName) {
                if (categoryName && categoryName.trim()) {
                    const categoryKey = 'custom_' + Date.now();
                    showConfirmDialog(`ç¡®å®šè¦æ·»åŠ æ–°ç±»åˆ«"${categoryName}"å—ï¼Ÿ`, function() {
                        // æ·»åŠ æ–°ç±»åˆ«åˆ°æ•°æ®ç»“æ„
                        addCategory(categoryKey, categoryName.trim());
                        // é‡æ–°æ¸²æŸ“ç•Œé¢
                        renderAllContent();
                        showNotification('æ–°ç±»åˆ«æ·»åŠ æˆåŠŸï¼', 'success');
                    });
                }
            });
        }
        
        // åˆ é™¤ç±»åˆ«
        function deleteCategory(categoryKey) {
            const categoryName = getCategoryDisplayName(categoryKey);
            const itemCount = getItemCountInCategory(categoryKey);
            const message = itemCount > 0 
                ? `ç¡®å®šè¦åˆ é™¤ç±»åˆ«"${categoryName}"å—ï¼Ÿ\nè¿™å°†åŒæ—¶åˆ é™¤è¯¥ç±»åˆ«ä¸‹çš„ ${itemCount} ä¸ªé€‰é¡¹ã€‚`
                : `ç¡®å®šè¦åˆ é™¤ç±»åˆ«"${categoryName}"å—ï¼Ÿ`;
            
            showConfirmDialog(message, function() {
                // åˆ é™¤ç±»åˆ«åŠå…¶ä¸‹çš„æ‰€æœ‰é€‰é¡¹
                removeCategoryAndItems(categoryKey);
                // é‡æ–°æ¸²æŸ“ç•Œé¢
                renderAllContent();
                showNotification('ç±»åˆ«åˆ é™¤æˆåŠŸï¼', 'success');
            });
        }
        
        // æ˜¾ç¤ºè¾“å…¥å¯¹è¯æ¡†
        function showInputDialog(title, message, defaultValue, callback) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-lg shadow-xl max-w-sm w-full mx-4">
                    <div class="p-6">
                        <h3 class="text-lg font-semibold mb-4">${title}</h3>
                        <p class="text-gray-600 mb-4">${message}</p>
                        <input type="text" id="inputDialogValue" class="w-full p-3 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" value="${defaultValue}" placeholder="è¯·è¾“å…¥...">
                        <div class="flex gap-2 mt-6">
                            <button onclick="closeInputDialog(false)" class="flex-1 px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600">å–æ¶ˆ</button>
                            <button onclick="closeInputDialog(true)" class="flex-1 px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600">ç¡®å®š</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            const input = document.getElementById('inputDialogValue');
            input.focus();
            input.select();
            
            // å›è½¦ç¡®è®¤
            input.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    closeInputDialog(true);
                }
            });
            
            window.closeInputDialog = function(confirmed) {
                const value = input.value.trim();
                document.body.removeChild(modal);
                if (confirmed && callback) {
                    callback(value);
                }
                delete window.closeInputDialog;
            };
        }
        
        // æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†
        function showConfirmDialog(message, callback) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            modal.innerHTML = `
                <div class="bg-white rounded-lg shadow-xl max-w-sm w-full mx-4">
                    <div class="p-6">
                        <h3 class="text-lg font-semibold mb-4">ç¡®è®¤æ“ä½œ</h3>
                        <p class="text-gray-600 mb-6">${message}</p>
                        <div class="flex gap-2">
                            <button onclick="closeConfirmDialog(false)" class="flex-1 px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600">å–æ¶ˆ</button>
                            <button onclick="closeConfirmDialog(true)" class="flex-1 px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600">ç¡®å®š</button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            
            window.closeConfirmDialog = function(confirmed) {
                document.body.removeChild(modal);
                if (confirmed && callback) {
                    callback();
                }
                delete window.closeConfirmDialog;
            };
        }
        
        // è·å–ç±»åˆ«æ˜¾ç¤ºåç§°
        function getCategoryDisplayName(categoryKey) {
            // å…ˆä»æœ¬åœ°å­˜å‚¨è·å–è‡ªå®šä¹‰åç§°
            const customNames = getCustomCategoryNames();
            if (customNames[categoryKey]) {
                return customNames[categoryKey];
            }
            
            // å¦‚æœæ²¡æœ‰è‡ªå®šä¹‰åç§°ï¼Œä½¿ç”¨é»˜è®¤åç§°
            const categoryNames = {
                'greeting': 'èµ·æ‰‹ç§°å‘¼å¼',
                'strength': 'ä¼˜ç‚¹',
                'issue': 'é—®é¢˜',
                'closing': 'ç»“å°¾å¼'
            };
            return categoryNames[categoryKey] || categoryKey;
        }
        
        // è·å–è‡ªå®šä¹‰ç±»åˆ«åç§°
        function getCustomCategoryNames() {
            try {
                const saved = localStorage.getItem('customCategoryNames');
                return saved ? JSON.parse(saved) : {};
            } catch (e) {
                console.error('è¯»å–è‡ªå®šä¹‰ç±»åˆ«åç§°å¤±è´¥:', e);
                return {};
            }
        }

        // ä¿å­˜è‡ªå®šä¹‰ç±»åˆ«åç§°
        function saveCustomCategoryNames(customNames) {
            try {
                localStorage.setItem('customCategoryNames', JSON.stringify(customNames));
            } catch (e) {
                console.error('ä¿å­˜è‡ªå®šä¹‰ç±»åˆ«åç§°å¤±è´¥:', e);
            }
        }
        
        // è·å–ç±»åˆ«è¯´æ˜
        function getCategoryDescription(categoryKey) {
            try {
                const saved = localStorage.getItem('categoryDescriptions');
                const descriptions = saved ? JSON.parse(saved) : {};
                return descriptions[categoryKey] || '';
            } catch (e) {
                console.error('è¯»å–ç±»åˆ«è¯´æ˜å¤±è´¥:', e);
                return '';
            }
        }
        
        // ä¿å­˜ç±»åˆ«è¯´æ˜
        function saveCategoryDescriptions(descriptions) {
            try {
                localStorage.setItem('categoryDescriptions', JSON.stringify(descriptions));
            } catch (e) {
                console.error('ä¿å­˜ç±»åˆ«è¯´æ˜å¤±è´¥:', e);
            }
        }
        
        // æ›´æ–°ç±»åˆ«è¯´æ˜
        function updateCategoryDescription(categoryKey, description) {
            try {
                const saved = localStorage.getItem('categoryDescriptions');
                const descriptions = saved ? JSON.parse(saved) : {};
                if (description && description.trim()) {
                    descriptions[categoryKey] = description.trim();
                } else {
                    delete descriptions[categoryKey];
                }
                saveCategoryDescriptions(descriptions);
                // æ›´æ–°ç•Œé¢æ˜¾ç¤º
                updateCategoryTitles();
            } catch (e) {
                console.error('æ›´æ–°ç±»åˆ«è¯´æ˜å¤±è´¥:', e);
            }
        }
        
        // æ›´æ–°ç±»åˆ«æ˜¾ç¤ºåç§°
        function updateCategoryDisplayName(categoryKey, newName) {
            const customNames = getCustomCategoryNames();
            customNames[categoryKey] = newName;
            saveCustomCategoryNames(customNames);
            // æ›´æ–°ç•Œé¢æ˜¾ç¤º
            updateCategoryTitles();
        }
        
        // æ›´æ–°æ‰€æœ‰ç±»åˆ«æ ‡é¢˜æ˜¾ç¤º
        function updateCategoryTitles() {
            const categories = ['greeting', 'strength', 'issue', 'closing'];
            categories.forEach(categoryKey => {
                const displayName = getCategoryDisplayName(categoryKey);
                const description = getCategoryDescription(categoryKey);
                
                // æ›´æ–°ä¸»é¡µé¢æ ‡é¢˜
                const titleElement = document.getElementById(categoryKey + 'Title');
                if (titleElement) {
                    if (description) {
                        titleElement.innerHTML = `${displayName} <span class="text-xs text-gray-500 font-normal">(${description})</span>`;
                    } else {
                        titleElement.textContent = displayName;
                    }
                }
                
                // æ›´æ–°è®¾ç½®å¼¹çª—ä¸­çš„ç¼–è¾‘æŒ‰é’®æ–‡æœ¬
                const editElement = document.getElementById('edit' + categoryKey.charAt(0).toUpperCase() + categoryKey.slice(1) + 'Name');
                if (editElement) {
                    editElement.textContent = displayName;
                }
                
                // æ›´æ–°è®¾ç½®å¼¹çª—ä¸­çš„åˆ é™¤æŒ‰é’®æ–‡æœ¬
                const deleteElement = document.getElementById('delete' + categoryKey.charAt(0).toUpperCase() + categoryKey.slice(1) + 'Name');
                if (deleteElement) {
                    deleteElement.textContent = displayName;
                }
            });
        }
        
        // æ·»åŠ æ–°ç±»åˆ«
        function addCategory(categoryKey, categoryName) {
            // è¿™é‡Œå¯ä»¥æ·»åŠ ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨çš„é€»è¾‘
            console.log(`æ·»åŠ æ–°ç±»åˆ« ${categoryKey}: ${categoryName}`);
        }
        
        // è·å–ç±»åˆ«ä¸‹çš„é€‰é¡¹æ•°é‡
        function getItemCountInCategory(categoryKey) {
            const container = document.getElementById(categoryKey + 'Container');
            return container ? container.children.length : 0;
        }
        
        // åˆ é™¤ç±»åˆ«åŠå…¶é€‰é¡¹
        function removeCategoryAndItems(categoryKey) {
            // è¿™é‡Œå¯ä»¥æ·»åŠ ä»æœ¬åœ°å­˜å‚¨åˆ é™¤çš„é€»è¾‘
            console.log(`åˆ é™¤ç±»åˆ«åŠå…¶é€‰é¡¹: ${categoryKey}`);
        }
    </script>
    
    <!-- è®¾ç½®å¼¹çª— -->
    <div id="settingsModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" style="display: none;">
        <div class="bg-white rounded-lg shadow-xl max-w-md w-full mx-4 max-h-[80vh] overflow-y-auto">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-lg font-semibold">ä¿®æ”¹è®¾ç½®</h3>
                    <button onclick="closeSettingsModal()" class="text-gray-400 hover:text-gray-600 text-xl">
                        <i class="fa fa-times"></i>
                    </button>
                </div>
                
                <div class="space-y-4">
                    <!-- ä¿®æ”¹ç°æœ‰ç±»åˆ« -->
                    <div>
                        <h4 class="font-medium mb-2 text-gray-700">ä¿®æ”¹ç°æœ‰ç±»åˆ«</h4>
                        <div class="space-y-2">
                            <div class="border rounded-lg p-3">
                                <div class="flex items-center justify-between mb-2">
                                    <span id="editGreetingName">èµ·æ‰‹ç§°å‘¼å¼</span>
                                    <div class="flex flex-col gap-1 items-center">
                                        <button onclick="editCategoryName('greeting')" class="text-blue-500 hover:text-blue-700">
                                            <i class="fa fa-edit"></i>
                                        </button>
                                        <button onclick="deleteCategory('greeting')" class="text-red-600 hover:text-red-700">
                                            <i class="fa fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                                <button onclick="editCategoryDescription('greeting')" class="w-full text-left text-sm text-gray-600 hover:text-blue-600 flex items-center gap-1">
                                    <i class="fa fa-comment-o"></i>
                                    <span>ç¼–è¾‘è¯´æ˜</span>
                                </button>
                            </div>
                            <div class="border rounded-lg p-3">
                                <div class="flex items-center justify-between mb-2">
                                    <span id="editStrengthName">ä¼˜ç‚¹</span>
                                    <div class="flex flex-col gap-1 items-center">
                                        <button onclick="editCategoryName('strength')" class="text-blue-500 hover:text-blue-700">
                                            <i class="fa fa-edit"></i>
                                        </button>
                                        <button onclick="deleteCategory('strength')" class="text-red-600 hover:text-red-700">
                                            <i class="fa fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                                <button onclick="editCategoryDescription('strength')" class="w-full text-left text-sm text-gray-600 hover:text-blue-600 flex items-center gap-1">
                                    <i class="fa fa-comment-o"></i>
                                    <span>ç¼–è¾‘è¯´æ˜</span>
                                </button>
                            </div>
                            <div class="border rounded-lg p-3">
                                <div class="flex items-center justify-between mb-2">
                                    <span id="editIssueName">é—®é¢˜</span>
                                    <div class="flex flex-col gap-1 items-center">
                                        <button onclick="editCategoryName('issue')" class="text-blue-500 hover:text-blue-700">
                                            <i class="fa fa-edit"></i>
                                        </button>
                                        <button onclick="deleteCategory('issue')" class="text-red-600 hover:text-red-700">
                                            <i class="fa fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                                <button onclick="editCategoryDescription('issue')" class="w-full text-left text-sm text-gray-600 hover:text-blue-600 flex items-center gap-1">
                                    <i class="fa fa-comment-o"></i>
                                    <span>ç¼–è¾‘è¯´æ˜</span>
                                </button>
                            </div>
                            <div class="border rounded-lg p-3">
                                <div class="flex items-center justify-between mb-2">
                                    <span id="editClosingName">ç»“å°¾å¼</span>
                                    <div class="flex flex-col gap-1 items-center">
                                        <button onclick="editCategoryName('closing')" class="text-blue-500 hover:text-blue-700">
                                            <i class="fa fa-edit"></i>
                                        </button>
                                        <button onclick="deleteCategory('closing')" class="text-red-600 hover:text-red-700">
                                            <i class="fa fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                                <button onclick="editCategoryDescription('closing')" class="w-full text-left text-sm text-gray-600 hover:text-blue-600 flex items-center gap-1">
                                    <i class="fa fa-comment-o"></i>
                                    <span>ç¼–è¾‘è¯´æ˜</span>
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- æ–°å¢ç±»åˆ« -->
                    <div>
                        <h4 class="font-medium mb-2 text-gray-700">æ–°å¢ç±»åˆ«</h4>
                        <button onclick="addNewCategory()" class="w-full p-3 border-2 border-dashed border-blue-300 rounded-lg hover:border-blue-500 hover:bg-blue-50 text-blue-600 flex items-center justify-center gap-2">
                            <i class="fa fa-plus"></i>
                            <span>æ·»åŠ æ–°ç±»åˆ«</span>
                        </button>
                    </div>
                    

                </div>
                
                <div class="mt-6 flex justify-end">
                    <button onclick="closeSettingsModal()" class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600">
                        å…³é—­
                    </button>
                </div>
            </div>
        

        </div>
    </div>
    
    <script>

        
        // æ›´æ–°é…ç½®æ‘˜è¦

        
        // å¯¼å‡ºæ‰€æœ‰æ•°æ®

        

        

        

        

        

        
        // ä¸‹è½½JSONæ–‡ä»¶
        function downloadJSON(data, filename) {
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        // æ ¼å¼åŒ–æ—¥æœŸ
        function formatDate(date) {
            return date.getFullYear() + 
                   String(date.getMonth() + 1).padStart(2, '0') + 
                   String(date.getDate()).padStart(2, '0') + '_' +
                   String(date.getHours()).padStart(2, '0') + 
                   String(date.getMinutes()).padStart(2, '0');
        }
        
        // æ˜¾ç¤ºè‡ªå®šä¹‰å¯¹è¯æ¡†
        function showCustomDialog(title, content, buttons) {
            const dialog = document.createElement('div');
            dialog.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
            dialog.innerHTML = `
                <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4 max-h-96 overflow-y-auto">
                    <h3 class="text-lg font-bold mb-4">${title}</h3>
                    <div class="mb-6">${content}</div>
                    <div class="flex gap-2 justify-end">
                        ${buttons.map(btn => `<button class="px-4 py-2 rounded ${btn.action ? 'bg-blue-500 text-white hover:bg-blue-600' : 'bg-gray-300 text-gray-700 hover:bg-gray-400'}" onclick="${btn.action ? 'this.closest(\'.fixed\').remove(); (' + btn.action + ')()' : 'this.closest(\'.fixed\').remove()'}">${btn.text}</button>`).join('')}
                    </div>
                </div>
            `;
            document.body.appendChild(dialog);
        }

        // ==================== é…ç½®ç®¡ç†åŠŸèƒ½ ====================
        
        // é…ç½®ç®¡ç†å…¨å±€å˜é‡
        let configurations = {}; // å­˜å‚¨æ‰€æœ‰é…ç½®
        let currentConfigId = 'default'; // å½“å‰é…ç½®ID
        
        // é…ç½®æ•°æ®ç»“æ„
        function createDefaultConfig() {
            return {
                id: 'default',
                name: 'é»˜è®¤é…ç½®',
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString(),
                data: {
                    appData: JSON.parse(JSON.stringify(appData)),
                    favoriteScripts: JSON.parse(JSON.stringify(favoriteScripts)),
                    subOptionTags: JSON.parse(JSON.stringify(subOptionTags)),
                    primaryOptionTags: JSON.parse(JSON.stringify(primaryOptionTags)),
                    primaryOptionTagColors: JSON.parse(JSON.stringify(primaryOptionTagColors)),
                    subOptionTagColors: JSON.parse(JSON.stringify(subOptionTagColors)),
                    selection: JSON.parse(JSON.stringify(selection))
                }
            };
        }
        
        // åŠ è½½é…ç½®ç®¡ç†æ•°æ®
        function loadConfigurations() {
            try {
                const saved = localStorage.getItem('configurations');
                if (saved) {
                    configurations = JSON.parse(saved);
                } else {
                    // åˆ›å»ºé»˜è®¤é…ç½®
                    configurations = {
                        'default': createDefaultConfig()
                    };
                }
                
                // åŠ è½½å½“å‰é…ç½®ID
                const savedCurrentId = localStorage.getItem('currentConfigId');
                if (savedCurrentId && configurations[savedCurrentId]) {
                    currentConfigId = savedCurrentId;
                } else {
                    currentConfigId = 'default';
                }
            } catch (e) {
                console.error('åŠ è½½é…ç½®å¤±è´¥:', e);
                configurations = {
                    'default': createDefaultConfig()
                };
                currentConfigId = 'default';
            }
        }
        
        // ä¿å­˜é…ç½®ç®¡ç†æ•°æ®
        function saveConfigurations() {
            try {
                localStorage.setItem('configurations', JSON.stringify(configurations));
                localStorage.setItem('currentConfigId', currentConfigId);
            } catch (e) {
                console.error('ä¿å­˜é…ç½®å¤±è´¥:', e);
            }
        }
        
        // æ›´æ–°é…ç½®é€‰æ‹©å™¨
        function updateConfigSelector() {
            const selector = document.getElementById('configSelector');
            if (!selector) return;
            
            selector.innerHTML = '';
            Object.values(configurations).forEach(config => {
                const option = document.createElement('option');
                option.value = config.id;
                option.textContent = config.name;
                option.selected = config.id === currentConfigId;
                selector.appendChild(option);
            });
        }
        
        // åº”ç”¨é…ç½®æ•°æ®
        function applyConfiguration(configId) {
            const config = configurations[configId];
            if (!config) {
                console.error('é…ç½®ä¸å­˜åœ¨:', configId);
                return false;
            }
            
            try {
                // åº”ç”¨é…ç½®æ•°æ®
                appData = JSON.parse(JSON.stringify(config.data.appData));
                favoriteScripts = JSON.parse(JSON.stringify(config.data.favoriteScripts));
                subOptionTags = JSON.parse(JSON.stringify(config.data.subOptionTags));
                primaryOptionTags = JSON.parse(JSON.stringify(config.data.primaryOptionTags));
                primaryOptionTagColors = JSON.parse(JSON.stringify(config.data.primaryOptionTagColors));
                subOptionTagColors = JSON.parse(JSON.stringify(config.data.subOptionTagColors));
                selection = JSON.parse(JSON.stringify(config.data.selection));
                
                // é‡æ–°æ„å»ºç´¢å¼•å’Œæ¸²æŸ“ç•Œé¢
                buildContentIndex();
                renderAllContent();
                renderFavoriteScripts();
                updateResult();
                
                currentConfigId = configId;
                saveConfigurations();
                
                return true;
            } catch (e) {
                console.error('åº”ç”¨é…ç½®å¤±è´¥:', e);
                return false;
            }
        }
        
        // ä¿å­˜å½“å‰çŠ¶æ€åˆ°é…ç½®
        function saveCurrentStateToConfig() {
            if (!configurations[currentConfigId]) return;
            
            configurations[currentConfigId].data = {
                appData: JSON.parse(JSON.stringify(appData)),
                favoriteScripts: JSON.parse(JSON.stringify(favoriteScripts)),
                subOptionTags: JSON.parse(JSON.stringify(subOptionTags)),
                primaryOptionTags: JSON.parse(JSON.stringify(primaryOptionTags)),
                primaryOptionTagColors: JSON.parse(JSON.stringify(primaryOptionTagColors)),
                subOptionTagColors: JSON.parse(JSON.stringify(subOptionTagColors)),
                selection: JSON.parse(JSON.stringify(selection))
            };
            configurations[currentConfigId].updatedAt = new Date().toISOString();
            saveConfigurations();
        }
        
        // åˆ›å»ºæ–°é…ç½®
        function createNewConfiguration(name) {
            const id = 'config_' + Date.now();
            const newConfig = {
                id: id,
                name: name,
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString(),
                data: {
                    appData: JSON.parse(JSON.stringify(appData)),
                    favoriteScripts: JSON.parse(JSON.stringify(favoriteScripts)),
                    subOptionTags: JSON.parse(JSON.stringify(subOptionTags)),
                    primaryOptionTags: JSON.parse(JSON.stringify(primaryOptionTags)),
                    primaryOptionTagColors: JSON.parse(JSON.stringify(primaryOptionTagColors)),
                    subOptionTagColors: JSON.parse(JSON.stringify(subOptionTagColors)),
                    selection: JSON.parse(JSON.stringify(selection))
                }
            };
            
            configurations[id] = newConfig;
            saveConfigurations();
            updateConfigSelector();
            
            return id;
        }
        
        // é‡å‘½åé…ç½®
        function renameConfiguration(configId, newName) {
            if (!configurations[configId]) return false;
            
            configurations[configId].name = newName;
            configurations[configId].updatedAt = new Date().toISOString();
            saveConfigurations();
            updateConfigSelector();
            
            return true;
        }
        
        // å¤åˆ¶é…ç½®
        function duplicateConfiguration(configId) {
            const sourceConfig = configurations[configId];
            if (!sourceConfig) return null;
            
            const newId = 'config_' + Date.now();
            const newConfig = {
                id: newId,
                name: sourceConfig.name + ' (å‰¯æœ¬)',
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString(),
                data: JSON.parse(JSON.stringify(sourceConfig.data))
            };
            
            configurations[newId] = newConfig;
            saveConfigurations();
            updateConfigSelector();
            
            return newId;
        }
        
        // åˆ é™¤é…ç½®
        function deleteConfiguration(configId) {
            if (configId === 'default') {
                showNotification('ä¸èƒ½åˆ é™¤é»˜è®¤é…ç½®', 'warning');
                return false;
            }
            
            if (!configurations[configId]) return false;
            
            delete configurations[configId];
            
            // å¦‚æœåˆ é™¤çš„æ˜¯å½“å‰é…ç½®ï¼Œåˆ‡æ¢åˆ°é»˜è®¤é…ç½®
            if (currentConfigId === configId) {
                currentConfigId = 'default';
                applyConfiguration('default');
            }
            
            saveConfigurations();
            updateConfigSelector();
            
            return true;
        }
        
        // å¯¼å‡ºé…ç½®
        function exportConfiguration(configId) {
            const config = configurations[configId];
            if (!config) return;
            
            const exportData = {
                version: '1.0',
                exportedAt: new Date().toISOString(),
                config: config
            };
            
            const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${config.name}_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            showNotification('é…ç½®å¯¼å‡ºæˆåŠŸ', 'success');
        }
        
        // å¯¼å…¥é…ç½®
        function importConfiguration(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importData = JSON.parse(e.target.result);
                    
                    if (!importData.config || !importData.config.name) {
                        throw new Error('æ— æ•ˆçš„é…ç½®æ–‡ä»¶æ ¼å¼');
                    }
                    
                    let config = importData.config;
                    let originalName = config.name;
                    let finalName = originalName;
                    let counter = 1;
                    
                    // å¤„ç†åç§°å†²çª
                    while (Object.values(configurations).some(c => c.name === finalName)) {
                        finalName = `${originalName} (${counter})`;
                        counter++;
                    }
                    
                    // åˆ›å»ºæ–°çš„é…ç½®ID
                    const newId = 'config_' + Date.now();
                    config.id = newId;
                    config.name = finalName;
                    config.updatedAt = new Date().toISOString();
                    
                    configurations[newId] = config;
                    saveConfigurations();
                    updateConfigSelector();
                    
                    showNotification(`é…ç½®å¯¼å…¥æˆåŠŸï¼š${finalName}`, 'success');
                } catch (error) {
                    console.error('å¯¼å…¥é…ç½®å¤±è´¥:', error);
                    showNotification('å¯¼å…¥é…ç½®å¤±è´¥ï¼š' + error.message, 'error');
                }
            };
            reader.readAsText(file);
        }
        
        // ç»‘å®šé…ç½®ç®¡ç†äº‹ä»¶ç›‘å¬å™¨
        function setupConfigManagementListeners(modal) {
            // åˆ‡æ¢é…ç½®
            const switchBtn = modal.querySelector('#switchConfigBtn');
            const configSelector = modal.querySelector('#configSelector');
            
            if (switchBtn && configSelector) {
                switchBtn.addEventListener('click', function() {
                    const selectedConfigId = configSelector.value;
                    if (selectedConfigId !== currentConfigId) {
                        if (applyConfiguration(selectedConfigId)) {
                            showNotification(`å·²åˆ‡æ¢åˆ°é…ç½®ï¼š${configurations[selectedConfigId].name}`, 'success');
                            updateConfigSelector();
                        } else {
                            showNotification('åˆ‡æ¢é…ç½®å¤±è´¥', 'error');
                        }
                    }
                });
            }
            
            // åˆ›å»ºæ–°é…ç½®
            const createBtn = modal.querySelector('#createConfigBtn');
            if (createBtn) {
                createBtn.addEventListener('click', function() {
                    const name = prompt('è¯·è¾“å…¥æ–°é…ç½®çš„åç§°:');
                    if (name && name.trim()) {
                        const newId = createNewConfiguration(name.trim());
                        showNotification(`é…ç½®åˆ›å»ºæˆåŠŸï¼š${name.trim()}`, 'success');
                    }
                });
            }
            
            // é‡å‘½åé…ç½®
            const renameBtn = modal.querySelector('#renameConfigBtn');
            if (renameBtn) {
                renameBtn.addEventListener('click', function() {
                    if (currentConfigId === 'default') {
                        showNotification('ä¸èƒ½é‡å‘½åé»˜è®¤é…ç½®', 'warning');
                        return;
                    }
                    
                    const currentName = configurations[currentConfigId].name;
                    const newName = prompt('è¯·è¾“å…¥æ–°çš„é…ç½®åç§°:', currentName);
                    if (newName && newName.trim() && newName.trim() !== currentName) {
                        if (renameConfiguration(currentConfigId, newName.trim())) {
                            showNotification('é…ç½®é‡å‘½åæˆåŠŸ', 'success');
                        }
                    }
                });
            }
            
            // å¤åˆ¶é…ç½®
            const duplicateBtn = modal.querySelector('#duplicateConfigBtn');
            if (duplicateBtn) {
                duplicateBtn.addEventListener('click', function() {
                    const newId = duplicateConfiguration(currentConfigId);
                    if (newId) {
                        showNotification('é…ç½®å¤åˆ¶æˆåŠŸ', 'success');
                    }
                });
            }
            
            // åˆ é™¤é…ç½®
            const deleteBtn = modal.querySelector('#deleteConfigBtn');
            if (deleteBtn) {
                deleteBtn.addEventListener('click', function() {
                    if (currentConfigId === 'default') {
                        showNotification('ä¸èƒ½åˆ é™¤é»˜è®¤é…ç½®', 'warning');
                        return;
                    }
                    
                    const configName = configurations[currentConfigId].name;
                    if (confirm(`ç¡®å®šè¦åˆ é™¤é…ç½®"${configName}"å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ã€‚`)) {
                        if (deleteConfiguration(currentConfigId)) {
                            showNotification('é…ç½®åˆ é™¤æˆåŠŸ', 'success');
                        }
                    }
                });
            }
            
            // å¯¼å‡ºé…ç½®
            const exportBtn = modal.querySelector('#exportConfigBtn');
            if (exportBtn) {
                exportBtn.addEventListener('click', function() {
                    exportConfiguration(currentConfigId);
                });
            }
            
            // å¯¼å…¥é…ç½®
            const importBtn = modal.querySelector('#importConfigBtn');
            const importFile = modal.querySelector('#importConfigFile');
            
            if (importBtn && importFile) {
                importBtn.addEventListener('click', function() {
                    importFile.click();
                });
                
                importFile.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    if (file) {
                        importConfiguration(file);
                        e.target.value = ''; // æ¸…ç©ºæ–‡ä»¶é€‰æ‹©
                    }
                });
            }
        }
        
        // é‡å†™åŸæœ‰çš„ä¿å­˜å‡½æ•°ï¼Œæ·»åŠ è‡ªåŠ¨ä¿å­˜åˆ°å½“å‰é…ç½®
        const originalSaveAppData = saveAppData;
        saveAppData = function() {
            originalSaveAppData();
            saveCurrentStateToConfig();
        };
        
        const originalSaveFavoriteScripts = saveFavoriteScripts;
        saveFavoriteScripts = function() {
            originalSaveFavoriteScripts();
            saveCurrentStateToConfig();
        };
        
        const originalSaveSubOptionTags = saveSubOptionTags;
        saveSubOptionTags = function() {
            originalSaveSubOptionTags();
            saveCurrentStateToConfig();
        };
        
        const originalSavePrimaryOptionTags = savePrimaryOptionTags;
        savePrimaryOptionTags = function() {
            originalSavePrimaryOptionTags();
            saveCurrentStateToConfig();
        };
        
        const originalSavePrimaryOptionTagColors = savePrimaryOptionTagColors;
        savePrimaryOptionTagColors = function() {
            originalSavePrimaryOptionTagColors();
            saveCurrentStateToConfig();
        };
        
        const originalSaveSubOptionTagColors = saveSubOptionTagColors;
        saveSubOptionTagColors = function() {
            originalSaveSubOptionTagColors();
            saveCurrentStateToConfig();
        };
    </script>
</body>
</html>
    