<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coze API v3 å¯¹è¯è®°å½•è·å–æ¼”ç¤º</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        
        .content {
            padding: 40px;
        }
        
        .section {
            margin-bottom: 30px;
            padding: 25px;
            border: 2px solid #e1e5e9;
            border-radius: 15px;
            background: #f8f9fa;
        }
        
        .section h2 {
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.5rem;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #34495e;
        }
        
        .form-group input, .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        
        .form-group input:focus, .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: transform 0.2s;
            margin-right: 10px;
            margin-bottom: 10px;
        }
        
        .btn:hover {
            transform: translateY(-2px);
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .result-box {
            background: #f8f9fa;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .status {
            padding: 10px 15px;
            border-radius: 8px;
            margin: 10px 0;
            font-weight: 600;
        }
        
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .api-info {
            background: #e7f3ff;
            border-left: 4px solid #2196F3;
            padding: 15px;
            margin: 20px 0;
        }
        
        .step-indicator {
            display: flex;
            justify-content: space-between;
            margin-bottom: 30px;
        }
        
        .step {
            flex: 1;
            text-align: center;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            margin: 0 5px;
            position: relative;
        }
        
        .step.active {
            background: #667eea;
            color: white;
        }
        
        .step.completed {
            background: #28a745;
            color: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¤– Coze API v3 å¯¹è¯è®°å½•è·å–</h1>
            <p>æ¼”ç¤ºå®Œæ•´çš„å¯¹è¯æµç¨‹ï¼šå‘èµ·å¯¹è¯ â†’ æŸ¥è¯¢çŠ¶æ€ â†’ è·å–æ¶ˆæ¯è®°å½•</p>
        </div>
        
        <div class="content">
            <div class="api-info">
                <h3>ğŸ“š API æ–‡æ¡£å‚è€ƒ</h3>
                <p><strong>å‘èµ·å¯¹è¯ï¼š</strong> https://www.coze.cn/docs/developer_guides/chat_v3</p>
                <p><strong>æŸ¥è¯¢å¯¹è¯çŠ¶æ€ï¼š</strong> https://www.coze.cn/docs/developer_guides/retrieve_chat</p>
                <p><strong>è·å–æ¶ˆæ¯åˆ—è¡¨ï¼š</strong> https://www.coze.cn/docs/developer_guides/list_chat_messages</p>
            </div>
            
            <div class="step-indicator">
                <div class="step" id="step1">1. é…ç½®å‚æ•°</div>
                <div class="step" id="step2">2. å‘èµ·å¯¹è¯</div>
                <div class="step" id="step3">3. æŸ¥è¯¢çŠ¶æ€</div>
                <div class="step" id="step4">4. è·å–æ¶ˆæ¯</div>
            </div>
            
            <div class="section">
                <h2>ğŸ”§ API é…ç½®</h2>
                <div class="form-group">
                    <label for="apiKey">Personal Access Token:</label>
                    <input type="password" id="apiKey" placeholder="è¾“å…¥ä½ çš„ Coze API Token">
                </div>
                <div class="form-group">
                    <label for="botId">Bot ID:</label>
                    <input type="text" id="botId" placeholder="è¾“å…¥ä½ çš„ Bot ID">
                </div>
                <div class="form-group">
                    <label for="userId">User ID:</label>
                    <input type="text" id="userId" value="123456" placeholder="ç”¨æˆ·ID">
                </div>
            </div>
            
            <div class="section">
                <h2>ğŸ’¬ å‘èµ·å¯¹è¯</h2>
                <div class="form-group">
                    <label for="userMessage">ç”¨æˆ·æ¶ˆæ¯:</label>
                    <textarea id="userMessage" rows="3" placeholder="è¾“å…¥ä½ æƒ³å‘é€çš„æ¶ˆæ¯">ä½ å¥½ï¼Œè¯·ä»‹ç»ä¸€ä¸‹ä½ è‡ªå·±</textarea>
                </div>
                <button class="btn" onclick="startChat()">å‘èµ·å¯¹è¯</button>
                <div id="chatResult" class="result-box" style="display: none;"></div>
            </div>
            
            <div class="section">
                <h2>ğŸ” æŸ¥è¯¢å¯¹è¯çŠ¶æ€</h2>
                <div class="form-group">
                    <label for="conversationId">Conversation ID:</label>
                    <input type="text" id="conversationId" placeholder="ä»ä¸Šä¸€æ­¥è·å–çš„ conversation_id">
                </div>
                <div class="form-group">
                    <label for="chatId">Chat ID:</label>
                    <input type="text" id="chatId" placeholder="ä»ä¸Šä¸€æ­¥è·å–çš„ chat_id">
                </div>
                <button class="btn" onclick="retrieveChat()" id="retrieveBtn" disabled>æŸ¥è¯¢å¯¹è¯çŠ¶æ€</button>
                <button class="btn" onclick="autoRetrieve()" id="autoRetrieveBtn" disabled>è‡ªåŠ¨è½®è¯¢çŠ¶æ€</button>
                <div id="retrieveResult" class="result-box" style="display: none;"></div>
            </div>
            
            <div class="section">
                <h2>ğŸ“‹ è·å–æ¶ˆæ¯åˆ—è¡¨</h2>
                <button class="btn" onclick="getMessages()" id="getMessagesBtn" disabled>è·å–å®Œæ•´æ¶ˆæ¯è®°å½•</button>
                <div id="messagesResult" class="result-box" style="display: none;"></div>
            </div>
            
            <div class="section">
                <h2>ğŸ“Š å®Œæ•´æµç¨‹æ¼”ç¤º</h2>
                <button class="btn" onclick="runFullDemo()">è¿è¡Œå®Œæ•´æ¼”ç¤ºæµç¨‹</button>
                <div id="fullDemoResult" class="result-box" style="display: none;"></div>
            </div>
        </div>
    </div>
    
    <script>
        let currentConversationId = '';
        let currentChatId = '';
        let pollingInterval = null;
        
        // æ›´æ–°æ­¥éª¤çŠ¶æ€
        function updateStep(stepNumber, status) {
            const step = document.getElementById(`step${stepNumber}`);
            step.className = `step ${status}`;
        }
        
        // æ˜¾ç¤ºçŠ¶æ€æ¶ˆæ¯
        function showStatus(message, type = 'info') {
            const statusDiv = document.createElement('div');
            statusDiv.className = `status ${type}`;
            statusDiv.textContent = message;
            document.body.appendChild(statusDiv);
            setTimeout(() => statusDiv.remove(), 5000);
        }
        
        // å‘èµ·å¯¹è¯
        async function startChat() {
            const apiKey = document.getElementById('apiKey').value;
            const botId = document.getElementById('botId').value;
            const userId = document.getElementById('userId').value;
            const message = document.getElementById('userMessage').value;
            
            if (!apiKey || !botId || !message) {
                showStatus('è¯·å¡«å†™å®Œæ•´çš„APIé…ç½®å’Œæ¶ˆæ¯å†…å®¹', 'error');
                return;
            }
            
            updateStep(1, 'completed');
            updateStep(2, 'active');
            
            const requestBody = {
                bot_id: botId,
                user_id: userId,
                stream: false,
                auto_save_history: true,
                additional_messages: [{
                    role: "user",
                    content: message,
                    content_type: "text"
                }]
            };
            
            console.log('å‘èµ·å¯¹è¯è¯·æ±‚:', {
                url: 'https://api.coze.cn/v3/chat',
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${apiKey.substring(0, 10)}...`,
                    'Content-Type': 'application/json'
                },
                body: requestBody
            });
            
            try {
                const response = await fetch('https://api.coze.cn/v3/chat', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });
                
                const result = await response.json();
                
                document.getElementById('chatResult').style.display = 'block';
                document.getElementById('chatResult').textContent = JSON.stringify(result, null, 2);
                
                if (response.ok && result.code === 0) {
                    currentConversationId = result.data.conversation_id;
                    currentChatId = result.data.id;
                    
                    document.getElementById('conversationId').value = currentConversationId;
                    document.getElementById('chatId').value = currentChatId;
                    
                    document.getElementById('retrieveBtn').disabled = false;
                    document.getElementById('autoRetrieveBtn').disabled = false;
                    
                    updateStep(2, 'completed');
                    showStatus('å¯¹è¯å‘èµ·æˆåŠŸï¼', 'success');
                } else {
                    showStatus(`å¯¹è¯å‘èµ·å¤±è´¥: ${result.msg || 'æœªçŸ¥é”™è¯¯'}`, 'error');
                }
            } catch (error) {
                console.error('å‘èµ·å¯¹è¯å¤±è´¥:', error);
                document.getElementById('chatResult').style.display = 'block';
                document.getElementById('chatResult').textContent = `é”™è¯¯: ${error.message}`;
                showStatus('ç½‘ç»œè¯·æ±‚å¤±è´¥', 'error');
            }
        }
        
        // æŸ¥è¯¢å¯¹è¯çŠ¶æ€
        async function retrieveChat() {
            const apiKey = document.getElementById('apiKey').value;
            const conversationId = document.getElementById('conversationId').value;
            const chatId = document.getElementById('chatId').value;
            
            if (!apiKey || !conversationId || !chatId) {
                showStatus('è¯·ç¡®ä¿å·²å‘èµ·å¯¹è¯å¹¶è·å–åˆ°å¯¹è¯ID', 'error');
                return;
            }
            
            updateStep(3, 'active');
            
            const url = `https://api.coze.cn/v3/chat/retrieve?conversation_id=${conversationId}&chat_id=${chatId}`;
            
            console.log('æŸ¥è¯¢å¯¹è¯çŠ¶æ€:', {
                url: url,
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${apiKey.substring(0, 10)}...`,
                    'Content-Type': 'application/json'
                }
            });
            
            try {
                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                const result = await response.json();
                
                document.getElementById('retrieveResult').style.display = 'block';
                document.getElementById('retrieveResult').textContent = JSON.stringify(result, null, 2);
                
                if (response.ok && result.code === 0) {
                    const status = result.data.status;
                    showStatus(`å¯¹è¯çŠ¶æ€: ${status}`, 'info');
                    
                    if (status === 'completed') {
                        updateStep(3, 'completed');
                        document.getElementById('getMessagesBtn').disabled = false;
                        showStatus('å¯¹è¯å·²å®Œæˆï¼Œå¯ä»¥è·å–æ¶ˆæ¯è®°å½•', 'success');
                    } else if (status === 'failed') {
                        showStatus('å¯¹è¯å¤„ç†å¤±è´¥', 'error');
                    } else {
                        showStatus('å¯¹è¯ä»åœ¨å¤„ç†ä¸­...', 'info');
                    }
                } else {
                    showStatus(`æŸ¥è¯¢å¤±è´¥: ${result.msg || 'æœªçŸ¥é”™è¯¯'}`, 'error');
                }
            } catch (error) {
                console.error('æŸ¥è¯¢å¯¹è¯çŠ¶æ€å¤±è´¥:', error);
                document.getElementById('retrieveResult').style.display = 'block';
                document.getElementById('retrieveResult').textContent = `é”™è¯¯: ${error.message}`;
                showStatus('ç½‘ç»œè¯·æ±‚å¤±è´¥', 'error');
            }
        }
        
        // è‡ªåŠ¨è½®è¯¢å¯¹è¯çŠ¶æ€
        async function autoRetrieve() {
            if (pollingInterval) {
                clearInterval(pollingInterval);
                pollingInterval = null;
                document.getElementById('autoRetrieveBtn').textContent = 'è‡ªåŠ¨è½®è¯¢çŠ¶æ€';
                return;
            }
            
            document.getElementById('autoRetrieveBtn').textContent = 'åœæ­¢è½®è¯¢';
            showStatus('å¼€å§‹è‡ªåŠ¨è½®è¯¢å¯¹è¯çŠ¶æ€...', 'info');
            
            pollingInterval = setInterval(async () => {
                await retrieveChat();
                
                const conversationId = document.getElementById('conversationId').value;
                const chatId = document.getElementById('chatId').value;
                const apiKey = document.getElementById('apiKey').value;
                
                try {
                    const response = await fetch(`https://api.coze.cn/v3/chat/retrieve?conversation_id=${conversationId}&chat_id=${chatId}`, {
                        headers: {
                            'Authorization': `Bearer ${apiKey}`,
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    const result = await response.json();
                    
                    if (result.data && (result.data.status === 'completed' || result.data.status === 'failed')) {
                        clearInterval(pollingInterval);
                        pollingInterval = null;
                        document.getElementById('autoRetrieveBtn').textContent = 'è‡ªåŠ¨è½®è¯¢çŠ¶æ€';
                        
                        if (result.data.status === 'completed') {
                            showStatus('è½®è¯¢å®Œæˆï¼šå¯¹è¯å·²å®Œæˆ', 'success');
                        } else {
                            showStatus('è½®è¯¢å®Œæˆï¼šå¯¹è¯å¤±è´¥', 'error');
                        }
                    }
                } catch (error) {
                    console.error('è½®è¯¢è¿‡ç¨‹ä¸­å‡ºé”™:', error);
                }
            }, 3000); // æ¯3ç§’è½®è¯¢ä¸€æ¬¡
        }
        
        // è·å–æ¶ˆæ¯åˆ—è¡¨
        async function getMessages() {
            const apiKey = document.getElementById('apiKey').value;
            const conversationId = document.getElementById('conversationId').value;
            const chatId = document.getElementById('chatId').value;
            
            if (!apiKey || !conversationId || !chatId) {
                showStatus('è¯·ç¡®ä¿å·²å®Œæˆå¯¹è¯å¹¶è·å–åˆ°å¯¹è¯ID', 'error');
                return;
            }
            
            updateStep(4, 'active');
            
            const url = `https://api.coze.cn/v3/chat/message/list?conversation_id=${conversationId}&chat_id=${chatId}`;
            
            console.log('è·å–æ¶ˆæ¯åˆ—è¡¨:', {
                url: url,
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${apiKey.substring(0, 10)}...`,
                    'Content-Type': 'application/json'
                }
            });
            
            try {
                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                const result = await response.json();
                
                document.getElementById('messagesResult').style.display = 'block';
                document.getElementById('messagesResult').textContent = JSON.stringify(result, null, 2);
                
                if (response.ok && result.code === 0) {
                    updateStep(4, 'completed');
                    showStatus('æ¶ˆæ¯è®°å½•è·å–æˆåŠŸï¼', 'success');
                    
                    // è§£æå¹¶æ˜¾ç¤ºæ¶ˆæ¯å†…å®¹
                    if (result.data && result.data.length > 0) {
                        let messagesSummary = '\n\n=== æ¶ˆæ¯æ‘˜è¦ ===\n';
                        result.data.forEach((msg, index) => {
                            messagesSummary += `${index + 1}. [${msg.role}] ${msg.type}: ${msg.content}\n`;
                        });
                        document.getElementById('messagesResult').textContent += messagesSummary;
                    }
                } else {
                    showStatus(`è·å–æ¶ˆæ¯å¤±è´¥: ${result.msg || 'æœªçŸ¥é”™è¯¯'}`, 'error');
                }
            } catch (error) {
                console.error('è·å–æ¶ˆæ¯åˆ—è¡¨å¤±è´¥:', error);
                document.getElementById('messagesResult').style.display = 'block';
                document.getElementById('messagesResult').textContent = `é”™è¯¯: ${error.message}`;
                showStatus('ç½‘ç»œè¯·æ±‚å¤±è´¥', 'error');
            }
        }
        
        // è¿è¡Œå®Œæ•´æ¼”ç¤ºæµç¨‹
        async function runFullDemo() {
            const apiKey = document.getElementById('apiKey').value;
            const botId = document.getElementById('botId').value;
            
            if (!apiKey || !botId) {
                showStatus('è¯·å…ˆé…ç½®API Keyå’ŒBot ID', 'error');
                return;
            }
            
            document.getElementById('fullDemoResult').style.display = 'block';
            document.getElementById('fullDemoResult').textContent = 'å¼€å§‹å®Œæ•´æ¼”ç¤ºæµç¨‹...\n\n';
            
            try {
                // 1. å‘èµ·å¯¹è¯
                showStatus('æ­¥éª¤1: å‘èµ·å¯¹è¯...', 'info');
                await startChat();
                await new Promise(resolve => setTimeout(resolve, 2000));
                
                // 2. è½®è¯¢çŠ¶æ€ç›´åˆ°å®Œæˆ
                showStatus('æ­¥éª¤2: ç­‰å¾…å¯¹è¯å®Œæˆ...', 'info');
                let completed = false;
                let attempts = 0;
                const maxAttempts = 30;
                
                while (!completed && attempts < maxAttempts) {
                    await retrieveChat();
                    
                    const response = await fetch(`https://api.coze.cn/v3/chat/retrieve?conversation_id=${currentConversationId}&chat_id=${currentChatId}`, {
                        headers: {
                            'Authorization': `Bearer ${apiKey}`,
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    const result = await response.json();
                    
                    if (result.data && result.data.status === 'completed') {
                        completed = true;
                        showStatus('æ­¥éª¤2å®Œæˆ: å¯¹è¯å·²å®Œæˆ', 'success');
                    } else if (result.data && result.data.status === 'failed') {
                        throw new Error('å¯¹è¯å¤„ç†å¤±è´¥');
                    } else {
                        attempts++;
                        await new Promise(resolve => setTimeout(resolve, 2000));
                    }
                }
                
                if (!completed) {
                    throw new Error('å¯¹è¯å¤„ç†è¶…æ—¶');
                }
                
                // 3. è·å–æ¶ˆæ¯è®°å½•
                showStatus('æ­¥éª¤3: è·å–æ¶ˆæ¯è®°å½•...', 'info');
                await getMessages();
                
                document.getElementById('fullDemoResult').textContent += '\n\n=== å®Œæ•´æ¼”ç¤ºæµç¨‹å®Œæˆ ===\n';
                showStatus('å®Œæ•´æ¼”ç¤ºæµç¨‹æ‰§è¡ŒæˆåŠŸï¼', 'success');
                
            } catch (error) {
                console.error('å®Œæ•´æ¼”ç¤ºæµç¨‹å¤±è´¥:', error);
                document.getElementById('fullDemoResult').textContent += `\n\né”™è¯¯: ${error.message}`;
                showStatus(`æ¼”ç¤ºæµç¨‹å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        // é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            updateStep(1, 'active');
            showStatus('é¡µé¢åŠ è½½å®Œæˆï¼Œè¯·é…ç½®APIå‚æ•°å¼€å§‹æµ‹è¯•', 'info');
        });
    </script>
</body>
</html>