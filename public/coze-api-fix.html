<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Coze API ä¿®å¤å·¥å…·</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .content {
            padding: 30px;
        }
        
        .section {
            margin-bottom: 30px;
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #667eea;
            background: #f8f9fa;
        }
        
        .section h2 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.5em;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }
        
        .form-group input, .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        .form-group input:focus, .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            margin: 5px;
            transition: background 0.3s;
        }
        
        .btn:hover {
            background: #5a6fd8;
        }
        
        .btn.success {
            background: #28a745;
        }
        
        .btn.warning {
            background: #ffc107;
            color: #333;
        }
        
        .btn.danger {
            background: #dc3545;
        }
        
        .status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            margin-left: 10px;
        }
        
        .status.ok {
            background: #d4edda;
            color: #155724;
        }
        
        .status.error {
            background: #f8d7da;
            color: #721c24;
        }
        
        .status.warning {
            background: #fff3cd;
            color: #856404;
        }
        
        .log {
            background: #f4f4f4;
            border: 1px solid #ddd;
            border-radius: 5px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            margin: 10px 0;
        }
        
        .progress {
            width: 100%;
            height: 20px;
            background: #f0f0f0;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        
        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            width: 0%;
            transition: width 0.3s;
        }
        
        .alert {
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }
        
        .alert.success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        
        .alert.error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        
        .alert.warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }
        
        .alert.info {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ”§ Coze API ä¿®å¤å·¥å…·</h1>
            <p>ä¸“ä¸šçš„APIé—®é¢˜è¯Šæ–­å’Œä¿®å¤è§£å†³æ–¹æ¡ˆ</p>
        </div>
        
        <div class="content">
            <div class="section">
                <h2>ğŸ”‘ API é…ç½®</h2>
                <div class="form-group">
                    <label for="apiKey">API å¯†é’¥ (Personal Access Token):</label>
                    <input type="password" id="apiKey" placeholder="è¯·è¾“å…¥ä»¥ pat_ å¼€å¤´çš„APIå¯†é’¥">
                    <span id="apiKeyStatus" class="status"></span>
                </div>
                <div class="form-group">
                    <label for="botId">æœºå™¨äºº ID:</label>
                    <input type="text" id="botId" placeholder="è¯·è¾“å…¥çº¯æ•°å­—çš„æœºå™¨äººID">
                    <span id="botIdStatus" class="status"></span>
                </div>
                <button class="btn" onclick="validateConfig()">ğŸ” éªŒè¯é…ç½®</button>
                <button class="btn success" onclick="saveConfig()">ğŸ’¾ ä¿å­˜é…ç½®</button>
                <button class="btn warning" onclick="loadConfig()">ğŸ“‚ åŠ è½½é…ç½®</button>
            </div>
            
            <div class="section">
                <h2>ğŸ§ª API æµ‹è¯•</h2>
                <div class="form-group">
                    <label for="testMessage">æµ‹è¯•æ¶ˆæ¯:</label>
                    <textarea id="testMessage" rows="3" placeholder="è¯·è¾“å…¥è¦æµ‹è¯•çš„æ¶ˆæ¯å†…å®¹">è¯·ä¼˜åŒ–ä»¥ä¸‹è¯æœ¯ï¼šæ‚¨å¥½ï¼Œæˆ‘æ˜¯é”€å”®ä»£è¡¨ï¼Œæƒ³å‘æ‚¨ä»‹ç»æˆ‘ä»¬çš„äº§å“ã€‚</textarea>
                </div>
                <button class="btn" onclick="testApiCall()">ğŸš€ æµ‹è¯•APIè°ƒç”¨</button>
                <button class="btn warning" onclick="testWithFixedParams()">ğŸ”§ ä½¿ç”¨ä¿®å¤å‚æ•°æµ‹è¯•</button>
                <button class="btn danger" onclick="clearLog()">ğŸ—‘ï¸ æ¸…ç©ºæ—¥å¿—</button>
                
                <div class="progress" id="progressContainer" style="display: none;">
                    <div class="progress-bar" id="progressBar"></div>
                </div>
                
                <div id="testResult"></div>
                <div class="log" id="apiLog"></div>
            </div>
            
            <div class="section">
                <h2>ğŸ”§ è‡ªåŠ¨ä¿®å¤</h2>
                <div id="fixSuggestions"></div>
                <button class="btn success" onclick="autoFix()">ğŸ¤– è‡ªåŠ¨ä¿®å¤å¸¸è§é—®é¢˜</button>
                <button class="btn" onclick="generateFixedCode()">ğŸ“ ç”Ÿæˆä¿®å¤ä»£ç </button>
            </div>
        </div>
    </div>
    
    <script>
        let apiLog = [];
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${type.toUpperCase()}: ${message}`;
            apiLog.push(logEntry);
            
            const logElement = document.getElementById('apiLog');
            logElement.textContent = apiLog.join('\n');
            logElement.scrollTop = logElement.scrollHeight;
            
            console.log(logEntry);
        }
        
        function clearLog() {
            apiLog = [];
            document.getElementById('apiLog').textContent = '';
            document.getElementById('testResult').innerHTML = '';
        }
        
        function showProgress(show, percent = 0) {
            const container = document.getElementById('progressContainer');
            const bar = document.getElementById('progressBar');
            
            if (show) {
                container.style.display = 'block';
                bar.style.width = percent + '%';
            } else {
                container.style.display = 'none';
            }
        }
        
        function showAlert(message, type = 'info') {
            const resultDiv = document.getElementById('testResult');
            resultDiv.innerHTML = `<div class="alert ${type}">${message}</div>`;
        }
        
        function validateConfig() {
            const apiKey = document.getElementById('apiKey').value;
            const botId = document.getElementById('botId').value;
            
            // éªŒè¯APIå¯†é’¥
            const apiKeyStatus = document.getElementById('apiKeyStatus');
            if (!apiKey) {
                apiKeyStatus.textContent = 'æœªå¡«å†™';
                apiKeyStatus.className = 'status error';
            } else if (!apiKey.startsWith('pat_')) {
                apiKeyStatus.textContent = 'æ ¼å¼é”™è¯¯';
                apiKeyStatus.className = 'status error';
            } else if (apiKey.length < 20) {
                apiKeyStatus.textContent = 'é•¿åº¦ä¸è¶³';
                apiKeyStatus.className = 'status warning';
            } else {
                apiKeyStatus.textContent = 'æ ¼å¼æ­£ç¡®';
                apiKeyStatus.className = 'status ok';
            }
            
            // éªŒè¯æœºå™¨äººID
            const botIdStatus = document.getElementById('botIdStatus');
            if (!botId) {
                botIdStatus.textContent = 'æœªå¡«å†™';
                botIdStatus.className = 'status error';
            } else if (!/^\d+$/.test(botId)) {
                botIdStatus.textContent = 'æ ¼å¼é”™è¯¯';
                botIdStatus.className = 'status error';
            } else {
                botIdStatus.textContent = 'æ ¼å¼æ­£ç¡®';
                botIdStatus.className = 'status ok';
            }
            
            log('é…ç½®éªŒè¯å®Œæˆ');
        }
        
        function saveConfig() {
            const apiKey = document.getElementById('apiKey').value;
            const botId = document.getElementById('botId').value;
            
            localStorage.setItem('coze_api_key', apiKey);
            localStorage.setItem('coze_bot_id', botId);
            
            showAlert('é…ç½®å·²ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨', 'success');
            log('é…ç½®å·²ä¿å­˜');
        }
        
        function loadConfig() {
            const apiKey = localStorage.getItem('coze_api_key') || '';
            const botId = localStorage.getItem('coze_bot_id') || '';
            
            document.getElementById('apiKey').value = apiKey;
            document.getElementById('botId').value = botId;
            
            validateConfig();
            showAlert('é…ç½®å·²ä»æœ¬åœ°å­˜å‚¨åŠ è½½', 'info');
            log('é…ç½®å·²åŠ è½½');
        }
        
        async function testApiCall() {
            const apiKey = document.getElementById('apiKey').value;
            const botId = document.getElementById('botId').value;
            const message = document.getElementById('testMessage').value;
            
            if (!apiKey || !botId || !message) {
                showAlert('è¯·å¡«å†™å®Œæ•´çš„APIé…ç½®å’Œæµ‹è¯•æ¶ˆæ¯', 'error');
                return;
            }
            
            try {
                showProgress(true, 10);
                log('å¼€å§‹APIæµ‹è¯•...');
                
                // ç”Ÿæˆå”¯ä¸€ç”¨æˆ·ID
                const userId = 'test_user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                
                // æ„é€ è¯·æ±‚ä½“
                const requestBody = {
                    bot_id: botId,
                    user_id: userId,
                    stream: false,
                    auto_save_history: true,
                    additional_messages: [{
                        role: 'user',
                        content: message,
                        content_type: 'text'
                    }]
                };
                
                log(`ç”¨æˆ·ID: ${userId}`);
                log(`è¯·æ±‚ä½“: ${JSON.stringify(requestBody, null, 2)}`);
                
                showProgress(true, 30);
                
                // æ­¥éª¤1: å‘èµ·å¯¹è¯
                log('æ­¥éª¤1: å‘èµ·å¯¹è¯è¯·æ±‚...');
                const response = await fetch('https://api.coze.cn/v3/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`,
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });
                
                log(`å“åº”çŠ¶æ€: ${response.status} ${response.statusText}`);
                
                if (!response.ok) {
                    const errorText = await response.text();
                    log(`é”™è¯¯å“åº”: ${errorText}`, 'error');
                    throw new Error(`APIè°ƒç”¨å¤±è´¥: ${response.status} - ${errorText}`);
                }
                
                const data = await response.json();
                log(`å“åº”æ•°æ®: ${JSON.stringify(data, null, 2)}`);
                
                if (!data.data || !data.data.id) {
                    throw new Error('æœªè·å–åˆ°chat_id');
                }
                
                const chatId = data.data.id;
                const conversationId = data.data.conversation_id;
                log(`è·å–åˆ° chat_id: ${chatId}, conversation_id: ${conversationId}`);
                
                showProgress(true, 50);
                
                // æ­¥éª¤2: è½®è¯¢çŠ¶æ€
                log('æ­¥éª¤2: è½®è¯¢å¯¹è¯çŠ¶æ€...');
                let chatStatus = 'in_progress';
                let pollCount = 0;
                const maxPolls = 30;
                
                while (chatStatus === 'in_progress' && pollCount < maxPolls) {
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    pollCount++;
                    
                    const statusResponse = await fetch(`https://api.coze.cn/v3/chat/retrieve?conversation_id=${conversationId}&chat_id=${chatId}`, {
                        method: 'GET',
                        headers: {
                            'Authorization': `Bearer ${apiKey}`,
                            'Accept': 'application/json'
                        }
                    });
                    
                    if (!statusResponse.ok) {
                        throw new Error(`çŠ¶æ€æŸ¥è¯¢å¤±è´¥: ${statusResponse.status}`);
                    }
                    
                    const statusData = await statusResponse.json();
                    chatStatus = statusData.data.status;
                    log(`è½®è¯¢ç¬¬${pollCount}æ¬¡ï¼ŒçŠ¶æ€: ${chatStatus}`);
                    
                    showProgress(true, 50 + (pollCount / maxPolls) * 30);
                    
                    if (chatStatus === 'failed') {
                        throw new Error('å¯¹è¯å¤„ç†å¤±è´¥');
                    }
                    if (chatStatus === 'cancelled') {
                        throw new Error('å¯¹è¯è¢«å–æ¶ˆ');
                    }
                }
                
                if (chatStatus !== 'completed') {
                    throw new Error('å¯¹è¯å¤„ç†è¶…æ—¶');
                }
                
                showProgress(true, 90);
                
                // æ­¥éª¤3: è·å–æ¶ˆæ¯
                log('æ­¥éª¤3: è·å–å¯¹è¯æ¶ˆæ¯...');
                const messagesResponse = await fetch(`https://api.coze.cn/v3/chat/message/list?conversation_id=${conversationId}&chat_id=${chatId}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${apiKey}`,
                        'Accept': 'application/json'
                    }
                });
                
                if (!messagesResponse.ok) {
                    throw new Error(`æ¶ˆæ¯è·å–å¤±è´¥: ${messagesResponse.status}`);
                }
                
                const messagesData = await messagesResponse.json();
                log(`æ¶ˆæ¯æ•°æ®: ${JSON.stringify(messagesData, null, 2)}`);
                
                // è§£ææ¶ˆæ¯
                let generatedText = '';
                if (messagesData.data && Array.isArray(messagesData.data)) {
                    const assistantMessages = messagesData.data.filter(msg => 
                        msg.role === 'assistant' && 
                        msg.type === 'answer' && 
                        msg.content_type === 'text'
                    );
                    
                    if (assistantMessages.length > 0) {
                        generatedText = assistantMessages.map(msg => msg.content).join('\n');
                    }
                }
                
                showProgress(true, 100);
                
                if (generatedText) {
                    showAlert(`âœ… APIæµ‹è¯•æˆåŠŸï¼\n\nç”Ÿæˆçš„å†…å®¹ï¼š\n${generatedText}`, 'success');
                    log('APIæµ‹è¯•æˆåŠŸå®Œæˆ', 'success');
                } else {
                    showAlert('âš ï¸ APIè°ƒç”¨æˆåŠŸï¼Œä½†æœªè·å–åˆ°æœ‰æ•ˆå†…å®¹', 'warning');
                    log('æœªè·å–åˆ°æœ‰æ•ˆå†…å®¹', 'warning');
                }
                
                setTimeout(() => showProgress(false), 2000);
                
            } catch (error) {
                showProgress(false);
                showAlert(`âŒ APIæµ‹è¯•å¤±è´¥ï¼š${error.message}`, 'error');
                log(`APIæµ‹è¯•å¤±è´¥: ${error.message}`, 'error');
                
                // æä¾›ä¿®å¤å»ºè®®
                generateFixSuggestions(error.message);
            }
        }
        
        async function testWithFixedParams() {
            // ä½¿ç”¨ä¿®å¤åçš„å‚æ•°è¿›è¡Œæµ‹è¯•
            log('ä½¿ç”¨ä¿®å¤å‚æ•°è¿›è¡Œæµ‹è¯•...');
            await testApiCall();
        }
        
        function generateFixSuggestions(errorMessage) {
            const suggestionsDiv = document.getElementById('fixSuggestions');
            let suggestions = [];
            
            if (errorMessage.includes('401') || errorMessage.includes('Unauthorized')) {
                suggestions.push('ğŸ”‘ APIå¯†é’¥é—®é¢˜ï¼šè¯·æ£€æŸ¥PATä»¤ç‰Œæ˜¯å¦æœ‰æ•ˆä¸”å…·æœ‰æ­£ç¡®æƒé™');
                suggestions.push('ğŸ”„ å»ºè®®é‡æ–°ç”ŸæˆPersonal Access Token');
            }
            
            if (errorMessage.includes('404') || errorMessage.includes('Not Found')) {
                suggestions.push('ğŸ¤– æœºå™¨äººé—®é¢˜ï¼šè¯·ç¡®è®¤æœºå™¨äººIDæ­£ç¡®ä¸”å·²å‘å¸ƒä¸ºAPIæœåŠ¡');
                suggestions.push('ğŸ“‹ æ£€æŸ¥æœºå™¨äººæ˜¯å¦åœ¨æ­£ç¡®çš„å·¥ä½œç©ºé—´ä¸­');
            }
            
            if (errorMessage.includes('403') || errorMessage.includes('Forbidden')) {
                suggestions.push('ğŸš« æƒé™é—®é¢˜ï¼šPATä»¤ç‰Œå¯èƒ½ç¼ºå°‘å¿…è¦æƒé™');
                suggestions.push('âš™ï¸ ç¡®ä¿ä»¤ç‰Œå…·æœ‰Botç®¡ç†å’ŒChatæƒé™');
            }
            
            if (errorMessage.includes('429')) {
                suggestions.push('â±ï¸ è¯·æ±‚é¢‘ç‡è¿‡é«˜ï¼šè¯·é™ä½APIè°ƒç”¨é¢‘ç‡');
                suggestions.push('â³ å»ºè®®å¢åŠ è¯·æ±‚é—´éš”æ—¶é—´');
            }
            
            if (suggestions.length === 0) {
                suggestions.push('ğŸ” é€šç”¨å»ºè®®ï¼šæ£€æŸ¥ç½‘ç»œè¿æ¥å’ŒAPIé…ç½®');
                suggestions.push('ğŸ“š å‚è€ƒå®˜æ–¹æ–‡æ¡£ç¡®è®¤APIè°ƒç”¨æ ¼å¼');
            }
            
            suggestionsDiv.innerHTML = suggestions.map(s => `<div class="alert warning">${s}</div>`).join('');
        }
        
        function autoFix() {
            log('å¼€å§‹è‡ªåŠ¨ä¿®å¤...');
            
            // è‡ªåŠ¨ä¿®å¤å¸¸è§é—®é¢˜
            const apiKey = document.getElementById('apiKey').value;
            const botId = document.getElementById('botId').value;
            
            let fixed = false;
            
            // ä¿®å¤APIå¯†é’¥æ ¼å¼
            if (apiKey && !apiKey.startsWith('pat_')) {
                document.getElementById('apiKey').value = 'pat_' + apiKey;
                log('å·²ä¿®å¤APIå¯†é’¥æ ¼å¼');
                fixed = true;
            }
            
            // ä¿®å¤æœºå™¨äººIDæ ¼å¼
            if (botId && !/^\d+$/.test(botId)) {
                const cleanBotId = botId.replace(/\D/g, '');
                if (cleanBotId) {
                    document.getElementById('botId').value = cleanBotId;
                    log('å·²ä¿®å¤æœºå™¨äººIDæ ¼å¼');
                    fixed = true;
                }
            }
            
            if (fixed) {
                validateConfig();
                showAlert('è‡ªåŠ¨ä¿®å¤å®Œæˆï¼Œè¯·é‡æ–°æµ‹è¯•', 'success');
            } else {
                showAlert('æœªå‘ç°å¯è‡ªåŠ¨ä¿®å¤çš„é—®é¢˜', 'info');
            }
        }
        
        function generateFixedCode() {
            const fixedCode = `
// ä¿®å¤åçš„Coze APIè°ƒç”¨ä»£ç 
async function callCozeAPI(message) {
    const apiKey = '${document.getElementById('apiKey').value}';
    const botId = '${document.getElementById('botId').value}';
    
    try {
        // ç”Ÿæˆå”¯ä¸€ç”¨æˆ·ID
        const userId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        
        // æ„é€ è¯·æ±‚ä½“ï¼ˆç¬¦åˆCoze API v3è§„èŒƒï¼‰
        const requestBody = {
            bot_id: botId,
            user_id: userId,
            stream: false,
            auto_save_history: true,
            additional_messages: [{
                role: 'user',
                content: message,
                content_type: 'text'
            }]
        };
        
        // æ­¥éª¤1: å‘èµ·å¯¹è¯
        const response = await fetch('https://api.coze.cn/v3/chat', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': \`Bearer \${apiKey}\`,
                'Accept': 'application/json'
            },
            body: JSON.stringify(requestBody)
        });
        
        if (!response.ok) {
            const errorText = await response.text();
            throw new Error(\`APIè°ƒç”¨å¤±è´¥: \${response.status} - \${errorText}\`);
        }
        
        const data = await response.json();
        const chatId = data.data.id;
        const conversationId = data.data.conversation_id;
        
        // æ­¥éª¤2: è½®è¯¢çŠ¶æ€
        let chatStatus = 'in_progress';
        let pollCount = 0;
        const maxPolls = 30;
        
        while (chatStatus === 'in_progress' && pollCount < maxPolls) {
            await new Promise(resolve => setTimeout(resolve, 1000));
            pollCount++;
            
            const statusResponse = await fetch(\`https://api.coze.cn/v3/chat/retrieve?conversation_id=\${conversationId}&chat_id=\${chatId}\`, {
                method: 'GET',
                headers: {
                    'Authorization': \`Bearer \${apiKey}\`,
                    'Accept': 'application/json'
                }
            });
            
            if (!statusResponse.ok) {
                throw new Error(\`çŠ¶æ€æŸ¥è¯¢å¤±è´¥: \${statusResponse.status}\`);
            }
            
            const statusData = await statusResponse.json();
            chatStatus = statusData.data.status;
            
            if (chatStatus === 'failed' || chatStatus === 'cancelled') {
                throw new Error(\`å¯¹è¯å¤„ç†å¤±è´¥: \${chatStatus}\`);
            }
        }
        
        if (chatStatus !== 'completed') {
            throw new Error('å¯¹è¯å¤„ç†è¶…æ—¶');
        }
        
        // æ­¥éª¤3: è·å–æ¶ˆæ¯
        const messagesResponse = await fetch(\`https://api.coze.cn/v3/chat/message/list?conversation_id=\${conversationId}&chat_id=\${chatId}\`, {
            method: 'GET',
            headers: {
                'Authorization': \`Bearer \${apiKey}\`,
                'Accept': 'application/json'
            }
        });
        
        if (!messagesResponse.ok) {
            throw new Error(\`æ¶ˆæ¯è·å–å¤±è´¥: \${messagesResponse.status}\`);
        }
        
        const messagesData = await messagesResponse.json();
        
        // è§£æåŠ©æ‰‹å›å¤
        if (messagesData.data && Array.isArray(messagesData.data)) {
            const assistantMessages = messagesData.data.filter(msg => 
                msg.role === 'assistant' && 
                msg.type === 'answer' && 
                msg.content_type === 'text'
            );
            
            if (assistantMessages.length > 0) {
                return assistantMessages.map(msg => msg.content).join('\\n');
            }
        }
        
        throw new Error('æœªè·å–åˆ°æœ‰æ•ˆçš„åŠ©æ‰‹å›å¤');
        
    } catch (error) {
        console.error('Coze APIè°ƒç”¨å¤±è´¥:', error);
        throw error;
    }
}

// ä½¿ç”¨ç¤ºä¾‹
// callCozeAPI('è¯·ä¼˜åŒ–è¿™æ®µè¯æœ¯').then(result => console.log(result));
            `;
            
            // åˆ›å»ºä¸‹è½½é“¾æ¥
            const blob = new Blob([fixedCode], { type: 'text/javascript' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'coze-api-fixed.js';
            a.click();
            URL.revokeObjectURL(url);
            
            showAlert('ä¿®å¤ä»£ç å·²ç”Ÿæˆå¹¶ä¸‹è½½', 'success');
            log('ä¿®å¤ä»£ç å·²ç”Ÿæˆ');
        }
        
        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨åŠ è½½é…ç½®
        document.addEventListener('DOMContentLoaded', function() {
            loadConfig();
            log('Coze APIä¿®å¤å·¥å…·å·²åŠ è½½');
        });
    </script>
</body>
</html>